@using erp.DTOs.Inventory
@using erp.Services
@using erp.Services.Inventory
@using Color = MudBlazor.Color
@using Size = MudBlazor.Size
@inject ISnackbar Snackbar
@inject IApiService ApiService
@inject ILogger<CreateProductDialog> Logger

<MudDialog>
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@(QuickMode ? Icons.Material.Filled.FlashOn : Icons.Material.Filled.Inventory)" Color="MudBlazor.Color.Primary" Size="MudBlazor.Size.Large" />
            <MudText Typo="Typo.h6">@(QuickMode ? "Produto Rápido" : "Adicionar Novo Produto")</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        @if (_loading)
        {
            <MudStack AlignItems="AlignItems.Center" Spacing="3" Class="pa-6">
                <MudProgressCircular Color="MudBlazor.Color.Primary" Indeterminate="true" Size="MudBlazor.Size.Large" />
                <MudText Typo="Typo.body1" Color="MudBlazor.Color.Secondary">Carregando categorias...</MudText>
            </MudStack>
        }
        else
        {
            <MudForm @ref="_form" Class="pa-2">
                @if (QuickMode)
                {
                    <MudGrid Spacing="3">
                        <MudItem xs="12">
                            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">
                                Cadastro rápido: informe apenas o essencial. SKU será gerado automaticamente.
                            </MudAlert>
                        </MudItem>

                        <MudItem xs="12">
                            <MudTextField T="string"
                                         Label="Nome do Produto"
                                         @bind-Value="_newProduct.Name"
                                         Variant="Variant.Outlined"
                                         Required="true"
                                         Adornment="Adornment.Start"
                                         AdornmentIcon="@Icons.Material.Filled.Inventory"/>
                        </MudItem>

                        <MudItem xs="12">
                            <MudSelect T="int"
                                       Label="Categoria"
                                       @bind-Value="_newProduct.CategoryId"
                                       Variant="Variant.Outlined"
                                       Required="true"
                                       Adornment="Adornment.Start"
                                       AdornmentIcon="@Icons.Material.Filled.Category">
                                @foreach (var category in _categories)
                                {
                                    <MudSelectItem T="int" Value="@category.Id">@category.Name</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>

                        <MudItem xs="12">
                            <MudNumericField T="decimal"
                                             Label="Preço de Venda"
                                             @bind-Value="_newProduct.SalePrice"
                                             Min="0"
                                             Step="0.01m"
                                             Variant="Variant.Outlined"
                                             Required="true"
                                             Format="C2"
                                             Adornment="Adornment.Start"
                                             AdornmentText="R$"/>
                        </MudItem>

                        <MudItem xs="12">
                            <MudNumericField T="decimal?"
                                             Label="Estoque Inicial (opcional)"
                                             @bind-Value="_initialStock"
                                             Min="0"
                                             Step="1"
                                             Variant="Variant.Outlined"
                                             Adornment="Adornment.Start"
                                             AdornmentIcon="@Icons.Material.Filled.Inventory"/>
                        </MudItem>
                    </MudGrid>
                }
                else
                {
                <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4" Style="min-height: 420px;" Color="MudBlazor.Color.Primary">
                    <!-- Aba: Informações Básicas -->
                    <MudTabPanel Text="Informações Básicas" Icon="@Icons.Material.Filled.Info">
                        <MudGrid Spacing="3">
                            <MudItem xs="12" md="4">
                                <MudTextField T="string"
                                             Label="SKU"
                                             @bind-Value="_newProduct.Sku"
                                             Variant="Variant.Outlined"
                                             Required="true"
                                             Immediate="true"
                                             Adornment="Adornment.Start"
                                             AdornmentIcon="@Icons.Material.Filled.Tag"
                                             HelperText="Código único do produto"/>
                            </MudItem>
                            
                            <MudItem xs="12" md="4">
                                <MudTextField T="string"
                                             Label="Código de Barras"
                                             @bind-Value="_newProduct.Barcode"
                                             Variant="Variant.Outlined"
                                             Adornment="Adornment.Start"
                                             AdornmentIcon="@Icons.Material.Filled.QrCode"/>
                            </MudItem>
                            
                            <MudItem xs="12" md="4">
                                <MudSelect T="int"
                                          Label="Categoria"
                                          @bind-Value="_newProduct.CategoryId"
                                          Variant="Variant.Outlined"
                                          Required="true"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Category">
                                    @foreach (var category in _categories)
                                    {
                                        <MudSelectItem T="int" Value="@category.Id">@category.Name</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudTextField T="string"
                                             Label="Nome do Produto"
                                             @bind-Value="_newProduct.Name"
                                             Variant="Variant.Outlined"
                                             Required="true"
                                             Adornment="Adornment.Start"
                                             AdornmentIcon="@Icons.Material.Filled.Inventory"/>
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudTextField T="string"
                                             Label="Descrição"
                                             @bind-Value="_newProduct.Description"
                                             Variant="Variant.Outlined"
                                             Lines="3"
                                             Adornment="Adornment.Start"
                                             AdornmentIcon="@Icons.Material.Filled.Description"/>
                            </MudItem>
                            
                            <MudItem xs="12" md="4">
                                <MudTextField T="string"
                                             Label="Unidade"
                                             @bind-Value="_newProduct.Unit"
                                             Variant="Variant.Outlined"
                                             HelperText="Ex: UN, KG, L, M"/>
                            </MudItem>
                            
                            <MudItem xs="12" md="4">
                                <MudSwitch T="bool" 
                                          @bind-Value="_newProduct.IsActive" 
                                          Color="MudBlazor.Color.Success"
                                          Label="Produto Ativo"/>
                            </MudItem>
                            
                            <MudItem xs="12" md="4">
                                <MudSwitch T="bool" 
                                          @bind-Value="_newProduct.AllowNegativeStock" 
                                          Color="MudBlazor.Color.Warning"
                                          Label="Permitir Estoque Negativo"/>
                            </MudItem>
                        </MudGrid>
                    </MudTabPanel>
                    
                    <!-- Aba: Preços -->
                    <MudTabPanel Text="Preços" Icon="@Icons.Material.Filled.AttachMoney">
                        <MudGrid Spacing="3">
                            <MudItem xs="12" md="4">
                                <MudNumericField T="decimal"
                                                Label="Preço de Custo"
                                                @bind-Value="_newProduct.CostPrice"
                                                Min="0"
                                                Step="0.01m"
                                                Variant="Variant.Outlined"
                                                Required="true"
                                                Format="C2"
                                                Adornment="Adornment.Start"
                                                AdornmentText="R$"/>
                            </MudItem>
                            
                            <MudItem xs="12" md="4">
                                <MudNumericField T="decimal"
                                                Label="Preço de Venda"
                                                @bind-Value="_newProduct.SalePrice"
                                                Min="0"
                                                Step="0.01m"
                                                Variant="Variant.Outlined"
                                                Required="true"
                                                Format="C2"
                                                Adornment="Adornment.Start"
                                                AdornmentText="R$"/>
                            </MudItem>
                            
                            <MudItem xs="12" md="4">
                                <MudNumericField T="decimal?"
                                                Label="Preço Atacado"
                                                @bind-Value="_newProduct.WholesalePrice"
                                                Min="0"
                                                Step="0.01m"
                                                Variant="Variant.Outlined"
                                                Format="C2"
                                                Adornment="Adornment.Start"
                                                AdornmentText="R$"/>
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                                    <strong>Margem de Lucro:</strong> @GetProfitMargin().ToString("P2")
                                </MudAlert>
                            </MudItem>
                        </MudGrid>
                    </MudTabPanel>
                    
                    <!-- Aba: Estoque -->
                    <MudTabPanel Text="Estoque" Icon="@Icons.Material.Filled.Warehouse">
                        <MudGrid Spacing="3">
                            <MudItem xs="12">
                                <MudAlert Severity="Severity.Info" Variant="Variant.Text" Dense="true" Class="mb-2">
                                    <MudIcon Icon="@Icons.Material.Filled.Info" Size="MudBlazor.Size.Small" Class="mr-1"/>
                                    O estoque inicial é opcional. Você pode gerenciar o estoque posteriormente através de movimentações.
                                </MudAlert>
                            </MudItem>
                            
                            <MudItem xs="12" md="6">
                                <MudNumericField T="decimal?"
                                                Label="Estoque Inicial (opcional)"
                                                @bind-Value="_initialStock"
                                                Min="0"
                                                Step="1"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentIcon="@Icons.Material.Filled.Inventory"
                                                HelperText="Deixe em branco para iniciar com 0"/>
                            </MudItem>
                            
                            <MudItem xs="12" md="6">
                                <MudNumericField T="decimal"
                                                Label="Estoque Mínimo"
                                                @bind-Value="_newProduct.MinimumStock"
                                                Min="0"
                                                Step="1"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentIcon="@Icons.Material.Filled.ArrowDownward"/>
                            </MudItem>
                            
                            <MudItem xs="12" md="6">
                                <MudNumericField T="decimal"
                                                Label="Estoque Máximo"
                                                @bind-Value="_newProduct.MaximumStock"
                                                Min="0"
                                                Step="1"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentIcon="@Icons.Material.Filled.ArrowUpward"/>
                            </MudItem>
                            
                            <MudItem xs="12" md="6">
                                <MudNumericField T="decimal"
                                                Label="Ponto de Reposição"
                                                @bind-Value="_newProduct.ReorderPoint"
                                                Min="0"
                                                Step="1"
                                                Variant="Variant.Outlined"
                                                HelperText="Quando atingir este valor, fazer novo pedido"
                                                Adornment="Adornment.Start"
                                                AdornmentIcon="@Icons.Material.Filled.Refresh"/>
                            </MudItem>
                            
                            <MudItem xs="12" md="6">
                                <MudNumericField T="decimal"
                                                Label="Estoque de Segurança"
                                                @bind-Value="_newProduct.SafetyStock"
                                                Min="0"
                                                Step="1"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentIcon="@Icons.Material.Filled.Shield"/>
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudTextField T="string"
                                             Label="Localização no Armazém"
                                             @bind-Value="_newProduct.WarehouseLocation"
                                             Variant="Variant.Outlined"
                                             Placeholder="Ex: A-12-3"
                                             Adornment="Adornment.Start"
                                             AdornmentIcon="@Icons.Material.Filled.LocationOn"/>
                            </MudItem>
                        </MudGrid>
                    </MudTabPanel>
                    
                    <!-- Aba: Dimensões -->
                    <MudTabPanel Text="Dimensões" Icon="@Icons.Material.Filled.Straighten">
                        <MudGrid Spacing="3">
                            <MudItem xs="12" md="6">
                                <MudNumericField T="decimal?"
                                                Label="Peso (kg)"
                                                @bind-Value="_newProduct.Weight"
                                                Min="0"
                                                Step="0.01m"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.End"
                                                AdornmentText="kg"/>
                            </MudItem>
                            
                            <MudItem xs="12" md="6">
                                <MudNumericField T="decimal"
                                                Label="Unidades por Caixa"
                                                @bind-Value="_newProduct.UnitsPerBox"
                                                Min="0.01m"
                                                Step="1"
                                                Variant="Variant.Outlined"/>
                            </MudItem>
                            
                            <MudItem xs="12" md="4">
                                <MudNumericField T="decimal?"
                                                Label="Comprimento (cm)"
                                                @bind-Value="_newProduct.Length"
                                                Min="0"
                                                Step="0.01m"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.End"
                                                AdornmentText="cm"/>
                            </MudItem>
                            
                            <MudItem xs="12" md="4">
                                <MudNumericField T="decimal?"
                                                Label="Largura (cm)"
                                                @bind-Value="_newProduct.Width"
                                                Min="0"
                                                Step="0.01m"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.End"
                                                AdornmentText="cm"/>
                            </MudItem>
                            
                            <MudItem xs="12" md="4">
                                <MudNumericField T="decimal?"
                                                Label="Altura (cm)"
                                                @bind-Value="_newProduct.Height"
                                                Min="0"
                                                Step="0.01m"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.End"
                                                AdornmentText="cm"/>
                            </MudItem>
                        </MudGrid>
                    </MudTabPanel>
                    
                    <!-- Aba: Fiscal -->
                    <MudTabPanel Text="Informações Fiscais" Icon="@Icons.Material.Filled.Receipt">
                        <MudGrid Spacing="3">
                            <MudItem xs="12" md="6">
                                <MudTextField T="string"
                                             Label="NCM"
                                             @bind-Value="_newProduct.NcmCode"
                                             Variant="Variant.Outlined"
                                             Placeholder="00000000"
                                             HelperText="Nomenclatura Comum do Mercosul"/>
                            </MudItem>
                            
                            <MudItem xs="12" md="6">
                                <MudTextField T="string"
                                             Label="CEST"
                                             @bind-Value="_newProduct.CestCode"
                                             Variant="Variant.Outlined"
                                             HelperText="Código Especificador da Substituição Tributária"/>
                            </MudItem>
                            
                            <MudItem xs="12" md="6">
                                <MudNumericField T="decimal"
                                                Label="ICMS (%)"
                                                @bind-Value="_newProduct.IcmsRate"
                                                Min="0"
                                                Max="100"
                                                Step="0.01m"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.End"
                                                AdornmentText="%"/>
                            </MudItem>
                            
                            <MudItem xs="12" md="6">
                                <MudNumericField T="decimal"
                                                Label="IPI (%)"
                                                @bind-Value="_newProduct.IpiRate"
                                                Min="0"
                                                Max="100"
                                                Step="0.01m"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.End"
                                                AdornmentText="%"/>
                            </MudItem>
                            
                            <MudItem xs="12" md="6">
                                <MudNumericField T="decimal"
                                                Label="PIS (%)"
                                                @bind-Value="_newProduct.PisRate"
                                                Min="0"
                                                Max="100"
                                                Step="0.01m"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.End"
                                                AdornmentText="%"/>
                            </MudItem>
                            
                            <MudItem xs="12" md="6">
                                <MudNumericField T="decimal"
                                                Label="COFINS (%)"
                                                @bind-Value="_newProduct.CofinsRate"
                                                Min="0"
                                                Max="100"
                                                Step="0.01m"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.End"
                                                AdornmentText="%"/>
                            </MudItem>
                        </MudGrid>
                    </MudTabPanel>
                    <!-- Aba: Variações -->
                    <MudTabPanel Text="Variações" Icon="@Icons.Material.Filled.Style">
                        <MudGrid Spacing="3">
                            <MudItem xs="12">
                                <MudAlert Severity="Severity.Info" Variant="Variant.Text" Dense="true" Class="mb-2">
                                    <MudIcon Icon="@Icons.Material.Filled.Info" Size="MudBlazor.Size.Small" Class="mr-1"/>
                                    Selecione esta opção se o produto tiver variações (ex: Tamanho, Cor). As variações serão geradas após salvar o produto base, e você poderá configurar preços e estoques individuais.
                                </MudAlert>
                            </MudItem>

                            <MudItem xs="12">
                                <MudSwitch T="bool" 
                                          @bind-Value="_hasVariants" 
                                          Color="MudBlazor.Color.Primary"
                                          Label="Este produto tem variações"/>
                            </MudItem>

                            @if (_hasVariants)
                            {
                                <MudItem xs="12">
                                    <MudText Typo="Typo.subtitle2" Class="mb-2">Opções de Variação (ex: Cor, Tamanho)</MudText>
                                    
                                    @foreach (var (option, index) in _variantOptions.Select((o, i) => (o, i)))
                                    {
                                        <MudPaper Elevation="1" Class="pa-3 mb-3" Outlined="true">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                <MudTextField T="string" 
                                                            @bind-Value="option.Name" 
                                                            Label="Nome da Opção" 
                                                            Placeholder="ex: Cor" 
                                                            Variant="Variant.Outlined" 
                                                            Margin="Margin.Dense" />
                                                
                                                <MudTextField T="string" 
                                                            @bind-Value="option.PendingValue" 
                                                            Label="Adicionar Valor" 
                                                            Placeholder="ex: Vermelho" 
                                                            Variant="Variant.Outlined" 
                                                            Margin="Margin.Dense"
                                                            OnKeyDown="@(e => HandleValueKeyDown(e, option))" />
                                                
                                                <MudIconButton Icon="@Icons.Material.Filled.Add" 
                                                             Color="Color.Primary" 
                                                             Size="Size.Small" 
                                                             OnClick="@(() => AddOptionValue(option))" />
                                                
                                                <MudSpacer />
                                                <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                             Color="Color.Error" 
                                                             Size="Size.Small" 
                                                             OnClick="@(() => RemoveOption(option))" />
                                            </MudStack>
                                            
                                            @if (option.Values.Any())
                                            {
                                                <MudStack Row="true" Wrap="Wrap.Wrap" Class="mt-2" Spacing="1">
                                                    @foreach (var val in option.Values)
                                                    {
                                                        <MudChip T="string" Color="Color.Default" OnClose="@(() => RemoveOptionValue(option, val))">@val</MudChip>
                                                    }
                                                </MudStack>
                                            }
                                        </MudPaper>
                                    }
                                    
                                    <MudButton StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Text" Color="Color.Primary" OnClick="AddOption">
                                        Adicionar Nova Opção
                                    </MudButton>
                                </MudItem>
                                
                                @if (_variantOptions.Any(o => o.Values.Any()))
                                {
                                    <MudItem xs="12">
                                        <MudAlert Severity="Severity.Success" Variant="Variant.Outlined" Dense="true">
                                            <strong>@CalculateTotalCombinations() variações</strong> serão geradas após salvar.
                                        </MudAlert>
                                    </MudItem>
                                }
                            }
                        </MudGrid>
                    </MudTabPanel>
                </MudTabs>
                }
            </MudForm>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Outlined" Disabled="@_saving">Cancelar</MudButton>
        <MudButton OnClick="Submit" 
                   Variant="Variant.Filled" 
                   Color="MudBlazor.Color.Primary" 
                   Disabled="@(_loading || _saving)">
            @if (_saving)
            {
                <MudProgressCircular Size="MudBlazor.Size.Small" Indeterminate="true" Class="mr-2"/>
                <text>Salvando...</text>
            }
            else
            {
                <MudIcon Icon="@Icons.Material.Filled.Save" Class="mr-1"/>
                <text>@(QuickMode ? "Criar Rápido" : "Criar Produto")</text>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter]
    public bool QuickMode { get; set; }

    [CascadingParameter] 
    private IMudDialogInstance MudDialog { get; set; } = null!;
    
    private MudForm? _form;
    private bool _loading = false;
    private bool _saving = false;
    private CreateProductDto _newProduct = new();
    private List<ProductCategoryDto> _categories = new();
    private decimal? _initialStock;
    private bool _hasVariants = false;
    private List<VariantOptionViewModel> _variantOptions = new();
    
    // ViewModel para a UI de opções
    private class VariantOptionViewModel
    {
        public string Name { get; set; } = "";
        public string PendingValue { get; set; } = "";
        public List<string> Values { get; set; } = new();
    }
    
    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        try
        {
            // Carrega categorias - aumenta pageSize para pegar todas
            var response = await ApiService.GetAsync<PaginatedCategoryResponse>("/api/produtos/categories?pageSize=1000");
            _categories = response?.Items ?? new List<ProductCategoryDto>();
            
            // Inicializa valores padrão
            _newProduct.Unit = "UN";
            _newProduct.UnitsPerBox = 1;
            _newProduct.IsActive = true;
            _newProduct.Status = 0;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erro ao carregar categorias");
            Snackbar.Add("Erro ao carregar categorias", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }
    
    private decimal GetProfitMargin()
    {
        if (_newProduct.CostPrice <= 0 || _newProduct.SalePrice <= 0)
            return 0;
        
        return (_newProduct.SalePrice - _newProduct.CostPrice) / _newProduct.SalePrice;
    }
    
    private void Cancel()
    {
        MudDialog.Cancel();
    }
    
    private async Task Submit()
    {
        if (_form != null)
        {
            await _form.Validate();
            if (!_form.IsValid)
            {
                Snackbar.Add("Por favor, corrija os erros no formulário", Severity.Warning);
                return;
            }
        }
        
        if (string.IsNullOrWhiteSpace(_newProduct.Name))
        {
            Snackbar.Add("O nome do produto é obrigatório", Severity.Warning);
            return;
        }
        
        if (_newProduct.CategoryId <= 0)
        {
            Snackbar.Add("Selecione uma categoria", Severity.Warning);
            return;
        }

        if (_newProduct.SalePrice <= 0)
        {
            Snackbar.Add("Informe um preço de venda maior que zero", Severity.Warning);
            return;
        }

        if (!QuickMode && string.IsNullOrWhiteSpace(_newProduct.Sku))
        {
            Snackbar.Add("O SKU é obrigatório", Severity.Warning);
            return;
        }
        
        _saving = true;
        try
        {
            if (QuickMode)
            {
                QuickProductDefaults.Apply(_newProduct, _initialStock);
            }
            else if (_initialStock.HasValue && _initialStock.Value > 0)
            {
                _newProduct.CurrentStock = _initialStock.Value;
            }
            var result = await ApiService.PostAsync<ProductDto>("/api/produtos", _newProduct);
            
            if (result != null)
            {
                // Se tiver variações, cria as opções
                if (!QuickMode && _hasVariants && _variantOptions.Any(o => !string.IsNullOrWhiteSpace(o.Name) && o.Values.Any()))
                {
                    try
                    {
                        var position = 0;
                        foreach (var option in _variantOptions.Where(o => !string.IsNullOrWhiteSpace(o.Name) && o.Values.Any()))
                        {
                            var createOptionDto = new CreateProductVariantOptionDto
                            {
                                Name = option.Name,
                                Position = position++,
                                Values = option.Values.Select((v, i) => new CreateProductVariantOptionValueDto
                                {
                                    Value = v,
                                    Position = i
                                }).ToList()
                            };
                            
                            await ApiService.PostAsync<ProductVariantOptionDto>($"/api/produtos/{result.Id}/variantes/opcoes", createOptionDto);
                        }
                        
                        Snackbar.Add("Produto e opções de variação criados com sucesso!", Severity.Success);
                    }
                    catch (Exception ex)
                    {
                        Logger.LogError(ex, "Produto criado, mas erro ao criar opções de variação");
                        Snackbar.Add("Produto criado, mas houve um erro ao criar as opções de variação.", Severity.Warning);
                    }
                }
                else
                {
                    Snackbar.Add("Produto criado com sucesso!", Severity.Success);
                }
                
                MudDialog.Close(DialogResult.Ok(result));
            }
            else
            {
                Snackbar.Add("Erro ao criar produto", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erro ao criar produto");
            Snackbar.Add($"Erro ao criar produto: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private void AddOption()
    {
        _variantOptions.Add(new VariantOptionViewModel());
    }

    private void RemoveOption(VariantOptionViewModel option)
    {
        _variantOptions.Remove(option);
    }

    private void AddOptionValue(VariantOptionViewModel option)
    {
        if (!string.IsNullOrWhiteSpace(option.PendingValue) && !option.Values.Contains(option.PendingValue.Trim()))
        {
            option.Values.Add(option.PendingValue.Trim());
            option.PendingValue = "";
        }
    }

    private void RemoveOptionValue(VariantOptionViewModel option, string value)
    {
        option.Values.Remove(value);
    }

    private void HandleValueKeyDown(Microsoft.AspNetCore.Components.Web.KeyboardEventArgs e, VariantOptionViewModel option)
    {
        if (e.Key == "Enter")
        {
            AddOptionValue(option);
        }
    }

    private int CalculateTotalCombinations()
    {
        var validOptions = _variantOptions.Where(o => o.Values.Any()).ToList();
        if (!validOptions.Any()) return 0;
        
        return validOptions.Aggregate(1, (acc, next) => acc * next.Values.Count);
    }

    private class PaginatedCategoryResponse
    {
        public List<ProductCategoryDto> Items { get; set; } = new();
        public int TotalItems { get; set; }
        public int Page { get; set; }
        public int PageSize { get; set; }
    }
}
}
