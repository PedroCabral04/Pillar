@using System.ComponentModel.DataAnnotations
@using System.Net.Http.Headers
@using erp.DTOs.Tenancy
@using erp.Models.Tenancy
@using erp.Services
@using erp.Services.Tenancy
@using MudBlazor
@using MudBlazor.Utilities
@inject IApiService ApiService
@inject ISnackbar Snackbar
@inject ITenantBrandingProvider BrandingProvider
@inject ITenantContextAccessor TenantContextAccessor

<MudDialog Class="tenant-form-dialog">
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@(IsEdit ? Icons.Material.Filled.Domain : Icons.Material.Filled.AddBusiness)" Color="MudBlazor.Color.Primary" />
            <MudText Typo="Typo.h6">@(IsEdit ? "Editar tenant" : "Novo tenant")</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="2">
            @if (!string.IsNullOrWhiteSpace(_errorMessage))
            {
                <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
            }
            <MudForm @ref="_form" OnValidSubmit="HandleValidSubmit">
                <MudStack Spacing="3">
                    <MudGrid GutterSize="GutterSize.Small">
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_model.Name"
                                      Label="Nome da empresa"
                                      For="() => _model.Name"
                                      Required="true"
                                      MaxLength="200"
                                      Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_model.Slug"
                                      Label="Slug (subdomínio)"
                                      For="() => _model.Slug"
                                      Required="true"
                                      Disabled="@IsEdit"
                                      HelperText="Usado em links como {slug}.pillar.local"
                                      MaxLength="64"
                                      Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_model.DocumentNumber"
                                      Label="Documento (CNPJ/CPF)"
                                      For="() => _model.DocumentNumber"
                                      Variant="Variant.Outlined"
                                      MaxLength="20" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_model.Region"
                                      Label="Região / Unidade"
                                      For="() => _model.Region"
                                      Variant="Variant.Outlined"
                                      MaxLength="200" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_model.PrimaryContactName"
                                      Label="Contato principal"
                                      For="() => _model.PrimaryContactName"
                                      Variant="Variant.Outlined"
                                      MaxLength="200" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_model.PrimaryContactEmail"
                                      Label="Email do contato"
                                      For="() => _model.PrimaryContactEmail"
                                      Variant="Variant.Outlined"
                                      MaxLength="200" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_model.PrimaryContactPhone"
                                      Label="Telefone do contato"
                                      For="() => _model.PrimaryContactPhone"
                                      Variant="Variant.Outlined"
                                      MaxLength="20" />
                    </MudItem>
                    <MudItem xs="12" md="6" Class="d-flex align-center">
                        <MudSwitch T="bool" @bind-Checked="_model.IsDemo" Color="MudBlazor.Color.Info" Label="Tenant de demonstração" />
                    </MudItem>
                    @if (IsEdit)
                    {
                        <MudItem xs="12" md="6">
                            <MudSelect @bind-Value="_model.Status" Label="Status" Variant="Variant.Outlined">
                                @foreach (var status in Enum.GetValues<TenantStatus>())
                                {
                                    <MudSelectItem Value="@status">@GetStatusLabel(status)</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField @bind-Value="_model.Notes"
                                          Label="Observações"
                                          For="() => _model.Notes"
                                          Variant="Variant.Outlined"
                                          Lines="3"
                                          MaxLength="2000" />
                        </MudItem>
                    }
                </MudGrid>

                <MudExpansionPanels Elevation="0">
                    <MudExpansionPanel Text="Branding e identidade visual" Expanded="@(!IsEdit)">
                        <MudGrid GutterSize="GutterSize.Small">
                            @* Logo Upload *@
                            <MudItem xs="12" md="6">
                                <MudStack Spacing="2">
                                    <MudText Typo="Typo.subtitle2">Logo</MudText>
                                    <MudText Typo="Typo.caption" Color="MudBlazor.Color.Secondary">
                                        Recomendado: 200x60px. Máximo: 512x512px, 2MB. Formatos: PNG, JPG, SVG, WebP
                                    </MudText>
                                    @{
                                        var logoToShow = _previewLogoUrl ?? _model.Branding.LogoUrl;
                                    }
                                    @if (!string.IsNullOrWhiteSpace(logoToShow))
                                    {
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                            <MudImage Src="@logoToShow" Alt="Logo" Height="40" ObjectFit="ObjectFit.Contain" Class="rounded border" />
                                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="MudBlazor.Color.Error" Size="MudBlazor.Size.Small" OnClick="ClearLogoPreview" Title="Remover logo" />
                                            @if (_pendingLogoFile is not null)
                                            {
                                                <MudChip T="string" Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Info">Pendente</MudChip>
                                            }
                                        </MudStack>
                                    }
                                    <MudFileUpload T="IBrowserFile" Accept=".png,.jpg,.jpeg,.svg,.webp" OnFilesChanged="OnLogoFileSelected" MaximumFileCount="1">
                                        <ActivatorContent>
                                            <MudButton Variant="Variant.Outlined" Color="MudBlazor.Color.Primary" StartIcon="@Icons.Material.Filled.CloudUpload" Disabled="_uploadingLogo">
                                                @if (_uploadingLogo)
                                                {
                                                    <MudProgressCircular Size="MudBlazor.Size.Small" Indeterminate="true" Class="mr-2" />
                                                }
                                                Enviar arquivo
                                            </MudButton>
                                        </ActivatorContent>
                                    </MudFileUpload>
                                    <MudTextField @bind-Value="_model.Branding.LogoUrl" Label="ou informe URL" Variant="Variant.Outlined" Placeholder="https://..." />
                                </MudStack>
                            </MudItem>
                            @* Favicon Upload *@
                            <MudItem xs="12" md="6">
                                <MudStack Spacing="2">
                                    <MudText Typo="Typo.subtitle2">Favicon</MudText>
                                    <MudText Typo="Typo.caption" Color="MudBlazor.Color.Secondary">
                                        Recomendado: 32x32px ou 64x64px. Máximo: 128x128px, 512KB. Formatos: PNG, ICO, SVG
                                    </MudText>
                                    @{
                                        var faviconToShow = _previewFaviconUrl ?? _model.Branding.FaviconUrl;
                                    }
                                    @if (!string.IsNullOrWhiteSpace(faviconToShow))
                                    {
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                            <MudImage Src="@faviconToShow" Alt="Favicon" Height="32" Width="32" ObjectFit="ObjectFit.Contain" Class="rounded border" />
                                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="MudBlazor.Color.Error" Size="MudBlazor.Size.Small" OnClick="ClearFaviconPreview" Title="Remover favicon" />
                                            @if (_pendingFaviconFile is not null)
                                            {
                                                <MudChip T="string" Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Info">Pendente</MudChip>
                                            }
                                        </MudStack>
                                    }
                                    <MudFileUpload T="IBrowserFile" Accept=".png,.ico,.svg" OnFilesChanged="OnFaviconFileSelected" MaximumFileCount="1">
                                        <ActivatorContent>
                                            <MudButton Variant="Variant.Outlined" Color="MudBlazor.Color.Primary" StartIcon="@Icons.Material.Filled.CloudUpload" Disabled="_uploadingFavicon">
                                                @if (_uploadingFavicon)
                                                {
                                                    <MudProgressCircular Size="MudBlazor.Size.Small" Indeterminate="true" Class="mr-2" />
                                                }
                                                Enviar arquivo
                                            </MudButton>
                                        </ActivatorContent>
                                    </MudFileUpload>
                                    <MudTextField @bind-Value="_model.Branding.FaviconUrl" Label="ou informe URL" Variant="Variant.Outlined" Placeholder="https://..." />
                                </MudStack>
                            </MudItem>
                            
                            @* Color Pickers *@
                            <MudItem xs="12" md="4">
                                <MudStack Spacing="1">
                                    <MudText Typo="Typo.subtitle2">Cor primária</MudText>
                                    <MudColorPicker Value="_primaryColor"
                                                    Variant="Variant.Outlined"
                                                    ShowAlpha="false"
                                                    DisableToolbar="false"
                                                    PickerVariant="PickerVariant.Inline"
                                                    ColorPickerView="ColorPickerView.Spectrum"
                                                    ValueChanged="OnPrimaryColorChanged" />
                                    @if (_primaryColor is not null)
                                    {
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                            <div style="width: 20px; height: 20px; border-radius: 4px; background-color: @_primaryColor.ToString(MudColorOutputFormats.Hex);"></div>
                                            <MudText Typo="Typo.caption">@_primaryColor.ToString(MudColorOutputFormats.Hex)</MudText>
                                        </MudStack>
                                    }
                                </MudStack>
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudStack Spacing="1">
                                    <MudText Typo="Typo.subtitle2">Cor secundária</MudText>
                                    <MudColorPicker Value="_secondaryColor"
                                                    Variant="Variant.Outlined"
                                                    ShowAlpha="false"
                                                    DisableToolbar="false"
                                                    PickerVariant="PickerVariant.Inline"
                                                    ColorPickerView="ColorPickerView.Spectrum"
                                                    ValueChanged="OnSecondaryColorChanged" />
                                    @if (_secondaryColor is not null)
                                    {
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                            <div style="width: 20px; height: 20px; border-radius: 4px; background-color: @_secondaryColor.ToString(MudColorOutputFormats.Hex);"></div>
                                            <MudText Typo="Typo.caption">@_secondaryColor.ToString(MudColorOutputFormats.Hex)</MudText>
                                        </MudStack>
                                    }
                                </MudStack>
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudStack Spacing="1">
                                    <MudText Typo="Typo.subtitle2">Cor de destaque</MudText>
                                    <MudColorPicker Value="_accentColor"
                                                    Variant="Variant.Outlined"
                                                    ShowAlpha="false"
                                                    DisableToolbar="false"
                                                    PickerVariant="PickerVariant.Inline"
                                                    ColorPickerView="ColorPickerView.Spectrum"
                                                    ValueChanged="OnAccentColorChanged" />
                                    @if (_accentColor is not null)
                                    {
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                            <div style="width: 20px; height: 20px; border-radius: 4px; background-color: @_accentColor.ToString(MudColorOutputFormats.Hex);"></div>
                                            <MudText Typo="Typo.caption">@_accentColor.ToString(MudColorOutputFormats.Hex)</MudText>
                                        </MudStack>
                                    }
                                </MudStack>
                            </MudItem>
                            
                            @* Additional Branding Fields *@
                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="_model.Branding.LoginBackgroundUrl" Label="Fundo da tela de login (URL)" Variant="Variant.Outlined" Placeholder="https://..." />
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudText Typo="Typo.caption" Color="MudBlazor.Color.Secondary" Class="mt-4">
                                    Imagem de fundo exibida na página de login. Recomendado: 1920x1080px.
                                </MudText>
                            </MudItem>
                            <MudItem xs="12">
                                <MudTextField @bind-Value="_model.Branding.EmailFooterHtml" Label="Rodapé de email (HTML)" Variant="Variant.Outlined" Lines="3" HelperText="HTML que será inserido no rodapé dos emails enviados pelo sistema" />
                            </MudItem>
                            <MudItem xs="12">
                            <MudTextField @bind-Value="_model.Branding.CustomCss" Label="CSS customizado" Variant="Variant.Outlined" Lines="4" HelperText="CSS adicional para personalizar o visual. Propriedades permitidas: cores, fontes, bordas, sombras." />
                            </MudItem>
                        </MudGrid>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            </MudStack>
        </MudForm>
    </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Outlined" Disabled="_saving" OnClick="Cancel">Cancelar</MudButton>
        <MudButton Variant="Variant.Filled" Color="MudBlazor.Color.Primary" OnClick="SubmitForm" Disabled="_saving">
            @if (_saving)
            {
                <MudProgressCircular Indeterminate="true" Size="MudBlazor.Size.Small" Class="mr-2" />
            }
            @(IsEdit ? "Salvar alterações" : "Criar tenant")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public TenantDto? Tenant { get; set; }
    [Parameter] public bool IsEdit { get; set; }

    private MudForm? _form;
    private readonly TenantFormModel _model = new();
    private bool _saving;
    private string? _errorMessage;

    // File upload state
    private bool _uploadingLogo;
    private bool _uploadingFavicon;
    
    // Pending file uploads for new tenants
    private IBrowserFile? _pendingLogoFile;
    private IBrowserFile? _pendingFaviconFile;
    private string? _previewLogoUrl;
    private string? _previewFaviconUrl;

    // Color picker state
    private MudColor? _primaryColor;
    private MudColor? _secondaryColor;
    private MudColor? _accentColor;

    protected override void OnInitialized()
    {
        if (Tenant is not null)
        {
            _model.Name = Tenant.Name;
            _model.Slug = Tenant.Slug;
            _model.DocumentNumber = Tenant.DocumentNumber;
            _model.PrimaryContactEmail = Tenant.PrimaryContactEmail;
            _model.PrimaryContactName = Tenant.PrimaryContactName;
            _model.PrimaryContactPhone = Tenant.PrimaryContactPhone;
            _model.Region = Tenant.Region;
            _model.IsDemo = Tenant.IsDemo;
            _model.Status = Tenant.Status;
            _model.Notes = Tenant.Notes;
            if (Tenant.Branding is not null)
            {
                _model.Branding = TenantBrandingModel.FromDto(Tenant.Branding);
                // Initialize color pickers from existing values
                _primaryColor = ParseColor(Tenant.Branding.PrimaryColor);
                _secondaryColor = ParseColor(Tenant.Branding.SecondaryColor);
                _accentColor = ParseColor(Tenant.Branding.AccentColor);
            }
        }
        else
        {
            // Default colors
            _primaryColor = new MudColor("#2563EB");
            _secondaryColor = new MudColor("#64748B");
            _accentColor = new MudColor("#F59E0B");
        }
    }

    private static MudColor? ParseColor(string? hexColor)
    {
        if (string.IsNullOrWhiteSpace(hexColor))
            return null;
        try
        {
            return new MudColor(hexColor);
        }
        catch
        {
            return null;
        }
    }

    private void OnPrimaryColorChanged(MudColor color)
    {
        _primaryColor = color;
        _model.Branding.PrimaryColor = color?.ToString(MudColorOutputFormats.Hex);
    }

    private void OnSecondaryColorChanged(MudColor color)
    {
        _secondaryColor = color;
        _model.Branding.SecondaryColor = color?.ToString(MudColorOutputFormats.Hex);
    }

    private void OnAccentColorChanged(MudColor color)
    {
        _accentColor = color;
        _model.Branding.AccentColor = color?.ToString(MudColorOutputFormats.Hex);
    }

    private async Task OnLogoFileSelected(InputFileChangeEventArgs e)
    {
        if (e.FileCount == 0) return;
        
        var file = e.File;
        
        // Para novos tenants, armazena o arquivo e cria preview
        if (!IsEdit || Tenant is null)
        {
            _pendingLogoFile = file;
            // Cria preview local usando Data URL
            await CreateLocalPreview(file, url => _previewLogoUrl = url);
            return;
        }
        
        await UploadBrandingImage(file, "logo", url => _model.Branding.LogoUrl = url, v => _uploadingLogo = v);
    }

    private async Task OnFaviconFileSelected(InputFileChangeEventArgs e)
    {
        if (e.FileCount == 0) return;
        
        var file = e.File;
        
        // Para novos tenants, armazena o arquivo e cria preview
        if (!IsEdit || Tenant is null)
        {
            _pendingFaviconFile = file;
            // Cria preview local usando Data URL
            await CreateLocalPreview(file, url => _previewFaviconUrl = url);
            return;
        }
        
        await UploadBrandingImage(file, "favicon", url => _model.Branding.FaviconUrl = url, v => _uploadingFavicon = v);
    }

    private async Task CreateLocalPreview(IBrowserFile file, Action<string> setPreviewUrl)
    {
        try
        {
            // Le o arquivo e converte para Data URL para preview local
            var buffer = new byte[file.Size];
            await using var stream = file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
            await stream.ReadExactlyAsync(buffer);
            var base64 = Convert.ToBase64String(buffer);
            var dataUrl = $"data:{file.ContentType};base64,{base64}";
            setPreviewUrl(dataUrl);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao criar preview: {ex.Message}", Severity.Warning);
        }
    }

    private async Task UploadBrandingImage(IBrowserFile file, string imageType, Action<string?> setUrl, Action<bool> setUploading)
    {
        // For new tenants, we need to save first to get an ID
        if (!IsEdit || Tenant is null)
        {
            Snackbar.Add("Salve o tenant primeiro para fazer upload de imagens.", Severity.Warning);
            return;
        }

        setUploading(true);
        StateHasChanged();

        try
        {
            using var content = new MultipartFormDataContent();
            var fileContent = new StreamContent(file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024)); // 5MB
            fileContent.Headers.ContentType = new MediaTypeHeaderValue(file.ContentType);
            content.Add(fileContent, "file", file.Name);

            var response = await ApiService.PostMultipartAsync($"api/tenants/{Tenant.Id}/branding/{imageType}", content);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<BrandingUploadResultDto>();
                if (result?.Success == true)
                {
                    setUrl(result.Url);
                    var message = result.WasResized 
                        ? $"Imagem redimensionada para {result.FinalWidth}×{result.FinalHeight}px e salva!" 
                        : "Imagem salva!";
                    Snackbar.Add(message, Severity.Success);
                }
                else
                {
                    Snackbar.Add(result?.ErrorMessage ?? "Erro ao fazer upload", Severity.Error);
                }
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Erro ao fazer upload: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao fazer upload: {ex.Message}", Severity.Error);
        }
        finally
        {
            setUploading(false);
            StateHasChanged();
        }
    }

    // DTO for upload result
    private record BrandingUploadResultDto(bool Success, string? Url, string? ErrorMessage, bool WasResized, int FinalWidth, int FinalHeight);

    private async Task HandleValidSubmit()
    {
        _errorMessage = null;
        _saving = true;
        try
        {
            if (IsEdit && Tenant is not null)
            {
                var updateDto = new UpdateTenantDto
                {
                    Name = _model.Name,
                    DocumentNumber = _model.DocumentNumber,
                    PrimaryContactName = _model.PrimaryContactName,
                    PrimaryContactEmail = _model.PrimaryContactEmail,
                    PrimaryContactPhone = _model.PrimaryContactPhone,
                    Region = _model.Region,
                    IsDemo = _model.IsDemo,
                    Status = _model.Status,
                    Notes = _model.Notes,
                    Branding = _model.Branding.ToDto()
                };

                var updated = await ApiService.PutAsync<TenantDto>($"api/tenants/{Tenant.Id}", updateDto);
                Snackbar.Add($"Tenant '{updated?.Name ?? _model.Name}' atualizado com sucesso", Severity.Success);
                
                // Notify branding change if this is the current user's tenant
                if (TenantContextAccessor.Current.TenantId == Tenant.Id)
                {
                    BrandingProvider.NotifyBrandingChanged();
                }
                
                MudDialog.Close(DialogResult.Ok(updated));
            }
            else
            {
                var createDto = new CreateTenantDto
                {
                    Name = _model.Name,
                    Slug = _model.Slug?.ToLowerInvariant() ?? string.Empty,
                    DocumentNumber = _model.DocumentNumber,
                    PrimaryContactName = _model.PrimaryContactName,
                    PrimaryContactEmail = _model.PrimaryContactEmail,
                    PrimaryContactPhone = _model.PrimaryContactPhone,
                    Region = _model.Region,
                    IsDemo = _model.IsDemo,
                    Branding = _model.Branding.ToDto()
                };

                var created = await ApiService.PostAsync<TenantDto>("api/tenants", createDto);
                
                // Upload pending images after creating the tenant
                if (created is not null)
                {
                    await UploadPendingImagesAsync(created.Id);
                }
                
                Snackbar.Add($"Tenant '{created?.Name ?? _model.Name}' criado", Severity.Success);
                MudDialog.Close(DialogResult.Ok(created));
            }
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
            Snackbar.Add("Não foi possível salvar o tenant. Verifique os dados e tente novamente.", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task UploadPendingImagesAsync(int tenantId)
    {
        // Upload pending logo
        if (_pendingLogoFile is not null)
        {
            try
            {
                using var content = new MultipartFormDataContent();
                var fileContent = new StreamContent(_pendingLogoFile.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024));
                fileContent.Headers.ContentType = new MediaTypeHeaderValue(_pendingLogoFile.ContentType);
                content.Add(fileContent, "file", _pendingLogoFile.Name);

                var response = await ApiService.PostMultipartAsync($"api/tenants/{tenantId}/branding/logo", content);
                if (response.IsSuccessStatusCode)
                {
                    Snackbar.Add("Logo enviado com sucesso", Severity.Success);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro ao enviar logo: {ex.Message}", Severity.Warning);
            }
        }

        // Upload pending favicon
        if (_pendingFaviconFile is not null)
        {
            try
            {
                using var content = new MultipartFormDataContent();
                var fileContent = new StreamContent(_pendingFaviconFile.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024));
                fileContent.Headers.ContentType = new MediaTypeHeaderValue(_pendingFaviconFile.ContentType);
                content.Add(fileContent, "file", _pendingFaviconFile.Name);

                var response = await ApiService.PostMultipartAsync($"api/tenants/{tenantId}/branding/favicon", content);
                if (response.IsSuccessStatusCode)
                {
                    Snackbar.Add("Favicon enviado com sucesso", Severity.Success);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro ao enviar favicon: {ex.Message}", Severity.Warning);
            }
        }
    }

    private void ClearLogoPreview()
    {
        _pendingLogoFile = null;
        _previewLogoUrl = null;
        _model.Branding.LogoUrl = null;
    }

    private void ClearFaviconPreview()
    {
        _pendingFaviconFile = null;
        _previewFaviconUrl = null;
        _model.Branding.FaviconUrl = null;
    }

    private async Task SubmitForm()
    {
        if (_form is null) return;
        await _form.Validate();
        if (_form.IsValid)
        {
            await HandleValidSubmit();
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private static string GetStatusLabel(TenantStatus status) => status switch
    {
        TenantStatus.Active => "Ativo",
        TenantStatus.Provisioning => "Provisionando",
        TenantStatus.Suspended => "Suspenso",
        TenantStatus.Disabled => "Desativado",
        TenantStatus.Archived => "Arquivado",
        _ => status.ToString()
    };

    private class TenantFormModel
    {
        [Required]
        [MaxLength(200)]
        public string Name { get; set; } = string.Empty;

        [Required]
        [MaxLength(64)]
        [RegularExpression("^[a-z0-9-]+$", ErrorMessage = "Use apenas letras minúsculas, números e hífen")]
        public string Slug { get; set; } = string.Empty;

        [MaxLength(20)]
        public string? DocumentNumber { get; set; }

        [MaxLength(200)]
        [EmailAddress]
        public string? PrimaryContactEmail { get; set; }

        [MaxLength(200)]
        public string? PrimaryContactName { get; set; }

        [MaxLength(20)]
        public string? PrimaryContactPhone { get; set; }

        [MaxLength(200)]
        public string? Region { get; set; }

        public bool IsDemo { get; set; }
        public TenantStatus Status { get; set; } = TenantStatus.Provisioning;
        public string? Notes { get; set; }

        public TenantBrandingModel Branding { get; set; } = new();
    }

    private class TenantBrandingModel
    {
        public string? LogoUrl { get; set; }
        public string? FaviconUrl { get; set; }
        public string? PrimaryColor { get; set; }
        public string? SecondaryColor { get; set; }
        public string? AccentColor { get; set; }
        public string? LoginBackgroundUrl { get; set; }
        public string? EmailFooterHtml { get; set; }
        public string? CustomCss { get; set; }

        public TenantBrandingDto? ToDto()
        {
            if (string.IsNullOrWhiteSpace(LogoUrl) &&
                string.IsNullOrWhiteSpace(FaviconUrl) &&
                string.IsNullOrWhiteSpace(PrimaryColor) &&
                string.IsNullOrWhiteSpace(SecondaryColor) &&
                string.IsNullOrWhiteSpace(AccentColor) &&
                string.IsNullOrWhiteSpace(LoginBackgroundUrl) &&
                string.IsNullOrWhiteSpace(EmailFooterHtml) &&
                string.IsNullOrWhiteSpace(CustomCss))
            {
                return null;
            }

            return new TenantBrandingDto(
                LogoUrl,
                FaviconUrl,
                PrimaryColor,
                SecondaryColor,
                AccentColor,
                LoginBackgroundUrl,
                EmailFooterHtml,
                CustomCss);
        }

        public static TenantBrandingModel FromDto(TenantBrandingDto dto) => new()
        {
            LogoUrl = dto.LogoUrl,
            FaviconUrl = dto.FaviconUrl,
            PrimaryColor = dto.PrimaryColor,
            SecondaryColor = dto.SecondaryColor,
            AccentColor = dto.AccentColor,
            LoginBackgroundUrl = dto.LoginBackgroundUrl,
            EmailFooterHtml = dto.EmailFooterHtml,
            CustomCss = dto.CustomCss
        };
    }
}
