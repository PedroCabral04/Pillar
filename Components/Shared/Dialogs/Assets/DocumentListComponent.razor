@using erp.DTOs.Assets
@using erp.Services
@using erp.Models
@using MudBlazor
@using Size = MudBlazor.Size
@using Color = MudBlazor.Color
@inject IApiService ApiService
@inject ISnackbar Snackbar
@inject ILogger<DocumentListComponent> Logger
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime

<MudPaper Elevation="2" Class="pa-4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Description" Class="mr-2"/>
            Documentos
        </MudText>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled" 
                   Size="Size.Small"
                   StartIcon="@Icons.Material.Filled.CloudUpload"
                   OnClick="OpenUploadDialog">
            Adicionar Documento
        </MudButton>
    </MudStack>

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary"/>
    }
    else if (_documents.Count == 0)
    {
        <MudAlert Severity="Severity.Info" Dense="true">
            Nenhum documento anexado a este ativo.
        </MudAlert>
    }
    else
    {
        <!-- Document Type Tabs -->
        <MudTabs Elevation="0" Color="Color.Primary" @bind-ActivePanelIndex="_activeTab" Class="mb-3">
            <MudTabPanel Text="Todos" BadgeData="@_documents.Count">
                @DocumentTable(_documents)
            </MudTabPanel>
            <MudTabPanel Text="Notas Fiscais" BadgeData="@GetDocumentCountByType(AssetDocumentType.Invoice)">
                @DocumentTable(_documents.Where(d => d.Type == AssetDocumentType.Invoice).ToList())
            </MudTabPanel>
            <MudTabPanel Text="Manuais" BadgeData="@GetDocumentCountByType(AssetDocumentType.Manual)">
                @DocumentTable(_documents.Where(d => d.Type == AssetDocumentType.Manual).ToList())
            </MudTabPanel>
            <MudTabPanel Text="Garantias" BadgeData="@GetDocumentCountByType(AssetDocumentType.Warranty)">
                @DocumentTable(_documents.Where(d => d.Type == AssetDocumentType.Warranty).ToList())
            </MudTabPanel>
            <MudTabPanel Text="Fotos" BadgeData="@GetDocumentCountByType(AssetDocumentType.Photo)">
                @DocumentTable(_documents.Where(d => d.Type == AssetDocumentType.Photo).ToList())
            </MudTabPanel>
            <MudTabPanel Text="Outros" BadgeData="@GetDocumentCountByType(AssetDocumentType.Other)">
                @DocumentTable(_documents.Where(d => d.Type == AssetDocumentType.Other).ToList())
            </MudTabPanel>
        </MudTabs>
    }
</MudPaper>

@code {
    [Parameter] public int AssetId { get; set; }
    [Parameter] public EventCallback OnDocumentChanged { get; set; }

    private List<AssetDocumentDto> _documents = new();
    private bool _loading = false;
    private int _activeTab = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadDocuments();
    }

    private async Task LoadDocuments()
    {
        _loading = true;
        try
        {
            _documents = await ApiService.GetAsync<List<AssetDocumentDto>>($"/api/assets/{AssetId}/documents") ?? new();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erro ao carregar documentos do ativo {AssetId}", AssetId);
            Snackbar.Add("Erro ao carregar documentos", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OpenUploadDialog()
    {
        var parameters = new DialogParameters<DocumentUploadDialog>
        {
            { x => x.AssetId, AssetId }
        };

        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = false,
            CloseOnEscapeKey = true 
        };

        var dialog = await DialogService.ShowAsync<DocumentUploadDialog>("Upload de Documento", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            await LoadDocuments();
            await OnDocumentChanged.InvokeAsync();
        }
    }

    private async Task DownloadDocument(AssetDocumentDto document)
    {
        try
        {
            var url = $"/api/assets/{AssetId}/documents/{document.Id}/download";
            await JSRuntime.InvokeVoidAsync("open", url, "_blank");
            Snackbar.Add("Download iniciado", Severity.Success);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erro ao fazer download do documento {DocumentId}", document.Id);
            Snackbar.Add("Erro ao fazer download", Severity.Error);
        }
    }

    private async Task DeleteDocument(AssetDocumentDto document)
    {
        var parameters = new DialogParameters
        {
            { "ContentText", $"Tem certeza que deseja excluir o documento '{document.OriginalFileName}'?" },
            { "ButtonText", "Excluir" },
            { "Color", Color.Error }
        };

        var optionsConfirm = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Confirmar Exclusão", parameters, optionsConfirm);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            try
            {
                await ApiService.DeleteAsync($"/api/assets/documents/{document.Id}");
                Snackbar.Add("Documento excluído com sucesso", Severity.Success);
                await LoadDocuments();
                await OnDocumentChanged.InvokeAsync();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Erro ao excluir documento {DocumentId}", document.Id);
                Snackbar.Add("Erro ao excluir documento", Severity.Error);
            }
        }
    }

    private int GetDocumentCountByType(AssetDocumentType type)
    {
        return _documents.Count(d => d.Type == type);
    }

    // Inner component for document table
    private RenderFragment<List<AssetDocumentDto>> DocumentTable => documents => __builder =>
    {
        if (documents.Count == 0)
        {
            <MudAlert Severity="Severity.Info" Dense="true">
                Nenhum documento deste tipo.
            </MudAlert>
        }
        else
        {
            <MudTable Items="@documents" Dense="true" Hover="true" Striped="true">
                <HeaderContent>
                    <MudTh>Arquivo</MudTh>
                    <MudTh>Tipo</MudTh>
                    <MudTh>Descrição</MudTh>
                    <MudTh>Data</MudTh>
                    <MudTh>Enviado por</MudTh>
                    <MudTh Style="text-align: center">Ações</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Arquivo">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@GetFileIcon(context.ContentType)" Color="Color.Primary" Size="Size.Small"/>
                            <div>
                                <MudText Typo="Typo.body2">@context.OriginalFileName</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @FormatFileSize(context.FileSize)
                                </MudText>
                            </div>
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="Tipo">
                        <MudChip T="string" Size="Size.Small" Color="@GetDocumentTypeColor(context.Type)">
                            @GetDocumentTypeText(context.Type)
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Descrição">
                        <MudText Typo="Typo.body2">@(context.Description ?? "-")</MudText>
                        @if (!string.IsNullOrEmpty(context.DocumentNumber))
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Nº @context.DocumentNumber</MudText>
                        }
                        @if (context.ExpiryDate.HasValue)
                        {
                            var isExpired = context.ExpiryDate.Value < DateTime.UtcNow;
                            <MudText Typo="Typo.caption" Color="@(isExpired ? Color.Error : Color.Warning)">
                                @(isExpired ? "Vencido" : "Vence") em @context.ExpiryDate.Value.ToString("dd/MM/yyyy")
                            </MudText>
                        }
                    </MudTd>
                    <MudTd DataLabel="Data">
                        @if (context.DocumentDate.HasValue)
                        {
                            <MudText Typo="Typo.body2">@context.DocumentDate.Value.ToString("dd/MM/yyyy")</MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">-</MudText>
                        }
                    </MudTd>
                    <MudTd DataLabel="Enviado por">
                        <MudText Typo="Typo.body2">@context.UploadedByUserName</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            @context.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                        </MudText>
                    </MudTd>
                    <MudTd DataLabel="Ações" Style="text-align: center">
                        <MudIconButton Icon="@Icons.Material.Filled.Download" 
                                       Size="Size.Small"
                                       Color="Color.Primary"
                                       OnClick="@(() => DownloadDocument(context))"
                                       Title="Baixar"/>
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                       Size="Size.Small" 
                                       Color="Color.Error"
                                       OnClick="@(() => DeleteDocument(context))"
                                       Title="Excluir"/>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    };

    private string GetFileIcon(string contentType) => contentType switch
    {
        var ct when ct.Contains("pdf") => Icons.Material.Filled.PictureAsPdf,
        var ct when ct.Contains("word") || ct.Contains("document") => Icons.Material.Filled.Description,
        var ct when ct.Contains("image") => Icons.Material.Filled.Image,
        var ct when ct.Contains("excel") || ct.Contains("spreadsheet") => Icons.Material.Filled.TableChart,
        _ => Icons.Material.Filled.InsertDriveFile
    };

    private Color GetDocumentTypeColor(AssetDocumentType type) => type switch
    {
        AssetDocumentType.Invoice => Color.Success,
        AssetDocumentType.Manual => Color.Info,
        AssetDocumentType.Warranty => Color.Warning,
        AssetDocumentType.Certificate => Color.Primary,
        AssetDocumentType.Photo => Color.Secondary,
        AssetDocumentType.Contract => Color.Tertiary,
        _ => Color.Default
    };

    private string GetDocumentTypeText(AssetDocumentType type) => type switch
    {
        AssetDocumentType.Invoice => "Nota Fiscal",
        AssetDocumentType.Manual => "Manual",
        AssetDocumentType.Warranty => "Garantia",
        AssetDocumentType.Certificate => "Certificado",
        AssetDocumentType.Photo => "Foto",
        AssetDocumentType.Contract => "Contrato",
        AssetDocumentType.Other => "Outro",
        _ => type.ToString()
    };

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
}
