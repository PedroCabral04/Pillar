@using erp.DTOs.Financial
@using MudBlazor

<MudDialog>
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.LocalShipping" Color="MudBlazor.Color.Primary" Size="MudBlazor.Size.Large" />
            <MudText Typo="Typo.h6">@(string.IsNullOrEmpty(Model.Name) ? "Novo Fornecedor" : "Editar Fornecedor")</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="form" @bind-IsValid="@success" Class="pa-2">
            <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4" Style="min-height: 420px;" Color="MudBlazor.Color.Primary">
                <MudTabPanel Text="Dados Gerais" Icon="@Icons.Material.Filled.Business">
                    <MudGrid Spacing="3">
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="Model.Name" 
                                          Label="Razão Social" 
                                          Required="true" 
                                          RequiredError="Razão Social é obrigatória" 
                                          Variant="Variant.Outlined"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Business"/>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="Model.TradeName" 
                                          Label="Nome Fantasia" 
                                          Variant="Variant.Outlined"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Store"/>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="Model.TaxId" 
                                          Label="CNPJ/CPF" 
                                          Required="true" 
                                          RequiredError="CNPJ/CPF é obrigatório" 
                                          Variant="Variant.Outlined"
                                          Placeholder="00.000.000/0000-00"
                                          Mask="@_cnpjMask"
                                          Validation="@(new Func<string, string?>(ValidateTaxId))"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Badge"/>
                        </MudItem>
                        <MudItem xs="12" sm="3">
                            <MudTextField @bind-Value="Model.StateRegistration" 
                                          Label="Inscrição Estadual" 
                                          Variant="Variant.Outlined"/>
                        </MudItem>
                        <MudItem xs="12" sm="3">
                            <MudTextField @bind-Value="Model.MunicipalRegistration" 
                                          Label="Inscrição Municipal" 
                                          Variant="Variant.Outlined"/>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="Model.Email" 
                                          Label="Email" 
                                          InputType="InputType.Email" 
                                          Variant="Variant.Outlined"
                                          Placeholder="contato@empresa.com.br"
                                          Validation="@(new Func<string, string?>(ValidateEmail))"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Email"/>
                        </MudItem>
                        <MudItem xs="12" sm="3">
                            <MudTextField @bind-Value="Model.Phone" 
                                          Label="Telefone" 
                                          Variant="Variant.Outlined"
                                          Placeholder="(00) 0000-0000"
                                          Mask="@_phoneMask"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Phone"/>
                        </MudItem>
                        <MudItem xs="12" sm="3">
                            <MudTextField @bind-Value="Model.MobilePhone" 
                                          Label="Celular" 
                                          Variant="Variant.Outlined"
                                          Placeholder="(00) 00000-0000"
                                          Mask="@_mobileMask"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.PhoneAndroid"/>
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField @bind-Value="Model.Website" 
                                          Label="Website" 
                                          Variant="Variant.Outlined"
                                          Placeholder="https://www.empresa.com.br"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Language"/>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>
                <MudTabPanel Text="Endereço" Icon="@Icons.Material.Filled.LocationOn">
                    <MudGrid Spacing="3">
                        <MudItem xs="12" sm="4">
                            <MudTextField @bind-Value="Model.ZipCode" 
                                          Label="CEP" 
                                          Variant="Variant.Outlined"
                                          Placeholder="00000-000"
                                          Mask="@_cepMask"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.LocationOn"/>
                        </MudItem>
                        <MudItem xs="12" sm="8">
                            <MudTextField @bind-Value="Model.Street" 
                                          Label="Logradouro" 
                                          Variant="Variant.Outlined"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Home"/>
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudTextField @bind-Value="Model.Number" 
                                          Label="Número" 
                                          Variant="Variant.Outlined"/>
                        </MudItem>
                        <MudItem xs="12" sm="8">
                            <MudTextField @bind-Value="Model.Complement" 
                                          Label="Complemento" 
                                          Variant="Variant.Outlined"/>
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudTextField @bind-Value="Model.District" 
                                          Label="Bairro" 
                                          Variant="Variant.Outlined"/>
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudTextField @bind-Value="Model.City" 
                                          Label="Cidade" 
                                          Variant="Variant.Outlined"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.LocationCity"/>
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudTextField @bind-Value="Model.State" 
                                          Label="Estado" 
                                          Variant="Variant.Outlined"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Map"/>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>
                <MudTabPanel Text="Financeiro" Icon="@Icons.Material.Filled.AttachMoney">
                    <MudGrid Spacing="3">
                        <MudItem xs="12" sm="6">
                            <MudSelect T="int?" @bind-Value="Model.CategoryId"
                                       Label="Categoria"
                                       Variant="Variant.Outlined"
                                       Adornment="Adornment.Start"
                                       AdornmentIcon="@Icons.Material.Filled.Category"
                                       Dense="true">
                                @if (_categories != null)
                                {
                                    @foreach (var cat in _categories)
                                    {
                                        <MudSelectItem T="int?" Value="@cat.Id">@cat.Name</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="Model.PaymentMethod" 
                                          Label="Método de Pagamento Padrão" 
                                          Variant="Variant.Outlined"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Payment"/>
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudNumericField @bind-Value="Model.PaymentTermDays" 
                                             Label="Prazo de Pagamento (dias)" 
                                             Min="0" 
                                             Variant="Variant.Outlined"
                                             Adornment="Adornment.Start"
                                             AdornmentIcon="@Icons.Material.Filled.CalendarMonth"/>
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudNumericField @bind-Value="Model.DeliveryLeadTimeDays" 
                                             Label="Prazo de Entrega (dias)" 
                                             Min="0" 
                                             Variant="Variant.Outlined"
                                             Adornment="Adornment.Start"
                                             AdornmentIcon="@Icons.Material.Filled.LocalShipping"/>
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudNumericField @bind-Value="Model.MinimumOrderValue" 
                                             Label="Pedido Mínimo" 
                                             Format="C2" 
                                             Variant="Variant.Outlined"
                                             Adornment="Adornment.Start"
                                             AdornmentIcon="@Icons.Material.Filled.AttachMoney"/>
                        </MudItem>
                        <MudItem xs="12">
                            <MudCheckBox @bind-Value="Model.IsPreferred" 
                                         Label="Fornecedor Preferencial" 
                                         Color="MudBlazor.Color.Primary" />
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>
                <MudTabPanel Text="Observações" Icon="@Icons.Material.Filled.Notes">
                    <MudGrid Spacing="3">
                        <MudItem xs="12">
                            <MudTextField @bind-Value="Model.Notes" 
                                          Label="Observações" 
                                          Lines="5" 
                                          Variant="Variant.Outlined"
                                          HelperText="Anotações internas sobre o fornecedor"/>
                        </MudItem>
                        <MudItem xs="12">
                            <MudSwitch @bind-Value="Model.IsActive" 
                                       Label="Fornecedor Ativo" 
                                       Color="MudBlazor.Color.Success" />
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>
            </MudTabs>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" 
                   Variant="Variant.Text"
                   StartIcon="@Icons.Material.Filled.Close"
                   Disabled="@_saving">
            Cancelar
        </MudButton>
        <MudButton Color="MudBlazor.Color.Primary" 
                   Variant="Variant.Filled" 
                   OnClick="Submit"
                   Disabled="@_saving"
                   StartIcon="@(_saving ? null : Icons.Material.Filled.Save)">
            @if (_saving)
            {
                <MudProgressCircular Size="MudBlazor.Size.Small" Indeterminate="true" Class="mr-2"/>
                <text>Salvando...</text>
            }
            else
            {
                <text>Salvar Fornecedor</text>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public CreateSupplierDto Model { get; set; } = new() { Name = "", TaxId = "" };
    [Inject] private HttpClient HttpClient { get; set; } = null!;
    [Inject] private ISnackbar Snackbar { get; set; } = null!;

    private MudForm form = null!;
    private bool success;
    private bool _saving = false;
    private List<FinancialCategoryDto>? _categories;

    // Máscaras de entrada
    private PatternMask _cnpjMask = new PatternMask("00.000.000/0000-00");
    private PatternMask _cpfMask = new PatternMask("000.000.000-00");
    private PatternMask _phoneMask = new PatternMask("(00) 0000-0000");
    private PatternMask _mobileMask = new PatternMask("(00) 00000-0000");
    private PatternMask _cepMask = new PatternMask("00000-000");

    protected override async Task OnInitializedAsync()
    {
        await LoadCategoriesAsync();
    }

    private async Task LoadCategoriesAsync()
    {
        try
        {
            var response = await HttpClient.GetFromJsonAsync<List<FinancialCategoryDto>>("api/financial-categories");
            _categories = response?.Where(c => c.IsActive).ToList() ?? new List<FinancialCategoryDto>();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar categorias: {ex.Message}", Severity.Error);
            _categories = new List<FinancialCategoryDto>();
        }
    }

    private string? ValidateTaxId(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return null; // Required validation handled separately
        
        var digits = new string(value.Where(char.IsDigit).ToArray());
        
        if (digits.Length == 11)
        {
            // Validate CPF
            if (!ValidateCpf(digits))
                return "CPF inválido";
        }
        else if (digits.Length == 14)
        {
            // Validate CNPJ
            if (!ValidateCnpj(digits))
                return "CNPJ inválido";
        }
        else if (digits.Length > 0)
        {
            return "CNPJ deve ter 14 dígitos ou CPF deve ter 11 dígitos";
        }
        
        return null;
    }
    
    private bool ValidateCpf(string cpf)
    {
        if (cpf.Distinct().Count() == 1) return false;
        
        int[] mult1 = { 10, 9, 8, 7, 6, 5, 4, 3, 2 };
        int[] mult2 = { 11, 10, 9, 8, 7, 6, 5, 4, 3, 2 };
        
        var tempCpf = cpf.Substring(0, 9);
        var sum = tempCpf.Select((c, i) => (c - '0') * mult1[i]).Sum();
        var rest = sum % 11;
        var digit = rest < 2 ? 0 : 11 - rest;
        
        tempCpf += digit;
        sum = tempCpf.Select((c, i) => (c - '0') * mult2[i]).Sum();
        rest = sum % 11;
        digit = rest < 2 ? 0 : 11 - rest;
        
        return cpf.EndsWith(tempCpf.Substring(9) + digit.ToString());
    }
    
    private bool ValidateCnpj(string cnpj)
    {
        if (cnpj.Distinct().Count() == 1) return false;
        
        int[] mult1 = { 5, 4, 3, 2, 9, 8, 7, 6, 5, 4, 3, 2 };
        int[] mult2 = { 6, 5, 4, 3, 2, 9, 8, 7, 6, 5, 4, 3, 2 };
        
        var tempCnpj = cnpj.Substring(0, 12);
        var sum = tempCnpj.Select((c, i) => (c - '0') * mult1[i]).Sum();
        var rest = sum % 11;
        var digit = rest < 2 ? 0 : 11 - rest;
        
        tempCnpj += digit;
        sum = tempCnpj.Select((c, i) => (c - '0') * mult2[i]).Sum();
        rest = sum % 11;
        digit = rest < 2 ? 0 : 11 - rest;
        
        return cnpj.EndsWith(tempCnpj.Substring(12) + digit.ToString());
    }
    
    private string? ValidateEmail(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return null; // Email is optional
        
        try
        {
            var addr = new System.Net.Mail.MailAddress(value);
            return addr.Address == value ? null : "Email inválido";
        }
        catch
        {
            return "Email inválido";
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task Submit()
    {
        await form.Validate();
        if (success)
        {
            _saving = true;
            StateHasChanged();
            
            await Task.Delay(100);
            
            MudDialog.Close(DialogResult.Ok(Model));
        }
    }
}
