@using MudBlazor
@inject ISnackbar Snackbar;
@inject IApiService ApiService;
@inject ILogger<UserCreateDialog> Logger;
@using System.ComponentModel.DataAnnotations
@using erp.DTOs.User
@using erp.DTOs.Role
@using erp.Services
@using erp.Services.Validation
@inject IUserValidationService ValidationService

<MudDialog Class="user-dialog">
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.PersonAdd" Color="MudBlazor.Color.Primary" Size="MudBlazor.Size.Large" />
            <MudText Typo="Typo.h6">Adicionar Novo Usuário</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        @if (_loading)
        {
            <MudStack AlignItems="AlignItems.Center" Spacing="3" Class="pa-6">
                <MudProgressCircular Color="MudBlazor.Color.Primary" Indeterminate="true" Size="MudBlazor.Size.Large" />
                <MudText Typo="Typo.body1" Color="MudBlazor.Color.Secondary">Carregando permissões...</MudText>
            </MudStack>
        }
        else if (_loadError != null)
        {
            <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Icon="@Icons.Material.Filled.Error">
                @_loadError
            </MudAlert>
        }
        else
        {
            <MudForm @ref="_form" Class="pa-2">
                <MudText Typo="Typo.subtitle2" Color="MudBlazor.Color.Primary" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Badge" Size="MudBlazor.Size.Small" Class="mr-1" />
                    Informações Pessoais
                </MudText>
                
                <MudGrid Spacing="3">
                    <MudItem xs="12">
                        <MudTextField T="string" 
                                      Label="Nome completo" 
                                      Variant="Variant.Outlined" 
                                      InputType="InputType.Text"
                                      @bind-Value="_newUser.Username"
                                      Validation="@(ValidateUsernameAsync)"
                                      Immediate="true"
                                      Debounce="500"
                                      HelperText="@_usernameHelperText"
                                      HelperTextOnFocus="true"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@_usernameIcon"
                                      AdornmentColor="@_usernameAdornmentColor"/>
                    </MudItem>
                    
                    <MudItem xs="12" md="6">
                        <MudTextField T="string" 
                                      Label="E-mail" 
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Email"
                                      @bind-Value="_newUser.Email"
                                      Validation="@(ValidateEmailAsync)"
                                      Immediate="true"
                                      Debounce="500"
                                      HelperText="@_emailHelperText"
                                      HelperTextOnFocus="true"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@_emailIcon"
                                      AdornmentColor="@_emailAdornmentColor"/>
                    </MudItem>
                    
                    <MudItem xs="12" md="6">
                        <MudTextField T="string" 
                                      Label="Telefone" 
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Telephone"
                                      Placeholder="(00) 00000-0000" 
                                      Mask="@(new PatternMask("(00) 00000-0000"))"
                                      @bind-Value="_newUser.Phone"
                                      Validation="@(_phoneRules)"
                                      Immediate="true"
                                      HelperText="Com DDD"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Phone"/>
                    </MudItem>
                    
                    <MudItem xs="12" md="6">
                        <MudTextField T="string" 
                                      Label="CPF" 
                                      Variant="Variant.Outlined"
                                      Placeholder="000.000.000-00"
                                      Mask="@(new PatternMask("000.000.000-00"))"
                                      @bind-Value="_newUser.Cpf"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Badge"/>
                    </MudItem>
                    
                    <MudItem xs="12" md="6">
                        <MudDatePicker T="DateTime?" 
                                       Label="Data de Nascimento"
                                       @bind-Date="_newUser.DateOfBirth"
                                       Variant="Variant.Outlined"
                                       Adornment="Adornment.Start"
                                       AdornmentIcon="@Icons.Material.Filled.Cake"/>
                    </MudItem>
                </MudGrid>

                <MudDivider Class="my-4" />

                <MudText Typo="Typo.subtitle2" Color="MudBlazor.Color.Primary" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Work" Size="MudBlazor.Size.Small" Class="mr-1" />
                    Informações Profissionais
                </MudText>

                <MudGrid Spacing="3">
                    <MudItem xs="12" md="6">
                        <MudSelect T="int?" 
                                   @bind-Value="_newUser.DepartmentId"
                                   Label="Departamento"
                                   Variant="Variant.Outlined"
                                   Clearable="true"
                                   Adornment="Adornment.Start"
                                   AdornmentIcon="@Icons.Material.Filled.BusinessCenter">
                            @foreach (var dept in _departmentsList)
                            {
                                <MudSelectItem T="int?" Value="@dept.Id">@dept.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    
                    <MudItem xs="12" md="6">
                        <MudSelect T="int?" 
                                   @bind-Value="_newUser.PositionId"
                                   Label="Cargo"
                                   Variant="Variant.Outlined"
                                   Clearable="true"
                                   Adornment="Adornment.Start"
                                   AdornmentIcon="@Icons.Material.Filled.WorkOutline">
                            @foreach (var pos in _positionsList)
                            {
                                <MudSelectItem T="int?" Value="@pos.Id">@pos.Title</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    
                    <MudItem xs="12" md="6">
                        <MudDatePicker T="DateTime?" 
                                       Label="Data de Admissão"
                                       @bind-Date="_newUser.HireDate"
                                       Variant="Variant.Outlined"
                                       Adornment="Adornment.Start"
                                       AdornmentIcon="@Icons.Material.Filled.Event"/>
                    </MudItem>
                    
                    <MudItem xs="12" md="6">
                        <MudNumericField T="decimal?" 
                                         Label="Salário"
                                         @bind-Value="_newUser.Salary"
                                         Variant="Variant.Outlined"
                                         Format="C2"
                                         Culture="@(new System.Globalization.CultureInfo("pt-BR"))"
                                         Adornment="Adornment.Start"
                                         AdornmentIcon="@Icons.Material.Filled.AttachMoney"/>
                    </MudItem>
                </MudGrid>

                <MudDivider Class="my-4" />

                <MudText Typo="Typo.subtitle2" Color="MudBlazor.Color.Primary" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Security" Size="MudBlazor.Size.Small" Class="mr-1" />
                    Permissões de Acesso
                </MudText>

                <MudSelect T="@RoleDto" 
                           @bind-SelectedValues="_selectedRoles" 
                           Label="Funções/Permissões" 
                           MultiSelection="true"
                           Variant="Variant.Outlined" 
                           Required="true"
                           RequiredError="Selecione pelo menos uma permissão" 
                           SelectAll="true" 
                           SelectAllText="Selecionar todas"
                           Adornment="Adornment.Start"
                           AdornmentIcon="@Icons.Material.Filled.AdminPanelSettings"
                           HelperText="Selecione uma ou mais funções para o usuário"
                           Immediate="true">
                    @foreach (var roleOption in _rolesList)
                    {
                        <MudSelectItem T="@RoleDto" Value="@roleOption">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@GetRoleIcon(roleOption.Name)" Size="MudBlazor.Size.Small" />
                                <div>
                                    <MudText Typo="Typo.body2">@roleOption.Name</MudText>
                                    <MudText Typo="Typo.caption" Color="MudBlazor.Color.Secondary">@GetRoleDescription(roleOption.Name)</MudText>
                                </div>
                            </MudStack>
                        </MudSelectItem>
                    }
                </MudSelect>

                @if (_selectedRoles.Any())
                {
                    <MudChipSet T="string" Class="mt-2">
                        @foreach (var role in _selectedRoles)
                        {
                            <MudChip T="string" 
                                     Text="@role.Name" 
                                     Color="MudBlazor.Color.Primary" 
                                     Variant="Variant.Filled"
                                     Size="MudBlazor.Size.Small"
                                     Icon="@GetRoleIcon(role.Name)" />
                        }
                    </MudChipSet>
                }
            </MudForm>
        }
    </DialogContent>
    <DialogActions>
        <MudButton Color="MudBlazor.Color.Default" 
                   Variant="Variant.Text" 
                   OnClick="@Cancel"
                   StartIcon="@Icons.Material.Filled.Close">
            Cancelar
        </MudButton>
        <MudButton Color="MudBlazor.Color.Primary" 
                   Variant="Variant.Filled" 
                   OnClick="@CreateUser" 
                   Disabled="@(_loading || _submitting || _loadError != null)"
                   StartIcon="@(_submitting ? null : Icons.Material.Filled.Check)">
            @if (_submitting)
            {
                <MudProgressCircular Class="mr-2" Size="MudBlazor.Size.Small" Indeterminate="true"/>
                <span>Criando usuário...</span>
            }
            else
            {
                <span>Adicionar Usuário</span>
            }
        </MudButton>       
    </DialogActions>
</MudDialog>

@implements IDisposable

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    private CreateUserDto _newUser = new() { RoleIds = new List<int>() };
    private IEnumerable<RoleDto> _selectedRoles = new List<RoleDto>();
    private List<RoleDto> _rolesList = new List<RoleDto>();
    private List<DepartmentDto> _departmentsList = new List<DepartmentDto>();
    private List<PositionDto> _positionsList = new List<PositionDto>();
    
    private bool _loading = true;
    private bool _submitting = false;
    private string? _loadError;
    private MudForm? _form;

    // Estados de validação assíncrona
    private string _usernameHelperText = "Mínimo 3 caracteres";
    private string _emailHelperText = "exemplo@empresa.com";
    private string _usernameIcon = Icons.Material.Filled.Person;
    private string _emailIcon = Icons.Material.Filled.Email;
    private MudBlazor.Color _usernameAdornmentColor = MudBlazor.Color.Default;
    private MudBlazor.Color _emailAdornmentColor = MudBlazor.Color.Default;
    
    private System.Threading.CancellationTokenSource? _usernameValidationCts;
    private System.Threading.CancellationTokenSource? _emailValidationCts;
    private System.Threading.Timer? _usernameDebounceTimer;
    private System.Threading.Timer? _emailDebounceTimer;
    private const int DebounceDelayMs = 500;

    // Regras de validação do formulário (client-side)
    private Func<string, string?> _required(string fieldName) =>
        v => string.IsNullOrWhiteSpace(v) ? $"{fieldName} é obrigatório" : null;

    private static string OnlyDigits(string? s) => new string((s ?? string.Empty).Where(char.IsDigit).ToArray());
    private IEnumerable<Func<string, string?>> _phoneRules => new List<Func<string, string?>>
    {
        _required("Telefone"),
        v =>
        {
            var digits = OnlyDigits(v);
            return (digits.Length is < 10 or > 11) ? "Telefone deve conter DDD + número (10 ou 11 dígitos)" : null;
        }
    };

    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(
            LoadRolesAsync(),
            LoadDepartmentsAsync(),
            LoadPositionsAsync()
        );
        _loading = false;
    }
    
    private void Cancel() => MudDialog.Cancel();

    /// <summary>
    /// Validação assíncrona do username com feedback visual e debounce
    /// </summary>
    private async Task<string?> ValidateUsernameAsync(string username)
    {
        // Validações básicas síncronas
        if (string.IsNullOrWhiteSpace(username))
        {
            _usernameHelperText = "Nome é obrigatório";
            _usernameIcon = Icons.Material.Filled.Person;
            _usernameAdornmentColor = MudBlazor.Color.Default;
            return "Nome é obrigatório";
        }

        if (username.Trim().Length < 3)
        {
            _usernameHelperText = "Nome deve ter pelo menos 3 caracteres";
            _usernameIcon = Icons.Material.Filled.Warning;
            _usernameAdornmentColor = MudBlazor.Color.Warning;
            return "Nome deve ter pelo menos 3 caracteres";
        }

        if (username.Trim().Length > 50)
        {
            _usernameHelperText = "Nome não pode exceder 50 caracteres";
            _usernameIcon = Icons.Material.Filled.Warning;
            _usernameAdornmentColor = MudBlazor.Color.Warning;
            return "Nome não pode exceder 50 caracteres";
        }

        // Cancela validação anterior e timer de debounce
        _usernameValidationCts?.Cancel();
        _usernameDebounceTimer?.Dispose();
        
        _usernameValidationCts = new System.Threading.CancellationTokenSource();
        var localCts = _usernameValidationCts;

        // Cria TaskCompletionSource para aguardar o timer de debounce
        var tcs = new TaskCompletionSource<bool>();

        _usernameDebounceTimer = new System.Threading.Timer(_ =>
        {
            tcs.TrySetResult(true);
        }, null, DebounceDelayMs, System.Threading.Timeout.Infinite);

        try
        {
            // Aguarda o debounce
            await tcs.Task;

            // Verifica se foi cancelado durante o debounce
            if (localCts.IsCancellationRequested)
                return null;

            // Feedback visual de carregamento
            _usernameHelperText = "Verificando disponibilidade...";
            _usernameIcon = Icons.Material.Filled.HourglassEmpty;
            _usernameAdornmentColor = MudBlazor.Color.Info;
            await InvokeAsync(StateHasChanged);

            var isAvailable = await ValidationService.IsUsernameAvailableAsync(username);

            if (localCts.IsCancellationRequested)
                return null;

            if (isAvailable)
            {
                _usernameHelperText = "✓ Nome disponível";
                _usernameIcon = Icons.Material.Filled.CheckCircle;
                _usernameAdornmentColor = MudBlazor.Color.Success;
                await InvokeAsync(StateHasChanged);
                return null; // Válido
            }
            else
            {
                _usernameHelperText = "Este nome já está em uso";
                _usernameIcon = Icons.Material.Filled.Error;
                _usernameAdornmentColor = MudBlazor.Color.Error;
                await InvokeAsync(StateHasChanged);
                return "Este nome já está em uso";
            }
        }
        catch (OperationCanceledException)
        {
            // Validação cancelada, ignorar
            return null;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erro ao validar username");
            _usernameHelperText = "Erro ao verificar disponibilidade";
            _usernameIcon = Icons.Material.Filled.Warning;
            _usernameAdornmentColor = MudBlazor.Color.Warning;
            await InvokeAsync(StateHasChanged);
            return null; // Não bloqueia em caso de erro
        }
    }

    /// <summary>
    /// Validação assíncrona do email com feedback visual e debounce
    /// </summary>
    private async Task<string?> ValidateEmailAsync(string email)
    {
        // Validações básicas síncronas
        if (string.IsNullOrWhiteSpace(email))
        {
            _emailHelperText = "Email é obrigatório";
            _emailIcon = Icons.Material.Filled.Email;
            _emailAdornmentColor = MudBlazor.Color.Default;
            return "Email é obrigatório";
        }

        if (!new EmailAddressAttribute().IsValid(email))
        {
            _emailHelperText = "Email inválido";
            _emailIcon = Icons.Material.Filled.Warning;
            _emailAdornmentColor = MudBlazor.Color.Warning;
            return "Email inválido";
        }

        // Cancela validação anterior e timer de debounce
        _emailValidationCts?.Cancel();
        _emailDebounceTimer?.Dispose();
        
        _emailValidationCts = new System.Threading.CancellationTokenSource();
        var localCts = _emailValidationCts;

        // Cria TaskCompletionSource para aguardar o timer de debounce
        var tcs = new TaskCompletionSource<bool>();

        _emailDebounceTimer = new System.Threading.Timer(_ =>
        {
            tcs.TrySetResult(true);
        }, null, DebounceDelayMs, System.Threading.Timeout.Infinite);

        try
        {
            // Aguarda o debounce
            await tcs.Task;

            // Verifica se foi cancelado durante o debounce
            if (localCts.IsCancellationRequested)
                return null;

            // Feedback visual de carregamento
            _emailHelperText = "Verificando disponibilidade...";
            _emailIcon = Icons.Material.Filled.HourglassEmpty;
            _emailAdornmentColor = MudBlazor.Color.Info;
            await InvokeAsync(StateHasChanged);

            var isAvailable = await ValidationService.IsEmailAvailableAsync(email);

            if (localCts.IsCancellationRequested)
                return null;

            if (isAvailable)
            {
                _emailHelperText = "✓ Email disponível";
                _emailIcon = Icons.Material.Filled.CheckCircle;
                _emailAdornmentColor = MudBlazor.Color.Success;
                await InvokeAsync(StateHasChanged);
                return null; // Válido
            }
            else
            {
                _emailHelperText = "Este email já está em uso";
                _emailIcon = Icons.Material.Filled.Error;
                _emailAdornmentColor = MudBlazor.Color.Error;
                await InvokeAsync(StateHasChanged);
                return "Este email já está em uso";
            }
        }
        catch (OperationCanceledException)
        {
            // Validação cancelada, ignorar
            return null;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erro ao validar email");
            _emailHelperText = "Erro ao verificar disponibilidade";
            _emailIcon = Icons.Material.Filled.Warning;
            _emailAdornmentColor = MudBlazor.Color.Warning;
            await InvokeAsync(StateHasChanged);
            return null; // Não bloqueia em caso de erro
        }
    }

    private async Task LoadRolesAsync()
    {
        try
        {
            var response = await ApiService.GetAsync("api/roles");
            
            if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                _loadError = "Você precisa estar autenticado para acessar as funções.";
                return;
            }
            
            if (response.StatusCode == System.Net.HttpStatusCode.Forbidden)
            {
                _loadError = "Você não tem permissão para acessar as funções.";
                return;
            }
            
            response.EnsureSuccessStatusCode();
            
            var roles = await response.Content.ReadFromJsonAsync<List<RoleDto>>();
            _rolesList = roles ?? new List<RoleDto>();
        }
        catch (Exception ex)
        {
            Logger.LogError($"Erro ao buscar funções: {ex.Message}");
            _loadError = "Erro ao carregar funções. Tente novamente.";
        }
    }

    private async Task LoadDepartmentsAsync()
    {
        try
        {
            var response = await ApiService.GetAsync("api/departments");
            
            if (response.IsSuccessStatusCode)
            {
                var departments = await response.Content.ReadFromJsonAsync<List<DepartmentDto>>();
                _departmentsList = departments?.Where(d => d.IsActive).ToList() ?? new List<DepartmentDto>();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"Erro ao buscar departamentos: {ex.Message}");
            // Não bloqueia o formulário se departamentos não carregarem
        }
    }

    private async Task LoadPositionsAsync()
    {
        try
        {
            var response = await ApiService.GetAsync("api/positions");
            
            if (response.IsSuccessStatusCode)
            {
                var positions = await response.Content.ReadFromJsonAsync<List<PositionDto>>();
                _positionsList = positions?.Where(p => p.IsActive).ToList() ?? new List<PositionDto>();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"Erro ao buscar cargos: {ex.Message}");
            // Não bloqueia o formulário se cargos não carregarem
        }
    }

    private async Task CreateUser()
    {
        try
        {
            // Validação client-side
            await (_form?.Validate() ?? Task.CompletedTask);
            if (!(_form?.IsValid ?? false))
            {
                Snackbar.Add("Verifique os campos destacados e tente novamente.", Severity.Warning);
                return;
            }

            if (_selectedRoles == null || !_selectedRoles.Any())
            {
                Snackbar.Add("Escolha pelo menos uma permissão.", Severity.Warning);
                return;
            }

            // Sanitiza telefone para enviar apenas dígitos
            _newUser.Phone = OnlyDigits(_newUser.Phone);
            if (_newUser.Phone.Length is < 10 or > 11)
            {
                Snackbar.Add("Telefone inválido. Informe DDD + número (10 ou 11 dígitos).", Severity.Warning);
                return;
            }

            _submitting = true;
            _newUser.RoleIds = _selectedRoles.Select(r => r.Id).ToList();
            var response = await ApiService.PostAsJsonAsync("api/users", _newUser);
            
            if (response.IsSuccessStatusCode)
            {
                Logger.LogInformation("Usuário adicionado com sucesso.");
                Snackbar.Add("✓ Usuário adicionado com sucesso!", Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                var errorMessage = ErrorMessageHelper.GetUserOperationErrorMessage(response.StatusCode, "create");
                Logger.LogError($"Erro ao adicionar usuário: {response.StatusCode}");
                Snackbar.Add(errorMessage, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"Erro ao adicionar usuário: {ex.Message}");
            Snackbar.Add("Erro inesperado ao adicionar usuário.", Severity.Error);
        }
        finally
        {
            _submitting = false;
        }
    }

    private string GetRoleIcon(string roleName)
    {
        return roleName.ToLower() switch
        {
            "administrador" => Icons.Material.Filled.AdminPanelSettings,
            "gerente" => Icons.Material.Filled.ManageAccounts,
            "vendedor" => Icons.Material.Filled.StoreMallDirectory,
            _ => Icons.Material.Filled.Person
        };
    }

    private string GetRoleDescription(string roleName)
    {
        return roleName.ToLower() switch
        {
            "administrador" => "Acesso total ao sistema",
            "gerente" => "Gerenciar equipes e relatórios",
            "vendedor" => "Registro de vendas e atendimento",
            _ => "Usuário comum"
        };
    }

    public void Dispose()
    {
        _usernameValidationCts?.Cancel();
        _usernameValidationCts?.Dispose();
        _emailValidationCts?.Cancel();
        _emailValidationCts?.Dispose();
        _usernameDebounceTimer?.Dispose();
        _emailDebounceTimer?.Dispose();
    }
}

<style>
.user-dialog ::deep .mud-dialog-content {
    overflow-y: auto;
    max-height: 70vh;
}

.user-dialog ::deep .mud-input-adornment {
    color: var(--mud-palette-primary);
}
</style>