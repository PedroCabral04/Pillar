@using erp.Services
@inject IApiService ApiService
@implements IDisposable

@if (_isLoading)
{
    <div class="global-loading-overlay">
        <div class="global-loading-spinner">
            <MudProgressCircular Color="MudBlazor.Color.Primary" 
                                 Size="MudBlazor.Size.Large" 
                                 Indeterminate="true" />
            <MudText Typo="Typo.body1" Class="mt-3" Color="MudBlazor.Color.Primary">
                Carregando...
            </MudText>
        </div>
    </div>
}

<style>
    .global-loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(2px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: fadeIn 0.2s ease-in;
    }

    .global-loading-spinner {
        background: var(--mud-palette-surface);
        padding: 2rem 3rem;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        align-items: center;
        animation: scaleIn 0.3s ease-out;
    }

    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @@keyframes scaleIn {
        from { 
            opacity: 0;
            transform: scale(0.9);
        }
        to { 
            opacity: 1;
            transform: scale(1);
        }
    }
</style>

@code {
    private bool _isLoading;

    protected override void OnInitialized()
    {
        ApiService.LoadingStateChanged += OnLoadingStateChanged;
        _isLoading = ApiService.IsLoading;
    }

    private void OnLoadingStateChanged(object? sender, bool isLoading)
    {
        _isLoading = isLoading;
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        ApiService.LoadingStateChanged -= OnLoadingStateChanged;
    }
}
