@using MudBlazor
@inject NavigationManager NavigationManager
@implements IDisposable

<MudBreadcrumbs Items="_items" Separator=">">
    <ItemTemplate Context="item">
        @if (item.Href != null)
        {
            <MudLink Href="@item.Href" Color="MudBlazor.Color.Inherit">@item.Text</MudLink>
        }
        else
        {
            <MudText>@item.Text</MudText>
        }
    </ItemTemplate>
</MudBreadcrumbs>

@code {
    private List<BreadcrumbItem> _items = new();

    protected override void OnInitialized()
    {
        NavigationManager.LocationChanged += OnLocationChanged;
        UpdateBreadcrumbs();
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        UpdateBreadcrumbs();
        StateHasChanged();
    }

    private void UpdateBreadcrumbs()
    {
        var uri = new Uri(NavigationManager.Uri);
        var path = uri.AbsolutePath.TrimStart('/');
        
        _items = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home)
        };

        if (string.IsNullOrEmpty(path))
        {
            return;
        }

        var segments = path.Split('/', StringSplitOptions.RemoveEmptyEntries);
        var currentPath = "";

        for (int i = 0; i < segments.Length; i++)
        {
            currentPath += "/" + segments[i];
            var isLast = i == segments.Length - 1;
            var displayName = GetDisplayName(segments[i], segments, i);

            _items.Add(new BreadcrumbItem(
                displayName,
                href: isLast ? null : currentPath,
                icon: GetIcon(segments[i])
            ));
        }
    }

    private string GetDisplayName(string segment, string[] allSegments, int index)
    {
        return segment.ToLower() switch
        {
            // Admin
            "dashboard" => "Dashboard",
            "admin" => "Administração",
            "users" => "Usuários",
            "roles" => "Permissões",
            "tenants" => "Inquilinos",
            "audit" => "Auditoria",
            
            // Financeiro
            "financial" => "Financeiro",
            "payables" => "Contas a Pagar",
            "receivables" => "Contas a Receber",
            "accounts-payable" => "Contas a Pagar",
            "accounts-receivable" => "Contas a Receber",
            "suppliers" => "Fornecedores",
            "categories" => index > 0 && allSegments[index - 1] == "financial" ? "Categorias Financeiras" : "Categorias",
            "cost-centers" => "Centros de Custo",
            "costcenters" => "Centros de Custo",
            
            // Estoque
            "inventory" => "Estoque",
            "products" => "Produtos",
            "stock-movements" => "Movimentações",
            "stock-counts" => "Contagens",
            "warehouses" => "Armazéns",
            
            // Vendas
            "sales" => "Vendas",
            "customers" => "Clientes",
            
            // Ativos
            "assets" => "Ativos",
            
            // RH
            "hr" => "Recursos Humanos",
            "departments" => "Departamentos",
            "positions" => "Cargos",
            "payroll" => "Folha de Pagamento",
            "time-tracking" => "Ponto",
            
            // Relatórios
            "reports" => "Relatórios",
            
            // Configurações
            "kanban" => "Kanban",
            "settings" or "ajustes" => "Configurações",
            "preferences" => "Preferências",
            "login" => "Login",
            
            _ => segment.Length > 0 ? char.ToUpper(segment[0]) + segment.Substring(1) : segment
        };
    }

    private string? GetIcon(string segment)
    {
        return segment.ToLower() switch
        {
            // Admin
            "dashboard" => Icons.Material.Filled.Dashboard,
            "admin" => Icons.Material.Filled.AdminPanelSettings,
            "users" => Icons.Material.Filled.People,
            "roles" => Icons.Material.Filled.Security,
            "tenants" => Icons.Material.Filled.Business,
            "audit" => Icons.Material.Filled.History,
            
            // Financeiro
            "financial" => Icons.Material.Filled.AccountBalance,
            "payables" => Icons.Material.Filled.CallMade,
            "receivables" => Icons.Material.Filled.CallReceived,
            "accounts-payable" => Icons.Material.Filled.CallMade,
            "accounts-receivable" => Icons.Material.Filled.CallReceived,
            "suppliers" => Icons.Material.Filled.LocalShipping,
            "categories" => Icons.Material.Filled.Category,
            "cost-centers" => Icons.Material.Filled.AccountTree,
            "costcenters" => Icons.Material.Filled.AccountTree,
            
            // Estoque
            "inventory" => Icons.Material.Filled.Inventory,
            "products" => Icons.Material.Filled.ShoppingCart,
            "stock-movements" => Icons.Material.Filled.SwapHoriz,
            "stock-counts" => Icons.Material.Filled.Checklist,
            "warehouses" => Icons.Material.Filled.Warehouse,
            
            // Vendas
            "sales" => Icons.Material.Filled.PointOfSale,
            "customers" => Icons.Material.Filled.People,
            
            // Ativos
            "assets" => Icons.Material.Filled.Inventory2,
            
            // RH
            "hr" => Icons.Material.Filled.Badge,
            "departments" => Icons.Material.Filled.CorporateFare,
            "positions" => Icons.Material.Filled.Work,
            "payroll" => Icons.Material.Filled.Payments,
            "time-tracking" => Icons.Material.Filled.AccessTime,
            
            // Relatórios
            "reports" => Icons.Material.Filled.Assessment,
            
            // Configurações
            "kanban" => Icons.Material.Filled.ViewKanban,
            "settings" or "ajustes" => Icons.Material.Filled.Settings,
            "preferences" => Icons.Material.Filled.Tune,
            
            _ => null
        };
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}
