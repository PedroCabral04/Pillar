@using MudBlazor
@using Microsoft.AspNetCore.Components.Web
@using erp.Services.Tenancy
@using erp.Services.Authorization
@using erp.Models.Identity
@inject NavigationManager Navigation
@inject erp.Services.PreferenceService PreferenceService
@inject IDialogService DialogService
@inject IJSRuntime JS
@inject ITenantBrandingProvider BrandingProvider
@inject IPermissionService PermissionService

<nav class="pillar-sidebar @(_renderMini ? "mini-mode" : "")" role="navigation" aria-label="Navegação principal">
<MudNavMenu Rounded="true" Margin="Margin.Dense" Color="MudBlazor.Color.Primary" Class="pa-2 sidebar-nav-menu">
    @if (IsOpen || !_renderMini)
    {
        <div class="full-wrapper @(IsOpen ? "open" : "closing")">
            @* Search Box *@
            <div class="sidebar-search-container px-3 pt-3 pb-2">
                <MudTextField Id="sidebar-search" 
                              @ref="_searchField" 
                              @bind-Value="_search" 
                              Placeholder="Buscar (Ctrl + K)" 
                              Dense="true" 
                              Clearable="true" 
                              Adornment="Adornment.Start" 
                              AdornmentIcon="@Icons.Material.Filled.Search" 
                              Immediate="true" 
                              AriaLabel="Pesquisar navegação" 
                              @onkeydown="OnSearchKeyDown" 
                              Variant="Variant.Outlined" 
                              Margin="Margin.Dense"
                              Class="sidebar-search-field" />
            </div>
        </div>

        @if (_isSearching)
        {
            <div class="search-results px-2">
                @if (_searchResults.Count == 0)
                {
                    <div class="search-empty-state pa-3 d-flex flex-column align-center">
                        <MudIcon Icon="@Icons.Material.Outlined.SearchOff" Size="MudBlazor.Size.Large" Color="MudBlazor.Color.Default" Class="mb-2" />
                        <MudText Typo="Typo.body2" Color="MudBlazor.Color.Secondary">Nenhum resultado para "@_search"</MudText>
                    </div>
                }
                else
                {
                    <MudText Class="section-title px-2 py-1" Typo="Typo.overline">@_searchResults.Count resultado(s)</MudText>
                    @foreach (var item in _searchResults)
                    {
                        <div class="search-result-item d-flex align-center my-1 px-1 rounded-lg">
                            <div class="flex-grow-1">
                                <MudNavLink Href="@item.Href" Icon="@item.Icon" Match="NavLinkMatch.Prefix">@item.Title</MudNavLink>
                            </div>
                            <MudTooltip Text="@(IsPinned(item.Href) ? "Remover dos favoritos" : "Adicionar aos favoritos")" Placement="Placement.Right">
                                <MudIconButton AriaLabel="@(IsPinned(item.Href) ? "Remover dos favoritos" : "Adicionar aos favoritos")" 
                                               Icon="@(IsPinned(item.Href) ? Icons.Material.Filled.Star : Icons.Material.Outlined.StarBorder)" 
                                               Size="MudBlazor.Size.Small" 
                                               Color="@(IsPinned(item.Href) ? MudBlazor.Color.Warning : MudBlazor.Color.Default)" 
                                               OnClick="@(() => TogglePin(item.Href))" />
                            </MudTooltip>
                        </div>
                    }
                }
            </div>
        }
        else
        {
            @* Favoritos (Pinned Items) *@
            @if (PreferenceService.CurrentPreferences.Ui.PinnedRoutes.Count > 0)
            {
                <div class="sidebar-section favorites-section">
                    <MudText Class="section-title px-3 mt-2" Typo="Typo.overline">
                        <MudIcon Icon="@Icons.Material.Filled.Star" Size="MudBlazor.Size.Small" Class="mr-1" Style="vertical-align: middle;" />
                        Favoritos
                    </MudText>
                    <div class="px-2">
                        @foreach (var href in PreferenceService.CurrentPreferences.Ui.PinnedRoutes)
                        {
                            var pinnedItem = _allItems.FirstOrDefault(i => i.Href == href);
                            if (pinnedItem is not null)
                            {
                                <div class="pinned-item d-flex align-center my-1 px-1 rounded-lg">
                                    <div class="flex-grow-1">
                                        <MudNavLink Href="@pinnedItem.Href" Icon="@pinnedItem.Icon" Match="NavLinkMatch.Prefix">@pinnedItem.Title</MudNavLink>
                                    </div>
                                    <MudTooltip Text="Remover dos favoritos" Placement="Placement.Right">
                                        <MudIconButton AriaLabel="Remover dos favoritos" 
                                                       Icon="@Icons.Material.Filled.PushPin" 
                                                       Size="MudBlazor.Size.Small" 
                                                       Color="MudBlazor.Color.Primary"
                                                       OnClick="@(() => TogglePin(pinnedItem.Href))" />
                                    </MudTooltip>
                                </div>
                            }
                        }
                    </div>
                </div>
                <MudDivider Class="my-2 mx-3" DividerType="DividerType.Middle" />
            }

            @* Principal Navigation *@
            <div class="sidebar-section main-navigation">
                <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home" Class="nav-item" AriaLabel="Ir para Home">Home</MudNavLink>
                <MudNavLink Href="/dashboard" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Dashboard" Class="nav-item">Dashboard</MudNavLink>
            </div>

            <MudDivider Class="my-2 mx-3" DividerType="DividerType.Middle" />

            @* Módulos de Negócio *@
            <div class="sidebar-section business-modules">
                <MudText Class="section-title px-3" Typo="Typo.overline">Módulos</MudText>
                
                @* Vendas *@
                @if (HasModuleAccess(ModuleKeys.Sales))
                {
                    <MudNavGroup Title="Vendas" Icon="@Icons.Material.Filled.ShoppingCart" Class="nav-group" AriaLabel="Seção Vendas">
                        <MudNavLink Href="/sales" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Receipt" Class="nav-subitem">Vendas</MudNavLink>
                        <MudNavLink Href="/sales/customers" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.People" Class="nav-subitem">Clientes</MudNavLink>
                    </MudNavGroup>
                }

                @* Estoque *@
                @if (HasModuleAccess(ModuleKeys.Inventory))
                {
                    <MudNavGroup Title="Estoque" Icon="@Icons.Material.Filled.Inventory" Class="nav-group" AriaLabel="Seção Estoque">
                        <MudNavLink Href="/inventory/products" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Category" Class="nav-subitem">Produtos</MudNavLink>
                        <MudNavLink Href="/inventory/categories" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.FolderOpen" Class="nav-subitem">Categorias</MudNavLink>
                        <MudNavLink Href="/inventory/movements" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.SwapHoriz" Class="nav-subitem">Movimentações</MudNavLink>
                        <MudNavLink Href="/inventory/counts" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Checklist" Class="nav-subitem">Contagens</MudNavLink>
                    </MudNavGroup>
                }

                @* Financeiro *@
                @if (HasModuleAccess(ModuleKeys.Financial))
                {
                    <MudNavGroup Title="Financeiro" Icon="@Icons.Material.Filled.AccountBalance" Class="nav-group" AriaLabel="Seção Financeiro">
                        <MudNavLink Href="/financial/dashboard" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Dashboard" Class="nav-subitem">Dashboard</MudNavLink>
                        <MudNavLink Href="/financial/receivables" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.CallReceived" Class="nav-subitem">Contas a Receber</MudNavLink>
                        <MudNavLink Href="/financial/payables" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.CallMade" Class="nav-subitem">Contas a Pagar</MudNavLink>
                        <MudNavLink Href="/financial/suppliers" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.LocalShipping" Class="nav-subitem">Fornecedores</MudNavLink>
                        <MudNavLink Href="/financial/categories" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Category" Class="nav-subitem">Categorias</MudNavLink>
                        <MudNavLink Href="/financial/costcenters" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.AccountBalanceWallet" Class="nav-subitem">Centros de Custo</MudNavLink>
                    </MudNavGroup>
                }

                @* RH - Recursos Humanos *@
                @if (HasModuleAccess(ModuleKeys.HR))
                {
                    <MudNavGroup Title="RH" Icon="@Icons.Material.Filled.Groups" Class="nav-group" AriaLabel="Seção Recursos Humanos">
                        <MudNavLink Href="/admin/users" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.People" Class="nav-subitem">Colaboradores</MudNavLink>
                        <MudNavLink Href="/admin/departments" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.BusinessCenter" Class="nav-subitem">Departamentos</MudNavLink>
                        <MudNavLink Href="/admin/positions" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.WorkOutline" Class="nav-subitem">Cargos</MudNavLink>
                        <MudNavLink Href="/time-tracking/payroll" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.AccessTime" Class="nav-subitem">Apontamento</MudNavLink>
                    </MudNavGroup>
                }
            </div>

            @* Ferramentas *@
            <div class="sidebar-section tools-section">
                <MudText Class="section-title px-3 mt-2" Typo="Typo.overline">Ferramentas</MudText>
                @if (HasModuleAccess(ModuleKeys.Kanban))
                {
                    <MudNavLink Href="/kanban" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.ViewKanban" Class="nav-item">Kanban</MudNavLink>
                }
                @if (HasModuleAccess(ModuleKeys.Assets))
                {
                    <MudNavLink Href="/assets" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Devices" Class="nav-item">Ativos</MudNavLink>
                }
                @if (HasModuleAccess(ModuleKeys.Reports))
                {
                    <MudNavLink Href="/reports" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Assessment" Class="nav-item">Relatórios</MudNavLink>
                }
            </div>

            <MudDivider Class="my-2 mx-3" DividerType="DividerType.Middle" />

            @* Administração (apenas para admins) *@
            <AuthorizeView Roles="Administrador">
                <Authorized>
                    <div class="sidebar-section admin-section">
                        <MudNavGroup Title="Administração" Icon="@Icons.Material.Filled.AdminPanelSettings" Class="nav-group admin-group" AriaLabel="Seção Administração">
                            <MudNavLink Href="/admin/tenants" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Domain" Class="nav-subitem">Tenants</MudNavLink>
                            <MudNavLink Href="/admin/role-permissions" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Security" Class="nav-subitem">Permissões</MudNavLink>
                            <MudNavLink Href="/admin/widget-roles" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Widgets" Class="nav-subitem">Widgets / Papéis</MudNavLink>
                            <MudNavLink Href="/audit" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.History" Class="nav-subitem">Auditoria</MudNavLink>
                            <MudNavLink Href="/data-access-report" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Shield" Class="nav-subitem">Acessos LGPD</MudNavLink>
                        </MudNavGroup>
                    </div>
                    <MudDivider Class="my-2 mx-3" DividerType="DividerType.Middle" />
                </Authorized>
            </AuthorizeView>

            @* Rodapé - Configurações e Logout *@
            <div class="sidebar-section footer-section mt-auto">
                <MudNavLink Href="/settings" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Settings" Class="nav-item">Configurações</MudNavLink>
                <AuthorizeView>
                    <Authorized>
                        <MudNavLink OnClick="LogoutAsync" Icon="@Icons.Material.Filled.Logout" Class="nav-item logout-item">Sair</MudNavLink>
                    </Authorized>
                    <NotAuthorized>
                        <MudNavLink Href="/login" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Login" Class="nav-item">Entrar</MudNavLink>
                    </NotAuthorized>
                </AuthorizeView>
            </div>
        }
    }
    else
    {
        @if (_renderMini) 
        {
            <div class="mini-root" role="menu" aria-label="Menu compacto">
                <MudTooltip Text="Home" Placement="Placement.Right" Arrow="true" Duration="200">
                    <MudNavLink Href="/" Icon="@Icons.Material.Filled.Home" Class="mini-nav-item" AriaLabel="Home"/>
                </MudTooltip>
                <MudTooltip Text="Dashboard" Placement="Placement.Right" Arrow="true" Duration="200">
                    <MudNavLink Href="/dashboard" Icon="@Icons.Material.Filled.Dashboard" Class="mini-nav-item" AriaLabel="Dashboard"/>
                </MudTooltip>
                
                <MudDivider Class="my-1 mx-2" />
                
                @if (HasModuleAccess(ModuleKeys.Sales))
                {
                    <MudTooltip Text="Vendas" Placement="Placement.Right" Arrow="true" Duration="200">
                        <MudNavLink Href="/sales" Icon="@Icons.Material.Filled.ShoppingCart" Class="mini-nav-item" AriaLabel="Vendas"/>
                    </MudTooltip>
                }
                @if (HasModuleAccess(ModuleKeys.Inventory))
                {
                    <MudTooltip Text="Produtos" Placement="Placement.Right" Arrow="true" Duration="200">
                        <MudNavLink Href="/inventory/products" Icon="@Icons.Material.Filled.Inventory" Class="mini-nav-item" AriaLabel="Produtos"/>
                    </MudTooltip>
                }
                @if (HasModuleAccess(ModuleKeys.Financial))
                {
                    <MudTooltip Text="Financeiro" Placement="Placement.Right" Arrow="true" Duration="200">
                        <MudNavLink Href="/financial/dashboard" Icon="@Icons.Material.Filled.AccountBalance" Class="mini-nav-item" AriaLabel="Financeiro"/>
                    </MudTooltip>
                }
                @if (HasModuleAccess(ModuleKeys.HR))
                {
                    <MudTooltip Text="RH" Placement="Placement.Right" Arrow="true" Duration="200">
                        <MudNavLink Href="/admin/users" Icon="@Icons.Material.Filled.Groups" Class="mini-nav-item" AriaLabel="Recursos Humanos"/>
                    </MudTooltip>
                }
                
                <MudDivider Class="my-1 mx-2" />
                
                @if (HasModuleAccess(ModuleKeys.Kanban))
                {
                    <MudTooltip Text="Kanban" Placement="Placement.Right" Arrow="true" Duration="200">
                        <MudNavLink Href="/kanban" Icon="@Icons.Material.Filled.ViewKanban" Class="mini-nav-item" AriaLabel="Kanban"/>
                    </MudTooltip>
                }
                @if (HasModuleAccess(ModuleKeys.Assets))
                {
                    @* Link compacto para 'Ativos' comentado por solicitação *@
                    @*
                    <MudTooltip Text="Ativos" Placement="Placement.Right" Arrow="true" Duration="200">
                        <MudNavLink Href="/assets" Icon="@Icons.Material.Filled.Devices" Class="mini-nav-item" AriaLabel="Ativos"/>
                    </MudTooltip>
                    *@
                }
                @if (HasModuleAccess(ModuleKeys.Reports))
                {
                    <MudTooltip Text="Relatórios" Placement="Placement.Right" Arrow="true" Duration="200">
                        <MudNavLink Href="/reports" Icon="@Icons.Material.Filled.Assessment" Class="mini-nav-item" AriaLabel="Relatórios"/>
                    </MudTooltip>
                }
                
                <AuthorizeView Roles="Administrador">
                    <Authorized>
                        <MudDivider Class="my-1 mx-2" />
                        <MudTooltip Text="Administração" Placement="Placement.Right" Arrow="true" Duration="200">
                            <MudNavLink Href="/admin/role-permissions" Icon="@Icons.Material.Filled.AdminPanelSettings" Class="mini-nav-item" AriaLabel="Administração"/>
                        </MudTooltip>
                        <MudTooltip Text="Tenants" Placement="Placement.Right" Arrow="true" Duration="200">
                            <MudNavLink Href="/admin/tenants" Icon="@Icons.Material.Filled.Domain" Class="mini-nav-item" AriaLabel="Tenants"/>
                        </MudTooltip>
                    </Authorized>
                </AuthorizeView>
                
                <div class="mini-spacer"></div>
                
                <MudTooltip Text="Configurações" Placement="Placement.Right" Arrow="true" Duration="200">
                    <MudNavLink Href="/settings" Icon="@Icons.Material.Filled.Settings" Class="mini-nav-item" AriaLabel="Configurações"/>
                </MudTooltip>
                <MudTooltip Text="Sair" Placement="Placement.Right" Arrow="true" Duration="200">
                    <MudNavLink OnClick="LogoutAsync" Icon="@Icons.Material.Filled.Logout" Class="mini-nav-item logout-mini" AriaLabel="Sair do sistema"/>
                </MudTooltip>
            </div>
        }
    }
</MudNavMenu>
</nav>

@code {
    [Parameter] public bool IsOpen { get; set; } = true;
    [Parameter] public EventCallback OnToggleDrawer { get; set; }
    [Parameter] public bool IsMobile { get; set; } = false;
    [CascadingParameter] private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    private TenantBrandingTheme _branding = TenantBrandingTheme.Default;
    private string _search = string.Empty;
    private bool _isSearching => !string.IsNullOrWhiteSpace(_search);
    private MudTextField<string>? _searchField;
    private bool _renderMini = false;
    private IReadOnlyList<string> _userModules = Array.Empty<string>();
    private bool _permissionsLoaded = false;

    private record NavItem(string Title, string Href, string Icon, string? Category = null);
    
    private readonly List<NavItem> _allItems = new()
    {
        // Principal
        new("Home", "/", Icons.Material.Filled.Home, "Principal"),
        new("Dashboard", "/dashboard", Icons.Material.Filled.Dashboard, "Principal"),
        // Vendas
        new("Vendas", "/sales", Icons.Material.Filled.Receipt, "Vendas"),
        new("Clientes", "/sales/customers", Icons.Material.Filled.People, "Vendas"),
        // Estoque
        new("Produtos", "/inventory/products", Icons.Material.Filled.Category, "Estoque"),
        new("Categorias", "/inventory/categories", Icons.Material.Filled.FolderOpen, "Estoque"),
        new("Movimentações", "/inventory/movements", Icons.Material.Filled.SwapHoriz, "Estoque"),
        new("Contagens", "/inventory/counts", Icons.Material.Filled.Checklist, "Estoque"),
        // Financeiro
        new("Financeiro", "/financial/dashboard", Icons.Material.Filled.AccountBalance, "Financeiro"),
        new("Contas a Receber", "/financial/receivables", Icons.Material.Filled.CallReceived, "Financeiro"),
        new("Contas a Pagar", "/financial/payables", Icons.Material.Filled.CallMade, "Financeiro"),
        new("Fornecedores", "/financial/suppliers", Icons.Material.Filled.LocalShipping, "Financeiro"),
        new("Categorias Financeiras", "/financial/categories", Icons.Material.Filled.Category, "Financeiro"),
        new("Centros de Custo", "/financial/costcenters", Icons.Material.Filled.AccountBalanceWallet, "Financeiro"),
        // RH - Recursos Humanos
        new("Colaboradores", "/admin/users", Icons.Material.Filled.People, "RH"),
        new("Departamentos", "/admin/departments", Icons.Material.Filled.BusinessCenter, "RH"),
        new("Cargos", "/admin/positions", Icons.Material.Filled.WorkOutline, "RH"),
        new("Apontamento", "/time-tracking/payroll", Icons.Material.Filled.AccessTime, "RH"),
        // Ferramentas
        new("Kanban", "/kanban", Icons.Material.Filled.ViewKanban, "Ferramentas"),
        // Link para 'Ativos' comentado por solicitação
        // new("Ativos", "/assets", Icons.Material.Filled.Devices, "Ferramentas"),
        new("Relatórios", "/reports", Icons.Material.Filled.Assessment, "Ferramentas"),
        // Administração
        new("Tenants", "/admin/tenants", Icons.Material.Filled.Domain, "Administração"),
        new("Widgets / Papéis", "/admin/widget-roles", Icons.Material.Filled.Widgets, "Administração"),
        new("Auditoria", "/audit", Icons.Material.Filled.History, "Administração"),
        new("Acessos LGPD", "/data-access-report", Icons.Material.Filled.Shield, "Administração"),
        // Sistema
        new("Configurações", "/settings", Icons.Material.Filled.Settings, "Sistema")
    };

    private List<NavItem> _searchResults => string.IsNullOrWhiteSpace(_search) 
        ? new List<NavItem>()
        : _allItems
            .Where(i => i.Title.Contains(_search, StringComparison.OrdinalIgnoreCase) ||
                       (i.Category?.Contains(_search, StringComparison.OrdinalIgnoreCase) ?? false))
            .Take(8) // Limita resultados para melhor UX
            .ToList();

    protected override void OnInitialized()
    {
        _branding = BrandingProvider.GetCurrentBranding();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadUserPermissionsAsync();
    }

    private async Task LoadUserPermissionsAsync()
    {
        if (AuthenticationStateTask == null) return;
        
        try
        {
            var authState = await AuthenticationStateTask;
            if (authState.User.Identity?.IsAuthenticated == true)
            {
                _userModules = await PermissionService.GetUserModulesAsync(authState.User);
                _permissionsLoaded = true;
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            // If permissions fail to load, only allow Dashboard (fail safe for UI)
            Console.WriteLine($"[Sidebar] Failed to load permissions: {ex.Message}");
            _userModules = new[] { ModuleKeys.Dashboard };
            _permissionsLoaded = true;
            await InvokeAsync(StateHasChanged);
        }
    }

    private bool HasModuleAccess(string moduleKey)
    {
        // If permissions haven't loaded yet, hide modules until loaded
        if (!_permissionsLoaded) return false;
        
        return _userModules.Contains(moduleKey, StringComparer.OrdinalIgnoreCase);
    }



    private bool IsPinned(string href) => 
        PreferenceService.CurrentPreferences.Ui.PinnedRoutes.Contains(href);

    private async Task TogglePin(string href)
    {
        var routes = PreferenceService.CurrentPreferences.Ui.PinnedRoutes;
        if (IsPinned(href))
        {
            routes.RemoveAll(r => r == href);
        }
        else
        {
            // Limita a 5 favoritos para evitar poluição visual
            if (routes.Count >= 5)
            {
                return; // Poderia mostrar um snackbar aqui
            }
            routes.Add(href);
        }
        await PreferenceService.SaveAsync();
    }

    private void OnSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            _search = string.Empty;
        }
        else if (e.Key == "Enter" && _searchResults.Count == 1)
        {
            // Navega diretamente se houver apenas um resultado
            Navigation.NavigateTo(_searchResults[0].Href);
            _search = string.Empty;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try 
            { 
                await JS.InvokeVoidAsync("erpShortcuts.registerSearchHotkeys", "sidebar-search"); 
            } 
            catch (JSDisconnectedException) { }
            catch (TaskCanceledException) { }
        }
    }

    public async ValueTask DisposeAsync()
    {
        try 
        { 
            await JS.InvokeVoidAsync("erpShortcuts.unregisterSearchHotkeys"); 
        } 
        catch (JSDisconnectedException) { }
        catch (TaskCanceledException) { }
        catch (ObjectDisposedException) { }
    }

    private async Task LogoutAsync()
    {
        var parameters = new DialogParameters
        {
            { "ContentText", "Tem certeza que deseja sair do sistema?" },
            { "ButtonText", "Sair" },
            { "Color", MudBlazor.Color.Error }
        };

        var options = new DialogOptions 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Small,
            NoHeader = false 
        };
        
        var dialog = await DialogService.ShowAsync<erp.Components.Shared.Dialogs.ConfirmDialog>("Confirmar saída", parameters, options);
        var result = await dialog.Result;
        
        if (result is { Canceled: false })
        {
            try 
            { 
                await JS.InvokeVoidAsync("erpAuth.logout"); 
                Navigation.NavigateTo("/login", true); 
            }
            catch 
            { 
                Navigation.NavigateTo("/login", true); 
            }
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!IsOpen)
        {
            // Aguarda a animação terminar antes de trocar o DOM
            await Task.Delay(110);
            _renderMini = true;
        }
        else
        {
            _renderMini = false;
        }
    }
}
