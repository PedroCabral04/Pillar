@using erp.DTOs.Chatbot
@using erp.Services
@using MudBlazor
@inject IApiService ApiService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

<div class="chatbot-widget">
    @if (_isOpen)
    {
        <div class="chatbot-window">
            <div class="chat-header">
                <div class="chat-header-info">
                    <MudAvatar Color="MudBlazor.Color.Surface" Size="MudBlazor.Size.Medium" Style="background: rgba(255,255,255,0.15);">
                        <MudIcon Icon="@Icons.Material.Filled.SmartToy" Style="color: white;" Size="MudBlazor.Size.Small"/>
                    </MudAvatar>
                    <div class="chat-header-text">
                        <span class="chat-header-title">Assistente Virtual</span>
                        <span class="chat-header-status">
                            <span class="status-dot"></span>
                            Online
                        </span>
                    </div>
                </div>
                <div class="chat-header-actions">
                    <MudTooltip Text="Limpar conversa" Placement="Placement.Bottom">
                        <MudIconButton Icon="@Icons.Material.Filled.Refresh" 
                                       Color="MudBlazor.Color.Inherit" 
                                       OnClick="ClearChat"
                                       Size="MudBlazor.Size.Small"
                                       Disabled="@(!_messages.Any())"
                                       Style="color: rgba(255,255,255,0.8);"
                                       aria-label="Limpar conversa"/>
                    </MudTooltip>
                    <MudTooltip Text="Fechar" Placement="Placement.Bottom">
                        <MudIconButton Icon="@Icons.Material.Filled.Close" 
                                       Color="MudBlazor.Color.Inherit" 
                                       OnClick="ToggleChatbot"
                                       Size="MudBlazor.Size.Small"
                                       Style="color: rgba(255,255,255,0.8);"
                                       aria-label="Fechar"/>
                    </MudTooltip>
                </div>
            </div>

            <div class="chat-messages" id="chat-messages-container" @ref="_messagesContainer">
                @if (!_messages.Any())
                {
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <MudIcon Icon="@Icons.Material.Filled.AutoAwesome" Size="MudBlazor.Size.Large" Color="MudBlazor.Color.Primary"/>
                        </div>
                        <MudText Typo="Typo.h6" Style="font-weight: 600; margin-bottom: 8px; color: var(--mud-palette-text-primary);">
                            Olá! Como posso ajudar?
                        </MudText>
                        <MudText Typo="Typo.body2" Style="max-width: 240px; opacity: 0.8;">
                            Estou aqui para ajudar com produtos, vendas e informações do sistema.
                        </MudText>
                    </div>
                }
                else
                {
                    @foreach (var message in _messages)
                    {
                        <div class="chat-message @(message.IsError ? "chat-message-error" : message.Role == "user" ? "chat-message-user" : "chat-message-assistant")">
                            <span>@message.Content</span>
                        </div>
                    }
                    
                    @if (_isProcessing)
                    {
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    }
                }
            </div>

            @if (_suggestedActions.Any() && !_isProcessing)
            {
                <div class="suggested-actions">
                    @foreach (var action in _suggestedActions)
                    {
                        <MudChip T="string"
                                 Size="MudBlazor.Size.Small" 
                                 Color="MudBlazor.Color.Primary" 
                                 Variant="Variant.Outlined"
                                 OnClick="@(() => SendSuggestedAction(action))"
                                 Style="border-radius: 16px; font-weight: 500;">
                            @action
                        </MudChip>
                    }
                </div>
            }

            <div class="chat-input-area">
                <MudTextField @bind-Value="_currentMessage"
                              Placeholder="Digite sua mensagem..."
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              OnKeyDown="HandleKeyDown"
                              Disabled="_isProcessing"
                              Immediate="true"
                              FullWidth="true"
                              Adornment="Adornment.None"
                              Style="flex: 1;"/>
                <MudIconButton Icon="@Icons.Material.Filled.Send" 
                               Color="MudBlazor.Color.Primary" 
                               Variant="Variant.Filled"
                               Class="send-button"
                               OnClick="SendMessage"
                               Disabled="@(string.IsNullOrWhiteSpace(_currentMessage) || _isProcessing)"
                               aria-label="Enviar mensagem"/>
            </div>
        </div>
    }

    <MudTooltip Text="@(_isOpen ? "Fechar assistente" : "Abrir assistente")" Placement="Placement.Left">
        <MudIconButton Icon="@(_isOpen ? Icons.Material.Filled.Close : Icons.Material.Filled.SmartToy)" 
                       Class="@($"chatbot-button {(_isOpen ? "is-open" : "")}")"
                       OnClick="ToggleChatbot"
                       Size="MudBlazor.Size.Large"
                       aria-label="@(_isOpen ? "Fechar Assistente Virtual" : "Abrir Assistente Virtual")"/>
    </MudTooltip>
</div>

@code {
    private bool _isOpen = false;
    private bool _isProcessing = false;
    private string _currentMessage = string.Empty;
    private List<ChatMessageDto> _messages = new();
    private List<string> _suggestedActions = new();
    private ElementReference _messagesContainer;

    protected override void OnInitialized()
    {
        base.OnInitialized();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_isOpen && _messages.Any())
        {
            await ScrollToBottom();
        }
    }

    private async Task ScrollToBottom()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("eval", 
                "document.getElementById('chat-messages-container')?.scrollTo({ top: document.getElementById('chat-messages-container').scrollHeight, behavior: 'smooth' })");
        }
        catch
        {
            // Ignore JS interop errors
        }
    }

    private void ToggleChatbot()
    {
        _isOpen = !_isOpen;
        
        if (_isOpen && !_messages.Any())
        {
            _suggestedActions = new List<string>
            {
                "O que você pode fazer?",
                "Listar produtos",
            };
        }
    }

    private void ClearChat()
    {
        _messages.Clear();
        _suggestedActions = new List<string>
        {
            "O que você pode fazer?",
            "Listar produtos",
        };
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await SendMessage();
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_currentMessage) || _isProcessing)
            return;

        var userMessage = _currentMessage.Trim();
        _currentMessage = string.Empty;
        _suggestedActions.Clear();

        _messages.Add(new ChatMessageDto
        {
            Role = "user",
            Content = userMessage,
            Timestamp = DateTime.UtcNow
        });

        _isProcessing = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            var request = new ChatRequestDto
            {
                Message = userMessage,
                ConversationHistory = _messages.Where(m => !m.IsError).ToList()
            };

            var response = await ApiService.PostAsync<ChatResponseDto>("api/chatbot/message", request);

            if (response?.Success == true)
            {
                _messages.Add(new ChatMessageDto
                {
                    Role = "assistant",
                    Content = response.Response,
                    Timestamp = DateTime.UtcNow
                });

                if (response.SuggestedActions?.Any() == true)
                {
                    _suggestedActions = response.SuggestedActions;
                }
            }
            else
            {
                _messages.Add(new ChatMessageDto
                {
                    Role = "assistant",
                    Content = response?.Error ?? "Desculpe, não consegui processar sua mensagem. Tente novamente.",
                    Timestamp = DateTime.UtcNow,
                    IsError = true
                });
            }
        }
        catch (Exception ex)
        {
            _messages.Add(new ChatMessageDto
            {
                Role = "assistant",
                Content = "Erro de conexão. Verifique sua internet e tente novamente.",
                Timestamp = DateTime.UtcNow,
                IsError = true
            });
            Snackbar.Add("Erro ao comunicar com o assistente", Severity.Error);
        }
        finally
        {
            _isProcessing = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task SendSuggestedAction(string action)
    {
        _currentMessage = action;
        await SendMessage();
    }
}
