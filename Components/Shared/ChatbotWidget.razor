@using erp.DTOs.Chatbot
@using erp.Services
@using MudBlazor
@inject IApiService ApiService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

@using System.Text.RegularExpressions
@using System.Text.Encodings.Web
@using Markdig

<div class="chatbot-widget">
    @if (_isOpen)
    {
        <div class="chatbot-window">
            <div class="chat-header">
                <div class="chat-header-info">
                    <MudAvatar Color="MudBlazor.Color.Surface" Size="MudBlazor.Size.Medium" Style="background: rgba(255,255,255,0.15);">
                        <MudIcon Icon="@Icons.Material.Filled.SmartToy" Style="color: white;" Size="MudBlazor.Size.Small"/>
                    </MudAvatar>
                    <div class="chat-header-text">
                        <span class="chat-header-title">Assistente Virtual</span>
                        <span class="chat-header-status">
                            <span class="status-dot"></span>
                            Online
                        </span>
                    </div>
                </div>
                <div class="chat-header-actions">
                    <MudTooltip Text="Limpar conversa" Placement="Placement.Bottom">
                        <MudIconButton Icon="@Icons.Material.Filled.Refresh" 
                                       Color="MudBlazor.Color.Inherit" 
                                       OnClick="ClearChat"
                                       Size="MudBlazor.Size.Small"
                                       Disabled="@(!_messages.Any())"
                                       Style="color: rgba(255,255,255,0.8);"
                                       aria-label="Limpar conversa"/>
                    </MudTooltip>
                    <MudTooltip Text="Fechar" Placement="Placement.Bottom">
                        <MudIconButton Icon="@Icons.Material.Filled.Close" 
                                       Color="MudBlazor.Color.Inherit" 
                                       OnClick="ToggleChatbot"
                                       Size="MudBlazor.Size.Small"
                                       Style="color: rgba(255,255,255,0.8);"
                                       aria-label="Fechar"/>
                    </MudTooltip>
                </div>
            </div>

            <div class="chat-messages" id="chat-messages-container" @ref="_messagesContainer">
                @if (!_messages.Any())
                {
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <MudIcon Icon="@Icons.Material.Filled.AutoAwesome" Size="MudBlazor.Size.Large" Color="MudBlazor.Color.Primary"/>
                        </div>
                        <MudText Typo="Typo.h6" Style="font-weight: 600; margin-bottom: 8px; color: var(--mud-palette-text-primary);">
                            Olá! Como posso ajudar?
                        </MudText>
                        <MudText Typo="Typo.body2" Style="max-width: 240px; opacity: 0.8;">
                            Estou aqui para ajudar com produtos, vendas e informações do sistema.
                        </MudText>
                    </div>
                }
                else
                {
                    @foreach (var message in _messages)
                    {
                        var messageId = message.Id;
                        var isLongMessage = message.Role == "assistant" && !message.IsError && message.Content.Length > MaxCollapsedLength;
                        var isExpanded = _expandedMessages.Contains(messageId);
                        
                        <div class="chat-message @(message.IsError ? "chat-message-error" : message.Role == "user" ? "chat-message-user" : "chat-message-assistant") @(isLongMessage && !isExpanded ? "collapsed" : "")">
                            @if (isLongMessage && !isExpanded)
                            {
                                @RenderMessage(TruncateMessage(message.Content))
                                <div class="message-expand-overlay">
                                    <MudButton Size="MudBlazor.Size.Small" 
                                               Variant="Variant.Text" 
                                               Color="MudBlazor.Color.Primary"
                                               StartIcon="@Icons.Material.Filled.ExpandMore"
                                               OnClick="@(() => ExpandMessage(messageId))">
                                        Ver mais
                                    </MudButton>
                                </div>
                            }
                            else
                            {
                                @RenderMessage(message.Content)
                                @if (isLongMessage && isExpanded)
                                {
                                    <div class="message-collapse-button">
                                        <MudButton Size="MudBlazor.Size.Small" 
                                                   Variant="Variant.Text" 
                                                   Color="MudBlazor.Color.Primary"
                                                   StartIcon="@Icons.Material.Filled.ExpandLess"
                                                   OnClick="@(() => CollapseMessage(messageId))">
                                            Ver menos
                                        </MudButton>
                                    </div>
                                }
                            }
                        </div>
                    }
                    
                    @if (_isProcessing)
                    {
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    }
                }
            </div>

            @if (_suggestedActions.Any() && !_isProcessing)
            {
                <div class="suggested-actions">
                    @foreach (var action in _suggestedActions)
                    {
                        <MudChip T="string"
                                 Size="MudBlazor.Size.Small" 
                                 Color="MudBlazor.Color.Primary" 
                                 Variant="Variant.Outlined"
                                 OnClick="@(() => SendSuggestedAction(action))"
                                 Style="border-radius: 16px; font-weight: 500;">
                            @action
                        </MudChip>
                    }
                </div>
            }

            <div class="chat-input-area">
                <MudTextField @bind-Value="_currentMessage"
                              Placeholder="Digite sua mensagem..."
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              OnKeyDown="HandleKeyDown"
                              Disabled="_isProcessing"
                              Immediate="true"
                              FullWidth="true"
                              Adornment="Adornment.None"
                              Style="flex: 1;"/>
                <MudIconButton Icon="@Icons.Material.Filled.Send" 
                               Color="MudBlazor.Color.Primary" 
                               Variant="Variant.Filled"
                               Class="send-button"
                               OnClick="SendMessage"
                               Disabled="@(string.IsNullOrWhiteSpace(_currentMessage) || _isProcessing)"
                               aria-label="Enviar mensagem"/>
            </div>
        </div>
    }

    <MudTooltip Text="@(_isOpen ? "Fechar assistente" : "Abrir assistente")" Placement="Placement.Left">
        <MudIconButton Icon="@(_isOpen ? Icons.Material.Filled.Close : Icons.Material.Filled.SmartToy)" 
                       Class="@($"chatbot-button {(_isOpen ? "is-open" : "")}")"
                       OnClick="ToggleChatbot"
                       Size="MudBlazor.Size.Large"
                       aria-label="@(_isOpen ? "Fechar Assistente Virtual" : "Abrir Assistente Virtual")"/>
    </MudTooltip>
</div>

@code {
    private const int MaxCollapsedLength = 500;
    private static readonly MarkdownPipeline _markdownPipeline = new MarkdownPipelineBuilder()
        .UseAdvancedExtensions()
        .Build();
    
    private bool _isOpen = false;
    private bool _isProcessing = false;
    private string _currentMessage = string.Empty;
    private List<ChatMessageDto> _messages = new();
    private List<string> _suggestedActions = new();
    private ElementReference _messagesContainer;
    private HashSet<string> _expandedMessages = new();

    private void ExpandMessage(string messageId)
    {
        _expandedMessages.Add(messageId);
        StateHasChanged();
    }

    private void CollapseMessage(string messageId)
    {
        _expandedMessages.Remove(messageId);
        StateHasChanged();
    }

    private string TruncateMessage(string message)
    {
        if (message.Length <= MaxCollapsedLength)
            return message;
        
        // Tenta cortar em um ponto natural (fim de linha ou espaço)
        var truncateAt = message.LastIndexOf('\n', MaxCollapsedLength);
        if (truncateAt < MaxCollapsedLength / 2)
            truncateAt = message.LastIndexOf(' ', MaxCollapsedLength);
        if (truncateAt < MaxCollapsedLength / 2)
            truncateAt = MaxCollapsedLength;
        
        return message[..truncateAt] + "...";
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_isOpen && _messages.Any())
        {
            await ScrollToBottom();
        }
    }

    private async Task ScrollToBottom()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("eval", 
                "document.getElementById('chat-messages-container')?.scrollTo({ top: document.getElementById('chat-messages-container').scrollHeight, behavior: 'smooth' })");
        }
        catch
        {
            // Ignore JS interop errors
        }
    }

    private void ToggleChatbot()
    {
        _isOpen = !_isOpen;
        
        if (_isOpen && !_messages.Any())
        {
            _suggestedActions = new List<string>
            {
                "O que você pode fazer?",
                "Listar produtos",
            };
        }
    }

    private void ClearChat()
    {
        _messages.Clear();
        _suggestedActions = new List<string>
        {
            "O que você pode fazer?",
            "Listar produtos",
        };
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await SendMessage();
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_currentMessage) || _isProcessing)
            return;

        var userMessage = _currentMessage.Trim();
        _currentMessage = string.Empty;
        _suggestedActions.Clear();

        _messages.Add(new ChatMessageDto
        {
            Role = "user",
            Content = userMessage,
            Timestamp = DateTime.UtcNow
        });

        _isProcessing = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            var request = new ChatRequestDto
            {
                Message = userMessage,
                ConversationHistory = _messages.Where(m => !m.IsError).ToList()
            };

            var response = await ApiService.PostAsync<ChatResponseDto>("api/chatbot/message", request);

            if (response?.Success == true)
            {
                _messages.Add(new ChatMessageDto
                {
                    Role = "assistant",
                    Content = response.Response,
                    Timestamp = DateTime.UtcNow
                });

                if (response.SuggestedActions?.Any() == true)
                {
                    _suggestedActions = response.SuggestedActions;
                }
            }
            else
            {
                _messages.Add(new ChatMessageDto
                {
                    Role = "assistant",
                    Content = response?.Error ?? "Desculpe, não consegui processar sua mensagem. Tente novamente.",
                    Timestamp = DateTime.UtcNow,
                    IsError = true
                });
            }
        }
        catch (Exception)
        {
            _messages.Add(new ChatMessageDto
            {
                Role = "assistant",
                Content = "Erro de conexão. Verifique sua internet e tente novamente.",
                Timestamp = DateTime.UtcNow,
                IsError = true
            });
            Snackbar.Add("Erro ao comunicar com o assistente", Severity.Error);
        }
        finally
        {
            _isProcessing = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task SendSuggestedAction(string action)
    {
        _currentMessage = action;
        await SendMessage();
    }

    private MarkupString RenderMessage(string message)
    {
        if (string.IsNullOrEmpty(message))
            return new MarkupString(string.Empty);

        try
        {
            // Usar Markdig para converter Markdown para HTML
            var html = Markdig.Markdown.ToHtml(message, _markdownPipeline);
            return new MarkupString(html);
        }
        catch
        {
            // Fallback: apenas encode e quebras de linha
            var encoded = HtmlEncoder.Default.Encode(message);
            var withBreaks = encoded
                .Replace("\r\n", "<br>")
                .Replace("\r", "<br>")
                .Replace("\n", "<br>");
            return new MarkupString(withBreaks);
        }
    }
}

<style>
.chatbot-widget {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 2000;
    font-family: inherit;
}

.chatbot-button {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    box-shadow: 0 4px 16px rgba(var(--tenant-primary-rgb, 89, 74, 226), 0.35);
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    background: linear-gradient(135deg, var(--mud-palette-primary) 0%, var(--mud-palette-primary-darken) 100%);
    color: white !important;
    border: none;
}

.chatbot-button:hover {
    transform: scale(1.08) translateY(-2px);
    box-shadow: 0 8px 24px rgba(var(--tenant-primary-rgb, 89, 74, 226), 0.45);
}

.chatbot-button:focus-visible {
    outline: 2px solid var(--mud-palette-primary);
    outline-offset: 3px;
}

.chatbot-button.is-open {
    background: var(--mud-palette-text-secondary);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.chatbot-window {
    position: fixed;
    bottom: 96px;
    right: 24px;
    width: 380px;
    height: 560px;
    max-height: calc(100vh - 140px);
    border-radius: 16px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.18), 0 4px 12px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    z-index: 2001;
    background-color: var(--mud-palette-surface);
    overflow: hidden;
    animation: chatSlideIn 0.35s cubic-bezier(0.16, 1, 0.3, 1);
    border: 1px solid var(--mud-palette-lines-default);
}

@@keyframes chatSlideIn {
    from { 
        opacity: 0; 
        transform: translateY(16px) scale(0.96); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0) scale(1); 
    }
}

.chat-header {
    padding: 14px 16px;
    background: linear-gradient(135deg, var(--mud-palette-primary) 0%, var(--mud-palette-primary-darken) 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
}

.chat-header-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.chat-header-text {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.chat-header-title {
    font-weight: 600;
    font-size: 0.95rem;
    line-height: 1.2;
}

.chat-header-status {
    font-size: 0.75rem;
    opacity: 0.85;
    display: flex;
    align-items: center;
    gap: 4px;
}

.status-dot {
    width: 6px;
    height: 6px;
    background-color: #4ade80;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.chat-header-actions {
    display: flex;
    align-items: center;
    gap: 4px;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    background-color: var(--mud-palette-background-grey);
    scroll-behavior: smooth;
}

/* Scrollbar customizada para mensagens */
.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: transparent;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.15);
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 0, 0, 0.25);
}

.chat-message {
    max-width: 82%;
    padding: 10px 14px;
    border-radius: 16px;
    font-size: 0.875rem;
    line-height: 1.5;
    position: relative;
    animation: messageIn 0.25s ease-out;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

@@keyframes messageIn {
    from { 
        opacity: 0; 
        transform: translateY(8px); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

.chat-message-user {
    align-self: flex-end;
    background: var(--mud-palette-primary);
    color: white;
    border-bottom-right-radius: 4px;
    box-shadow: 0 2px 8px rgba(var(--tenant-primary-rgb, 89, 74, 226), 0.25);
}

.chat-message-assistant {
    align-self: flex-start;
    background: var(--mud-palette-surface);
    color: var(--mud-palette-text-primary);
    border-bottom-left-radius: 4px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    border: 1px solid var(--mud-palette-lines-default);
}

/* Estilos para mensagens colapsadas */
.chat-message.collapsed {
    position: relative;
    max-height: 200px;
    overflow: hidden;
}

.message-expand-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 24px 8px 8px 8px;
    background: linear-gradient(transparent, var(--mud-palette-surface) 60%);
    display: flex;
    justify-content: center;
}

.message-collapse-button {
    display: flex;
    justify-content: center;
    margin-top: 12px;
    padding-top: 8px;
    border-top: 1px solid var(--mud-palette-lines-default);
    width: 100%;
    box-sizing: border-box;
}

/* Estilos para elementos Markdown dentro das mensagens */
.chat-message-assistant p {
    margin: 0 0 8px 0;
}

.chat-message-assistant p:last-child {
    margin-bottom: 0;
}

.chat-message-assistant ul,
.chat-message-assistant ol {
    margin: 8px 0;
    padding-left: 20px;
}

.chat-message-assistant li {
    margin: 4px 0;
}

.chat-message-assistant h1,
.chat-message-assistant h2,
.chat-message-assistant h3,
.chat-message-assistant h4 {
    margin: 12px 0 8px 0;
    font-weight: 600;
}

.chat-message-assistant h1 { font-size: 1.1rem; }
.chat-message-assistant h2 { font-size: 1.05rem; }
.chat-message-assistant h3 { font-size: 1rem; }
.chat-message-assistant h4 { font-size: 0.95rem; }

.chat-message-assistant code {
    background: rgba(0,0,0,0.06);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 0.85em;
}

.chat-message-assistant pre {
    background: rgba(0,0,0,0.06);
    padding: 10px;
    border-radius: 6px;
    overflow-x: auto;
    margin: 8px 0;
}

.chat-message-assistant pre code {
    background: none;
    padding: 0;
}

.chat-message-assistant blockquote {
    border-left: 3px solid var(--mud-palette-primary);
    margin: 8px 0;
    padding-left: 12px;
    color: var(--mud-palette-text-secondary);
}

.chat-message-assistant table {
    border-collapse: collapse;
    margin: 8px 0;
    width: 100%;
    font-size: 0.85rem;
}

.chat-message-assistant th,
.chat-message-assistant td {
    border: 1px solid var(--mud-palette-lines-default);
    padding: 6px 8px;
    text-align: left;
}

.chat-message-assistant th {
    background: rgba(0,0,0,0.04);
    font-weight: 600;
}

.chat-message-assistant strong {
    color: var(--mud-palette-primary);
}

.chat-message-assistant a {
    color: var(--mud-palette-primary);
    text-decoration: underline;
}

.chat-message-assistant hr {
    border: none;
    border-top: 1px solid var(--mud-palette-lines-default);
    margin: 12px 0;
}

.chat-message-error {
    align-self: center;
    background: rgba(var(--mud-palette-error-rgb, 244, 67, 54), 0.1);
    color: var(--mud-palette-error);
    border: 1px solid rgba(var(--mud-palette-error-rgb, 244, 67, 54), 0.3);
    font-size: 0.8rem;
    text-align: center;
    max-width: 90%;
    border-radius: 8px;
}

.chat-input-area {
    padding: 12px 16px;
    background-color: var(--mud-palette-surface);
    border-top: 1px solid var(--mud-palette-lines-default);
    display: flex;
    align-items: flex-end;
    gap: 8px;
    flex-shrink: 0;
}

.chat-input-area ::deep .mud-input-control {
    margin: 0;
}

.chat-input-area ::deep .mud-input-outlined .mud-input-outlined-border {
    border-radius: 20px;
}

.suggested-actions {
    display: flex;
    gap: 6px;
    padding: 10px 16px;
    overflow-x: auto;
    white-space: nowrap;
    background-color: var(--mud-palette-background-grey);
    border-top: 1px solid var(--mud-palette-lines-default);
    scrollbar-width: none;
    flex-shrink: 0;
}

.suggested-actions ::deep .mud-chip {
    flex-shrink: 0;
    cursor: pointer;
    transition: all 0.2s ease;
}

.suggested-actions ::deep .mud-chip:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.suggested-actions::-webkit-scrollbar {
    display: none;
}

.typing-indicator {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 10px 14px;
    background: var(--mud-palette-surface);
    border-radius: 16px;
    width: fit-content;
    border-bottom-left-radius: 4px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    align-self: flex-start;
    border: 1px solid var(--mud-palette-lines-default);
}

.typing-dot {
    width: 7px;
    height: 7px;
    background: var(--mud-palette-text-secondary);
    border-radius: 50%;
    animation: typingBounce 1.4s infinite ease-in-out both;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }
.typing-dot:nth-child(3) { animation-delay: 0s; }

@@keyframes typingBounce {
    0%, 80%, 100% { 
        transform: scale(0.6);
        opacity: 0.5;
    }
    40% { 
        transform: scale(1);
        opacity: 1;
    }
}

.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 32px 24px;
    text-align: center;
    color: var(--mud-palette-text-secondary);
}

.empty-state-icon {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(var(--tenant-primary-rgb, 89, 74, 226), 0.1) 0%, rgba(var(--tenant-primary-rgb, 89, 74, 226), 0.05) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 16px;
}

.send-button {
    border-radius: 50%;
    min-width: 40px;
    width: 40px;
    height: 40px;
    padding: 0;
    transition: all 0.2s ease;
}

.send-button:not(:disabled):hover {
    transform: scale(1.05);
}

.send-button:disabled {
    opacity: 0.5;
}

/* Responsividade */
@@media(max-width: 600px) {
    .chatbot-widget {
        bottom: 16px;
        right: 16px;
    }

    .chatbot-button {
        width: 56px;
        height: 56px;
    }

    .chatbot-window {
        width: calc(100vw - 32px);
        height: calc(100vh - 120px);
        max-height: calc(100vh - 120px);
        bottom: 88px;
        right: 16px;
        border-radius: 16px;
    }
}

@@media(max-width: 400px) {
    .chatbot-window {
        width: 100%;
        height: calc(100vh - 80px);
        max-height: calc(100vh - 80px);
        bottom: 80px;
        right: 0;
        border-radius: 16px 16px 0 0;
    }
}

/* Suporte a tema escuro */
::deep .mud-theme-dark .chat-messages {
    background-color: var(--mud-palette-background);
}

::deep .mud-theme-dark .suggested-actions {
    background-color: var(--mud-palette-background);
}

::deep .mud-theme-dark .chat-messages::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.15);
}

::deep .mud-theme-dark .chat-messages::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.25);
}
</style>