@using erp.DTOs.Chatbot
@using erp.Services
@using MudBlazor
@inject IApiService ApiService
@inject ISnackbar Snackbar

<style>
    .chatbot-widget {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 2000;
        font-family: 'Inter', sans-serif;
    }

    .chatbot-button {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        background: linear-gradient(135deg, var(--mud-palette-primary) 0%, var(--mud-palette-secondary) 100%);
        color: white !important;
    }

    .chatbot-button:hover {
        transform: scale(1.1);
        box-shadow: 0 12px 32px rgba(0,0,0,0.3);
    }

    .chatbot-window {
        position: fixed;
        bottom: 100px;
        right: 24px;
        width: 380px;
        height: 600px;
        max-height: calc(100vh - 120px);
        border-radius: 24px;
        box-shadow: 0 16px 48px rgba(0,0,0,0.25);
        display: flex;
        flex-direction: column;
        z-index: 2001;
        background-color: var(--mud-palette-surface);
        overflow: hidden;
        animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        border: 1px solid var(--mud-palette-lines-default);
    }

    @@keyframes slideIn {
        from { opacity: 0; transform: translateY(20px) scale(0.95); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .chat-header {
        padding: 16px 20px;
        background: linear-gradient(135deg, var(--mud-palette-primary) 0%, var(--mud-palette-primary-darken) 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        background-color: var(--mud-palette-background-grey);
        scroll-behavior: smooth;
    }

    .chat-message {
        max-width: 85%;
        padding: 12px 16px;
        border-radius: 18px;
        font-size: 0.95rem;
        line-height: 1.5;
        position: relative;
        animation: fadeIn 0.3s ease;
        word-wrap: break-word;
    }

    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .chat-message-user {
        align-self: flex-end;
        background: var(--mud-palette-primary);
        color: white;
        border-bottom-right-radius: 4px;
        box-shadow: 0 4px 12px rgba(var(--mud-palette-primary-rgb), 0.3);
    }

    .chat-message-assistant {
        align-self: flex-start;
        background: var(--mud-palette-surface);
        color: var(--mud-palette-text-primary);
        border-bottom-left-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border: 1px solid var(--mud-palette-lines-default);
    }

    .chat-message-error {
        align-self: center;
        background: var(--mud-palette-error-lighten);
        color: var(--mud-palette-error);
        border: 1px solid var(--mud-palette-error);
        font-size: 0.85rem;
        text-align: center;
    }

    .chat-input-area {
        padding: 16px;
        background-color: var(--mud-palette-surface);
        border-top: 1px solid var(--mud-palette-lines-default);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .suggested-actions {
        display: flex;
        gap: 8px;
        padding: 12px 20px;
        overflow-x: auto;
        white-space: nowrap;
        background-color: var(--mud-palette-background-grey);
        border-bottom: 1px solid var(--mud-palette-lines-default);
        scrollbar-width: none; /* Firefox */
    }

    .suggested-actions .mud-chip {
        flex-shrink: 0;
    }
    
    .suggested-actions::-webkit-scrollbar {
        display: none; /* Chrome, Safari */
    }

    .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 12px 16px;
        background: var(--mud-palette-surface);
        border-radius: 18px;
        width: fit-content;
        border-bottom-left-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        align-self: flex-start;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        background: var(--mud-palette-text-secondary);
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out both;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @@keyframes typing {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }

    @@media (max-width: 600px) {
        .chatbot-window {
            width: 100%;
            height: 100%;
            max-height: 100%;
            bottom: 0;
            right: 0;
            border-radius: 0;
        }
        
        .chatbot-button {
            bottom: 16px;
            right: 16px;
        }
    }
</style>

<div class="chatbot-widget">
    @if (_isOpen)
    {
        <div class="chatbot-window">
            <div class="chat-header">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <MudAvatar Color="MudBlazor.Color.Surface" Size="MudBlazor.Size.Medium">
                        <MudIcon Icon="@Icons.Material.Filled.SmartToy" Color="MudBlazor.Color.Primary" Size="MudBlazor.Size.Small"/>
                    </MudAvatar>
                    <div>
                        <MudText Typo="Typo.subtitle1" Style="font-weight: 600; line-height: 1.2;">Assistente Virtual</MudText>
                        <MudText Typo="Typo.caption" Style="opacity: 0.8;">Online</MudText>
                    </div>
                </div>
                <div>
                    <MudIconButton Icon="@Icons.Material.Filled.Remove" 
                                   Color="MudBlazor.Color.Inherit" 
                                   OnClick="MinimizeChatbot"
                                   Size="MudBlazor.Size.Small"
                                   aria-label="Minimizar"/>
                    <MudIconButton Icon="@Icons.Material.Filled.Close" 
                                   Color="MudBlazor.Color.Inherit" 
                                   OnClick="ToggleChatbot"
                                   Size="MudBlazor.Size.Small"
                                   aria-label="Fechar"/>
                </div>
            </div>

            <div class="chat-messages" @ref="_messagesContainer">
                @if (!_messages.Any())
                {
                    <div style="text-align: center; padding: 40px 20px; color: var(--mud-palette-text-secondary); display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
                        <MudIcon Icon="@Icons.Material.Filled.AutoAwesome" Size="MudBlazor.Size.Large" Class="mb-4" Color="MudBlazor.Color.Primary"/>
                        <MudText Typo="Typo.h6" Style="font-weight: 600; margin-bottom: 8px;">Olá! Como posso ajudar?</MudText>
                        <MudText Typo="Typo.body2" Style="max-width: 260px;">
                            Estou aqui para ajudar com produtos, vendas e informações do sistema.
                        </MudText>
                    </div>
                }
                else
                {
                    @foreach (var message in _messages)
                    {
                        <div class="chat-message @(message.IsError ? "chat-message-error" : message.Role == "user" ? "chat-message-user" : "chat-message-assistant")">
                            @if (message.Role == "assistant" && !message.IsError)
                            {
                                // Optional: Add avatar or icon for assistant messages inside the bubble if needed
                            }
                            <MudText Typo="Typo.body2">@message.Content</MudText>
                        </div>
                    }
                    
                    @if (_isProcessing)
                    {
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    }
                }
            </div>

            @if (_suggestedActions.Any())
            {
                <div class="suggested-actions">
                    @foreach (var action in _suggestedActions)
                    {
                        <MudChip T="string"
                                 Size="MudBlazor.Size.Small" 
                                 Color="MudBlazor.Color.Primary" 
                                 Variant="Variant.Outlined"
                                 OnClick="@(() => SendSuggestedAction(action))"
                                 Style="border-radius: 16px; font-weight: 500;">
                            @action
                        </MudChip>
                    }
                </div>
            }

            <div class="chat-input-area">
                <MudTextField @bind-Value="_currentMessage"
                              Placeholder="Digite sua mensagem..."
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              OnKeyDown="HandleKeyDown"
                              Disabled="_isProcessing"
                              Immediate="true"
                              FullWidth="true"
                              Class="rounded-pill"
                              Style="background-color: var(--mud-palette-background);"/>
                <MudIconButton Icon="@Icons.Material.Filled.Send" 
                               Color="MudBlazor.Color.Primary" 
                               OnClick="SendMessage"
                               Disabled="@(string.IsNullOrWhiteSpace(_currentMessage) || _isProcessing)"
                               Size="MudBlazor.Size.Medium"/>
            </div>
        </div>
    }

    <MudIconButton Icon="@(_isOpen ? Icons.Material.Filled.Close : Icons.Material.Filled.SmartToy)" 
                   Class="chatbot-button"
                   OnClick="ToggleChatbot"
                   Size="MudBlazor.Size.Large"
                   aria-label="@(_isOpen ? "Fechar Assistente Virtual" : "Abrir Assistente Virtual")"/>
</div>

@code {
    private bool _isOpen = false;
    private bool _isProcessing = false;
    private string _currentMessage = string.Empty;
    private List<ChatMessageDto> _messages = new();
    private List<string> _suggestedActions = new();
    private ElementReference _messagesContainer;

    protected override void OnInitialized()
    {
        // Carregar mensagens salvas do localStorage se necessário
        base.OnInitialized();
    }

    private void ToggleChatbot()
    {
        _isOpen = !_isOpen;
        
        if (_isOpen && !_messages.Any())
        {
            // Mostrar sugestões iniciais
            _suggestedActions = new List<string>
            {
                "O que você pode fazer?",
                "Listar produtos",
            };
        }
    }

    private void MinimizeChatbot()
    {
        _isOpen = false;
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await SendMessage();
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_currentMessage) || _isProcessing)
            return;

        var userMessage = _currentMessage.Trim();
        _currentMessage = string.Empty;

        // Adicionar mensagem do usuário
        _messages.Add(new ChatMessageDto
        {
            Role = "user",
            Content = userMessage,
            Timestamp = DateTime.UtcNow
        });

        _isProcessing = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            // Enviar para o backend
            var request = new ChatRequestDto
            {
                Message = userMessage,
                ConversationHistory = _messages.Where(m => !m.IsError).ToList()
            };

            var response = await ApiService.PostAsync<ChatResponseDto>("api/chatbot/message", request);

            if (response?.Success == true)
            {
                // Adicionar resposta do assistente
                _messages.Add(new ChatMessageDto
                {
                    Role = "assistant",
                    Content = response.Response,
                    Timestamp = DateTime.UtcNow
                });

                // Atualizar sugestões
                if (response.SuggestedActions?.Any() == true)
                {
                    _suggestedActions = response.SuggestedActions;
                }
            }
            else
            {
                _messages.Add(new ChatMessageDto
                {
                    Role = "assistant",
                    Content = response?.Error ?? "Erro ao processar mensagem.",
                    Timestamp = DateTime.UtcNow,
                    IsError = true
                });
            }
        }
        catch (Exception ex)
        {
            _messages.Add(new ChatMessageDto
            {
                Role = "assistant",
                Content = $"Erro: {ex.Message}",
                Timestamp = DateTime.UtcNow,
                IsError = true
            });
            Snackbar.Add("Erro ao comunicar com o assistente", Severity.Error);
        }
        finally
        {
            _isProcessing = false;
            await InvokeAsync(StateHasChanged);
            
            // Scroll para o final
            // Note: Para scroll automático, considere usar JS Interop
        }
    }

    private async Task SendSuggestedAction(string action)
    {
        _currentMessage = action;
        await SendMessage();
    }
}
