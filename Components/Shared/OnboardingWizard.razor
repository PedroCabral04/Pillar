@using erp.DTOs.Onboarding
@using erp.Services.Onboarding
@using Microsoft.AspNetCore.Components.Authorization
@using MudBlazor
@using TourDto = erp.DTOs.Onboarding.OnboardingTour
@using StepDto = erp.DTOs.Onboarding.OnboardingStep
@inject IOnboardingService OnboardingService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject erp.Services.Onboarding.IOnboardingResumeService ResumeService

<MudDialog DisableSidePadding="true" Class="onboarding-wizard-dialog">
    <DialogContent>
        @if (CurrentStep != null)
        {
            <div class="d-flex flex-column align-center justify-center pa-6" style="min-height: 400px;">
                <div class="mb-6">
                    @if (CurrentStep.Id == "welcome")
                    {
                        <MudIcon Icon="@Icons.Material.Filled.WavingHand" Size="MudBlazor.Size.Large" Color="MudBlazor.Color.Primary" Style="font-size: 4rem;" />
                    }
                    else if (CurrentStep.Id == "security")
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Security" Size="MudBlazor.Size.Large" Color="MudBlazor.Color.Secondary" Style="font-size: 4rem;" />
                    }
                    else if (CurrentStep.Id == "customization")
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Palette" Size="MudBlazor.Size.Large" Color="MudBlazor.Color.Tertiary" Style="font-size: 4rem;" />
                    }
                    else if (CurrentStep.Id == "modules")
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Apps" Size="MudBlazor.Size.Large" Color="MudBlazor.Color.Info" Style="font-size: 4rem;" />
                    }
                    else if (CurrentStep.Id == "dashboard")
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Dashboard" Size="MudBlazor.Size.Large" Color="MudBlazor.Color.Warning" Style="font-size: 4rem;" />
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="MudBlazor.Size.Large" Color="MudBlazor.Color.Success" Style="font-size: 4rem;" />
                    }
                </div>

                <MudText Typo="Typo.h4" Align="MudBlazor.Align.Center" Class="mb-4">@CurrentStep.Title</MudText>
                
                <MudText Typo="Typo.body1" Align="MudBlazor.Align.Center" Class="mb-6" Style="max-width: 500px;">
                    @CurrentStep.Description
                </MudText>

                @if (!string.IsNullOrEmpty(CurrentStep.Target) && CurrentStep.Target.StartsWith("/"))
                {
                    <MudButton Variant="Variant.Outlined" 
                              Color="MudBlazor.Color.Primary" 
                              OnClick="@(() => NavigateTo(CurrentStep.Target))"
                              Class="mb-4"
                              Disabled="@_isProcessing">
                        Ir para página
                    </MudButton>
                }

                <div class="d-flex justify-center gap-2 mt-auto w-100">
                    
                    @if (CurrentStepIndex > 0)
                    {
                        <MudButton OnClick="PreviousStep" Variant="Variant.Text" Disabled="@_isProcessing">Voltar</MudButton>
                    }
                    
                    <MudSpacer />
                    
                    <div class="d-flex align-center gap-1">
                        @for (int i = 0; i < (CurrentTour?.Steps.Count ?? 0); i++)
                        {
                            var index = i;
                            <div class="@(index == CurrentStepIndex ? "mud-theme-primary" : "mud-theme-secondary")" 
                                 style="width: 8px; height: 8px; border-radius: 50%; opacity: @(index == CurrentStepIndex ? 1 : 0.3);">
                            </div>
                        }
                    </div>
                    
                    <MudSpacer />

                    @if (CurrentStepIndex < (CurrentTour?.Steps.Count ?? 0) - 1)
                    {
                        <MudButton OnClick="NextStep" Variant="Variant.Filled" Color="MudBlazor.Color.Primary" Disabled="@_isProcessing">
                            @if (_isProcessing)
                            {
                                <MudProgressCircular Class="ms-n1" Size="MudBlazor.Size.Small" Indeterminate="true"/>
                                <MudText Class="ms-2">Processando</MudText>
                            }
                            else
                            {
                                <MudText>Próximo</MudText>
                            }
                        </MudButton>
                    }
                    else
                    {
                        <MudButton OnClick="CompleteTour" Variant="Variant.Filled" Color="MudBlazor.Color.Success" Disabled="@_isProcessing">
                            @if (_isProcessing)
                            {
                                <MudProgressCircular Class="ms-n1" Size="MudBlazor.Size.Small" Indeterminate="true"/>
                                <MudText Class="ms-2">Processando</MudText>
                            }
                            else
                            {
                                <MudText>Começar!</MudText>
                            }
                        </MudButton>
                    }
                </div>
            </div>
        }
    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;
    
    [Parameter] public string TourId { get; set; } = "getting-started";
    [Parameter] public string UserId { get; set; } = string.Empty;

    private TourDto? CurrentTour;
    private StepDto? CurrentStep;
    private int CurrentStepIndex = 0;
    private bool _isProcessing = false;

    protected override async Task OnInitializedAsync()
    {
        CurrentTour = OnboardingService.GetTourById(TourId);

        // Try to load saved progress for this user and resume where left off
        if (!string.IsNullOrEmpty(UserId))
        {
            var progress = await OnboardingService.GetUserProgressAsync(UserId, TourId);
            if (progress != null)
            {
                // progress.CurrentStep stores the number of completed steps (1-based count)
                // We want to resume at the next step index (0-based)
                CurrentStepIndex = progress.CurrentStep;
            }
        }

        if (CurrentTour != null && CurrentTour.Steps.Any())
        {
            if (CurrentStepIndex < 0) CurrentStepIndex = 0;
            if (CurrentStepIndex >= CurrentTour.Steps.Count) CurrentStepIndex = CurrentTour.Steps.Count - 1;
            CurrentStep = CurrentTour.Steps[CurrentStepIndex];
        }
    }

    private async Task NextStep()
    {
        if (_isProcessing) return;
        if (CurrentTour == null || CurrentStepIndex >= CurrentTour.Steps.Count - 1) return;

        try
        {
            _isProcessing = true;
            CurrentStepIndex++;
            CurrentStep = CurrentTour.Steps[CurrentStepIndex];
            
            // Save progress
            if (!string.IsNullOrEmpty(UserId))
            {
                // Mark the previous step as completed (service expects 0-based index)
                await OnboardingService.CompleteStepAsync(UserId, TourId, CurrentStepIndex - 1);
            }
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private void PreviousStep()
    {
        if (_isProcessing) return;
        if (CurrentStepIndex <= 0) return;

        CurrentStepIndex--;
        CurrentStep = CurrentTour!.Steps[CurrentStepIndex];
    }

    private async Task CompleteTour()
    {
        if (_isProcessing) return;

        try
        {
            _isProcessing = true;
            if (!string.IsNullOrEmpty(UserId))
            {
                await OnboardingService.CompleteTourAsync(UserId, TourId);
            }
            MudDialog.Close(DialogResult.Ok(true));
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private async Task NavigateTo(string url)
    {
        if (_isProcessing) return;

        try
        {
            _isProcessing = true;
            // When navigating away from the wizard to a target page, persist the current step as completed
            if (!string.IsNullOrEmpty(UserId))
            {
                await OnboardingService.CompleteStepAsync(UserId, TourId, CurrentStepIndex);
            }

            // Close dialog first so navigation is clean; MainLayout will reopen the wizard at saved step
            try
            {
                MudDialog.Close(DialogResult.Ok(false));
            }
            catch {}

            // Mark resume pending for the layout and show a simple info snackbar
            if (!string.IsNullOrEmpty(UserId))
            {
                ResumeService.SetPendingResume(UserId, TourId);
            }

            Snackbar.Add("Você pode continuar o tour quando quiser. Use o botão 'Continuar tour' no canto inferior direito.", Severity.Info, config =>
            {
                config.VisibleStateDuration = 8000;
                config.HideTransitionDuration = 300;
                config.ShowTransitionDuration = 200;
                config.SnackbarVariant = Variant.Filled;
                config.Action = "Continuar";
                config.ActionVariant = Variant.Filled;
                config.ActionColor = MudBlazor.Color.Primary;
                config.OnClick = async snackbar =>
                {
                    // Clear pending marker and reopen the wizard dialog to resume
                    ResumeService.ClearPendingResume();
                    var parameters = new DialogParameters { ["TourId"] = TourId, ["UserId"] = UserId };
                    var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium };
                    await DialogService.ShowAsync<OnboardingWizard>("", parameters, options);
                };
            });

            NavigationManager.NavigateTo(url);
        }
        finally
        {
            _isProcessing = false;
        }
    }
}
