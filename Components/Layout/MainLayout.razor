@using MudBlazor
@using erp.Services
@using erp.Services.Browser
@using erp.Services.Tenancy
@using erp.Components.Branding
@inherits LayoutComponentBase
@inject ThemeService ThemeService
@inject PreferenceService PreferenceService
@inject IBrowserService BrowserService
@inject IJSRuntime JsRuntime
@inject ITenantBrandingProvider BrandingProvider
@inject IDialogService DialogService
@inject erp.Services.Onboarding.IOnboardingService OnboardingService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject erp.Services.Onboarding.IOnboardingResumeService OnboardingResumeService
@inject ISnackbar Snackbar
@implements IAsyncDisposable

<TenantBrandingHead Branding="@_branding" />

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

<MudThemeProvider @ref="@_mudThemeProvider" @bind-IsDarkMode="ThemeService.IsDarkMode" Theme="@ThemeService.Theme" />
<MudPopoverProvider />
<MudDialogProvider MaxWidth="MaxWidth.Medium" FullWidth="true" CloseOnEscapeKey="true" CloseButton="true"/>
<MudSnackbarProvider />

@if (PreferenceService.CurrentPreferences.Ui.ReduceMotion)
{
    <style>
        *, *::before, *::after {
            animation-duration: 0.001s !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.001s !important;
            scroll-behavior: auto !important;
        }
    </style>
}

<MudLayout>
    <!-- Desktop: Topbar Navigation (when explicitly selected in preferences) -->
    <MudHidden Breakpoint="Breakpoint.SmAndDown" Invert="false">
        @if (IsTopbarNavigation)
        {
            <NavMenuTopbar />
            <MudMainContent Class="pa-4" Style="@MainContentStyleTopbar()">
                <div class="mb-4">
                    <erp.Components.Shared.Breadcrumbs />
                </div>
                @Body
            </MudMainContent>
        }
        else
        {
            <!-- Desktop: Sidebar Navigation -->
            <MudAppBar Elevation="0" Color="MudBlazor.Color.Surface" Fixed="true" ClipMode="DrawerClipMode.Always" Style="border-bottom: 1px solid var(--mud-palette-lines-default);">
                <MudIconButton Icon="@(_isSidebarLocked ? Icons.Material.Filled.MenuOpen : Icons.Material.Filled.Menu)"
                               Color="MudBlazor.Color.Inherit"
                               Edge="Edge.Start"
                               OnClick="@ToggleDrawer"
                               Class="mr-3"
                               aria-label="@(_isSidebarLocked ? "Recolher menu lateral" : "Expandir menu lateral")" />
                
                <div class="d-flex align-center">
                    <MudAvatar Size="MudBlazor.Size.Medium"
                               Class="me-2"
                               Square="true"
                               Image="@_branding.LogoUrl"
                               Text="@_branding.Initials"
                               Style="@($"background-color:{_branding.PrimaryColor};color:white;")" />
                    <MudText Typo="Typo.h6" Style="font-weight: 600;">@_branding.TenantName</MudText>
                </div>

                <MudSpacer />
                
                @* <MudHidden Breakpoint="Breakpoint.SmAndDown">
                    <MudTextField @bind-Value="@_searchString" Placeholder="Pesquisar..." Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="MudBlazor.Size.Medium" Class="mt-0 mx-4" Variant="Variant.Outlined" Margin="Margin.Dense" Style="background-color: var(--mud-palette-background); border-radius: 8px; width: 300px;" />
                </MudHidden> *@

                <AuthorizeView>
                    <Authorized Context="auth">
                        <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" LockScroll="true">
                            <ActivatorContent>
                                <MudChip T="string" Icon="@Icons.Material.Filled.Person" Color="MudBlazor.Color.Surface">@auth.User.Identity?.Name</MudChip>
                            </ActivatorContent>
                            <ChildContent>
                                <MudMenuItem Href="/settings" Icon="@Icons.Material.Filled.Settings">Configurações</MudMenuItem>
                                <MudMenuItem OnClick="LogoutAsync" Icon="@Icons.Material.Filled.Logout">Sair</MudMenuItem>
                            </ChildContent>
                        </MudMenu>
                    </Authorized>
                    <NotAuthorized>
                        <MudButton Href="/login" Variant="Variant.Text" Color="MudBlazor.Color.Primary">Entrar</MudButton>
                    </NotAuthorized>
                </AuthorizeView>
            </MudAppBar>

            <MudDrawer id="nav-drawer"
                       Fixed="true"
                       Variant="@(_isSidebarLocked ? DrawerVariant.Persistent : DrawerVariant.Mini)"
                       Open="@(_isSidebarLocked || _isMouseOver)"
                       OpenMiniOnHover="false"
                       ClipMode="DrawerClipMode.Always"
                       Elevation="0"
                       Width="250px"
                       MiniWidth="64px"
                       Style="border-right: 1px solid var(--mud-palette-lines-default);"
                       @onmouseenter="OnSidebarMouseEnter"
                       @onmouseleave="OnSidebarMouseLeave">
                <erp.Components.Shared.Sidebar IsOpen="@(_isSidebarLocked || _isMouseOver)" OnToggleDrawer="@ToggleDrawer" />
            </MudDrawer>

            <MudMainContent Class="pa-4 full-height-content" Style="@MainContentStyle()">
                <div class="mb-4">
                    <erp.Components.Shared.Breadcrumbs />
                </div>
                @Body
            </MudMainContent>

            <MudScrollToTop>
                <MudFab Color="MudBlazor.Color.Tertiary" StartIcon="@Icons.Material.Filled.ArrowCircleUp" />
            </MudScrollToTop>
        }
    </MudHidden>
    
    <!-- Mobile: Adaptive Navigation with Drawer + Bottom Nav -->
    <MudHidden Breakpoint="Breakpoint.SmAndDown" Invert="true">
        @if (_mobileDrawerOpen)
        {
            <div class="mobile-drawer-backdrop" @onclick="@CloseMobileDrawer"></div>
            <div class="mobile-drawer @(_mobileDrawerOpen ? "open" : string.Empty)">
                <erp.Components.Shared.Sidebar IsOpen="true" OnToggleDrawer="@CloseMobileDrawer" IsMobile="true" />
            </div>
        }
        
        <MudMainContent Class="mobile-content-no-topbar">
            @Body
        </MudMainContent>
        
        <MobileBottomNav />
    </MudHidden>
    
    <!-- Chatbot Widget (available on all layouts) -->
    <erp.Components.Shared.ChatbotWidget />

    @* Continue-tour floating button shown when user navigated away from a tour step *@
    @if (OnboardingResumeService?.HasPending == true)
    {
        <div style="position:fixed; right:16px; bottom:90px; z-index:1300;">
            <MudTooltip Text="Continuar tour">
                <MudFab Color="MudBlazor.Color.Primary" StartIcon="@Icons.Material.Filled.PlayArrow" OnClick="OpenResumeTour">
                    Continuar
                </MudFab>
            </MudTooltip>
        </div>
    }
</MudLayout>

@code {
    private bool _drawerOpen = true; // Kept for mobile drawer logic if needed, but desktop uses _isSidebarLocked
    private bool _isSidebarLocked = true;
    private bool _isMouseOver = false;
    private System.Threading.CancellationTokenSource? _closeCts;
    private IJSObjectReference? _activityMonitor;
    private IJSObjectReference? _shortcutsModule;
    private DotNetObjectReference<MainLayout>? _dotNetRef;

    private bool _mobileDrawerOpen;
    private int _unreadNotifications;
    private MudThemeProvider _mudThemeProvider = null!;
    public bool IsDarkMode;
    private string? _currentUrl;
    private bool _isMobileView;
    private bool _brandingInitialized;
    private string? _searchString;

    private TenantBrandingTheme _branding = TenantBrandingTheme.Default;

    [Inject] private NavigationManager NavigationManager { get; set; } = null!;

    private bool IsTopbarNavigation => 
        PreferenceService.CurrentPreferences?.Ui?.NavigationType == "topbar";

    protected override void OnInitialized()
    {
        ApplyTenantBranding();
        // Subscribe to resume requests
        if (OnboardingResumeService != null) OnboardingResumeService.Changed += OnboardingResumeChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await PreferenceService.InitializeAsync();
            ThemeService.InitializeTheme();
            ApplyCulture();
            ApplySidebarPreference();
            PreferenceService.OnPreferenceChanged += OnPreferenceChanged;
            
            // Detecta se é mobile
            try
            {
                _isMobileView = await JsRuntime.InvokeAsync<bool>("erpResponsive.isMobile");
                
                // Fecha o drawer por padrão no mobile
                if (_isMobileView)
                {
                    _drawerOpen = false;
                    _isSidebarLocked = false;
                }

                // Setup Auto Logout
                _dotNetRef = DotNetObjectReference.Create(this);
                var timeout = PreferenceService.CurrentPreferences.Security.AutoLogoutMinutes;
                _activityMonitor = await JsRuntime.InvokeAsync<IJSObjectReference>("erpAuth.monitorActivity", _dotNetRef, timeout);

                // Setup Keyboard Shortcuts
                if (PreferenceService.CurrentPreferences.Ui.KeyboardShortcutsEnabled)
                {
                    _shortcutsModule = await JsRuntime.InvokeAsync<IJSObjectReference>("erpShortcuts.initialize", _dotNetRef);
                }
            }
            catch (JSDisconnectedException)
            {
                // Ignore exception if circuit is disconnected
            }
            catch (TaskCanceledException)
            {
                // Ignore exception if task is canceled
            }
            catch (Exception)
            {
                // Fallback safely if JS fails
                _isMobileView = false;
            }

            // Check Onboarding
            await CheckOnboardingAsync();
            
            StateHasChanged();
        }
    }

    protected override void OnParametersSet()
    {
        ApplyTenantBranding();
    }

    public async ValueTask DisposeAsync()
    {
        PreferenceService.OnPreferenceChanged -= OnPreferenceChanged;
        _closeCts?.Cancel();
        _closeCts?.Dispose();
        _dotNetRef?.Dispose();
        if (OnboardingResumeService != null) OnboardingResumeService.Changed -= OnboardingResumeChanged;
        
        if (_activityMonitor != null)
        {
            try { await _activityMonitor.InvokeVoidAsync("dispose"); await _activityMonitor.DisposeAsync(); } catch {}
        }
        
        if (_shortcutsModule != null)
        {
            try { await _shortcutsModule.InvokeVoidAsync("dispose"); await _shortcutsModule.DisposeAsync(); } catch {}
        }
    }

    

    private void OnboardingResumeChanged()
    {
        // Trigger UI update on circuit
        InvokeAsync(StateHasChanged);
    }

    private async Task OpenResumeTour()
    {
        var pending = OnboardingResumeService.GetPending();
        if (pending == null) return;

        var (userId, tourId) = pending.Value;
        var parameters = new DialogParameters
        {
            { "UserId", userId },
            { "TourId", tourId }
        };
        var options = new DialogOptions { CloseOnEscapeKey = false, BackdropClick = false, MaxWidth = MaxWidth.Medium, FullWidth = false };

        await DialogService.ShowAsync<erp.Components.Shared.OnboardingWizard>("Continuar tour", parameters, options);
        OnboardingResumeService.ClearPendingResume();
    }

    private void ToggleDrawer()
    {
        if (_isMobileView)
        {
            _drawerOpen = !_drawerOpen; // Mobile logic uses _drawerOpen? Wait, mobile uses _mobileDrawerOpen in markup
            // Actually mobile drawer uses _mobileDrawerOpen in markup:
            // <div class="mobile-drawer @(_mobileDrawerOpen ? "open" : string.Empty)">
            // But the toggle button in AppBar calls ToggleDrawer.
            // Let's check AppBar logic.
            // AppBar is hidden on mobile? No.
            // MudHidden Breakpoint="Breakpoint.SmAndDown" Invert="false" wraps the Sidebar Navigation (AppBar + Drawer).
            // So on mobile, this AppBar is HIDDEN.
            // Mobile has its own navigation?
            // "Mobile: Adaptive Navigation with Drawer + Bottom Nav"
            // <MudHidden Breakpoint="Breakpoint.SmAndDown" Invert="true"> ... <MobileBottomNav /> ... </MudHidden>
            // So ToggleDrawer is only called on Desktop.
        }
        
        _isSidebarLocked = !_isSidebarLocked;
        if (_isSidebarLocked)
        {
            _isMouseOver = false; // Reset hover state when locking
        }
    }

    private void OnSidebarMouseEnter()
    {
        if (!_isSidebarLocked)
        {
            _closeCts?.Cancel();
            _isMouseOver = true;
        }
    }

    private void OnSidebarMouseLeave()
    {
        if (!_isSidebarLocked)
        {
            _closeCts?.Cancel();
            _closeCts = new System.Threading.CancellationTokenSource();
            var token = _closeCts.Token;
            
            Task.Delay(2000, token).ContinueWith(t => 
            {
                if (!t.IsCanceled)
                {
                    InvokeAsync(() => 
                    {
                        _isMouseOver = false;
                        StateHasChanged();
                    });
                }
            });
        }
    }

    private void CloseMobileDrawer()
    {
        _mobileDrawerOpen = false;
        _ = BrowserService.UnlockScrollAsync();
    }

    private async Task LogoutAsync()
    {
        var parameters = new DialogParameters
        {
            { "ContentText", "Tem certeza que deseja sair do sistema?" },
            { "ButtonText", "Sair" },
            { "Color", MudBlazor.Color.Error }
        };

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<erp.Components.Shared.Dialogs.ConfirmDialog>("Confirmar saída", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            try
            {
                await JsRuntime.InvokeVoidAsync("erpAuth.logout");
                NavigationManager.NavigateTo("/login", forceLoad: true);
            }
            catch
            {
                NavigationManager.NavigateTo("/login", forceLoad: true);
            }
        }
    }

    private async void OnPreferenceChanged()
    {
        ApplyCulture();
        ApplySidebarPreference();
        await UpdateAutoLogout();
        await UpdateKeyboardShortcuts();
        await InvokeAsync(StateHasChanged);
    }

    private void ApplySidebarPreference()
    {
        // Apply sidebar persistent preference (only for desktop)
        if (!_isMobileView)
        {
            _isSidebarLocked = PreferenceService.CurrentPreferences.Ui.SidebarPersistent;
        }
    }

    private async Task UpdateKeyboardShortcuts()
    {
        try
        {
            if (PreferenceService.CurrentPreferences.Ui.KeyboardShortcutsEnabled && _shortcutsModule == null)
            {
                // Enable shortcuts
                _shortcutsModule = await JsRuntime.InvokeAsync<IJSObjectReference>("erpShortcuts.initialize", _dotNetRef);
            }
            else if (!PreferenceService.CurrentPreferences.Ui.KeyboardShortcutsEnabled && _shortcutsModule != null)
            {
                // Disable shortcuts
                await _shortcutsModule.InvokeVoidAsync("dispose");
                await _shortcutsModule.DisposeAsync();
                _shortcutsModule = null;
            }
        }
        catch { }
    }

    [JSInvokable]
    public async Task LogoutFromActivity()
    {
        try
        {
            await JsRuntime.InvokeVoidAsync("erpAuth.logout");
            NavigationManager.NavigateTo("/login?reason=timeout", forceLoad: true);
        }
        catch
        {
            NavigationManager.NavigateTo("/login", forceLoad: true);
        }
    }

    [JSInvokable]
    public void NavigateFromShortcut(string route)
    {
        NavigationManager.NavigateTo(route);
    }

    [JSInvokable]
    public void ToggleSidebarFromShortcut()
    {
        ToggleDrawer();
        InvokeAsync(StateHasChanged);
    }
    
    private async Task UpdateAutoLogout()
    {
        if (_activityMonitor != null)
        {
            var timeout = PreferenceService.CurrentPreferences.Security.AutoLogoutMinutes;
            try { await _activityMonitor.InvokeVoidAsync("updateTimeout", timeout); } catch {}
        }
    }

    private async Task CheckOnboardingAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (!string.IsNullOrEmpty(userId))
            {
                var hasCompleted = await OnboardingService.HasCompletedOnboardingAsync(userId);
                if (!hasCompleted)
                {
                    var options = new DialogOptions 
                    { 
                        CloseOnEscapeKey = false,
                        BackdropClick = false,
                        MaxWidth = MaxWidth.Medium,
                        FullWidth = false
                    };
                    
                    var parameters = new DialogParameters
                    {
                        { "UserId", userId },
                        { "TourId", "getting-started" }
                    };

                    await DialogService.ShowAsync<erp.Components.Shared.OnboardingWizard>("Bem-vindo", parameters, options);
                }
            }
        }
    }

    private void ApplyCulture()
    {
        var prefs = PreferenceService.CurrentPreferences.Locale;
        if (string.IsNullOrEmpty(prefs.Language)) return;

        try 
        {
            var culture = (System.Globalization.CultureInfo)System.Globalization.CultureInfo.GetCultureInfo(prefs.Language).Clone();
            
            // Apply Date Format
            if (!string.IsNullOrEmpty(prefs.DateFormat))
            {
                culture.DateTimeFormat.ShortDatePattern = prefs.DateFormat;
            }
            
            // Apply Number Format
            if (prefs.NumberFormat == "1.234,56")
            {
                culture.NumberFormat.NumberGroupSeparator = ".";
                culture.NumberFormat.NumberDecimalSeparator = ",";
            }
            else if (prefs.NumberFormat == "1,234.56")
            {
                culture.NumberFormat.NumberGroupSeparator = ",";
                culture.NumberFormat.NumberDecimalSeparator = ".";
            }
            
            // Apply Currency
            if (!string.IsNullOrEmpty(prefs.Currency))
            {
                culture.NumberFormat.CurrencySymbol = prefs.Currency == "BRL" ? "R$" : 
                                                      prefs.Currency == "USD" ? "$" : 
                                                      prefs.Currency == "EUR" ? "€" : prefs.Currency;
            }

            System.Globalization.CultureInfo.CurrentCulture = culture;
            System.Globalization.CultureInfo.CurrentUICulture = culture;
        }
        catch {}
    }

    private void ApplyTenantBranding()
    {
        var branding = BrandingProvider.GetCurrentBranding();
        if (_brandingInitialized && branding == _branding)
        {
            return;
        }

        _branding = branding;
        ThemeService.UpdatePrimaryColor(_branding.PrimaryColor);
        _brandingInitialized = true;
    }

    private string MainContentStyle()
    {
        // No mobile, CSS media queries controlam o layout
        // No desktop, MudDrawerContainer controla automaticamente
        var style = "flex: 1 1 auto; min-height: 0; overflow-y: auto;";
        
        if (PreferenceService.CurrentPreferences?.Ui?.FontSize == "small")
        {
            style += "font-size: 0.9rem;";
        }
        else if (PreferenceService.CurrentPreferences?.Ui?.FontSize == "large")
        {
            style += "font-size: 1.1rem;";
        }
        return style;
    }

    private string MainContentStyleTopbar()
    {
        var style = "min-height: calc(100vh - 64px);";
        if (PreferenceService.CurrentPreferences?.Ui?.FontSize == "small")
        {
            style += "font-size: 0.9rem;";
        }
        else if (PreferenceService.CurrentPreferences?.Ui?.FontSize == "large")
        {
            style += "font-size: 1.1rem;";
        }
        return style;
    }
}
