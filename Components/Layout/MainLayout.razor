@using MudBlazor
@using erp.Services
@using erp.Services.Browser
@using erp.Services.Tenancy
@using erp.Components.Branding
@inherits LayoutComponentBase
@inject ThemeService ThemeService
@inject PreferenceService PreferenceService
@inject IBrowserService BrowserService
@inject IJSRuntime JsRuntime
@inject ITenantBrandingProvider BrandingProvider
@inject IDialogService DialogService
@implements IDisposable

<TenantBrandingHead Branding="@_branding" />

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

<MudThemeProvider @ref="@_mudThemeProvider" @bind-IsDarkMode="ThemeService.IsDarkMode" Theme="@_customTheme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />
<MudLayout>
    <!-- Desktop: Topbar Navigation (when explicitly selected in preferences) -->
    <MudHidden Breakpoint="Breakpoint.SmAndDown" Invert="false">
        @if (IsTopbarNavigation)
        {
            <NavMenuTopbar />
            <MudMainContent Class="pa-4" Style="@MainContentStyleTopbar()">
                <div class="mb-4">
                    <erp.Components.Shared.Breadcrumbs />
                </div>
                @Body
            </MudMainContent>
        }
        else
        {
            <!-- Desktop: Sidebar Navigation -->
            <MudAppBar Elevation="1" Color="MudBlazor.Color.Surface" Fixed="true" ClipMode="DrawerClipMode.Always">
                <MudIconButton Icon="@(_drawerOpen ? Icons.Material.Filled.MenuOpen : Icons.Material.Filled.Menu)"
                               Color="MudBlazor.Color.Inherit"
                               Edge="Edge.Start"
                               OnClick="@ToggleDrawer"
                               Class="mr-3" />
                
                <div class="d-flex align-center">
                    <MudAvatar Size="MudBlazor.Size.Medium"
                               Class="me-2"
                               Square="true"
                               Image="@_branding.LogoUrl"
                               Text="@_branding.Initials"
                               Style="@($"background-color:{_branding.PrimaryColor};color:white;")" />
                    <MudText Typo="Typo.h6" Style="font-weight: 600;">@_branding.TenantName</MudText>
                </div>

                <MudSpacer />

                <AuthorizeView>
                    <Authorized Context="auth">
                        <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" LockScroll="true">
                            <ActivatorContent>
                                <MudChip T="string" Icon="@Icons.Material.Filled.Person" Color="MudBlazor.Color.Surface">@auth.User.Identity?.Name</MudChip>
                            </ActivatorContent>
                            <ChildContent>
                                <MudMenuItem Href="/settings" Icon="@Icons.Material.Filled.Settings">Configurações</MudMenuItem>
                                <MudMenuItem OnClick="LogoutAsync" Icon="@Icons.Material.Filled.Logout">Sair</MudMenuItem>
                            </ChildContent>
                        </MudMenu>
                    </Authorized>
                    <NotAuthorized>
                        <MudButton Href="/login" Variant="Variant.Text" Color="MudBlazor.Color.Primary">Entrar</MudButton>
                    </NotAuthorized>
                </AuthorizeView>
            </MudAppBar>

            <MudDrawer id="nav-drawer"
                       Fixed="true"
                       Variant="@(_drawerOpen ? DrawerVariant.Persistent : DrawerVariant.Mini)"
                       OpenMiniOnHover="true"
                       @bind-Open="_drawerOpen"
                       ClipMode="DrawerClipMode.Always"
                       Elevation="0"
                       Width="240px"
                       MiniWidth="56px">
                <erp.Components.Shared.Sidebar IsOpen="_drawerOpen" OnToggleDrawer="@ToggleDrawer" />
            </MudDrawer>

            <MudMainContent Class="pa-4 full-height-content" Style="@MainContentStyle()">
                <div class="mb-4">
                    <erp.Components.Shared.Breadcrumbs />
                </div>
                @Body
            </MudMainContent>

            <MudScrollToTop>
                <MudFab Color="MudBlazor.Color.Tertiary" StartIcon="@Icons.Material.Filled.ArrowCircleUp" />
            </MudScrollToTop>
        }
    </MudHidden>
    
    <!-- Mobile: Adaptive Navigation with Drawer + Bottom Nav -->
    <MudHidden Breakpoint="Breakpoint.SmAndDown" Invert="true">
        @if (_mobileDrawerOpen)
        {
            <div class="mobile-drawer-backdrop" @onclick="@CloseMobileDrawer"></div>
            <div class="mobile-drawer @(_mobileDrawerOpen ? "open" : string.Empty)">
                <erp.Components.Shared.Sidebar IsOpen="true" OnToggleDrawer="@CloseMobileDrawer" IsMobile="true" />
            </div>
        }
        
        <MudMainContent Class="mobile-content-no-topbar">
            @Body
        </MudMainContent>
        
        <MobileBottomNav />
    </MudHidden>
    
    <!-- Chatbot Widget (available on all layouts) -->
    <erp.Components.Shared.ChatbotWidget />
</MudLayout>

@code {
    private bool _drawerOpen = true;
    private bool _mobileDrawerOpen;
    private int _unreadNotifications;
    private MudThemeProvider _mudThemeProvider = null!;
    public bool IsDarkMode;
    private string? _currentUrl;
    private bool _isMobileView;
    private bool _brandingInitialized;

    private MudTheme _customTheme = TenantBrandingThemeBuilder.BuildTheme(TenantBrandingTheme.Default);
    private TenantBrandingTheme _branding = TenantBrandingTheme.Default;

    [Inject] private NavigationManager NavigationManager { get; set; } = null!;

    private bool IsTopbarNavigation => 
        PreferenceService.CurrentPreferences?.Ui?.NavigationType == "topbar";

    protected override void OnInitialized()
    {
        ApplyTenantBranding();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await PreferenceService.InitializeAsync();
            ThemeService.InitializeTheme();
            PreferenceService.OnPreferenceChanged += OnPreferenceChanged;
            
            // Detecta se é mobile
            try
            {
                _isMobileView = await JsRuntime.InvokeAsync<bool>("erpResponsive.isMobile");
                
                // Fecha o drawer por padrão no mobile
                if (_isMobileView)
                {
                    _drawerOpen = false;
                }
            }
            catch (JSDisconnectedException)
            {
                // Ignore exception if circuit is disconnected
            }
            catch (TaskCanceledException)
            {
                // Ignore exception if task is canceled
            }
            catch (Exception)
            {
                // Fallback safely if JS fails
                _isMobileView = false;
            }
            
            StateHasChanged();
        }
    }

    protected override void OnParametersSet()
    {
        ApplyTenantBranding();
    }

    public void Dispose()
    {
        PreferenceService.OnPreferenceChanged -= OnPreferenceChanged;
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private void CloseMobileDrawer()
    {
        _mobileDrawerOpen = false;
        _ = BrowserService.UnlockScrollAsync();
    }

    private async Task LogoutAsync()
    {
        var parameters = new DialogParameters
        {
            { "ContentText", "Tem certeza que deseja sair do sistema?" },
            { "ButtonText", "Sair" },
            { "Color", MudBlazor.Color.Error }
        };

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<erp.Components.Shared.Dialogs.ConfirmDialog>("Confirmar saída", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            try
            {
                await JsRuntime.InvokeVoidAsync("erpAuth.logout");
                NavigationManager.NavigateTo("/login", forceLoad: true);
            }
            catch
            {
                NavigationManager.NavigateTo("/login", forceLoad: true);
            }
        }
    }

    private void OnPreferenceChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void ApplyTenantBranding()
    {
        var branding = BrandingProvider.GetCurrentBranding();
        if (_brandingInitialized && branding == _branding)
        {
            return;
        }

        _branding = branding;
        _customTheme = TenantBrandingThemeBuilder.BuildTheme(_branding);
        _brandingInitialized = true;
    }

    private string MainContentStyle()
    {
        // No mobile, CSS media queries controlam o layout
        // No desktop, MudDrawerContainer controla automaticamente
        var style = "flex: 1 1 auto; min-height: 0; overflow-y: auto;";
        
        if (PreferenceService.CurrentPreferences?.Ui?.FontSize == "small")
        {
            style += "font-size: 0.9rem;";
        }
        else if (PreferenceService.CurrentPreferences?.Ui?.FontSize == "large")
        {
            style += "font-size: 1.1rem;";
        }
        return style;
    }

    private string MainContentStyleTopbar()
    {
        var style = "min-height: calc(100vh - 64px);";
        if (PreferenceService.CurrentPreferences?.Ui?.FontSize == "small")
        {
            style += "font-size: 0.9rem;";
        }
        else if (PreferenceService.CurrentPreferences?.Ui?.FontSize == "large")
        {
            style += "font-size: 1.1rem;";
        }
        return style;
    }
}
