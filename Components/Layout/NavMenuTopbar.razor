@using erp.Components.Shared.Dialogs
@using erp.Services.Tenancy
@using MudBlazor
@using Color = MudBlazor.Color
@implements IDisposable

@inject NavigationManager NavigationManager
@inject ITenantBrandingProvider BrandingProvider

<MudAppBar Elevation="2" Dense="false" Class="px-3">
    <div class="d-flex align-center mr-6">
        <MudImage Src="@(_branding.LogoUrl ?? "/logo.png")" 
                  Alt="@_branding.TenantName"
                  Height="32"
                  ObjectFit="ObjectFit.Contain"
                  Class="me-2" />
    </div>
    
    <MudButton 
               Color="@(IsActive("") ? Color.Primary : Color.Inherit)" 
               Variant="@(IsActive("") ? Variant.Filled : Variant.Text)"
               Href="/" 
               Class="mx-1"
               Style="text-transform: none;">
        Home
    </MudButton>
    
    <MudButton 
               Color="@(IsActive("dashboard") ? Color.Primary : Color.Inherit)"
               Variant="@(IsActive("dashboard") ? Variant.Filled : Variant.Text)"
               Href="dashboard" 
               Class="mx-1"
               Style="text-transform: none;">
        Dashboard
    </MudButton>
    
    <MudMenu 
             Label="Vendas" 
             Color="@(IsActive("sales") ? Color.Primary : Color.Inherit)" 
             Variant="@(IsActive("sales") ? Variant.Filled : Variant.Text)"
             Class="mx-1"
             Style="text-transform: none;"
             StartIcon="@Icons.Material.Filled.ArrowDropDown"
             EndIcon="">
        <MudMenuItem Href="sales" Icon="@Icons.Material.Filled.Receipt">Vendas</MudMenuItem>
        <MudMenuItem Href="sales/customers" Icon="@Icons.Material.Filled.People">Clientes</MudMenuItem>
    </MudMenu>
    
    <MudMenu 
             Label="Estoque" 
             Color="@(IsActive("inventory") ? Color.Primary : Color.Inherit)" 
             Variant="@(IsActive("inventory") ? Variant.Filled : Variant.Text)"
             Class="mx-1"
             Style="text-transform: none;"
             StartIcon="@Icons.Material.Filled.ArrowDropDown"
             EndIcon="">
        <MudMenuItem Href="inventory/products" Icon="@Icons.Material.Filled.Category">Produtos</MudMenuItem>
        <MudMenuItem Href="inventory/categories" Icon="@Icons.Material.Filled.FolderOpen">Categorias</MudMenuItem>
        <MudMenuItem Href="inventory/movements" Icon="@Icons.Material.Filled.SwapHoriz">Movimentações</MudMenuItem>
        <MudMenuItem Href="inventory/counts" Icon="@Icons.Material.Filled.Checklist">Contagens</MudMenuItem>
    </MudMenu>

    <MudMenu 
             Label="Financeiro" 
             Color="@(IsActive("financial") ? Color.Primary : Color.Inherit)" 
             Variant="@(IsActive("financial") ? Variant.Filled : Variant.Text)"
             Class="mx-1"
             Style="text-transform: none;"
             StartIcon="@Icons.Material.Filled.ArrowDropDown"
             EndIcon="">
        <MudMenuItem Href="financial/dashboard" Icon="@Icons.Material.Filled.Dashboard">Dashboard</MudMenuItem>
        <MudMenuItem Href="financial/receivables" Icon="@Icons.Material.Filled.CallReceived">Contas a Receber</MudMenuItem>
        <MudMenuItem Href="financial/payables" Icon="@Icons.Material.Filled.CallMade">Contas a Pagar</MudMenuItem>
        <MudMenuItem Href="financial/suppliers" Icon="@Icons.Material.Filled.LocalShipping">Fornecedores</MudMenuItem>
        <MudMenuItem Href="financial/categories" Icon="@Icons.Material.Filled.Category">Categorias</MudMenuItem>
        <MudMenuItem Href="financial/costcenters" Icon="@Icons.Material.Filled.AccountBalanceWallet">Centros de Custo</MudMenuItem>
    </MudMenu>
    
    <MudButton 
               Color="@(IsActive("kanban") ? Color.Primary : Color.Inherit)"
               Variant="@(IsActive("kanban") ? Variant.Filled : Variant.Text)"
               Href="kanban" 
               Class="mx-1"
               Style="text-transform: none;">
        Kanban
    </MudButton>

    <!-- <MudButton 
               Color="@(IsActive("assets") ? Color.Primary : Color.Inherit)"
               Variant="@(IsActive("assets") ? Variant.Filled : Variant.Text)"
               Href="assets" 
               Class="mx-1"
               Style="text-transform: none;">
        Ativos
    </MudButton> -->

    <MudButton 
               Color="@(IsActive("reports") ? Color.Primary : Color.Inherit)"
               Variant="@(IsActive("reports") ? Variant.Filled : Variant.Text)"
               Href="reports" 
               Class="mx-1"
               Style="text-transform: none;">
        Relatórios
    </MudButton>
    
    <MudSpacer />
    
    <AuthorizeView Roles="Administrador">
        <Authorized>
            <MudMenu 
                     Label="Admin" 
                     Color="@(IsActive("admin") ? Color.Primary : Color.Inherit)" 
                     Variant="@(IsActive("admin") ? Variant.Filled : Variant.Text)"
                     Class="mx-1"
                     Style="text-transform: none;"
                     StartIcon="@Icons.Material.Filled.ArrowDropDown"
                     EndIcon="">
                <MudMenuItem Href="admin/users" Icon="@Icons.Material.Filled.People">Usuários</MudMenuItem>
                <MudMenuItem Href="admin/tenants" Icon="@Icons.Material.Filled.Domain">Tenants</MudMenuItem>
                <MudMenuItem Href="admin/departments" Icon="@Icons.Material.Filled.BusinessCenter">Departamentos</MudMenuItem>
                <MudMenuItem Href="admin/positions" Icon="@Icons.Material.Filled.WorkOutline">Cargos</MudMenuItem>
                <MudMenuItem Href="admin/widget-roles" Icon="@Icons.Material.Filled.Widgets">Widgets / Papéis</MudMenuItem>
                <MudMenuItem Href="time-tracking/payroll" Icon="@Icons.Material.Filled.AccessTime">Apontamento</MudMenuItem>
                <MudMenuItem Href="audit" Icon="@Icons.Material.Filled.History">Auditoria</MudMenuItem>
                <MudMenuItem Href="data-access-report" Icon="@Icons.Material.Filled.Shield">Acessos LGPD</MudMenuItem>
            </MudMenu>
        </Authorized>
    </AuthorizeView>
    
    <MudIconButton Icon="@Icons.Material.Filled.Settings" 
                  Color="@(IsActive("settings") ? Color.Primary : Color.Inherit)" 
                  Href="settings"
                  Title="Configurações" />
    
    <MudIconButton Icon="@Icons.Material.Filled.Logout" 
                  Color="Color.Inherit" 
                  OnClick="LogoutAsync"
                  Title="Sair" />
</MudAppBar>

@code {
    [Inject] HttpClient Http { get; set; } = null!;
    private string? currentUrl;
    private TenantBrandingTheme _branding = TenantBrandingTheme.Default;

    protected override void OnInitialized()
    {
        _branding = BrandingProvider.GetCurrentBranding();
        currentUrl = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        NavigationManager.LocationChanged += OnLocationChanged;
        BrandingProvider.BrandingChanged += OnBrandingChanged;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = NavigationManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

    private bool IsActive(string path)
    {
        if (string.IsNullOrEmpty(path))
        {
            return string.IsNullOrEmpty(currentUrl) || currentUrl == "/";
        }
        return currentUrl?.StartsWith(path, StringComparison.OrdinalIgnoreCase) ?? false;
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
        BrandingProvider.BrandingChanged -= OnBrandingChanged;
    }

    [Inject] IJSRuntime JS { get; set; } = null!;
    [Inject] IDialogService DialogService { get; set; } = null!;

    private async Task LogoutAsync()
    {
        var parameters = new DialogParameters
        {
            { "ContentText", "Tem certeza que deseja sair do sistema?" },
            { "ButtonText", "Sair" },
            { "Color", MudBlazor.Color.Error }
        };

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Confirmar saída", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            try
            {
                await JS.InvokeVoidAsync("erpAuth.logout");
                NavigationManager.NavigateTo("/login", forceLoad: true);
            }
            catch
            {
                NavigationManager.NavigateTo("/login", forceLoad: true);
            }
        }
    }

    private void OnBrandingChanged(object? sender, EventArgs e)
    {
        _branding = BrandingProvider.GetCurrentBranding();
        InvokeAsync(StateHasChanged);
    }
}
