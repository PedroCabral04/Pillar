@using erp.Components.Shared.Dialogs
@using MudBlazor
@implements IDisposable

@inject NavigationManager NavigationManager

<MudNavMenu Rounded="false" Class="py-2">
    @if (IsOpen)
    {
        <div class="d-flex align-center justify-space-between px-3 py-3 mb-2">
            <MudText Typo="Typo.h5" Style="font-weight: 600;">Pillar</MudText>
            <MudIconButton Icon="@Icons.Material.Filled.MenuOpen" 
                          Color="MudBlazor.Color.Inherit" 
                          Size="MudBlazor.Size.Small"
                          OnClick="OnToggleDrawer" 
                          Title="Fechar menu" />
        </div>
    }
    else
    {
        <div class="d-flex justify-center py-3 mb-2">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" 
                          Color="MudBlazor.Color.Inherit" 
                          Size="MudBlazor.Size.Medium"
                          OnClick="OnToggleDrawer" 
                          Title="Abrir menu" />
        </div>
    }
    
    <MudNavLink Href="" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home" Class="my-1">Home</MudNavLink>
    <MudNavLink Href="dashboard" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Dashboard" Class="my-1">Dashboard</MudNavLink>
    
    <MudDivider Class="my-2"/>
    
    @if (IsOpen)
    {
        <MudNavGroup Title="Vendas" Icon="@Icons.Material.Filled.ShoppingCart" Expanded="false" Class="my-1" HideExpandIcon="false">
            <MudNavLink Href="sales" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Receipt">Vendas</MudNavLink>
            <MudNavLink Href="sales/customers" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.People">Clientes</MudNavLink>
        </MudNavGroup>
        
        <MudNavGroup Title="Estoque" Icon="@Icons.Material.Filled.Inventory" Expanded="false" Class="my-1" HideExpandIcon="false">
            <MudNavLink Href="inventory/products" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Category">Produtos</MudNavLink>
            <MudNavLink Href="inventory/categories" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.FolderOpen">Categorias</MudNavLink>
            <MudNavLink Href="inventory/movements" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.SwapHoriz">Movimentações</MudNavLink>
            <MudNavLink Href="inventory/counts" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Checklist">Contagens</MudNavLink>
        </MudNavGroup>
    }
    else
    {
        <MudNavLink Href="sales" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.ShoppingCart" Class="my-1" />
        <MudNavLink Href="inventory/products" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Inventory" Class="my-1" />
    }
    
    <MudNavLink Href="kanban" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.ViewKanban" Class="my-1">Kanban</MudNavLink>
    
    <MudDivider Class="my-2"/>
    
    <AuthorizeView Roles="Administrador">
        <Authorized>
            @if (IsOpen)
            {
                <MudNavGroup Title="RH & Admin" Icon="@Icons.Material.Filled.AdminPanelSettings" Expanded="false" Class="my-1" HideExpandIcon="false">
                    <MudNavLink Href="admin/users" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.People">Usuários</MudNavLink>
                    <MudNavLink Href="admin/departments" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.BusinessCenter">Departamentos</MudNavLink>
                    <MudNavLink Href="admin/positions" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.WorkOutline">Cargos</MudNavLink>
                    <MudNavLink Href="time-tracking/payroll" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.AccessTime">Apontamento</MudNavLink>
                    <MudNavLink Href="audit" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.History">Auditoria</MudNavLink>
                    <MudNavLink Href="data-access-report" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Shield">Acessos LGPD</MudNavLink>
                </MudNavGroup>
            }
            else
            {
                <MudNavLink Href="admin/users" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.AdminPanelSettings" Class="my-1" />
                <MudNavLink Href="time-tracking/payroll" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.AccessTime" Class="my-1" />
            }
        </Authorized>
    </AuthorizeView>
    
    <MudNavLink Href="settings" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Settings" Class="my-1">Configurações</MudNavLink>
    
    <MudDivider Class="my-2"/>
    
    <MudNavLink OnClick="LogoutAsync" Icon="@Icons.Material.Filled.Logout" Class="my-1">Sair</MudNavLink>
    
    <AuthorizeView>
        <NotAuthorized>
            <MudNavLink Href="login" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Login" Class="my-1">Entrar</MudNavLink>
        </NotAuthorized>
    </AuthorizeView>

    @*<MudNavLink Href="auth" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Lock">Auth Required</MudNavLink>
    <AuthorizeView>
        <Authorized>
            <MudNavLink Href="Account/Manage" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Person">@context.User.Identity?.Name</MudNavLink>
            <form action="Account/Logout" method="post">
                <AntiforgeryToken/>
                <input type="hidden" name="ReturnUrl" value="@currentUrl"/>
                <button type="submit" class="mud-nav-link mud-ripple">
                    <MudIcon Icon="@Icons.Material.Filled.Logout" Color="Color.Info" Class="mr-3"></MudIcon> Logout
                </button>
            </form>
        </Authorized>
        <NotAuthorized>
            <MudNavLink Href="Account/Register" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Person">Register</MudNavLink>
            <MudNavLink Href="Account/Login" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Password">Login</MudNavLink>
        </NotAuthorized>
    </AuthorizeView>*@
</MudNavMenu>


@code {
    [Parameter] public bool IsOpen { get; set; } = true;
    [Parameter] public EventCallback OnToggleDrawer { get; set; }
    
    [Inject] HttpClient Http { get; set; } = null!;
    private string? currentUrl;

    protected override void OnInitialized()
    {
        currentUrl = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = NavigationManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }

    [Inject] IJSRuntime JS { get; set; } = null!;
    [Inject] IDialogService DialogService { get; set; } = null!;

    private async Task LogoutAsync()
    {
        var parameters = new DialogParameters
        {
            { "ContentText", "Tem certeza que deseja sair do sistema?" },
            { "ButtonText", "Sair" },
            { "Color", MudBlazor.Color.Error }
        };

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Confirmar saída", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            try
            {
                await JS.InvokeVoidAsync("erpAuth.logout");
                NavigationManager.NavigateTo("/login", forceLoad: true);
            }
            catch
            {
                NavigationManager.NavigateTo("/login", forceLoad: true);
            }
        }
    }
}