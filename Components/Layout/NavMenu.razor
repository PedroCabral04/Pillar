@using erp.Components.Shared.Dialogs
@using MudBlazor
@using Microsoft.AspNetCore.Components.Web
@implements IDisposable

@inject NavigationManager NavigationManager

<MudNavMenu Rounded="false" Class="py-2 responsive-nav-menu">
    @if (IsOpen)
    {
        <div class="d-flex align-center justify-space-between px-3 py-3 mb-2">
            <div class="d-flex align-center">
                <MudAvatar Size="@MudBlazor.Size.Medium" Class="me-2" Square="true" Alt="Pillar" Text="P" Color="@MudBlazor.Color.Primary" />
                <div>
                    <MudText Typo="Typo.h6" Style="font-weight: 600;">Pillar</MudText>
                    <AuthorizeView>
                        <Authorized Context="auth">
                            <MudText Typo="Typo.caption">@auth.User.Identity?.Name</MudText>
                        </Authorized>
                        <NotAuthorized>
                            <MudText Typo="Typo.caption">Bem vindo</MudText>
                        </NotAuthorized>
                    </AuthorizeView>
                </div>
            </div>
            <div class="d-flex align-center">
                <MudIconButton Icon="@Icons.Material.Filled.Close" 
                              Color="MudBlazor.Color.Inherit" 
                              Size="MudBlazor.Size.Small"
                              OnClick="@(async (MouseEventArgs e) => await OnToggleDrawer.InvokeAsync())" 
                              Title="Fechar menu"
                              AriaLabel="Fechar menu"
                              Class="d-md-none" />
                <MudIconButton Icon="@(IsOpen ? Icons.Material.Filled.MenuOpen : Icons.Material.Filled.Menu)" 
                              Color="MudBlazor.Color.Inherit" 
                              Size="MudBlazor.Size.Small"
                              OnClick="@(async (MouseEventArgs e) => await OnToggleDrawer.InvokeAsync())" 
                              Title="@(IsOpen ? "Fechar menu" : "Abrir menu")"
                              AriaLabel="Menu toggle"
                              Class="d-none d-md-block menu-toggle" />
            </div>
        </div>
    }
    else
    {
        <div class="d-flex justify-center py-3 mb-2">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" 
                          Color="MudBlazor.Color.Inherit" 
                          Size="MudBlazor.Size.Medium"
                          OnClick="@(async (MouseEventArgs e) => await OnToggleDrawer.InvokeAsync())" 
                          Title="Abrir menu" AriaLabel="Abrir navegação" />
        </div>
    }
    
    <MudNavLink Href="" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home" Class="my-1" Title="Home">Home</MudNavLink>
    <MudNavLink Href="dashboard" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Dashboard" Class="my-1" Title="Dashboard">Dashboard</MudNavLink>
    
    <MudDivider Class="my-2"/>
    
    @if (IsOpen)
    {
        <MudNavGroup Title="Vendas" Icon="@Icons.Material.Filled.ShoppingCart" Expanded="false" Class="my-1" HideExpandIcon="false">
            <MudNavLink Href="sales" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Receipt">Vendas</MudNavLink>
            <MudNavLink Href="sales/customers" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.People">Clientes</MudNavLink>
        </MudNavGroup>
        
        <MudNavGroup Title="Estoque" Icon="@Icons.Material.Filled.Inventory" Expanded="false" Class="my-1" HideExpandIcon="false">
            <MudNavLink Href="inventory/products" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Category">Produtos</MudNavLink>
            <MudNavLink Href="inventory/categories" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.FolderOpen">Categorias</MudNavLink>
            <MudNavLink Href="inventory/movements" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.SwapHoriz">Movimentações</MudNavLink>
            <MudNavLink Href="inventory/counts" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Checklist">Contagens</MudNavLink>
        </MudNavGroup>
        
        <MudNavGroup Title="Financeiro" Icon="@Icons.Material.Filled.AccountBalance" Expanded="false" Class="my-1" HideExpandIcon="false">
            <MudNavLink Href="financial/dashboard" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Dashboard">Dashboard</MudNavLink>
            <MudNavLink Href="financial/receivables" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.CallReceived">Contas a Receber</MudNavLink>
            <MudNavLink Href="financial/payables" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.CallMade">Contas a Pagar</MudNavLink>
            <MudNavLink Href="financial/suppliers" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.LocalShipping">Fornecedores</MudNavLink>
            <MudNavLink Href="financial/categories" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Category">Categorias</MudNavLink>
            <MudNavLink Href="financial/costcenters" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.AccountBalanceWallet">Centros de Custo</MudNavLink>
        </MudNavGroup>
    }
    else
    {
    <MudTooltip Text="Vendas" Placement="@MudBlazor.Placement.Bottom">
            <MudNavLink Href="sales" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.ShoppingCart" Class="my-1" />
        </MudTooltip>
    <MudTooltip Text="Produtos" Placement="@MudBlazor.Placement.Bottom">
            <MudNavLink Href="inventory/products" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Inventory" Class="my-1" />
        </MudTooltip>
    <MudTooltip Text="Financeiro" Placement="@MudBlazor.Placement.Bottom">
            <MudNavLink Href="financial/dashboard" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.AccountBalance" Class="my-1" />
        </MudTooltip>
    }
    
    <MudNavLink Href="kanban" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.ViewKanban" Class="my-1" Title="Kanban">Kanban</MudNavLink>
    
    @if (IsOpen)
    {
        <MudNavLink Href="assets" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Devices" Class="my-1">Ativos</MudNavLink>
    }
    else
    {
    <MudTooltip Text="Ativos" Placement="@MudBlazor.Placement.Bottom">
            <MudNavLink Href="assets" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Devices" Class="my-1" />
        </MudTooltip>
    }
    
    @if (IsOpen)
    {
        <MudNavLink Href="reports" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Assessment" Class="my-1">Relatórios</MudNavLink>
    }
    else
    {
    <MudTooltip Text="Relatórios" Placement="@MudBlazor.Placement.Bottom">
            <MudNavLink Href="reports" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Assessment" Class="my-1" />
        </MudTooltip>
    }
    
    <MudDivider Class="my-2"/>
    
    <AuthorizeView Roles="Administrador">
        <Authorized>
            @if (IsOpen)
            {
                <MudNavGroup Title="RH & Admin" Icon="@Icons.Material.Filled.AdminPanelSettings" Expanded="false" Class="my-1" HideExpandIcon="false">
                    <MudNavLink Href="admin/users" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.People">Usuários</MudNavLink>
                    <MudNavLink Href="admin/departments" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.BusinessCenter">Departamentos</MudNavLink>
                    <MudNavLink Href="admin/positions" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.WorkOutline">Cargos</MudNavLink>
                    <MudNavLink Href="admin/widget-roles" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Widgets">Widgets / Papéis</MudNavLink>
                    <MudNavLink Href="time-tracking/payroll" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.AccessTime">Apontamento</MudNavLink>
                    <MudNavLink Href="audit" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.History">Auditoria</MudNavLink>
                    <MudNavLink Href="data-access-report" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Shield">Acessos LGPD</MudNavLink>
                </MudNavGroup>
            }
            else
            {
                <MudTooltip Text="Administracao" Placement="@MudBlazor.Placement.Bottom">
                    <MudNavLink Href="admin/users" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.AdminPanelSettings" Class="my-1" />
                </MudTooltip>
                <MudNavLink Href="admin/widget-roles" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Widgets" Class="my-1" />
                <MudNavLink Href="time-tracking/payroll" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.AccessTime" Class="my-1" />
            }
        </Authorized>
    </AuthorizeView>
    
    <MudNavLink Href="settings" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Settings" Class="my-1">Configurações</MudNavLink>
    
    <MudDivider Class="my-2"/>
    
    <MudNavLink OnClick="LogoutAsync" Icon="@Icons.Material.Filled.Logout" Class="my-1">Sair</MudNavLink>
    
    <AuthorizeView>
        <NotAuthorized>
            <MudNavLink Href="login" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Login" Class="my-1">Entrar</MudNavLink>
        </NotAuthorized>
    </AuthorizeView>

    @*<MudNavLink Href="auth" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Lock">Auth Required</MudNavLink>
    <AuthorizeView>
        <Authorized>
            <MudNavLink Href="Account/Manage" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Person">@context.User.Identity?.Name</MudNavLink>
            <form action="Account/Logout" method="post">
                <AntiforgeryToken/>
                <input type="hidden" name="ReturnUrl" value="@currentUrl"/>
                <button type="submit" class="mud-nav-link mud-ripple">
                    <MudIcon Icon="@Icons.Material.Filled.Logout" Color="Color.Info" Class="mr-3"></MudIcon> Logout
                </button>
            </form>
        </Authorized>
        <NotAuthorized>
            <MudNavLink Href="Account/Register" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Person">Register</MudNavLink>
            <MudNavLink Href="Account/Login" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Password">Login</MudNavLink>
        </NotAuthorized>
    </AuthorizeView>*@
</MudNavMenu>


@code {
    [Parameter] public bool IsOpen { get; set; } = true;
    [Parameter] public EventCallback OnToggleDrawer { get; set; }
    [Parameter] public bool IsMobile { get; set; } = false;
    
    [Inject] HttpClient Http { get; set; } = null!;
    private string? currentUrl;

    protected override void OnInitialized()
    {
        currentUrl = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = NavigationManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }

    [Inject] IJSRuntime JS { get; set; } = null!;
    [Inject] IDialogService DialogService { get; set; } = null!;

    private async Task LogoutAsync()
    {
        var parameters = new DialogParameters
        {
            { "ContentText", "Tem certeza que deseja sair do sistema?" },
            { "ButtonText", "Sair" },
            { "Color", MudBlazor.Color.Error }
        };

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Confirmar saída", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            try
            {
                await JS.InvokeVoidAsync("erpAuth.logout");
                NavigationManager.NavigateTo("/login", forceLoad: true);
            }
            catch
            {
                NavigationManager.NavigateTo("/login", forceLoad: true);
            }
        }
    }
}