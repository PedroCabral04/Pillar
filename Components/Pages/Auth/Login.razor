@page "/login"
@attribute [AllowAnonymous]
@using System.ComponentModel.DataAnnotations
@using erp.Services
@using erp.Services.Tenancy
@using erp.Components.Branding
@inject HttpClient Http
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@inject ITenantBrandingProvider BrandingProvider
@code {
    [Parameter] [SupplyParameterFromQuery] public string? ReturnUrl { get; set; }
}

<PageTitle>Entrar • @_branding.TenantName</PageTitle>

<MudGrid Spacing="0" Style="height: 100vh; overflow: hidden;">
    <!-- Left Side: Branding / Image -->
    <MudItem xs="12" md="6" lg="7" Class="d-none d-md-flex flex-column justify-center align-center relative" 
             Style="@($"background-color: {_branding.PrimaryColor}; color: white; position: relative;")">
        
        @if (!string.IsNullOrEmpty(_branding.LoginBackgroundUrl))
        {
             <div style="@($"position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('{_branding.LoginBackgroundUrl}'); background-size: cover; background-position: center; opacity: 0.4; mix-blend-mode: overlay;")"></div>
        }
        else
        {
             <!-- Abstract pattern overlay if no image -->
             <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);"></div>
        }
        
        <div class="d-flex flex-column align-center gap-4 pa-8 text-center" style="z-index: 2; max-width: 600px;">
             @if (!string.IsNullOrEmpty(_branding.LogoUrl))
             {
                 <MudImage Src="@_branding.LogoUrl" Alt="@_branding.TenantName" Width="150" Class="mb-6" ObjectFit="ObjectFit.Contain" />
             }
             else
             {
                 <MudAvatar Size="MudBlazor.Size.Large" Color="MudBlazor.Color.Surface" Variant="Variant.Filled" Class="mb-6" Style="width: 80px; height: 80px;">
                     <MudText Typo="Typo.h3" Color="MudBlazor.Color.Primary" Style="font-weight: 700;">@_branding.Initials</MudText>
                 </MudAvatar>
             }
             
             <MudText Typo="Typo.h2" Style="font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">@_branding.TenantName</MudText>
             <MudText Typo="Typo.h5" Style="opacity: 0.9; font-weight: 300;">Gerencie seu negócio com eficiência e inteligência.</MudText>
        </div>
    </MudItem>

    <!-- Right Side: Login Form -->
    <MudItem xs="12" md="6" lg="5" Class="d-flex justify-center align-center pa-4" Style="background-color: var(--mud-palette-background);">
        <MudPaper Elevation="0" Class="pa-8 w-100" Style="max-width: 480px; background: transparent;">
            
            <!-- Mobile Branding Header -->
            <div class="d-md-none d-flex flex-column align-center mb-8">
                 <MudAvatar Size="MudBlazor.Size.Large" Color="MudBlazor.Color.Primary" Class="mb-2">@_branding.Initials</MudAvatar>
                 <MudText Typo="Typo.h5" Color="MudBlazor.Color.Primary" Style="font-weight: 600;">@_branding.TenantName</MudText>
            </div>

            <div class="mb-10">
                <MudText Typo="Typo.h4" Style="font-weight: 700;" Class="mb-2">Bem-vindo!</MudText>
                <MudText Typo="Typo.body1" Color="MudBlazor.Color.Secondary">Insira suas credenciais para acessar sua conta.</MudText>
            </div>

            <EditForm Model="model" OnValidSubmit="HandleLoginAsync">
                <DataAnnotationsValidator />
                
                <MudTextField @bind-Value="model.Email" 
                              Label="E-mail" 
                              Variant="Variant.Outlined" 
                              Class="mb-5"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Email"
                              Required="true" 
                              For="() => model.Email" 
                              InputType="InputType.Email"/>
                              
                <MudTextField @bind-Value="model.Password" 
                              Label="Senha" 
                              Variant="Variant.Outlined" 
                              Class="mb-3"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Lock"
                              Required="true" 
                              For="() => model.Password" 
                              InputType="InputType.Password"/>

                <div class="d-flex justify-space-between align-center mb-8">
                    <MudCheckBox T="bool" @bind-Checked="model.RememberMe" Label="Lembrar de mim" Color="MudBlazor.Color.Primary" Dense="true" />
                    <MudLink Href="/forgot-password" Underline="Underline.Hover" Color="MudBlazor.Color.Primary" Typo="Typo.body2" Style="font-weight: 500;">Esqueceu a senha?</MudLink>
                </div>

                <MudAlert Severity="Severity.Error" Dense="true" Class="mb-6" Style="@ErrorDisplayStyle" Variant="Variant.Filled">@error</MudAlert>

                <MudButton Disabled="busy" 
                           Loading="busy" 
                           Color="MudBlazor.Color.Primary" 
                           Variant="Variant.Filled" 
                           Size="MudBlazor.Size.Large" 
                           FullWidth="true" 
                           ButtonType="ButtonType.Submit"
                           Class="py-3"
                           Style="font-weight: 600; border-radius: 8px; text-transform: none; font-size: 1.1rem;">
                    Entrar
                </MudButton>
            </EditForm>
            
            <div class="mt-12 text-center">
                <MudText Typo="Typo.caption" Color="MudBlazor.Color.Secondary">
                    &copy; @DateTime.Now.Year @_branding.TenantName. Todos os direitos reservados.
                </MudText>
            </div>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private LoginModel model = new();
    private string? error;
    private bool busy;
    private TenantBrandingTheme _branding = TenantBrandingTheme.Default;
    private string ErrorDisplayStyle => string.IsNullOrEmpty(error) ? "display:none;" : "display:block;";

    protected override async Task OnInitializedAsync()
    {
        _branding = BrandingProvider.GetCurrentBranding();
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        if (state.User.Identity?.IsAuthenticated == true)
        {
            var target = string.IsNullOrWhiteSpace(ReturnUrl) ? "/" : ReturnUrl;
            Nav.NavigateTo(target!, replace: true);
        }
    }

    private async Task HandleLoginAsync()
    {
        busy = true;
        error = null;
        try
        {
            // Use JS fetch with credentials to ensure cookie is set in browser
            var result = await JS.InvokeAsync<LoginResult>("erpAuth.login", model);
            
            // DEBUG: Log para verificar o que está sendo retornado
            Console.WriteLine($"Login result - ok: {result.ok}, status: {result.status}");
            Console.WriteLine($"Login result - text: {result.text}");
            
            if (result.ok)
            {
                // Parse manual do JSON para garantir que funcione
                LoginData? loginData = null;
                if (!string.IsNullOrWhiteSpace(result.text))
                {
                    try
                    {
                        loginData = System.Text.Json.JsonSerializer.Deserialize<LoginData>(
                            result.text, 
                            new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                        Console.WriteLine($"Login result - requiresTwoFactor: {loginData?.requiresTwoFactor}");
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Erro ao fazer parse do JSON: {ex.Message}");
                    }
                }
                
                // Verificar se precisa de 2FA
                if (loginData?.requiresTwoFactor == true)
                {
                    Console.WriteLine($"Redirecionando para 2FA com email: {model.Email}");
                    // Redirecionar para página de verificação 2FA
                    Nav.NavigateTo($"/login/verify-2fa?email={Uri.EscapeDataString(model.Email)}", forceLoad: true);
                    return;
                }
                
                Console.WriteLine("Login sem 2FA - redirecionando para home");
                var target = string.IsNullOrWhiteSpace(ReturnUrl) ? "/" : ReturnUrl;
                Nav.NavigateTo(target!, forceLoad: true);
            }
            else
            {
                // Mensagem de erro mais contextual baseada no status HTTP
                if (result.status > 0)
                {
                    var statusCode = (System.Net.HttpStatusCode)result.status;
                    error = ErrorMessageHelper.GetLoginErrorMessage(statusCode);
                }
                else
                {
                    error = string.IsNullOrWhiteSpace(result.text) 
                        ? "E-mail ou senha incorretos. Verifique seus dados e tente novamente." 
                        : result.text;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro no login: {ex.Message}");
            error = "Erro ao conectar com o servidor. Verifique sua conexão e tente novamente.";
        }
        finally
        {
            busy = false;
        }
    }

    public class LoginModel
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = string.Empty;

        [Required]
        public string Password { get; set; } = string.Empty;

        public bool RememberMe { get; set; } = true;
    }

    public class LoginResult
    {
        public bool ok { get; set; }
        public int status { get; set; }
        public string? text { get; set; }
        public LoginData? data { get; set; }
    }
    
    public class LoginData
    {
        public bool requiresTwoFactor { get; set; }
        public string? email { get; set; }
        public string? message { get; set; }
    }
}