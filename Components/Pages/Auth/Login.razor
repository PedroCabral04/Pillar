@page "/login"
@attribute [AllowAnonymous]
@using System.ComponentModel.DataAnnotations
@using erp.Services
@using erp.Services.Tenancy
@using erp.Components.Branding
@inject HttpClient Http
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@inject ITenantBrandingProvider BrandingProvider
@inject PreferenceService PreferenceService
@inject ThemeService ThemeService
@implements IAsyncDisposable
@code {
    [Parameter] [SupplyParameterFromQuery] public string? ReturnUrl { get; set; }
}

<PageTitle>Entrar • @_branding.TenantName</PageTitle>

    <div class="login-card">
        <div class="login-header">
            <MudImage Src="@(_branding.LogoUrl ?? "/logo.png")" Alt="@_branding.TenantName" Height="48" ObjectFit="ObjectFit.Contain" Class="login-logo" />
        </div>
        
        <div class="login-title-section">
            <MudText Typo="Typo.h5" Style="font-weight: 600; color: var(--mud-palette-text-primary);">Entrar</MudText>
            <MudText Typo="Typo.body2" Color="MudBlazor.Color.Secondary" Class="mt-1">Digite suas credenciais para continuar</MudText>
        </div>

        <EditForm Model="model" OnValidSubmit="HandleLoginAsync">
            <DataAnnotationsValidator />
            
            <div class="login-form-group">
                <MudTextField @bind-Value="model.Email" 
                              Label="E-mail" 
                              Variant="Variant.Outlined" 
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Email"
                              Required="true" 
                              For="() => model.Email" 
                              InputType="InputType.Email"
                              Class="login-input"/>
            </div>
                              
            <div class="login-form-group">
                <MudTextField @bind-Value="model.Password" 
                              Label="Senha" 
                              Variant="Variant.Outlined" 
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Lock"
                              Required="true" 
                              For="() => model.Password" 
                              InputType="InputType.Password"
                              Class="login-input"/>
            </div>

            <div class="login-options">
                <MudCheckBox T="bool" @bind-Checked="model.RememberMe" Label="Lembrar de mim" Color="MudBlazor.Color.Primary" Dense="true" />
                <MudLink Href="/forgot-password" Underline="Underline.Hover" Color="MudBlazor.Color.Primary" Typo="Typo.caption">Esqueceu a senha?</MudLink>
            </div>

            <MudAlert Severity="Severity.Error" Dense="true" Class="login-error" Style="@ErrorDisplayStyle" Variant="Variant.Filled">@error</MudAlert>

            <MudButton Disabled="busy" 
                       Loading="busy" 
                       Color="MudBlazor.Color.Primary" 
                       Variant="Variant.Filled" 
                       Size="MudBlazor.Size.Large" 
                       FullWidth="true" 
                       ButtonType="ButtonType.Submit"
                       Class="login-button">
                Entrar
            </MudButton>
        </EditForm>
        
        <div class="login-footer">
            <MudText Typo="Typo.caption" Color="MudBlazor.Color.Secondary">
                &copy; @DateTime.Now.Year @_branding.TenantName
            </MudText>
        </div>
    </div>

<style>
    .login-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
    }
    
    .login-card {
        width: 100%;
        max-width: 400px;
        background: var(--mud-palette-background);
        border-radius: 16px;
        padding: 40px 32px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.05);
        border: 1px solid var(--mud-palette-lines-default);
    }
    
    .login-header {
        display: flex;
        justify-content: center;
        margin-bottom: 32px;
    }
    
    .login-logo {
        max-height: 48px;
    }
    
    .login-title-section {
        text-align: center;
        margin-bottom: 32px;
    }
    
    .login-form-group {
        margin-bottom: 20px;
    }
    
    .login-input {
        margin: 0;
    }
    
    .login-input ::deep .mud-input-outlined {
        border-radius: 8px;
    }
    
    .login-options {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }
    
    .login-error {
        margin-bottom: 16px;
        border-radius: 8px;
    }
    
    .login-button {
        font-weight: 600;
        border-radius: 8px;
        text-transform: none;
        font-size: 1rem;
        padding: 12px 0;
        letter-spacing: 0.01em;
    }
    
    .login-footer {
        text-align: center;
        margin-top: 32px;
        padding-top: 24px;
        border-top: 1px solid var(--mud-palette-lines-default);
    }
    
    @@media (max-width: 480px) {
        .login-card {
            padding: 32px 24px;
        }
        
        .login-header {
            margin-bottom: 24px;
        }
        
        .login-title-section {
            margin-bottom: 24px;
        }
    }
</style>

@code {
    private LoginModel model = new();
    private string? error;
    private bool busy;
    private TenantBrandingTheme _branding = TenantBrandingTheme.Default;
private string ErrorDisplayStyle => string.IsNullOrEmpty(error) ? "display:none;" : "display:block;";

    protected override async Task OnInitializedAsync()
    {
        _branding = BrandingProvider.GetCurrentBranding();
        ThemeService.OnThemeChanged += ThemeChanged;

        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        if (state.User.Identity?.IsAuthenticated == true)
        {
            var target = string.IsNullOrWhiteSpace(ReturnUrl) ? "/" : ReturnUrl;
            Nav.NavigateTo(target!, replace: true);
        }
    }

    private bool _themeInitialized;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_themeInitialized)
            return;

        try
        {
            var prefersDark = await JS.InvokeAsync<bool>("erpAuth.getSystemPrefersDark");
            await ThemeService.SetDarkModeAsync(prefersDark);
            _dotNetRef = DotNetObjectReference.Create(this);
            _themeListener = await JS.InvokeAsync<IJSObjectReference>("erpAuth.registerThemeListener", _dotNetRef);
            _themeInitialized = true;
        }
        catch (JSException jsEx)
        {
            Console.WriteLine($"JS interop not available yet: {jsEx.Message}");
            // Will retry on next OnAfterRenderAsync
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to initialize system theme listener: {ex.Message}");
        }
    }

    private void ThemeChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public async Task OnSystemThemeChanged(bool isDark)
    {
        await ThemeService.SetDarkModeAsync(isDark);
        await InvokeAsync(StateHasChanged);
    }

    public async ValueTask DisposeAsync()
    {
        ThemeService.OnThemeChanged -= ThemeChanged;
        try { _dotNetRef?.Dispose(); } catch { }
        if (_themeListener != null)
        {
            try { await _themeListener.InvokeVoidAsync("dispose"); } catch { }
            try { await _themeListener.DisposeAsync(); } catch { }
        }
    }

    private IJSObjectReference? _themeListener;
    private DotNetObjectReference<Login>? _dotNetRef;

    private async Task HandleLoginAsync()
    {
        busy = true;
        error = null;
        try
        {
            // Use JS fetch with credentials to ensure cookie is set in browser
            var result = await JS.InvokeAsync<LoginResult>("erpAuth.login", model);
            
            // DEBUG: Log para verificar o que está sendo retornado
            Console.WriteLine($"Login result - ok: {result.ok}, status: {result.status}");
            Console.WriteLine($"Login result - text: {result.text}");
            
            if (result.ok)
            {
                // Parse manual do JSON para garantir que funcione
                LoginData? loginData = null;
                if (!string.IsNullOrWhiteSpace(result.text))
                {
                    try
                    {
                        loginData = System.Text.Json.JsonSerializer.Deserialize<LoginData>(
                            result.text, 
                            new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                        Console.WriteLine($"Login result - requiresTwoFactor: {loginData?.requiresTwoFactor}");
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Erro ao fazer parse do JSON: {ex.Message}");
                    }
                }
                
                // Verificar se precisa de 2FA
                if (loginData?.requiresTwoFactor == true)
                {
                    Console.WriteLine($"Redirecionando para 2FA com email: {model.Email}");
                    // Redirecionar para página de verificação 2FA
                    Nav.NavigateTo($"/login/verify-2fa?email={Uri.EscapeDataString(model.Email)}", forceLoad: true);
                    return;
                }
                
                Console.WriteLine("Login sem 2FA - redirecionando para home");
                // Get the preferred start page from user preferences
                // Force loading from server to get the latest preferences after login
                await PreferenceService.InitializeAsync(forceServerLoad: true);
                var defaultPage = PreferenceService.CurrentPreferences.Dashboard.DefaultStartPage;
                Console.WriteLine($"[LOGIN] DefaultStartPage from preferences: '{defaultPage}'");
                var targetPage = defaultPage switch
                {
                    "Home" => "/",
                    "Dashboard" => "/dashboard",
                    "Kanban" => "/kanban",
                    "Vendas" => "/sales",
                    "Clientes" => "/sales/customers",
                    "Produtos" => "/inventory/products",
                    "Financeiro" => "/financial/dashboard",
                    _ => "/"
                };
                Console.WriteLine($"[LOGIN] Target page resolved to: '{targetPage}'");
                Console.WriteLine($"[LOGIN] ReturnUrl is: '{ReturnUrl}'");
                var target = string.IsNullOrWhiteSpace(ReturnUrl) ? targetPage : ReturnUrl;
                Console.WriteLine($"[LOGIN] Final navigation target: '{target}'");
                Nav.NavigateTo(target!, forceLoad: true);
            }
            else
            {
                // Mensagem de erro mais contextual baseada no status HTTP
                if (result.status > 0)
                {
                    var statusCode = (System.Net.HttpStatusCode)result.status;
                    error = ErrorMessageHelper.GetLoginErrorMessage(statusCode);
                }
                else
                {
                    error = string.IsNullOrWhiteSpace(result.text) 
                        ? "E-mail ou senha incorretos. Verifique seus dados e tente novamente." 
                        : result.text;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro no login: {ex.Message}");
            error = "Erro ao conectar com o servidor. Verifique sua conexão e tente novamente.";
        }
        finally
        {
            busy = false;
        }
    }

    public class LoginModel
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = string.Empty;

        [Required]
        public string Password { get; set; } = string.Empty;

        public bool RememberMe { get; set; } = true;
    }

    public class LoginResult
    {
        public bool ok { get; set; }
        public int status { get; set; }
        public string? text { get; set; }
        public LoginData? data { get; set; }
    }
    
    public class LoginData
    {
        public bool requiresTwoFactor { get; set; }
        public string? email { get; set; }
        public string? message { get; set; }
    }
}