@page "/login/verify-2fa"
@attribute [AllowAnonymous]
@using erp.DTOs.Auth
@using erp.Services
@using erp.Services.Tenancy
@using erp.Components.Branding
@using MudBlazor
@using System.Text.Json
@using Color = MudBlazor.Color
@using Size = MudBlazor.Size
@using Align = MudBlazor.Align
@inject IApiService ApiService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@inject ITenantBrandingProvider BrandingProvider

<PageTitle>Verificação 2FA • @_branding.TenantName</PageTitle>

<MudGrid Spacing="0" Style="height: 100vh; overflow: hidden;">
    <!-- Left Side: Branding / Image (Same as Login) -->
    <MudItem xs="12" md="6" lg="7" Class="d-none d-md-flex flex-column justify-center align-center relative" 
             Style="@($"background-color: white; color: white; position: relative;")">
        
        @* @if (!string.IsNullOrEmpty(_branding.LoginBackgroundUrl))
        {
             <div style="@($"position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('{_branding.LoginBackgroundUrl}'); background-size: cover; background-position: center; opacity: 0.4; mix-blend-mode: overlay;")"></div>
        }
        else
        {
             <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);"></div>
        } *@
        
        <div class="d-flex flex-column align-center gap-4 pa-8 text-center" style="z-index: 2; max-width: 600px;">
             <MudImage Src="@(_branding.LogoUrl ?? "/logo.png")" Alt="@_branding.TenantName" Width="600" Class="mb-6" ObjectFit="ObjectFit.Contain" />
             @* <MudText Typo="Typo.h2" Style="font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">@_branding.TenantName</MudText> *@
             @* <MudText Typo="Typo.h5" Style="opacity: 0.9; font-weight: 300;">Segurança em primeiro lugar.</MudText> *@
        </div>
    </MudItem>

    <!-- Right Side: 2FA Form -->
    <MudItem xs="12" md="6" lg="5" Class="d-flex justify-center align-center pa-4" Style="background-color: var(--mud-palette-background);">
        <MudPaper Elevation="0" Class="pa-8 w-100" Style="max-width: 480px; background: transparent;">
            
              <!-- Mobile Branding Header -->
              <div class="d-md-none d-flex flex-column align-center mb-8">
                  <MudImage Src="@(_branding.LogoUrl ?? "/logo.png")" Alt="@_branding.TenantName" Width="80" Class="mb-2" ObjectFit="ObjectFit.Contain" />
                  @* <MudText Typo="Typo.h5" Color="Color.Primary" Style="font-weight: 600;">@_branding.TenantName</MudText> *@
              </div>

            <div class="mb-10">
                <MudText Typo="Typo.h4" Style="font-weight: 700;" Class="mb-2">Verificação em Duas Etapas</MudText>
                <MudText Typo="Typo.body1" Color="Color.Secondary">
                    @(_useRecoveryCode ? "Digite seu código de recuperação." : "Digite o código de 6 dígitos do seu aplicativo autenticador.")
                </MudText>
            </div>

            @if (!_useRecoveryCode)
            {
                <MudTextField @bind-Value="_code"
                              Label="Código de Autenticação"
                              Variant="Variant.Outlined"
                              MaxLength="7"
                              Immediate="true"
                              HelperText="Exemplo: 123 456"
                              Class="mb-6"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Security"
                              OnKeyDown="HandleKeyDown"
                              AutoFocus="true" />

                <MudCheckBox @bind-Value="_rememberMachine" Color="Color.Primary" Class="mb-6" Label="Lembrar este dispositivo por 30 dias" />

                <MudButton OnClick="VerifyCode"
                           Color="Color.Primary"
                           Variant="Variant.Filled"
                           FullWidth="true"
                           Size="Size.Large"
                           Disabled="_verifying || string.IsNullOrWhiteSpace(_code)"
                           Class="mb-4 py-3"
                           Style="font-weight: 600; border-radius: 8px;">
                    @if (_verifying)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <text>Verificando...</text>
                    }
                    else
                    {
                        <text>Verificar Código</text>
                    }
                </MudButton>

                <div class="text-center mt-4">
                    <MudLink OnClick="SwitchToRecoveryCode" Color="Color.Primary" Underline="Underline.Hover">
                        Não tem acesso ao autenticador?
                    </MudLink>
                </div>
            }
            else
            {
                <MudAlert Severity="Severity.Warning" Class="mb-6" Variant="Variant.Filled" NoIcon="false">
                    Use um dos códigos de recuperação que foram fornecidos quando você habilitou 2FA.
                </MudAlert>

                <MudTextField @bind-Value="_code"
                              Label="Código de Recuperação"
                              Variant="Variant.Outlined"
                              HelperText="Digite o código de recuperação"
                              Class="mb-6"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.LockReset"
                              OnKeyDown="HandleKeyDown"
                              AutoFocus="true" />

                <MudButton OnClick="VerifyRecoveryCode"
                           Color="Color.Warning"
                           Variant="Variant.Filled"
                           FullWidth="true"
                           Size="Size.Large"
                           Disabled="_verifying || string.IsNullOrWhiteSpace(_code)"
                           Class="mb-4 py-3"
                           Style="font-weight: 600; border-radius: 8px;">
                    @if (_verifying)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <text>Verificando...</text>
                    }
                    else
                    {
                        <text>Usar Código de Recuperação</text>
                    }
                </MudButton>

                <div class="text-center mt-4">
                    <MudLink OnClick="SwitchToAuthenticator" Color="Color.Primary" Underline="Underline.Hover">
                        Voltar para código do autenticador
                    </MudLink>
                </div>
            }

            <div class="mt-8 text-center">
                <MudLink Href="/login" Color="Color.Secondary" Underline="Underline.Hover" Typo="Typo.body2">
                    Voltar para o login
                </MudLink>
            </div>
            
            @* <div class="mt-8 text-center">
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    &copy; @DateTime.Now.Year @_branding.TenantName. Todos os direitos reservados.
                </MudText>
            </div> *@
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private string _code = "";
    private bool _rememberMachine = false;
    private bool _verifying = false;
    private bool _useRecoveryCode = false;
    private TenantBrandingTheme _branding = TenantBrandingTheme.Default;

    protected override void OnInitialized()
    {
        _branding = BrandingProvider.GetCurrentBranding();
        // Verifica se há uma sessão de 2FA pendente
        // Se não houver, redireciona para login
        var uri = new Uri(NavigationManager.Uri);
        var queryParams = System.Web.HttpUtility.ParseQueryString(uri.Query);
        
        // Em produção, isso seria validado via sessão/cookie temporário
    }


    private void SwitchToRecoveryCode()
    {
        _useRecoveryCode = true;
        _code = "";
    }

    private void SwitchToAuthenticator()
    {
        _useRecoveryCode = false;
        _code = "";
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_code))
        {
            if (_useRecoveryCode)
                await VerifyRecoveryCode();
            else
                await VerifyCode();
        }
    }

    private async Task VerifyCode()
    {
        if (string.IsNullOrWhiteSpace(_code))
        {
            Snackbar.Add("Digite o código de autenticação", Severity.Warning);
            return;
        }

        _verifying = true;
        try
        {
            var payload = new VerifyTwoFactorLoginRequest
            {
                Code = _code,
                RememberMachine = _rememberMachine,
                IsRecoveryCode = false
            };

            // Chama via JS para garantir que o Set-Cookie do servidor seja aplicado no navegador
            // Usa função específica verify2fa para evitar erro de interop quando fetchJson não estiver disponível em versões antigas do script
            string resultJson;
            try
            {
                resultJson = await JS.InvokeAsync<string>("erpAuth.verify2fa", payload);
            }
            catch
            {
                // Fallback: se função não existir (cache antigo), usa fetchJson diretamente
                resultJson = await JS.InvokeAsync<string>("erpAuth.fetchJson", "/api/autenticacao/verify-2fa", payload);
            }
            var result = JsonSerializer.Deserialize<JsResult>(resultJson, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

            if (result?.Ok == true)
            {
                Snackbar.Add("Autenticado com sucesso!", Severity.Success);
                await Task.Delay(500);
                await JS.InvokeVoidAsync("eval", "window.location.href='/'");
            }
            else
            {
                var errorMsg = result?.Data?.Message ?? "Código de autenticação inválido.";
                Snackbar.Add(errorMsg, Severity.Error);
                _code = "";
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao verificar código: {ex.Message}", Severity.Error);
            _code = "";
        }
        finally
        {
            _verifying = false;
        }
    }

    private async Task VerifyRecoveryCode()
    {
        if (string.IsNullOrWhiteSpace(_code))
        {
            Snackbar.Add("Digite o código de recuperação", Severity.Warning);
            return;
        }

        _verifying = true;
        try
        {
            var payload = new VerifyTwoFactorLoginRequest
            {
                Code = _code,
                RememberMachine = false,
                IsRecoveryCode = true
            };

            // Usa função específica verify2fa
            string resultJson;
            try
            {
                resultJson = await JS.InvokeAsync<string>("erpAuth.verify2fa", payload);
            }
            catch
            {
                // Fallback para ambientes onde verify2fa ainda não está disponível no cache do navegador
                resultJson = await JS.InvokeAsync<string>("erpAuth.fetchJson", "/api/autenticacao/verify-2fa", payload);
            }
            var result = JsonSerializer.Deserialize<JsResult>(resultJson, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

            if (result?.Ok == true)
            {
                Snackbar.Add("Autenticado com código de recuperação!", Severity.Success);
                Snackbar.Add("IMPORTANTE: Gere novos códigos de recuperação em breve.", Severity.Warning);
                await Task.Delay(500);
                await JS.InvokeVoidAsync("eval", "window.location.href='/'");
            }
            else
            {
                var errorMsg = result?.Data?.Message ?? "Código de recuperação inválido.";
                Snackbar.Add(errorMsg, Severity.Error);
                _code = "";
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao verificar código: {ex.Message}", Severity.Error);
            _code = "";
        }
        finally
        {
            _verifying = false;
        }
    }
    
    // Classes para deserialização de resposta JS (unificada propriedade Message)
    private class JsResult
    {
        public bool Ok { get; set; }
        public int Status { get; set; }
        public string? Text { get; set; }
        public JsData? Data { get; set; }
    }

    private class JsData
    {
        public bool Success { get; set; }
        public string? Message { get; set; } // Aceita 'message' ou 'Message' via PropertyNameCaseInsensitive
        public string? RedirectUrl { get; set; }
    }
}
