@page "/assets"
@using erp.DTOs.Assets
@using erp.Services
@using erp.Components.Pages.Assets
@using erp.Models
@using MudBlazor
@using Size = MudBlazor.Size
@using Color = MudBlazor.Color
@attribute [Authorize]

@inject IApiService ApiService
@inject ILogger<Assets> Logger
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IDialogService DialogService

<PageTitle>Ativos</PageTitle>

<MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
    <MudText Typo="Typo.h4">Gerenciar Ativos</MudText>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled" 
                   StartIcon="@Icons.Material.Filled.Add"
                   OnClick="OpenCreateDialog">
            Adicionar Ativo
        </MudButton>
</MudStack>

@if (_loadError != null)
{
    <MudAlert Severity="Severity.Error" Class="mb-4">@_loadError</MudAlert>
}

<!-- Statistics Cards -->
@if (_statistics != null)
{
    <MudGrid Class="mb-4">
        <MudItem xs="12" sm="6" md="3">
            <MudCard>
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Total de Ativos</MudText>
                            <MudText Typo="Typo.h5">@_statistics.TotalAssets</MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.Inventory" Color="Color.Primary" Size="Size.Large"/>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard>
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Disponíveis</MudText>
                            <MudText Typo="Typo.h5">@_statistics.AvailableAssets</MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Large"/>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard>
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Em Uso</MudText>
                            <MudText Typo="Typo.h5">@_statistics.AssignedAssets</MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.PersonAdd" Color="Color.Info" Size="Size.Large"/>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard>
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Manutenções Atrasadas</MudText>
                            <MudText Typo="Typo.h5">@_statistics.OverdueMaintenances</MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Warning" Size="Size.Large"/>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
}

<!-- Assets Table -->
<MudPaper Elevation="4" Class="pa-4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudText Typo="Typo.h6">Lista de Ativos</MudText>
        <MudStack Row="true" Spacing="2">
            <MudTextField T="string" 
                          @bind-Value="_searchTerm"
                          Placeholder="Buscar..." 
                          Adornment="Adornment.Start" 
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Immediate="true"
                          DebounceInterval="300"
                          OnDebounceIntervalElapsed="LoadAssets"/>
            <MudSelect T="AssetStatus?" 
                       @bind-Value="_statusFilter"
                       Label="Status"
                       Variant="Variant.Outlined"
                       Margin="Margin.Dense"
                       Clearable="true"
                       OnClearButtonClick="async () => { _statusFilter = null; await LoadAssets(); }">
                <MudSelectItem T="AssetStatus?" Value="@AssetStatus.Available">Disponível</MudSelectItem>
                <MudSelectItem T="AssetStatus?" Value="@AssetStatus.InUse">Em Uso</MudSelectItem>
                <MudSelectItem T="AssetStatus?" Value="@AssetStatus.Maintenance">Manutenção</MudSelectItem>
                <MudSelectItem T="AssetStatus?" Value="@AssetStatus.Retired">Aposentado</MudSelectItem>
                <MudSelectItem T="AssetStatus?" Value="@AssetStatus.Lost">Perdido</MudSelectItem>
                <MudSelectItem T="AssetStatus?" Value="@AssetStatus.Sold">Vendido</MudSelectItem>
            </MudSelect>
        </MudStack>
    </MudStack>

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary"/>
    }

    <MudTable Items="@_assets" Hover="true" Striped="true" Dense="true">
        <HeaderContent>
            <MudTh>Código</MudTh>
            <MudTh>Nome</MudTh>
            <MudTh>Categoria</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Condição</MudTh>
            <MudTh>Atribuído a</MudTh>
            <MudTh>Localização</MudTh>
            <MudTh Style="text-align: center">Ações</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Código">
                <MudText Typo="Typo.body2" Style="font-family: monospace">@context.AssetCode</MudText>
            </MudTd>
            <MudTd DataLabel="Nome">
                <MudText Typo="Typo.body2">@context.Name</MudText>
                @if (!string.IsNullOrEmpty(context.SerialNumber))
                {
                    <MudText Typo="Typo.caption" Color="Color.Secondary">SN: @context.SerialNumber</MudText>
                }
            </MudTd>
            <MudTd DataLabel="Categoria">@context.CategoryName</MudTd>
            <MudTd DataLabel="Status">
                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                    @GetStatusText(context.Status)
                </MudChip>
            </MudTd>
            <MudTd DataLabel="Condição">
                <MudChip T="string" Size="Size.Small" Color="@GetConditionColor(context.Condition)">
                    @GetConditionText(context.Condition)
                </MudChip>
            </MudTd>
            <MudTd DataLabel="Atribuído a">
                @if (!string.IsNullOrEmpty(context.CurrentAssignedToUserName))
                {
                    <MudText Typo="Typo.body2">@context.CurrentAssignedToUserName</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Desde @context.CurrentAssignedDate?.ToString("dd/MM/yyyy")
                    </MudText>
                }
                else
                {
                    <MudText Typo="Typo.caption" Color="Color.Secondary">-</MudText>
                }
            </MudTd>
            <MudTd DataLabel="Localização">
                <MudText Typo="Typo.body2">@(context.Location ?? "-")</MudText>
            </MudTd>
            <MudTd DataLabel="Ações" Style="text-align: center">
                <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                               Size="Size.Small"
                               Href="@($"/assets/{context.Id}")"
                               Title="Ver detalhes"/>
                <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                               Size="Size.Small"
                               OnClick="@(() => OpenEditDialog(context.Id))"
                               Title="Editar"/>
                <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                               Size="Size.Small" 
                               Color="Color.Error"
                               OnClick="@(() => DeleteAsset(context.Id))"
                               Title="Excluir"/>
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>Nenhum ativo encontrado</MudText>
        </NoRecordsContent>
    </MudTable>
</MudPaper>

@code {
    private List<AssetDto> _assets = new();
    private AssetStatisticsDto? _statistics;
    private bool _loading = false;
    private string? _loadError;
    private string? _searchTerm;
    private AssetStatus? _statusFilter;

    private async Task OpenCreateDialog()
    {
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = false
        };

        var dialog = await DialogService.ShowAsync<AssetForm>("Adicionar Ativo", options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadStatistics();
            await LoadAssets();
        }
    }

    private async Task OpenEditDialog(int assetId)
    {
        var parameters = new DialogParameters
        {
            { "Id", assetId }
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = false
        };

        var dialog = await DialogService.ShowAsync<AssetForm>("Editar Ativo", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadStatistics();
            await LoadAssets();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadStatistics();
        await LoadAssets();
    }

    private async Task LoadStatistics()
    {
        try
        {
            _statistics = await ApiService.GetAsync<AssetStatisticsDto>("/api/assets/statistics");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erro ao carregar estatísticas de ativos");
        }
    }

    private async Task LoadAssets()
    {
        _loading = true;
        _loadError = null;

        try
        {
            var url = "/api/assets";
            
            if (_statusFilter.HasValue)
            {
                var filteredAssets = await ApiService.GetAsync<List<AssetDto>>($"/api/assets/status/{_statusFilter.Value}");
                _assets = filteredAssets ?? new List<AssetDto>();
            }
            else
            {
                var allAssets = await ApiService.GetAsync<List<AssetDto>>(url);
                _assets = allAssets ?? new List<AssetDto>();
            }

            // Apply search filter client-side
            if (!string.IsNullOrWhiteSpace(_searchTerm))
            {
                _assets = _assets.Where(a =>
                    a.AssetCode.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    a.Name.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    (a.SerialNumber?.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)
                ).ToList();
            }
        }
        catch (Exception ex)
        {
            _loadError = $"Erro ao carregar ativos: {ex.Message}";
            Logger.LogError(ex, "Erro ao carregar ativos");
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task DeleteAsset(int assetId)
    {
        try
        {
            var result = await ApiService.DeleteAsync($"/api/assets/{assetId}");
            if (result != null && result.IsSuccessStatusCode)
            {
                Snackbar.Add("Ativo excluído com sucesso", Severity.Success);
                await LoadStatistics();
                await LoadAssets();
            }
            else
            {
                Snackbar.Add("Erro ao excluir ativo", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erro ao excluir ativo {AssetId}", assetId);
            Snackbar.Add($"Erro ao excluir ativo: {ex.Message}", Severity.Error);
        }
    }

    private Color GetStatusColor(AssetStatus status) => status switch
    {
        AssetStatus.Available => Color.Success,
        AssetStatus.InUse => Color.Info,
        AssetStatus.Maintenance => Color.Warning,
        AssetStatus.Retired => Color.Default,
        AssetStatus.Lost => Color.Error,
        AssetStatus.Sold => Color.Secondary,
        _ => Color.Default
    };

    private string GetStatusText(AssetStatus status) => status switch
    {
        AssetStatus.Available => "Disponível",
        AssetStatus.InUse => "Em Uso",
        AssetStatus.Maintenance => "Manutenção",
        AssetStatus.Retired => "Aposentado",
        AssetStatus.Lost => "Perdido",
        AssetStatus.Sold => "Vendido",
        _ => status.ToString()
    };

    private Color GetConditionColor(AssetCondition condition) => condition switch
    {
        AssetCondition.Excellent => Color.Success,
        AssetCondition.Good => Color.Info,
        AssetCondition.Fair => Color.Warning,
        AssetCondition.Poor => Color.Error,
        AssetCondition.Damaged => Color.Error,
        _ => Color.Default
    };

    private string GetConditionText(AssetCondition condition) => condition switch
    {
        AssetCondition.Excellent => "Excelente",
        AssetCondition.Good => "Bom",
        AssetCondition.Fair => "Regular",
        AssetCondition.Poor => "Ruim",
        AssetCondition.Damaged => "Danificado",
        _ => condition.ToString()
    };
}
