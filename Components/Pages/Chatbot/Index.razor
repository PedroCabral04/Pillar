@page "/chatbot"
@page "/chatbot/{ConversationId:int}"
@using erp.DTOs.Chatbot
@using erp.Services
@using MudBlazor
@using System.Security.Claims
@using System.Text.Encodings.Web
@using Markdig
@inject IApiService ApiService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime

<PageTitle>Assistente Virtual - Pillar</PageTitle>

<div class="chatbot-fullpage">
    @* Sidebar *@
    <div class="chatbot-sidebar @(_sidebarCollapsed ? "collapsed" : "")">
        <div class="sidebar-header">
            @if (!_sidebarCollapsed)
            {
                <MudText Typo="Typo.h6" Class="sidebar-title">Conversas</MudText>
            }
            <MudIconButton Icon="@(_sidebarCollapsed ? Icons.Material.Filled.MenuOpen : Icons.Material.Filled.Menu)" 
                           OnClick="ToggleSidebar" 
                           Size="MudBlazor.Size.Small"
                           Title="@(_sidebarCollapsed ? "Expandir" : "Recolher")"/>
        </div>
        
        <div class="sidebar-new-chat">
            @if (_sidebarCollapsed)
            {
                <MudIconButton Icon="@Icons.Material.Filled.Add"
                               Color="MudBlazor.Color.Primary"
                               Variant="Variant.Outlined"
                               Size="MudBlazor.Size.Medium"
                               OnClick="CreateNewConversation"
                               Disabled="_isLoadingConversations"
                               Title="Nova conversa"/>
            }
            else
            {
                <MudButton Variant="Variant.Outlined" 
                           Color="MudBlazor.Color.Primary" 
                           FullWidth="true"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="CreateNewConversation"
                           Disabled="_isLoadingConversations">
                    Nova conversa
                </MudButton>
            }
        </div>
        
        @if (!_sidebarCollapsed)
        {
            <div class="sidebar-conversations">
                @if (_isLoadingConversations)
                {
                    <div class="loading-placeholder">
                        <MudProgressCircular Size="MudBlazor.Size.Small" Indeterminate="true"/>
                    </div>
                }
                else if (!_conversations.Any())
                {
                    <div class="empty-conversations">
                        <MudIcon Icon="@Icons.Material.Filled.ChatBubbleOutline" Size="MudBlazor.Size.Large" Color="MudBlazor.Color.Default"/>
                        <MudText Typo="Typo.body2">Nenhuma conversa ainda</MudText>
                    </div>
                }
                else
                {
                    @foreach (var conversation in _conversations)
                    {
                        <div class="conversation-item @(conversation.Id == _currentConversationId ? "active" : "")" 
                             @onclick="() => SelectConversation(conversation.Id)">
                            <div class="conversation-info">
                                <div class="conversation-title" title="@conversation.Title">@conversation.Title</div>
                                <div class="conversation-meta">
                                    @FormatDate(conversation.LastMessageAt ?? conversation.CreatedAt)
                                    @if (conversation.MessageCount >= 20)
                                    {
                                        <MudChip T="string" Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Warning" Variant="Variant.Text" Class="limit-chip">Limite</MudChip>
                                    }
                                </div>
                            </div>
                            <div class="conversation-actions">
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                               Size="MudBlazor.Size.Small" 
                                               Color="MudBlazor.Color.Error"
                                               OnClick="@(async () => await DeleteConversation(conversation.Id))"
                                               OnClickStopPropagation="true"
                                               Title="Excluir"/>
                            </div>
                        </div>
                    }
                }
            </div>
        }
    </div>
    
    @* Main Chat Area *@
    <div class="chatbot-main">
        <div class="main-header">
            <div class="header-left">
                @if (_currentConversation != null)
                {
                    <MudText Typo="Typo.h6">@_currentConversation.Title</MudText>
                    @if (_currentConversation.IsAtMessageLimit)
                    {
                        <MudChip T="string" Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Warning" Class="ml-2">
                            <MudIcon Icon="@Icons.Material.Filled.Warning" Size="MudBlazor.Size.Small" Class="mr-1"/>
                            Limite de 20 mensagens atingido
                        </MudChip>
                    }
                }
                else
                {
                    <MudText Typo="Typo.h6">Assistente Virtual</MudText>
                }
            </div>
            <div class="header-right">
                @if (_currentConversation != null)
                {
                    <MudTooltip Text="Editar título">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                       Size="MudBlazor.Size.Small"
                                       OnClick="OpenEditTitleDialog"/>
                    </MudTooltip>
                }
                <MudTooltip Text="Voltar ao sistema">
                    <MudIconButton Icon="@Icons.Material.Filled.Home" 
                                   Size="MudBlazor.Size.Small"
                                   Href="/"/>
                </MudTooltip>
            </div>
        </div>
        
        <div class="chat-messages-area" id="chat-messages-fullpage" @ref="_messagesContainer">
            @if (_isLoadingMessages)
            {
                <div class="loading-messages">
                    <MudProgressCircular Indeterminate="true"/>
                    <MudText Typo="Typo.body1">Carregando mensagens...</MudText>
                </div>
            }
            else if (_currentConversation == null || !_messages.Any())
            {
                <div class="empty-chat-state">
                    <div class="empty-icon">
                        <MudIcon Icon="@Icons.Material.Filled.AutoAwesome" Size="MudBlazor.Size.Large" Color="MudBlazor.Color.Primary"/>
                    </div>
                    <MudText Typo="Typo.h5" Class="mb-2">Como posso ajudar?</MudText>
                    <MudText Typo="Typo.body1" Style="color: var(--mud-palette-text-secondary);" Class="mb-4">
                        Inicie uma conversa para obter ajuda com produtos, vendas, financeiro e mais.
                    </MudText>
                    <div class="quick-actions">
                        @foreach (var action in _defaultSuggestedActions)
                        {
                            <MudButton Variant="Variant.Outlined" 
                                       Color="MudBlazor.Color.Primary"
                                       OnClick="@(() => SendQuickAction(action))">
                                @action
                            </MudButton>
                        }
                    </div>
                </div>
            }
            else
            {
                @foreach (var message in _messages)
                {
                    <div class="chat-message @(message.IsError ? "message-error" : message.Role == "user" ? "message-user" : "message-assistant")">
                        <div class="message-avatar">
                            @if (message.Role == "user")
                            {
                                <MudAvatar Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Primary">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="MudBlazor.Size.Small"/>
                                </MudAvatar>
                            }
                            else
                            {
                                <MudAvatar Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Secondary">
                                    <MudIcon Icon="@Icons.Material.Filled.SmartToy" Size="MudBlazor.Size.Small"/>
                                </MudAvatar>
                            }
                        </div>
                        <div class="message-body">
                            <div class="message-header">
                                <span class="message-role">@(message.Role == "user" ? "Você" : "Assistente")</span>
                                <span class="message-time">@message.Timestamp.ToLocalTime().ToString("HH:mm")</span>
                            </div>
                            <div class="message-content">
                                @RenderMessage(message.Content)
                            </div>
                        </div>
                    </div>
                }
                
                @if (_isProcessing)
                {
                    <div class="chat-message message-assistant">
                        <div class="message-avatar">
                            <MudAvatar Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Secondary">
                                <MudIcon Icon="@Icons.Material.Filled.SmartToy" Size="MudBlazor.Size.Small"/>
                            </MudAvatar>
                        </div>
                        <div class="message-body">
                            <div class="typing-indicator">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
        
        @if (_suggestedActions.Any() && !_isProcessing)
        {
            <div class="suggested-actions-area">
                @foreach (var action in _suggestedActions)
                {
                    <MudChip T="string" 
                             Size="MudBlazor.Size.Small" 
                             Color="MudBlazor.Color.Primary" 
                             Variant="Variant.Outlined"
                             OnClick="@(() => SendQuickAction(action))">
                        @action
                    </MudChip>
                }
            </div>
        }
        
        <div class="chat-input-area">
            @if (_currentConversation?.IsAtMessageLimit == true)
            {
                <div class="limit-warning">
                    <MudAlert Severity="Severity.Warning" Dense="true" Class="mb-2">
                        Esta conversa atingiu o limite de 20 mensagens. 
                        <MudLink OnClick="CreateNewConversation">Iniciar nova conversa</MudLink>
                    </MudAlert>
                </div>
            }
            <div class="input-container">
                <MudTextField @bind-Value="_currentMessage"
                              Placeholder="Digite sua mensagem..."
                              Variant="Variant.Outlined"
                              Lines="1"
                              MaxLines="5"
                              AutoGrow="true"
                              OnKeyDown="HandleKeyDown"
                              Disabled="@(_isProcessing || _currentConversation?.IsAtMessageLimit == true)"
                              Immediate="true"
                              FullWidth="true"/>
                <MudIconButton Icon="@Icons.Material.Filled.Send" 
                               Color="MudBlazor.Color.Primary" 
                               Variant="Variant.Filled"
                               Size="MudBlazor.Size.Large"
                               Class="send-button"
                               OnClick="SendMessage"
                               Disabled="@(string.IsNullOrWhiteSpace(_currentMessage) || _isProcessing || _currentConversation?.IsAtMessageLimit == true)"/>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int? ConversationId { get; set; }
    
    private static readonly MarkdownPipeline _markdownPipeline = new MarkdownPipelineBuilder()
        .UseAdvancedExtensions()
        .Build();
    
    private List<ChatConversationListDto> _conversations = new();
    private ChatConversationDto? _currentConversation;
    private List<ChatMessageDto> _messages = new();
    private List<string> _suggestedActions = new();
    private List<string> _defaultSuggestedActions = new()
    {
        "O que você pode fazer?",
        "Listar produtos",
        "Resumo de vendas",
        "Contas a pagar"
    };
    
    private string _currentMessage = string.Empty;
    private int? _currentConversationId;
    private bool _isLoadingConversations = true;
    private bool _isLoadingMessages;
    private bool _isProcessing;
    private bool _sidebarCollapsed;
    private ElementReference _messagesContainer;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadConversations();
    }
    
    protected override async Task OnParametersSetAsync()
    {
        if (ConversationId.HasValue && ConversationId != _currentConversationId)
        {
            await SelectConversation(ConversationId.Value);
        }
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_messages.Any() || _isProcessing)
        {
            await ScrollToBottom();
        }
    }
    
    private async Task LoadConversations()
    {
        _isLoadingConversations = true;
        try
        {
            var result = await ApiService.GetAsync<List<ChatConversationListDto>>("api/chatbot/conversations");
            _conversations = result ?? new();
            
            // If URL has conversation ID but not loaded yet
            if (ConversationId.HasValue && _currentConversationId != ConversationId.Value)
            {
                await SelectConversation(ConversationId.Value);
            }
        }
        catch (Exception)
        {
            Snackbar.Add("Erro ao carregar conversas", Severity.Error);
        }
        finally
        {
            _isLoadingConversations = false;
        }
    }
    
    private async Task SelectConversation(int conversationId)
    {
        if (_currentConversationId == conversationId)
            return;
            
        _isLoadingMessages = true;
        _currentConversationId = conversationId;
        _messages.Clear();
        _suggestedActions.Clear();
        StateHasChanged();
        
        try
        {
            var conversation = await ApiService.GetAsync<ChatConversationDto>($"api/chatbot/conversations/{conversationId}");
            if (conversation != null)
            {
                _currentConversation = conversation;
                _messages = conversation.Messages;
                
                // Update URL without full navigation
                NavigationManager.NavigateTo($"/chatbot/{conversationId}", replace: true);
            }
            else
            {
                Snackbar.Add("Conversa não encontrada", Severity.Warning);
                _currentConversationId = null;
                NavigationManager.NavigateTo("/chatbot", replace: true);
            }
        }
        catch
        {
            Snackbar.Add("Erro ao carregar conversa", Severity.Error);
        }
        finally
        {
            _isLoadingMessages = false;
        }
    }
    
    private async Task CreateNewConversation()
    {
        _currentConversationId = null;
        _currentConversation = null;
        _messages.Clear();
        _suggestedActions.Clear();
        _currentMessage = string.Empty;
        NavigationManager.NavigateTo("/chatbot", replace: true);
        StateHasChanged();
    }
    
    private async Task DeleteConversation(int conversationId)
    {
        try
        {
            await ApiService.DeleteAsync($"api/chatbot/conversations/{conversationId}");
            _conversations.RemoveAll(c => c.Id == conversationId);
            
            if (_currentConversationId == conversationId)
            {
                await CreateNewConversation();
            }
            
            Snackbar.Add("Conversa excluída", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Erro ao excluir conversa", Severity.Error);
        }
    }
    
    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await SendMessage();
        }
    }
    
    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_currentMessage) || _isProcessing)
            return;
            
        var message = _currentMessage.Trim();
        _currentMessage = string.Empty;
        _suggestedActions.Clear();
        
        // Add user message immediately for visual feedback
        var tempUserMessage = new ChatMessageDto
        {
            Id = Guid.NewGuid().ToString(),
            Role = "user",
            Content = message,
            Timestamp = DateTime.UtcNow
        };
        _messages.Add(tempUserMessage);
        
        _isProcessing = true;
        await InvokeAsync(StateHasChanged);
        
        try
        {
            // If no current conversation, create one
            if (_currentConversationId == null)
            {
                var newConv = await ApiService.PostAsync<ChatConversationDto>("api/chatbot/conversations", new CreateConversationDto());
                if (newConv != null)
                {
                    _currentConversationId = newConv.Id;
                    _currentConversation = newConv;
                    await LoadConversations(); // Refresh sidebar
                    NavigationManager.NavigateTo($"/chatbot/{newConv.Id}", replace: true);
                }
            }
            
            if (_currentConversationId == null)
            {
                Snackbar.Add("Erro ao criar conversa", Severity.Error);
                _messages.Remove(tempUserMessage); // Remove temp message on error
                return;
            }
            
            var response = await ApiService.PostAsync<ConversationMessageResponseDto>(
                $"api/chatbot/conversations/{_currentConversationId}/messages",
                new SendMessageToConversationDto { Message = message });
            
            if (response != null)
            {
                // Replace temp message with the real one (has correct ID from database)
                _messages.Remove(tempUserMessage);
                if (response.UserMessage != null)
                {
                    _messages.Add(response.UserMessage);
                }
                
                if (response.AssistantMessage != null)
                {
                    _messages.Add(response.AssistantMessage);
                }
                
                if (response.SuggestedActions?.Any() == true)
                {
                    _suggestedActions = response.SuggestedActions;
                }
                
                if (_currentConversation != null)
                {
                    _currentConversation.IsAtMessageLimit = response.IsAtMessageLimit;
                }
                
                // Refresh sidebar to update message counts
                await LoadConversations();
                
                if (!response.Success && !string.IsNullOrEmpty(response.Error))
                {
                    if (response.IsAtMessageLimit)
                    {
                        Snackbar.Add(response.Error, Severity.Warning);
                    }
                }
            }
        }
        catch (Exception)
        {
            // Remove temp message on error and add error message
            _messages.Remove(tempUserMessage);
            _messages.Add(new ChatMessageDto
            {
                Id = Guid.NewGuid().ToString(),
                Role = "user",
                Content = message,
                Timestamp = DateTime.UtcNow
            });
            _messages.Add(new ChatMessageDto
            {
                Id = Guid.NewGuid().ToString(),
                Role = "assistant",
                Content = "Erro ao enviar mensagem. Tente novamente.",
                Timestamp = DateTime.UtcNow,
                IsError = true
            });
            Snackbar.Add("Erro ao enviar mensagem", Severity.Error);
        }
        finally
        {
            _isProcessing = false;
            await InvokeAsync(StateHasChanged);
        }
    }
    
    private async Task SendQuickAction(string action)
    {
        _currentMessage = action;
        await SendMessage();
    }
    
    private async Task OpenEditTitleDialog()
    {
        if (_currentConversation == null) return;
        
        var newTitle = await JSRuntime.InvokeAsync<string?>("prompt", "Novo título:", _currentConversation.Title);
        if (!string.IsNullOrWhiteSpace(newTitle) && newTitle != _currentConversation.Title)
        {
            try
            {
                await ApiService.PutAsync($"api/chatbot/conversations/{_currentConversationId}", new UpdateConversationDto { Title = newTitle });
                _currentConversation.Title = newTitle;
                
                var conv = _conversations.FirstOrDefault(c => c.Id == _currentConversationId);
                if (conv != null)
                {
                    conv.Title = newTitle;
                }
                
                Snackbar.Add("Título atualizado", Severity.Success);
            }
            catch
            {
                Snackbar.Add("Erro ao atualizar título", Severity.Error);
            }
        }
    }
    
    private void ToggleSidebar()
    {
        _sidebarCollapsed = !_sidebarCollapsed;
    }
    
    private MarkupString RenderMessage(string message)
    {
        if (string.IsNullOrEmpty(message))
            return new MarkupString(string.Empty);

        try
        {
            var html = Markdig.Markdown.ToHtml(message, _markdownPipeline);
            return new MarkupString(html);
        }
        catch
        {
            var encoded = HtmlEncoder.Default.Encode(message);
            var withBreaks = encoded
                .Replace("\r\n", "<br>")
                .Replace("\r", "<br>")
                .Replace("\n", "<br>");
            return new MarkupString(withBreaks);
        }
    }
    
    private string FormatDate(DateTime date)
    {
        var local = date.ToLocalTime();
        var now = DateTime.Now;
        
        if (local.Date == now.Date)
            return local.ToString("HH:mm");
        if (local.Date == now.Date.AddDays(-1))
            return "Ontem";
        if (local.Date > now.Date.AddDays(-7))
            return local.ToString("dddd", new System.Globalization.CultureInfo("pt-BR"));
        
        return local.ToString("dd/MM/yyyy");
    }
    
    private async Task ScrollToBottom()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("eval", 
                "document.getElementById('chat-messages-fullpage')?.scrollTo({ top: document.getElementById('chat-messages-fullpage').scrollHeight, behavior: 'smooth' })");
        }
        catch { }
    }
}

<style>
.chatbot-fullpage {
    display: flex;
    height: 100vh;
    width: 100vw;
    position: fixed;
    top: 0;
    left: 0;
    background: var(--mud-palette-background);
    z-index: 9999;
}

/* Sidebar */
.chatbot-sidebar {
    width: 280px;
    min-width: 280px;
    background: var(--mud-palette-surface);
    border-right: 1px solid var(--mud-palette-lines-default);
    display: flex;
    flex-direction: column;
    transition: width 0.2s ease, min-width 0.2s ease;
}

.chatbot-sidebar.collapsed {
    width: 60px;
    min-width: 60px;
    overflow: hidden;
}

.sidebar-header {
    padding: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--mud-palette-lines-default);
}

.sidebar-title {
    font-weight: 600;
}

.sidebar-new-chat {
    padding: 12px;
    display: flex;
    justify-content: center;
}

.sidebar-conversations {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
}

.loading-placeholder, .empty-conversations {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 32px 16px;
    gap: 12px;
    color: var(--mud-palette-text-secondary);
}

.conversation-item {
    padding: 12px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 4px;
    transition: background 0.15s ease;
}

.conversation-item:hover {
    background: var(--mud-palette-action-default-hover);
}

.conversation-item.active {
    background: rgba(var(--mud-palette-primary-rgb), 0.12);
}

.conversation-info {
    flex: 1;
    min-width: 0;
}

.conversation-title {
    font-weight: 500;
    font-size: 0.875rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.conversation-meta {
    font-size: 0.75rem;
    color: var(--mud-palette-text-secondary);
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 4px;
}

.limit-chip {
    font-size: 0.65rem !important;
    height: 18px !important;
}

.conversation-actions {
    opacity: 0;
    transition: opacity 0.15s ease;
}

.conversation-item:hover .conversation-actions {
    opacity: 1;
}

/* Main Chat Area */
.chatbot-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
}

.main-header {
    padding: 16px 24px;
    border-bottom: 1px solid var(--mud-palette-lines-default);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--mud-palette-surface);
}

.header-left {
    display: flex;
    align-items: center;
    gap: 8px;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 4px;
}

.chat-messages-area {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.loading-messages {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    gap: 16px;
}

.empty-chat-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    padding: 24px;
}

.empty-icon {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(var(--mud-palette-primary-rgb), 0.1) 0%, rgba(var(--mud-palette-primary-rgb), 0.05) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 24px;
}

.quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: center;
    max-width: 600px;
}

/* Messages */
.chat-message {
    display: flex;
    gap: 12px;
    max-width: 800px;
    width: 100%;
    margin: 0 auto;
}

.message-user {
    flex-direction: row-reverse;
}

.message-avatar {
    flex-shrink: 0;
}

.message-body {
    flex: 1;
    min-width: 0;
}

.message-user .message-body {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
}

.message-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
    font-size: 0.8rem;
}

.message-role {
    font-weight: 600;
}

.message-time {
    color: var(--mud-palette-text-secondary);
}

.message-content {
    padding: 12px 16px;
    border-radius: 12px;
    font-size: 0.9rem;
    line-height: 1.6;
    position: relative;
    overflow: hidden;
}

.message-user .message-content {
    background: var(--mud-palette-primary);
    color: white;
    border-bottom-right-radius: 4px;
}

.message-assistant .message-content {
    background: var(--mud-palette-surface);
    border: 1px solid var(--mud-palette-lines-default);
    border-bottom-left-radius: 4px;
}

.message-error .message-content {
    background: rgba(var(--mud-palette-error-rgb), 0.1);
    border-color: rgba(var(--mud-palette-error-rgb), 0.3);
    color: var(--mud-palette-error);
}

/* Markdown styles */
.message-assistant .message-content p { margin: 0 0 8px 0; }
.message-assistant .message-content p:last-child { margin-bottom: 0; }
.message-assistant .message-content ul, 
.message-assistant .message-content ol { margin: 8px 0; padding-left: 20px; }
.message-assistant .message-content li { margin: 4px 0; }
.message-assistant .message-content code {
    background: rgba(0,0,0,0.06);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Consolas', monospace;
    font-size: 0.85em;
}
.message-assistant .message-content pre {
    background: rgba(0,0,0,0.06);
    padding: 12px;
    border-radius: 6px;
    overflow-x: auto;
    margin: 8px 0;
}
.message-assistant .message-content pre code {
    background: none;
    padding: 0;
}
.message-assistant .message-content table {
    border-collapse: collapse;
    margin: 8px 0;
    width: 100%;
}
.message-assistant .message-content th,
.message-assistant .message-content td {
    border: 1px solid var(--mud-palette-lines-default);
    padding: 8px;
}
.message-assistant .message-content th {
    background: rgba(0,0,0,0.04);
    font-weight: 600;
}

/* Typing indicator */
.typing-indicator {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 12px 16px;
    background: var(--mud-palette-surface);
    border: 1px solid var(--mud-palette-lines-default);
    border-radius: 12px;
    border-bottom-left-radius: 4px;
    width: fit-content;
}

.typing-dot {
    width: 8px;
    height: 8px;
    background: var(--mud-palette-text-secondary);
    border-radius: 50%;
    animation: typingBounce 1.4s infinite ease-in-out both;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }
.typing-dot:nth-child(3) { animation-delay: 0s; }

@@keyframes typingBounce {
    0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
    40% { transform: scale(1); opacity: 1; }
}

/* Suggested actions */
.suggested-actions-area {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 12px 24px;
    justify-content: center;
    max-width: 800px;
    margin: 0 auto;
    width: 100%;
}

/* Input area */
.chat-input-area {
    padding: 16px 24px 24px;
    background: var(--mud-palette-background);
    border-top: 1px solid var(--mud-palette-lines-default);
}

.limit-warning {
    max-width: 800px;
    margin: 0 auto;
}

.input-container {
    display: flex;
    gap: 12px;
    align-items: flex-end;
    max-width: 900px;
    margin: 0 auto;
    width: 100%;
}

.input-container ::deep .mud-input-control {
    margin: 0;
    flex: 1;
    min-width: 0;
}

.input-container ::deep .mud-input-outlined .mud-input-outlined-border {
    border-radius: 24px;
}

.send-button {
    border-radius: 50%;
    min-width: 48px;
    width: 48px;
    height: 48px;
}

/* Responsive */
@@media (max-width: 768px) {
    .chatbot-sidebar {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        z-index: 100;
        box-shadow: 2px 0 8px rgba(0,0,0,0.1);
    }
    
    .chatbot-sidebar.collapsed {
        width: 0;
        min-width: 0;
        overflow: hidden;
    }
    
    .chat-messages-area {
        padding: 16px;
    }
    
    .chat-message {
        max-width: 100%;
    }
    
    .chat-input-area {
        padding: 12px 16px 16px;
    }
}

/* Scrollbar */
.sidebar-conversations::-webkit-scrollbar,
.chat-messages-area::-webkit-scrollbar {
    width: 6px;
}

.sidebar-conversations::-webkit-scrollbar-track,
.chat-messages-area::-webkit-scrollbar-track {
    background: transparent;
}

.sidebar-conversations::-webkit-scrollbar-thumb,
.chat-messages-area::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,0.15);
    border-radius: 3px;
}

.sidebar-conversations::-webkit-scrollbar-thumb:hover,
.chat-messages-area::-webkit-scrollbar-thumb:hover {
    background: rgba(0,0,0,0.25);
}

/* Dark mode */
::deep .mud-theme-dark .message-assistant .message-content code {
    background: rgba(255,255,255,0.1);
}

::deep .mud-theme-dark .message-assistant .message-content pre {
    background: rgba(255,255,255,0.1);
}

::deep .mud-theme-dark .message-assistant .message-content th {
    background: rgba(255,255,255,0.06);
}
</style>
