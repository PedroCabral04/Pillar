@page "/reports/sales"
@attribute [Authorize]
@using erp.DTOs.Reports
@using erp.Services
@using Microsoft.AspNetCore.Authorization
@using Color = MudBlazor.Color
@using Size = MudBlazor.Size
@using ApexCharts
@inject IApiService ApiService
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@inject CurrencyFormatService Currency

<PageTitle>Relatórios de Vendas - Pillar ERP</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudBreadcrumbs Items="_breadcrumbItems" Class="mb-4" />
    
    <MudText Typo="Typo.h4" GutterBottom="true">
        <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Class="mr-2" />
        Relatório de Vendas
    </MudText>

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
        <!-- General Sales Tab -->
        <MudTabPanel Text="Relatório Geral" Icon="@Icons.Material.Filled.Receipt">

    <!-- Filters Card -->
    <MudCard Elevation="3" Class="mb-4">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Filtros</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudGrid>
                <MudItem xs="12" sm="6" md="3">
                    <MudDatePicker Label="Data Início" @bind-Date="_filter.StartDate" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudDatePicker Label="Data Fim" @bind-Date="_filter.EndDate" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudSelect T="string" Label="Status" @bind-Value="_filter.Status" Clearable="true">
                        <MudSelectItem Value="@("Pendente")">Pendente</MudSelectItem>
                        <MudSelectItem Value="@("Finalizada")">Finalizada</MudSelectItem>
                        <MudSelectItem Value="@("Cancelada")">Cancelada</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudSelect T="string" Label="Forma de Pagamento" @bind-Value="_filter.PaymentMethod" Clearable="true">
                        <MudSelectItem Value="@("Dinheiro")">Dinheiro</MudSelectItem>
                        <MudSelectItem Value="@("Cartão de Crédito")">Cartão de Crédito</MudSelectItem>
                        <MudSelectItem Value="@("Cartão de Débito")">Cartão de Débito</MudSelectItem>
                        <MudSelectItem Value="@("PIX")">PIX</MudSelectItem>
                        <MudSelectItem Value="@("Boleto")">Boleto</MudSelectItem>
                    </MudSelect>
                </MudItem>
            </MudGrid>
        </MudCardContent>
        <MudCardActions>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadReport" StartIcon="@Icons.Material.Filled.Search">
                Gerar Relatório
            </MudButton>
            <MudButton Variant="Variant.Outlined" OnClick="ClearFilters" StartIcon="@Icons.Material.Filled.Clear">
                Limpar Filtros
            </MudButton>
        </MudCardActions>
    </MudCard>

    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
    }

    @if (_report != null && !_loading)
    {
        <!-- Summary Card -->
        <MudCard Elevation="3" Class="mb-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Resumo do Período</MudText>
                </CardHeaderContent>
                <CardHeaderActions>
                    <MudButtonGroup Variant="Variant.Outlined" Size="Size.Small">
                        <MudButton StartIcon="@Icons.Material.Filled.PictureAsPdf" OnClick='() => ExportReport("pdf")' Color="Color.Error">
                            Exportar PDF
                        </MudButton>
                        <MudButton StartIcon="@Icons.Material.Filled.TableChart" OnClick='() => ExportReport("excel")' Color="Color.Success">
                            Exportar Excel
                        </MudButton>
                    </MudButtonGroup>
                </CardHeaderActions>
            </MudCardHeader>
            <MudCardContent>
                <MudGrid>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Class="pa-4" Elevation="0">
                            <MudText Typo="Typo.subtitle2" Color="Color.Primary">Total de Vendas</MudText>
                            <MudText Typo="Typo.h5">@_report.Summary.TotalSales</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Class="pa-4" Elevation="0">
                            <MudText Typo="Typo.subtitle2" Color="Color.Success">Receita Total</MudText>
                            <MudText Typo="Typo.h5">@Currency.Format(_report.Summary.TotalRevenue)</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Class="pa-4" Elevation="0">
                            <MudText Typo="Typo.subtitle2" Color="Color.Warning">Descontos</MudText>
                            <MudText Typo="Typo.h5">@Currency.Format(_report.Summary.TotalDiscounts)</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Class="pa-4" Elevation="0">
                            <MudText Typo="Typo.subtitle2" Color="Color.Info">Receita Líquida</MudText>
                            <MudText Typo="Typo.h5">@Currency.Format(_report.Summary.NetRevenue)</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="4">
                        <MudPaper Class="pa-4" Elevation="0">
                            <MudText Typo="Typo.subtitle2">Ticket Médio</MudText>
                            <MudText Typo="Typo.h6">@Currency.Format(_report.Summary.AverageTicket)</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="4">
                        <MudPaper Class="pa-4" Elevation="0">
                            <MudText Typo="Typo.subtitle2">Total de Itens Vendidos</MudText>
                            <MudText Typo="Typo.h6">@_report.Summary.TotalItemsSold</MudText>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </MudCardContent>
        </MudCard>

        <!-- Sales Table -->
        <MudCard Elevation="3">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Detalhamento das Vendas (@_report.Items.Count vendas)</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudTable Items="@_report.Items" Hover="true" Striped="true" Dense="true" Filter="new Func<SalesReportItemDto, bool>(FilterFunc)">
                    <ToolBarContent>
                        <MudTextField @bind-Value="_searchString" Placeholder="Buscar..." Adornment="Adornment.Start" 
                                      AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0" Immediate="true" />
                    </ToolBarContent>
                    <HeaderContent>
                        <MudTh>Número</MudTh>
                        <MudTh>Data</MudTh>
                        <MudTh>Cliente</MudTh>
                        <MudTh>Vendedor</MudTh>
                        <MudTh><MudTableSortLabel SortBy="new Func<SalesReportItemDto, object>(x => x.TotalAmount)">Total</MudTableSortLabel></MudTh>
                        <MudTh>Desconto</MudTh>
                        <MudTh><MudTableSortLabel SortBy="new Func<SalesReportItemDto, object>(x => x.NetAmount)">Líquido</MudTableSortLabel></MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh>Pagamento</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Número">@context.SaleNumber</MudTd>
                        <MudTd DataLabel="Data">@context.SaleDate.ToString("dd/MM/yyyy")</MudTd>
                        <MudTd DataLabel="Cliente">@context.CustomerName</MudTd>
                        <MudTd DataLabel="Vendedor">@context.SalespersonName</MudTd>
                        <MudTd DataLabel="Total">@Currency.Format(context.TotalAmount)</MudTd>
                        <MudTd DataLabel="Desconto">@Currency.Format(context.DiscountAmount)</MudTd>
                        <MudTd DataLabel="Líquido"><strong>@Currency.Format(context.NetAmount)</strong></MudTd>
                        <MudTd DataLabel="Status">
                            <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">@context.Status</MudChip>
                        </MudTd>
                        <MudTd DataLabel="Pagamento">@context.PaymentMethod</MudTd>
                    </RowTemplate>
                    <PagerContent>
                        <MudTablePager PageSizeOptions="new int[]{10, 25, 50, 100}" />
                    </PagerContent>
                    </MudTable>
            </MudCardContent>
        </MudCard>
    }
        </MudTabPanel>

        <!-- Sales Heatmap Tab -->
        <MudTabPanel Text="Mapa de Calor" Icon="@Icons.Material.Filled.CalendarViewWeek">
            <MudCard Elevation="3" Class="mb-4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Mapa de Calor de Vendas</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            Analise os horários de pico para otimizar a escala de funcionários
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudGrid>
                        <MudItem xs="12" sm="6" md="3">
                            <MudDatePicker Label="Data Início" @bind-Date="_heatmapFilter.StartDate" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudDatePicker Label="Data Fim" @bind-Date="_heatmapFilter.EndDate" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudSelect T="string" Label="Métrica" @bind-Value="_heatmapMetric" Variant="Variant.Outlined">
                                <MudSelectItem Value="@("count")">Quantidade de Vendas</MudSelectItem>
                                <MudSelectItem Value="@("revenue")">Faturamento</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadHeatmapReport" StartIcon="@Icons.Material.Filled.Search" Class="mt-4">
                                Gerar Mapa
                            </MudButton>
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>

            @if (_loadingHeatmap)
            {
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
            }

            @if (_heatmapReport != null)
            {
                <!-- Summary Cards -->
                <MudGrid Class="mb-4">
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Class="pa-4" Elevation="3">
                            <MudText Typo="Typo.subtitle2" Color="Color.Primary">Total de Vendas</MudText>
                            <MudText Typo="Typo.h5">@_heatmapReport.Summary.TotalSales</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Class="pa-4" Elevation="3">
                            <MudText Typo="Typo.subtitle2" Color="Color.Success">Faturamento Total</MudText>
                            <MudText Typo="Typo.h5">@Currency.Format(_heatmapReport.Summary.TotalRevenue)</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Class="pa-4" Elevation="3" Style="background-color: #E8F5E9;">
                            <MudText Typo="Typo.subtitle2" Color="Color.Success">
                                <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Small" /> Pico de Vendas
                            </MudText>
                            <MudText Typo="Typo.h6">@_heatmapReport.Summary.PeakDay @_heatmapReport.Summary.PeakHour</MudText>
                            <MudText Typo="Typo.body2">@_heatmapReport.Summary.PeakSalesCount vendas (@Currency.Format(_heatmapReport.Summary.PeakRevenue))</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Class="pa-4" Elevation="3">
                            <MudText Typo="Typo.subtitle2" Color="Color.Info">Média por Hora</MudText>
                            <MudText Typo="Typo.h5">@_heatmapReport.Summary.AverageSalesPerHour.ToString("N1") vendas</MudText>
                        </MudPaper>
                    </MudItem>
                </MudGrid>

                <!-- Heatmap Chart -->
                <MudCard Elevation="3">
                    <MudCardContent>
                        @if (_heatmapReport.Series.Any())
                        {
                            <ApexChart TItem="SalesHeatmapDataPoint"
                                       Title="@(_heatmapMetric == "count" ? "Vendas por Dia da Semana e Hora" : "Faturamento por Dia da Semana e Hora")"
                                       Options="_heatmapChartOptions"
                                       Height="350">
                                @foreach (var series in _heatmapReport.Series)
                                {
                                    <ApexPointSeries TItem="SalesHeatmapDataPoint"
                                                     Items="series.Data"
                                                     Name="@series.Name"
                                                     SeriesType="SeriesType.Heatmap"
                                                     XValue="@(e => e.X)"
                                                     YValue="@(e => _heatmapMetric == "count" ? e.Y : (int)e.Revenue)" />
                                }
                            </ApexChart>
                        }
                        else
                        {
                            <MudText>Sem dados para o período selecionado.</MudText>
                        }
                    </MudCardContent>
                </MudCard>

                <!-- Insights Card -->
                <MudCard Elevation="3" Class="mt-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">
                                <MudIcon Icon="@Icons.Material.Filled.Lightbulb" Class="mr-2" />
                                Insights para Escala de Funcionários
                            </MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudList T="string" Dense="true">
                            <MudListItem Icon="@Icons.Material.Filled.Schedule">
                                <MudText><strong>Horário de pico:</strong> @_heatmapReport.Summary.PeakDay às @_heatmapReport.Summary.PeakHour - Considere aumentar a equipe neste período</MudText>
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.WarningAmber">
                                <MudText><strong>Horário mais fraco:</strong> @_heatmapReport.Summary.LowestDay às @_heatmapReport.Summary.LowestHour - Oportunidade para reduzir custos ou investir em promoções</MudText>
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.Analytics">
                                <MudText><strong>Média:</strong> @_heatmapReport.Summary.AverageSalesPerHour.ToString("N1") vendas por hora - Use como base para dimensionamento</MudText>
                            </MudListItem>
                        </MudList>
                    </MudCardContent>
                </MudCard>
            }
        </MudTabPanel>
    </MudTabs>
</MudContainer>

@code {
    private List<BreadcrumbItem> _breadcrumbItems = new()
    {
        new BreadcrumbItem("Início", href: "/"),
        new BreadcrumbItem("Relatórios", href: "/reports"),
        new BreadcrumbItem("Vendas", href: null, disabled: true)
    };

    private SalesReportFilterDto _filter = new()
    {
        StartDate = DateTime.Today.AddMonths(-1),
        EndDate = DateTime.Today
    };

    private SalesReportFilterDto _heatmapFilter = new()
    {
        StartDate = DateTime.Today.AddMonths(-3),
        EndDate = DateTime.Today
    };

    private SalesReportResultDto? _report;
    private SalesHeatmapReportDto? _heatmapReport;
    private bool _loading = false;
    private bool _loadingHeatmap = false;
    private string _searchString = "";
    private string _heatmapMetric = "count";

    // Heatmap chart options
    private ApexChartOptions<SalesHeatmapDataPoint> _heatmapChartOptions = new()
    {
        Chart = new Chart
        {
            Toolbar = new Toolbar { Show = false },
            Background = "transparent"
        },
        DataLabels = new ApexCharts.DataLabels { Enabled = false },
        PlotOptions = new PlotOptions
        {
            Heatmap = new PlotOptionsHeatmap
            {
                Radius = 2,
                EnableShades = true,
                ShadeIntensity = 0.5
            }
        },
        Xaxis = new XAxis
        {
            Labels = new XAxisLabels
            {
                Rotate = -45,
                Style = new AxisLabelStyle { FontSize = "10px" }
            }
        },
        Legend = new Legend
        {
            Position = LegendPosition.Bottom
        },
        Colors = new List<string> { "#008FFB" },
        Tooltip = new Tooltip
        {
            Y = new TooltipY
            {
                Formatter = @"function (value) {
                    return value + ' vendas';
                }"
            }
        }
    };

    private async Task LoadHeatmapReport()
    {
        try
        {
            _loadingHeatmap = true;
            var response = await ApiService.PostAsync<SalesHeatmapReportDto>("/api/reports/sales/heatmap", _heatmapFilter);
            
            if (response != null)
            {
                _heatmapReport = response;
                Snackbar.Add("Mapa de calor gerado com sucesso!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Erro ao gerar mapa de calor", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loadingHeatmap = false;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadReport();
    }

    private async Task LoadReport()
    {
        try
        {
            _loading = true;
            var response = await ApiService.PostAsync<SalesReportResultDto>("/api/reports/sales", _filter);
            
            if (response != null)
            {
                _report = response;
                Snackbar.Add("Relatório gerado com sucesso!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Erro ao gerar relatório", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task ExportReport(string format)
    {
        try
        {
            _loading = true;
            _filter.ExportFormat = format;
            
            // For file downloads, we need to use the browser's download mechanism
            var url = $"/api/reports/sales/export?StartDate={_filter.StartDate:yyyy-MM-dd}&EndDate={_filter.EndDate:yyyy-MM-dd}&ExportFormat={format}";
            if (_filter.CustomerId.HasValue)
                url += $"&CustomerId={_filter.CustomerId}";
            if (!string.IsNullOrEmpty(_filter.PaymentMethod))
                url += $"&PaymentMethod={_filter.PaymentMethod}";
            if (!string.IsNullOrEmpty(_filter.Status))
                url += $"&Status={_filter.Status}";
            
            await JS.InvokeVoidAsync("open", url, "_blank");
            Snackbar.Add($"Relatório exportado em {format.ToUpper()}!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void ClearFilters()
    {
        _filter = new()
        {
            StartDate = DateTime.Today.AddMonths(-1),
            EndDate = DateTime.Today
        };
        _report = null;
        _searchString = "";
    }

    private bool FilterFunc(SalesReportItemDto item)
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;
        
        return item.SaleNumber.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
               item.CustomerName.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
               item.SalespersonName.Contains(_searchString, StringComparison.OrdinalIgnoreCase);
    }

    private MudBlazor.Color GetStatusColor(string status) => status switch
    {
        "Finalizada" => MudBlazor.Color.Success,
        "Pendente" => MudBlazor.Color.Warning,
        "Cancelada" => MudBlazor.Color.Error,
        _ => MudBlazor.Color.Default
    };
}
