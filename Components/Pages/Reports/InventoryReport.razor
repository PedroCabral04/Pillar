@page "/reports/inventory"
@using erp.Services.Authorization
@attribute [Authorize(Policy = ModulePolicies.Reports)]
@using erp.DTOs.Reports
@using erp.Services
@using erp.Components.Shared
@using Microsoft.AspNetCore.Authorization
@using Color = MudBlazor.Color
@using Size = MudBlazor.Size
@using ApexCharts
@inject IApiService ApiService
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@inject CurrencyFormatService Currency

<PageTitle>Relatórios de Estoque - Pillar ERP</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">
        <MudIcon Icon="@Icons.Material.Filled.Inventory" Class="mr-2" />
        Relatórios de Estoque
    </MudText>
    <MudText Typo="Typo.body1" Class="mb-6">
        Análise completa de níveis de estoque, movimentações e avaliação de inventário.
    </MudText>

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
        <!-- ABC Curve (Pareto) Tab -->
        <MudTabPanel Text="Curva ABC" Icon="@Icons.Material.Filled.ShowChart">
            <MudCard Elevation="3" Class="mb-4">
                <MudCardContent>
                    <MudGrid>
                        <MudItem xs="12" md="4">
                            <DatePicker Label="Data Início" @bind-Date="_abcFilter.StartDate" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <DatePicker Label="Data Fim" @bind-Date="_abcFilter.EndDate" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadABCCurveReport" StartIcon="@Icons.Material.Filled.Search" Class="mt-4">
                                Gerar Análise
                            </MudButton>
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>

            @if (_loadingABC)
            {
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
            }

            @if (_abcReport != null)
            {
                <MudCard Elevation="3" Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Análise de Curva ABC (Pareto)</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                A regra 80/20: aproximadamente 20% dos produtos geram 80% do faturamento
                            </MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <!-- Summary Cards -->
                        <MudGrid Class="mb-4">
                            <MudItem xs="12" sm="4">
                                <MudPaper Class="pa-4" Elevation="0" Style="background-color: #E8F5E9; border-left: 4px solid #4CAF50;">
                                    <MudText Typo="Typo.subtitle2" Color="Color.Success">Classe A - Itens Vitais</MudText>
                                    <MudText Typo="Typo.h5">@_abcReport.Summary.ClassACount produtos</MudText>
                                    <MudText Typo="Typo.body2">@Currency.Format(_abcReport.Summary.ClassARevenue) (@_abcReport.Summary.ClassAPercentage.ToString("N1")% do faturamento)</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" sm="4">
                                <MudPaper Class="pa-4" Elevation="0" Style="background-color: #FFF8E1; border-left: 4px solid #FFC107;">
                                    <MudText Typo="Typo.subtitle2" Color="Color.Warning">Classe B - Itens Importantes</MudText>
                                    <MudText Typo="Typo.h5">@_abcReport.Summary.ClassBCount produtos</MudText>
                                    <MudText Typo="Typo.body2">@Currency.Format(_abcReport.Summary.ClassBRevenue) (@_abcReport.Summary.ClassBPercentage.ToString("N1")% do faturamento)</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" sm="4">
                                <MudPaper Class="pa-4" Elevation="0" Style="background-color: #FFEBEE; border-left: 4px solid #F44336;">
                                    <MudText Typo="Typo.subtitle2" Color="Color.Error">Classe C - Itens Triviais</MudText>
                                    <MudText Typo="Typo.h5">@_abcReport.Summary.ClassCCount produtos</MudText>
                                    <MudText Typo="Typo.body2">@Currency.Format(_abcReport.Summary.ClassCRevenue) (@_abcReport.Summary.ClassCPercentage.ToString("N1")% do faturamento)</MudText>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>

                        <!-- Pareto Chart -->
                        @if (_abcReport.Items.Any())
                        {
                            <MudPaper Class="pa-4 mb-4" Elevation="0">
                                <ApexChart TItem="ABCCurveItemDto"
                                           Title="Gráfico de Pareto - Faturamento por Produto"
                                           Options="_paretoChartOptions"
                                           Height="400">

                                    <ApexPointSeries TItem="ABCCurveItemDto"
                                                     Items="_abcReport.Items.Take(20)"
                                                     Name="Faturamento"
                                                     SeriesType="SeriesType.Bar"
                                                     XValue="@(e => TruncateName(e.ProductName, 15))"
                                                     YValue="@(e => e.TotalRevenue)"
                                                     OrderBy="e => e.X" />

                                    <ApexPointSeries TItem="ABCCurveItemDto"
                                                     Items="_abcReport.Items.Take(20)"
                                                     Name="% Acumulado"
                                                     SeriesType="SeriesType.Line"
                                                     XValue="@(e => TruncateName(e.ProductName, 15))"
                                                     YValue="@(e => e.CumulativePercentage)"
                                                     OrderBy="e => e.X" />
                                </ApexChart>
                            </MudPaper>
                        }

                        <!-- Products Table -->
                        <MudTable Items="_abcReport.Items" Class="mt-4" Hover="true" Striped="true" Dense="true" 
                                  Filter="new Func<ABCCurveItemDto, bool>(FilterABCItems)">
                            <ToolBarContent>
                                <MudTextField @bind-Value="_abcSearchString" Placeholder="Buscar produtos" Adornment="Adornment.Start"
                                              AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0" Immediate="true" />
                                <MudSpacer />
                                <MudChipSet T="string" SelectionMode="SelectionMode.MultiSelection" @bind-SelectedValues="_selectedClasses">
                                    <MudChip Value="@("A")" Color="Color.Success" Variant="Variant.Outlined">Classe A</MudChip>
                                    <MudChip Value="@("B")" Color="Color.Warning" Variant="Variant.Outlined">Classe B</MudChip>
                                    <MudChip Value="@("C")" Color="Color.Error" Variant="Variant.Outlined">Classe C</MudChip>
                                </MudChipSet>
                            </ToolBarContent>
                            <HeaderContent>
                                <MudTh>SKU</MudTh>
                                <MudTh>Produto</MudTh>
                                <MudTh>Categoria</MudTh>
                                <MudTh>Qtd Vendida</MudTh>
                                <MudTh><MudTableSortLabel SortBy="new Func<ABCCurveItemDto, object>(x => x.TotalRevenue)">Faturamento</MudTableSortLabel></MudTh>
                                <MudTh>% Individual</MudTh>
                                <MudTh>% Acumulado</MudTh>
                                <MudTh>Classe</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="SKU">@context.Sku</MudTd>
                                <MudTd DataLabel="Produto">@context.ProductName</MudTd>
                                <MudTd DataLabel="Categoria">@context.Category</MudTd>
                                <MudTd DataLabel="Qtd Vendida">@context.QuantitySold</MudTd>
                                <MudTd DataLabel="Faturamento">@Currency.Format(context.TotalRevenue)</MudTd>
                                <MudTd DataLabel="% Individual">@context.RevenuePercentage.ToString("N2")%</MudTd>
                                <MudTd DataLabel="% Acumulado">@context.CumulativePercentage.ToString("N2")%</MudTd>
                                <MudTd DataLabel="Classe">
                                    <MudChip T="string" Size="Size.Small" Color="@GetClassColor(context.Classification)">@context.Classification</MudChip>
                                </MudTd>
                            </RowTemplate>
                            <PagerContent>
                                <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }"/>
                            </PagerContent>
                        </MudTable>
                    </MudCardContent>
                </MudCard>
            }
        </MudTabPanel>

        <!-- Stock Levels Tab -->
        <MudTabPanel Text="Níveis de Estoque" Icon="@Icons.Material.Filled.Inventory2">
            <MudCard Elevation="3" Class="mb-4">
                <MudCardContent>
                    <MudGrid>
                        <MudItem xs="12" md="4">
                            <MudCheckBox T="bool" @bind-Checked="_stockLevelsFilter.OnlyLowStock" Label="Apenas estoque baixo" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadStockLevelsReport" StartIcon="@Icons.Material.Filled.Search">
                                Gerar Relatório
                            </MudButton>
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>

            @if (_loadingStockLevels)
            {
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
            }

            @if (_stockLevelsReport != null)
            {
                <MudCard Elevation="3" Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Níveis de Estoque</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudButtonGroup Variant="Variant.Outlined" Size="Size.Small">
                                <MudButton StartIcon="@Icons.Material.Filled.PictureAsPdf" OnClick='() => ExportReport("stock-levels", "pdf")' Color="Color.Error">
                                    Exportar PDF
                                </MudButton>
                                <MudButton StartIcon="@Icons.Material.Filled.TableChart" OnClick='() => ExportReport("stock-levels", "excel")' Color="Color.Success">
                                    Exportar Excel
                                </MudButton>
                            </MudButtonGroup>
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudGrid>
                            <MudItem xs="12" sm="3">
                                <MudPaper Class="pa-4" Elevation="0">
                                    <MudText Typo="Typo.subtitle2" Color="Color.Primary">Total de Produtos</MudText>
                                    <MudText Typo="Typo.h5">@_stockLevelsReport.Summary.TotalProducts</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" sm="3">
                                <MudPaper Class="pa-4" Elevation="0">
                                    <MudText Typo="Typo.subtitle2" Color="Color.Success">Em Estoque</MudText>
                                    <MudText Typo="Typo.h5">@_stockLevelsReport.Summary.ProductsInStock</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" sm="3">
                                <MudPaper Class="pa-4" Elevation="0">
                                    <MudText Typo="Typo.subtitle2" Color="Color.Warning">Estoque Baixo</MudText>
                                    <MudText Typo="Typo.h5">@_stockLevelsReport.Summary.ProductsLowStock</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" sm="3">
                                <MudPaper Class="pa-4" Elevation="0">
                                    <MudText Typo="Typo.subtitle2" Color="Color.Error">Sem Estoque</MudText>
                                    <MudText Typo="Typo.h5">@_stockLevelsReport.Summary.ProductsOutOfStock</MudText>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>

                        <MudTable Items="_stockLevelsReport.Items" Class="mt-4" Hover="true" Striped="true" Dense="true" Filter="new Func<StockLevelItemDto, bool>(FilterStockItems)">
                            <ToolBarContent>
                                <MudTextField @bind-Value="_searchString" Placeholder="Buscar produtos" Adornment="Adornment.Start"
                                              AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0" Immediate="true" />
                            </ToolBarContent>
                            <HeaderContent>
                                <MudTh>SKU</MudTh>
                                <MudTh>Produto</MudTh>
                                <MudTh>Categoria</MudTh>
                                <MudTh>Estoque Atual</MudTh>
                                <MudTh>Estoque Mínimo</MudTh>
                                <MudTh>Valor Total</MudTh>
                                <MudTh>Status</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="SKU">@context.Sku</MudTd>
                                <MudTd DataLabel="Produto">@context.ProductName</MudTd>
                                <MudTd DataLabel="Categoria">@context.Category</MudTd>
                                <MudTd DataLabel="Estoque Atual">@context.CurrentStock @context.Unit</MudTd>
                                <MudTd DataLabel="Estoque Mínimo">@context.MinimumStock @context.Unit</MudTd>
                                <MudTd DataLabel="Valor Total">@Currency.Format(context.TotalValue)</MudTd>
                                <MudTd DataLabel="Status">
                                    <MudChip T="string" Size="Size.Small" Color="@GetStockStatusColor(context.Status)">@context.Status</MudChip>
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudCardContent>
                </MudCard>
            }
        </MudTabPanel>

        <!-- Stock Movement Tab -->
        <MudTabPanel Text="Movimentações" Icon="@Icons.Material.Filled.SwapHoriz">
            <MudCard Elevation="3" Class="mb-4">
                <MudCardContent>
                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <DatePicker Label="Data Início" @bind-Date="_stockMovementFilter.StartDate" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <DatePicker Label="Data Fim" @bind-Date="_stockMovementFilter.EndDate" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadStockMovementReport" StartIcon="@Icons.Material.Filled.Search">
                                Gerar Relatório
                            </MudButton>
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>

            @if (_loadingStockMovement)
            {
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
            }

            @if (_stockMovementReport != null)
            {
                <MudCard Elevation="3" Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Movimentações de Estoque</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudButtonGroup Variant="Variant.Outlined" Size="Size.Small">
                                <MudButton StartIcon="@Icons.Material.Filled.PictureAsPdf" OnClick='() => ExportReport("movement-history", "pdf")' Color="Color.Error">
                                    Exportar PDF
                                </MudButton>
                                <MudButton StartIcon="@Icons.Material.Filled.TableChart" OnClick='() => ExportReport("movement-history", "excel")' Color="Color.Success">
                                    Exportar Excel
                                </MudButton>
                            </MudButtonGroup>
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudGrid Class="mb-4">
                            <MudItem xs="12" sm="6">
                                <MudPaper Class="pa-4" Elevation="0">
                                    <MudText Typo="Typo.subtitle2" Color="Color.Primary">Total de Movimentações</MudText>
                                    <MudText Typo="Typo.h5">@_stockMovementReport.Summary.TotalMovements</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudPaper Class="pa-4" Elevation="0">
                                    <MudText Typo="Typo.subtitle2" Color="Color.Info">Valor Total Movimentado</MudText>
                                    <MudText Typo="Typo.h5">@Currency.Format(_stockMovementReport.Summary.TotalValueMovements)</MudText>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>

                        <MudTable Items="_stockMovementReport.Items" Class="mt-4" Hover="true" Striped="true" Dense="true">
                            <HeaderContent>
                                <MudTh>Data</MudTh>
                                <MudTh>Produto</MudTh>
                                <MudTh>Tipo</MudTh>
                                <MudTh>Quantidade</MudTh>
                                <MudTh>Custo Unitário</MudTh>
                                <MudTh>Custo Total</MudTh>
                                <MudTh>Usuário</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Data">@context.Date.ToString("dd/MM/yyyy HH:mm")</MudTd>
                                <MudTd DataLabel="Produto">@context.ProductName</MudTd>
                                <MudTd DataLabel="Tipo">@context.Type</MudTd>
                                <MudTd DataLabel="Quantidade">@context.Quantity @context.Unit</MudTd>
                                <MudTd DataLabel="Custo Unitário">@Currency.Format(context.UnitCost)</MudTd>
                                <MudTd DataLabel="Custo Total">@Currency.Format(context.TotalCost)</MudTd>
                                <MudTd DataLabel="Usuário">@context.UserName</MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudCardContent>
                </MudCard>
            }
        </MudTabPanel>

        <!-- Valuation Tab -->
        <MudTabPanel Text="Avaliação" Icon="@Icons.Material.Filled.Assessment">
            <MudCard Elevation="3" Class="mb-4">
                <MudCardContent>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadValuationReport" StartIcon="@Icons.Material.Filled.Search">
                        Gerar Relatório
                    </MudButton>
                </MudCardContent>
            </MudCard>

            @if (_loadingValuation)
            {
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
            }

            @if (_valuationReport != null)
            {
                <MudCard Elevation="3" Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Avaliação de Inventário</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudButtonGroup Variant="Variant.Outlined" Size="Size.Small">
                                <MudButton StartIcon="@Icons.Material.Filled.PictureAsPdf" OnClick='() => ExportReport("valuation", "pdf")' Color="Color.Error">
                                    Exportar PDF
                                </MudButton>
                                <MudButton StartIcon="@Icons.Material.Filled.TableChart" OnClick='() => ExportReport("valuation", "excel")' Color="Color.Success">
                                    Exportar Excel
                                </MudButton>
                            </MudButtonGroup>
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudGrid Class="mb-4">
                            <MudItem xs="12" sm="4">
                                <MudPaper Class="pa-4" Elevation="0">
                                    <MudText Typo="Typo.subtitle2" Color="Color.Primary">Valor de Custo</MudText>
                                    <MudText Typo="Typo.h5">@Currency.Format(_valuationReport.Summary.TotalCostValue)</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" sm="4">
                                <MudPaper Class="pa-4" Elevation="0">
                                    <MudText Typo="Typo.subtitle2" Color="Color.Success">Valor de Venda</MudText>
                                    <MudText Typo="Typo.h5">@Currency.Format(_valuationReport.Summary.TotalSaleValue)</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" sm="4">
                                <MudPaper Class="pa-4" Elevation="0">
                                    <MudText Typo="Typo.subtitle2" Color="Color.Info">Lucro Potencial</MudText>
                                    <MudText Typo="Typo.h5">@Currency.Format(_valuationReport.Summary.TotalPotentialProfit)</MudText>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>

                        <MudTable Items="_valuationReport.Items" Class="mt-4" Hover="true" Striped="true" Dense="true">
                            <HeaderContent>
                                <MudTh>Categoria</MudTh>
                                <MudTh>Produtos</MudTh>
                                <MudTh>Quantidade Total</MudTh>
                                <MudTh>Valor de Custo</MudTh>
                                <MudTh>Valor de Venda</MudTh>
                                <MudTh>Lucro Potencial</MudTh>
                                <MudTh>Margem</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Categoria">@context.Category</MudTd>
                                <MudTd DataLabel="Produtos">@context.ProductCount</MudTd>
                                <MudTd DataLabel="Quantidade Total">@context.TotalQuantity.ToString("N2")</MudTd>
                                <MudTd DataLabel="Valor de Custo">@Currency.Format(context.TotalCostValue)</MudTd>
                                <MudTd DataLabel="Valor de Venda">@Currency.Format(context.TotalSaleValue)</MudTd>
                                <MudTd DataLabel="Lucro Potencial"><MudText Color="Color.Success">@Currency.Format(context.PotentialProfit)</MudText></MudTd>
                                <MudTd DataLabel="Margem">@context.ProfitMargin.ToString("P2")</MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudCardContent>
                </MudCard>
            }
        </MudTabPanel>
    </MudTabs>
</MudContainer>

@code {
    private InventoryReportFilterDto _stockLevelsFilter = new() { OnlyLowStock = false };
    private InventoryReportFilterDto _stockMovementFilter = new() { StartDate = DateTime.Now.AddMonths(-1), EndDate = DateTime.Now };
    private InventoryReportFilterDto _valuationFilter = new();
    private InventoryReportFilterDto _abcFilter = new() { StartDate = DateTime.Now.AddMonths(-3), EndDate = DateTime.Now };
    
    private StockLevelsReportDto? _stockLevelsReport;
    private StockMovementReportDto? _stockMovementReport;
    private InventoryValuationReportDto? _valuationReport;
    private ABCCurveReportDto? _abcReport;
    
    private bool _loadingStockLevels;
    private bool _loadingStockMovement;
    private bool _loadingValuation;
    private bool _loadingABC;

    private string _searchString = "";
    private string _abcSearchString = "";
    private IReadOnlyCollection<string> _selectedClasses = new List<string> { "A", "B", "C" };

    // Pareto chart options
    private ApexChartOptions<ABCCurveItemDto> _paretoChartOptions = new()
    {
        Chart = new Chart
        {
            Toolbar = new Toolbar { Show = false }
        },
        PlotOptions = new PlotOptions
        {
            Bar = new PlotOptionsBar
            {
                Horizontal = false,
                ColumnWidth = "60%"
            }
        },
        Stroke = new Stroke
        {
            Width = new List<double> { 0, 3 }
        },
        Yaxis = new List<YAxis>
        {
            new YAxis
            {
                Title = new AxisTitle { Text = "Faturamento (R$)" },
                Labels = new YAxisLabels
                {
                    Formatter = @"function (value) {
                        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', maximumFractionDigits: 0 }).format(value);
                    }"
                }
            },
            new YAxis
            {
                Opposite = true,
                Title = new AxisTitle { Text = "% Acumulado" },
                Min = 0,
                Max = 100,
                Labels = new YAxisLabels
                {
                    Formatter = @"function (value) { return value.toFixed(0) + '%'; }"
                }
            }
        },
        Tooltip = new Tooltip
        {
            Shared = true,
            Intersect = false
        },
        Colors = new List<string> { "#4CAF50", "#FF9800" }
    };

    private async Task LoadABCCurveReport()
    {
        try
        {
            _loadingABC = true;
            var response = await ApiService.PostAsync<ABCCurveReportDto>("/api/reports/inventory/abc-curve", _abcFilter);
            
            if (response != null)
            {
                _abcReport = response;
                Snackbar.Add("Análise de Curva ABC gerada com sucesso!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Erro ao gerar análise de curva ABC", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loadingABC = false;
        }
    }

    private bool FilterABCItems(ABCCurveItemDto item)
    {
        // Filter by class selection
        if (_selectedClasses.Any() && !_selectedClasses.Contains(item.Classification))
            return false;

        // Filter by search string
        if (string.IsNullOrWhiteSpace(_abcSearchString))
            return true;
        if (item.ProductName.Contains(_abcSearchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (item.Sku.Contains(_abcSearchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (item.Category.Contains(_abcSearchString, StringComparison.OrdinalIgnoreCase))
            return true;
        return false;
    }

    private Color GetClassColor(string classification) => classification switch
    {
        "A" => Color.Success,
        "B" => Color.Warning,
        "C" => Color.Error,
        _ => Color.Default
    };

    private string TruncateName(string name, int maxLength)
    {
        if (string.IsNullOrEmpty(name)) return name;
        return name.Length <= maxLength ? name : name.Substring(0, maxLength) + "...";
    }

    private async Task LoadStockLevelsReport()
    {
        try
        {
            _loadingStockLevels = true;
            _stockLevelsFilter.ReportType = "stock-levels";
            var response = await ApiService.PostAsync<StockLevelsReportDto>("/api/reports/inventory/stock-levels", _stockLevelsFilter);
            
            if (response != null)
            {
                _stockLevelsReport = response;
                Snackbar.Add("Relatório de níveis de estoque gerado com sucesso!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Erro ao gerar relatório", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loadingStockLevels = false;
        }
    }

    private async Task LoadStockMovementReport()
    {
        try
        {
            _loadingStockMovement = true;
            _stockMovementFilter.ReportType = "movement-history";
            var response = await ApiService.PostAsync<StockMovementReportDto>("/api/reports/inventory/movement-history", _stockMovementFilter);
            
            if (response != null)
            {
                _stockMovementReport = response;
                Snackbar.Add("Relatório de movimentações gerado com sucesso!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Erro ao gerar relatório", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loadingStockMovement = false;
        }
    }

    private async Task LoadValuationReport()
    {
        try
        {
            _loadingValuation = true;
            _valuationFilter.ReportType = "valuation";
            var response = await ApiService.PostAsync<InventoryValuationReportDto>("/api/reports/inventory/valuation", _valuationFilter);
            
            if (response != null)
            {
                _valuationReport = response;
                Snackbar.Add("Relatório de avaliação gerado com sucesso!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Erro ao gerar relatório", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loadingValuation = false;
        }
    }

    private async Task ExportReport(string reportType, string format)
    {
        try
        {
            var url = $"/api/reports/inventory/{reportType}/export?ExportFormat={format}";
            
            switch (reportType)
            {
                case "stock-levels":
                    url += $"&OnlyLowStock={_stockLevelsFilter.OnlyLowStock}";
                    break;
                case "movement-history":
                    url += $"&StartDate={_stockMovementFilter.StartDate:yyyy-MM-dd}&EndDate={_stockMovementFilter.EndDate:yyyy-MM-dd}";
                    break;
            }
            
            await JS.InvokeVoidAsync("open", url, "_blank");
            Snackbar.Add($"Relatório exportado em {format.ToUpper()}!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
    }

    private bool FilterStockItems(StockLevelItemDto item)
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;
        if (item.ProductName.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (item.Sku.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (item.Category.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        return false;
    }

    private Color GetStockStatusColor(string status) => status switch
    {
        "OK" => Color.Success,
        "Baixo" => Color.Warning,
        "Crítico" => Color.Error,
        _ => Color.Default
    };
}
