@page "/settings"
@page "/ajustes"
@attribute [Authorize]
@using erp.Services
@using MudBlazor
@using System
@using System.Linq
@using erp.DTOs.Auth
@using erp.DTOs.Preferences
@using Color = MudBlazor.Color
@using Size = MudBlazor.Size
@using erp.Services.Dashboard
@using Microsoft.AspNetCore.Components.Authorization
@inject ISnackbar Snackbar
@inject IDashboardService DashboardService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JsRuntime
@inject IApiService ApiService

<PageTitle>Configurações - Pillar ERP</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">Configurações</MudText>
<MudText Typo="Typo.body1" GutterBottom="true">Personalize a plataforma de acordo com suas preferências</MudText>

<MudGrid>
    <MudItem xs="12" md="8">
        <MudTabs Position="Position.Top" Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-2" Outlined="true">
    <MudTabPanel Text="Perfil" Icon="@Icons.Material.Filled.Person">
        <MudStack Row="false" Spacing="3">
            <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid var(--mud-palette-divider);">
                <MudStack Row="true" Spacing="4" AlignItems="AlignItems.Center">
                    <MudAvatar Size="Size.Large" Color="Color.Primary" Style="width: 80px; height: 80px; font-size: 2rem;">
                        @(_userName?.Length > 0 ? _userName[0].ToString().ToUpper() : "U")
                    </MudAvatar>
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.h5" Style="font-weight: 600;">@_userName</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">@_userEmail</MudText>
                        <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined">
                            @string.Join(", ", _userRoles)
                        </MudChip>
                    </MudStack>
                </MudStack>
            </MudPaper>

            <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid var(--mud-palette-divider);">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" />
                    Informações da Conta
                </MudText>
                <MudGrid Spacing="2">
                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Nome de Usuário</MudText>
                        <MudText Typo="Typo.body1">@_userName</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">E-mail</MudText>
                        <MudText Typo="Typo.body1">@_userEmail</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Funções</MudText>
                        <MudText Typo="Typo.body1">@string.Join(", ", _userRoles)</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Status</MudText>
                        <MudChip T="string" Size="Size.Small" Color="Color.Success">Ativo</MudChip>
                    </MudItem>
                </MudGrid>
            </MudPaper>

            <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid var(--mud-palette-divider);">
                <MudText Typo="Typo.h6" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.LockReset" Class="mr-2" />
                    Alterar Senha
                </MudText>

                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                    Informe sua senha atual para definir uma nova senha de acesso.
                </MudText>

                @if (_passwordChangeErrors.Count > 0)
                {
                    <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mb-4">
                        @foreach (var error in _passwordChangeErrors)
                        {
                            <MudText Typo="Typo.body2">@error</MudText>
                        }
                    </MudAlert>
                }

                <EditForm Model="@_changePasswordModel" OnValidSubmit="HandleChangePasswordAsync">
                    <DataAnnotationsValidator />

                    <MudTextField @bind-Value="_changePasswordModel.CurrentPassword"
                                  Label="Senha Atual"
                                  Variant="Variant.Outlined"
                                  InputType="@_currentPasswordInput"
                                  For="@(() => _changePasswordModel.CurrentPassword)"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@_currentPasswordIcon"
                                  OnAdornmentClick="ToggleCurrentPasswordVisibility"
                                  Class="mb-3" />

                    <MudTextField @bind-Value="_changePasswordModel.NewPassword"
                                  Label="Nova Senha"
                                  Variant="Variant.Outlined"
                                  InputType="@_newPasswordInput"
                                  For="@(() => _changePasswordModel.NewPassword)"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@_newPasswordIcon"
                                  OnAdornmentClick="ToggleNewPasswordVisibility"
                                  Class="mb-3" />

                    <MudTextField @bind-Value="_changePasswordModel.ConfirmPassword"
                                  Label="Confirmar Nova Senha"
                                  Variant="Variant.Outlined"
                                  InputType="@_confirmPasswordInput"
                                  For="@(() => _changePasswordModel.ConfirmPassword)"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@_confirmPasswordIcon"
                                  OnAdornmentClick="ToggleConfirmPasswordVisibility"
                                  Class="mb-2" />

                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-4 d-block">
                        Mínimo de 8 caracteres, com letra maiúscula, minúscula, número e caractere especial.
                    </MudText>

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               ButtonType="ButtonType.Submit"
                               Disabled="@_isChangingPassword"
                               StartIcon="@Icons.Material.Filled.Save"
                               Class="mb-2">
                        @if (_isChangingPassword)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <text>Alterando...</text>
                        }
                        else
                        {
                            <text>Alterar Senha</text>
                        }
                    </MudButton>
                </EditForm>
            </MudPaper>
        </MudStack>
    </MudTabPanel>

    <MudTabPanel Text="Segurança" Icon="@Icons.Material.Filled.Security">
        <MudStack Row="false" Spacing="3">
            <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid var(--mud-palette-divider);">
                <MudText Typo="Typo.h6" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.Shield" Class="mr-2" />
                    Autenticação de Dois Fatores (2FA)
                </MudText>
                <MudText Typo="Typo.body2" Class="mb-3">
                    Adicione uma camada extra de segurança à sua conta com autenticação de dois fatores.
                </MudText>
                <MudButton Href="/account/two-factor" 
                           Color="Color.Primary" 
                           Variant="Variant.Filled"
                           StartIcon="@Icons.Material.Filled.Security">
                    Gerenciar 2FA
                </MudButton>
            </MudPaper>

            <MudDivider />

            @* <MudNumericField T="int"
                             Label="Tempo para sair automaticamente (minutos)"
                             Min="1" Max="480" Step="5"
                             Value="@PreferenceService.CurrentPreferences.Security.AutoLogoutMinutes"
                             ValueChanged="@(v => OnChange(async () => PreferenceService.CurrentPreferences.Security.AutoLogoutMinutes = v))"
                             Variant="Variant.Outlined" /> *@
        </MudStack>
    </MudTabPanel>

    <MudTabPanel Text="Visual" Icon="@Icons.Material.Filled.Brightness6">
        <MudStack Row="false" Spacing="2">
            <MudSwitch T="bool"
                       Value="@ThemeService.IsDarkMode"
                       ValueChanged="@OnThemeSwitchChanged"
                       ThumbIcon="@ThemeIcon"
                       Color="MudBlazor.Color.Primary"
                       Label="@ThemeLabel"
                       ThumbIconChecked="@Icons.Material.Filled.DarkMode"
                       ThumbIconUnchecked="@Icons.Material.Filled.LightMode" />
            <MudDivider Class="my-2" />
            <MudSelect T="string" Label="Tipo de navegação" Variant="Variant.Outlined"
                       Value="@PreferenceService.CurrentPreferences.Ui.NavigationType"
                       ValueChanged="@(v => OnChange(async () => PreferenceService.CurrentPreferences.Ui.NavigationType = v))">
                <MudSelectItem T="string" Value="@("sidebar")">Barra lateral (Sidebar)</MudSelectItem>
                <MudSelectItem T="string" Value="@("topbar")">Barra superior (Topbar)</MudSelectItem>
            </MudSelect>

            <MudSelect T="string" Label="Densidade" Variant="Variant.Outlined"
                       Value="@PreferenceService.CurrentPreferences.Ui.Density"
                       ValueChanged="@(v => OnChange(async () => PreferenceService.CurrentPreferences.Ui.Density = v))">
                <MudSelectItem T="string" Value="@("comfortable")">Confortável</MudSelectItem>
                <MudSelectItem T="string" Value="@("compact")">Compacto</MudSelectItem>
            </MudSelect>

            <MudSelect T="string" Label="Tamanho da fonte" Variant="Variant.Outlined"
                       Value="@PreferenceService.CurrentPreferences.Ui.FontSize"
                       ValueChanged="@(v => OnChange(async () => PreferenceService.CurrentPreferences.Ui.FontSize = v))">
                <MudSelectItem T="string" Value="@("base")">Padrão</MudSelectItem>
                <MudSelectItem T="string" Value="@("large")">Grande</MudSelectItem>
            </MudSelect>

            <MudSwitch T="bool" Color="MudBlazor.Color.Primary" Label="Alto contraste"
                       Value="@PreferenceService.CurrentPreferences.Ui.HighContrast"
                       ValueChanged="@(v => OnChange(async () => PreferenceService.CurrentPreferences.Ui.HighContrast = v))" />

            <MudSwitch T="bool" Color="MudBlazor.Color.Primary" Label="Reduzir animações"
                       Value="@PreferenceService.CurrentPreferences.Ui.ReduceMotion"
                       ValueChanged="@(v => OnChange(async () => PreferenceService.CurrentPreferences.Ui.ReduceMotion = v))" />

            <MudDivider Class="my-2" />
            <MudText Typo="Typo.subtitle2">Cor Primária</MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                Escolha a cor de destaque da interface
            </MudText>
            <MudStack Row="true" Spacing="2">
                @foreach (var color in AvailableColors)
                {
                    var isSelected = PreferenceService.CurrentPreferences.Ui.PrimaryColor == color;
                    <div @onclick="@(() => OnPrimaryColorChange(color))"
                         style="@($"background-color: {color}; width: 40px; height: 40px; border-radius: 50%; border: 3px solid {(isSelected ? "var(--mud-palette-text-primary)" : "transparent")}; cursor: pointer; transition: transform 0.2s;")"
                         class="hover-scale"
                         title="@color" />
                }
            </MudStack>

            @* <MudSwitch T="bool" Color="MudBlazor.Color.Primary" Label="Atalhos de teclado habilitados"
                       Value="@PreferenceService.CurrentPreferences.Ui.KeyboardShortcutsEnabled"
                       ValueChanged="@(v => OnChange(async () => PreferenceService.CurrentPreferences.Ui.KeyboardShortcutsEnabled = v))" /> *@
            
            <!-- @if (PreferenceService.CurrentPreferences.Ui.KeyboardShortcutsEnabled)
            {
                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true" Class="mt-2">
                    <MudText Typo="Typo.body2"><strong>Atalhos disponíveis:</strong></MudText>
                    <MudText Typo="Typo.body2">• <kbd>g</kbd> + <kbd>d</kbd> → Dashboard</MudText>
                    <MudText Typo="Typo.body2">• <kbd>g</kbd> + <kbd>h</kbd> → Início</MudText>
                    <MudText Typo="Typo.body2">• <kbd>g</kbd> + <kbd>s</kbd> → Vendas</MudText>
                    <MudText Typo="Typo.body2">• <kbd>g</kbd> + <kbd>c</kbd> → Clientes</MudText>
                    <MudText Typo="Typo.body2">• <kbd>g</kbd> + <kbd>p</kbd> → Produtos</MudText>
                    <MudText Typo="Typo.body2">• <kbd>g</kbd> + <kbd>k</kbd> → Kanban</MudText>
                    <MudText Typo="Typo.body2">• <kbd>g</kbd> + <kbd>a</kbd> → Configurações</MudText>
                    <MudText Typo="Typo.body2">• <kbd>Ctrl</kbd> + <kbd>b</kbd> → Alternar Sidebar</MudText>
                    <MudText Typo="Typo.body2">• <kbd>Ctrl</kbd> + <kbd>k</kbd> ou <kbd>/</kbd> → Buscar</MudText>
                </MudAlert>
            } -->
        </MudStack>
    </MudTabPanel>

    <MudTabPanel Text="Localização" Icon="@Icons.Material.Filled.Language">
        <MudStack Row="false" Spacing="2">
            <MudSelect T="string" Label="Idioma" Variant="Variant.Outlined"
                       Value="@PreferenceService.CurrentPreferences.Locale.Language"
                       ValueChanged="@(v => OnChange(async () => PreferenceService.CurrentPreferences.Locale.Language = v))">
                <MudSelectItem T="string" Value="@("pt-BR")">Português (Brasil)</MudSelectItem>
                <MudSelectItem T="string" Value="@("en-US")">English (US)</MudSelectItem>
                <MudSelectItem T="string" Value="@("es-ES")">Español (ES)</MudSelectItem>
            </MudSelect>

            <MudTextField T="string" Label="Fuso horário (IANA)" Variant="Variant.Outlined"
                           Value="@PreferenceService.CurrentPreferences.Locale.TimeZone"
                           ValueChanged="@(v => OnChange(async () => PreferenceService.CurrentPreferences.Locale.TimeZone = v))" />

            <MudSelect T="string" Label="Formato de data" Variant="Variant.Outlined"
                       Value="@PreferenceService.CurrentPreferences.Locale.DateFormat"
                       ValueChanged="@(v => OnChange(async () => PreferenceService.CurrentPreferences.Locale.DateFormat = v))">
                <MudSelectItem T="string" Value="@("dd/MM/yyyy")">dd/MM/yyyy</MudSelectItem>
                <MudSelectItem T="string" Value="@("MM/dd/yyyy")">MM/dd/yyyy</MudSelectItem>
                <MudSelectItem T="string" Value="@("yyyy-MM-dd")">yyyy-MM-dd</MudSelectItem>
            </MudSelect>

            <MudSelect T="string" Label="Formato numérico" Variant="Variant.Outlined"
                       Value="@PreferenceService.CurrentPreferences.Locale.NumberFormat"
                       ValueChanged="@(v => OnChange(async () => PreferenceService.CurrentPreferences.Locale.NumberFormat = v))">
                <MudSelectItem T="string" Value="@("1.234,56")">1.234,56</MudSelectItem>
                <MudSelectItem T="string" Value="@("1,234.56")">1,234.56</MudSelectItem>
            </MudSelect>

            <MudSelect T="string" Label="Moeda" Variant="Variant.Outlined"
                       Value="@PreferenceService.CurrentPreferences.Locale.Currency"
                       ValueChanged="@(v => OnChange(async () => PreferenceService.CurrentPreferences.Locale.Currency = v))">
                <MudSelectItem T="string" Value="@("BRL")">BRL</MudSelectItem>
                <MudSelectItem T="string" Value="@("USD")">USD</MudSelectItem>
                <MudSelectItem T="string" Value="@("EUR")">EUR</MudSelectItem>
            </MudSelect>
        </MudStack>
    </MudTabPanel>

    <MudTabPanel Text="Tabelas" Icon="@Icons.Material.Filled.TableRows">
        <MudStack Row="false" Spacing="2">
            <MudSelect T="int" Label="Itens por página" Variant="Variant.Outlined"
                       Value="@PreferenceService.CurrentPreferences.Tables.PageSize"
                       ValueChanged="@(v => OnChange(async () => PreferenceService.CurrentPreferences.Tables.PageSize = v))">
                <MudSelectItem T="int" Value="10">10</MudSelectItem>
                <MudSelectItem T="int" Value="25">25</MudSelectItem>
                <MudSelectItem T="int" Value="50">50</MudSelectItem>
                <MudSelectItem T="int" Value="100">100</MudSelectItem>
            </MudSelect>

            <MudDivider Class="my-2" />
            <MudText Typo="Typo.subtitle2">Ordenação padrão por módulo</MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                Configure a ordenação inicial das tabelas em cada módulo do sistema.
            </MudText>

            @foreach (var row in DefaultSortRows)
            {
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                    <MudSelect T="string" Label="Módulo" Variant="Variant.Outlined" Style="min-width: 180px;"
                               Value="@row.Module"
                               ValueChanged="@(v => { row.Module = v; StateHasChanged(); SyncDefaultSortDict(); })">
                        @foreach (var module in AvailableModules)
                        {
                            <MudSelectItem T="string" Value="@module.Key">@module.Key</MudSelectItem>
                        }
                    </MudSelect>
                    <MudSelect T="string" Label="Ordenar por" Variant="Variant.Outlined" Style="min-width: 220px;"
                               Value="@row.Sort"
                               ValueChanged="@(v => { row.Sort = v; SyncDefaultSortDict(); })"
                               Disabled="@(string.IsNullOrEmpty(row.Module))">
                        @if (!string.IsNullOrEmpty(row.Module) && AvailableModules.TryGetValue(row.Module, out var sortOptions))
                        {
                            @foreach (var option in sortOptions)
                            {
                                <MudSelectItem T="string" Value="@option.Value">@option.Label</MudSelectItem>
                            }
                        }
                    </MudSelect>
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="MudBlazor.Color.Error" OnClick="() => RemoveDefaultSortRow(row)" aria-label="Remover ordenação" />
                </MudStack>
            }
            <MudButton Variant="Variant.Outlined" Color="MudBlazor.Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="AddDefaultSortRow">Adicionar Regra</MudButton>

            <MudDivider Class="my-4" />
        </MudStack>
    </MudTabPanel>

    <MudTabPanel Text="Dashboard" Icon="@Icons.Material.Filled.Dashboard">
        <MudStack Row="false" Spacing="2">
            <MudSelect T="string" Label="Página inicial após login" Variant="Variant.Outlined"
                       Value="@PreferenceService.CurrentPreferences.Dashboard.DefaultStartPage"
                       ValueChanged="@(v => OnChange(async () => PreferenceService.CurrentPreferences.Dashboard.DefaultStartPage = v))">
                <MudSelectItem T="string" Value="@("Home")">Início</MudSelectItem>
                <MudSelectItem T="string" Value="@("Dashboard")">Dashboard</MudSelectItem>
                <MudSelectItem T="string" Value="@("Kanban")">Kanban</MudSelectItem>
                <MudSelectItem T="string" Value="@("Vendas")">Vendas</MudSelectItem>
                <MudSelectItem T="string" Value="@("Clientes")">Clientes</MudSelectItem>
                <MudSelectItem T="string" Value="@("Produtos")">Produtos</MudSelectItem>
                <MudSelectItem T="string" Value="@("Financeiro")">Dashboard Financeiro</MudSelectItem>
            </MudSelect>

    <MudSelect T="string" Label="Widgets" Variant="Variant.Outlined" MultiSelection="true"
               SelectedValues="@PreferenceService.CurrentPreferences.Dashboard.Widgets"
               SelectedValuesChanged="@(v => OnChange(async () => PreferenceService.CurrentPreferences.Dashboard.Widgets = v?.ToList() ?? new()))">
                @foreach (var w in AvailableWidgets)
                {
            <MudSelectItem T="string" Value="@w">@w</MudSelectItem>
                }
            </MudSelect>

            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                <MudTextField T="string" Label="Adicionar widget" Variant="Variant.Outlined" @bind-Value="NewWidgetName" Class="w-50" />
                <MudButton Variant="Variant.Filled" Color="MudBlazor.Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="AddCustomWidget">Adicionar</MudButton>
            </MudStack>
        </MudStack>
    </MudTabPanel>

    @* <MudTabPanel Text="Notificações" Icon="@Icons.Material.Filled.Notifications">
        <MudStack Row="false" Spacing="2">
            <MudSwitch T="bool" Color="MudBlazor.Color.Primary" Label="Notificações no app"
                       Value="@PreferenceService.CurrentPreferences.Notifications.InApp"
                       ValueChanged="@(v => OnChange(async () => PreferenceService.CurrentPreferences.Notifications.InApp = v))" />

            <MudSwitch T="bool" Color="MudBlazor.Color.Primary" Label="Notificar por e-mail"
                       Value="@PreferenceService.CurrentPreferences.Notifications.Email"
                       ValueChanged="@(v => OnChange(async () => PreferenceService.CurrentPreferences.Notifications.Email = v))" />

            <MudRadioGroup T="string" Label="Frequência do resumo" Row="true"
                           Value="@PreferenceService.CurrentPreferences.Notifications.Digest"
                           ValueChanged="@(v => OnChange(async () => PreferenceService.CurrentPreferences.Notifications.Digest = v))">
                <MudRadio T="string" Option="@("immediate")" Color="MudBlazor.Color.Primary">Imediato</MudRadio>
                <MudRadio T="string" Option="@("daily")" Color="MudBlazor.Color.Primary">Diário</MudRadio>
                <MudRadio T="string" Option="@("weekly")" Color="MudBlazor.Color.Primary">Semanal</MudRadio>
            </MudRadioGroup>
        </MudStack>
    </MudTabPanel>

    <MudTabPanel Text="Áudio" Icon="@Icons.Material.Filled.VolumeUp">
        <MudStack Row="false" Spacing="2">
            <MudSwitch T="bool" Color="MudBlazor.Color.Primary" Label="Sons de notificação"
                       Value="@PreferenceService.CurrentPreferences.Notifications.Sounds"
                       ValueChanged="@(v => OnChange(async () => PreferenceService.CurrentPreferences.Notifications.Sounds = v))" />

            @if (PreferenceService.CurrentPreferences.Notifications.Sounds)
            {
                <MudText Typo="Typo.subtitle2" Class="mt-2">Volume: @PreferenceService.CurrentPreferences.Notifications.Volume%</MudText>
                <MudSlider T="int" Min="0" Max="100" Step="5"
                           Value="@PreferenceService.CurrentPreferences.Notifications.Volume"
                           ValueChanged="@(v => OnChange(async () => PreferenceService.CurrentPreferences.Notifications.Volume = v))"
                           Color="MudBlazor.Color.Primary" />

                <MudSelect T="string" Label="Som de notificação" Variant="Variant.Outlined"
                           Value="@PreferenceService.CurrentPreferences.Notifications.SoundFile"
                           ValueChanged="@(v => OnChange(async () => PreferenceService.CurrentPreferences.Notifications.SoundFile = v))">
                    <MudSelectItem T="string" Value="@("notification.mp3")">Padrão</MudSelectItem>
                    <MudSelectItem T="string" Value="@("chime.mp3")">Chime</MudSelectItem>
                    <MudSelectItem T="string" Value="@("ding.mp3")">Ding</MudSelectItem>
                    <MudSelectItem T="string" Value="@("pop.mp3")">Pop</MudSelectItem>
                </MudSelect>

                <MudButton Variant="Variant.Outlined" Color="MudBlazor.Color.Primary" 
                           StartIcon="@Icons.Material.Filled.PlayArrow"
                           OnClick="TestNotificationSound">
                    Testar Som
                </MudButton>
            }
        </MudStack>
    </MudTabPanel>

    <MudTabPanel Text="Exportação" Icon="@Icons.Material.Filled.IosShare">
        <MudStack Row="false" Spacing="2">
            <MudSelect T="string" Label="Formato padrão" Variant="Variant.Outlined"
                       Value="@PreferenceService.CurrentPreferences.Export.DefaultFormat"
                       ValueChanged="@(v => OnChange(async () => PreferenceService.CurrentPreferences.Export.DefaultFormat = v))">
                <MudSelectItem T="string" Value="@("CSV")">CSV</MudSelectItem>
                <MudSelectItem T="string" Value="@("XLSX")">XLSX</MudSelectItem>
                <MudSelectItem T="string" Value="@("PDF")">PDF</MudSelectItem>
            </MudSelect>

            <MudSwitch T="bool" Color="MudBlazor.Color.Primary" Label="Incluir cabeçalho"
                       Value="@PreferenceService.CurrentPreferences.Export.PrintHeader"
                       ValueChanged="@(v => OnChange(async () => PreferenceService.CurrentPreferences.Export.PrintHeader = v))" />
        </MudStack>
    </MudTabPanel> *@

        </MudTabs>
    </MudItem>
    
    <MudItem xs="12" md="4">
        <MudPaper Elevation="2" Class="pa-4" Style="position: sticky; top: 80px;">
            <MudText Typo="Typo.h6" GutterBottom="true">
                <MudIcon Icon="@Icons.Material.Filled.Visibility" Class="mr-2" />
                Preview ao Vivo
            </MudText>
            <MudDivider Class="mb-3" />
            
            <MudStack Spacing="3">
                <!-- Theme Preview -->
                <MudPaper Elevation="1" Class="pa-3" Style="@GetPreviewStyle()">
                    <MudText Typo="Typo.subtitle2" GutterBottom="true">Tema: @(ThemeService.IsDarkMode ? "Escuro" : "Claro")</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Este é um exemplo de como o texto aparece no tema atual.
                    </MudText>
                    <div class="mt-2">
                        <MudChip T="string" Size="Size.Small" Style="@($"background-color: {PreferenceService.CurrentPreferences.Ui.PrimaryColor}; color: white;")">
                            Cor Primária
                        </MudChip>
                    </div>
                </MudPaper>

                <!-- Density Preview -->
                <MudPaper Elevation="1" Class="pa-3">
                    <MudText Typo="Typo.subtitle2" GutterBottom="true">Densidade</MudText>
                    <MudStack Spacing="@GetDensitySpacing()">
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" FullWidth="true">Botão Exemplo</MudButton>
                        <MudTextField T="string" Label="Campo de texto" Variant="Variant.Outlined" Margin="@GetDensityMargin()" />
                    </MudStack>
                </MudPaper>

                <!-- Font Size Preview -->
                <MudPaper Elevation="1" Class="pa-3">
                    <MudText Typo="Typo.subtitle2" GutterBottom="true">Tamanho da Fonte</MudText>
                    <div style="@GetFontSizeStyle()">
                        <MudText Typo="Typo.h6">Título</MudText>
                        <MudText Typo="Typo.body1">Texto normal com o tamanho de fonte configurado.</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Texto secundário.</MudText>
                    </div>
                </MudPaper>

                <!-- Contrast & Motion Preview -->
                <MudPaper Elevation="1" Class="pa-3">
                    <MudText Typo="Typo.subtitle2" GutterBottom="true">Acessibilidade</MudText>
                    <MudStack Spacing="2">
                        @if (PreferenceService.CurrentPreferences.Ui.HighContrast)
                        {
                            <MudChip T="string" Color="Color.Dark" Size="Size.Small">
                                <MudIcon Icon="@Icons.Material.Filled.Contrast" Size="Size.Small" Class="mr-1" />
                                Alto Contraste
                            </MudChip>
                        }
                        @if (PreferenceService.CurrentPreferences.Ui.ReduceMotion)
                        {
                            <MudChip T="string" Color="Color.Info" Size="Size.Small">
                                <MudIcon Icon="@Icons.Material.Filled.Animation" Size="Size.Small" Class="mr-1" />
                                Reduzir Animações
                            </MudChip>
                        }
                        @if (PreferenceService.CurrentPreferences.Ui.KeyboardShortcutsEnabled)
                        {
                            <MudChip T="string" Color="Color.Success" Size="Size.Small">
                                <MudIcon Icon="@Icons.Material.Filled.Keyboard" Size="Size.Small" Class="mr-1" />
                                Atalhos Habilitados
                            </MudChip>
                        }
                        @if (!PreferenceService.CurrentPreferences.Ui.SidebarPersistent)
                        {
                            <MudChip T="string" Color="Color.Warning" Size="Size.Small">
                                <MudIcon Icon="@Icons.Material.Filled.ViewSidebar" Size="Size.Small" Class="mr-1" />
                                Sidebar Auto-Recolher
                            </MudChip>
                        }
                        @if (!PreferenceService.CurrentPreferences.Ui.HighContrast && 
                             !PreferenceService.CurrentPreferences.Ui.ReduceMotion &&
                             !PreferenceService.CurrentPreferences.Ui.KeyboardShortcutsEnabled &&
                             PreferenceService.CurrentPreferences.Ui.SidebarPersistent)
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Configurações padrão</MudText>
                        }
                    </MudStack>
                </MudPaper>

                <!-- Locale Preview -->
                <MudPaper Elevation="1" Class="pa-3">
                    <MudText Typo="Typo.subtitle2" GutterBottom="true">Localização</MudText>
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.body2">
                            <strong>Data:</strong> @DateTime.Now.ToString(PreferenceService.CurrentPreferences.Locale.DateFormat)
                        </MudText>
                        <MudText Typo="Typo.body2">
                            <strong>Número:</strong> @FormatNumber(1234.56)
                        </MudText>
                        <MudText Typo="Typo.body2">
                            <strong>Moeda:</strong> @PreferenceService.CurrentPreferences.Locale.Currency
                        </MudText>
                    </MudStack>
                </MudPaper>

                <!-- Navigation Preview -->
                <MudPaper Elevation="1" Class="pa-3">
                    <MudText Typo="Typo.subtitle2" GutterBottom="true">Navegação</MudText>
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.body2">
                            <strong>Página inicial:</strong> @(PreferenceService.CurrentPreferences.Dashboard.DefaultStartPage ?? "Início")
                        </MudText>
                        <MudText Typo="Typo.body2">
                            <strong>Tipo de menu:</strong> @(PreferenceService.CurrentPreferences.Ui.NavigationType == "topbar" ? "Barra Superior" : "Barra Lateral")
                        </MudText>
                        <MudText Typo="Typo.body2">
                            <strong>Itens/página:</strong> @PreferenceService.CurrentPreferences.Tables.PageSize
                        </MudText>
                    </MudStack>
                </MudPaper>
            </MudStack>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    [Inject] ThemeService ThemeService { get; set; } = null!;
    [Inject] PreferenceService PreferenceService { get; set; } = null!;
    private string ThemeLabel => ThemeService.IsDarkMode ? "Modo escuro" : "Modo claro";
    private string ThemeIcon => ThemeService.IsDarkMode ? Icons.Material.Filled.DarkMode : Icons.Material.Filled.LightMode;
    private List<string> AvailableWidgets { get; set; } = new();
    private string NewWidgetName { get; set; } = string.Empty;

    // Color picker
    private string _customColorHex = "#2563EB";
    private readonly List<string> AvailableColors = new()
    {
        "#2563EB", // Blue (default)
        "#DC2626", // Red
        "#16A34A", // Green
        "#9333EA", // Purple
        "#EA580C", // Orange
        "#0891B2", // Cyan
        "#DB2777", // Pink
        "#4F46E5", // Indigo
    };

    // Available modules and their sort options for table preferences
    private record SortOption(string Label, string Value);
    private readonly Dictionary<string, List<SortOption>> AvailableModules = new()
    {
        ["Produtos"] = new()
        {
            new("SKU (A-Z)", "sku:asc"),
            new("SKU (Z-A)", "sku:desc"),
            new("Nome (A-Z)", "name:asc"),
            new("Nome (Z-A)", "name:desc"),
            new("Estoque (Menor)", "stock:asc"),
            new("Estoque (Maior)", "stock:desc"),
            new("Preço (Menor)", "price:asc"),
            new("Preço (Maior)", "price:desc")
        },
        ["Vendas"] = new()
        {
            new("Data (Mais Recente)", "date:desc"),
            new("Data (Mais Antiga)", "date:asc"),
            new("Cliente (A-Z)", "customer:asc"),
            new("Cliente (Z-A)", "customer:desc"),
            new("Valor (Maior)", "total:desc"),
            new("Valor (Menor)", "total:asc")
        },
        ["Clientes"] = new()
        {
            new("Nome (A-Z)", "name:asc"),
            new("Nome (Z-A)", "name:desc"),
            new("E-mail (A-Z)", "email:asc"),
            new("E-mail (Z-A)", "email:desc"),
            new("Criado (Mais Recente)", "createdAt:desc"),
            new("Criado (Mais Antigo)", "createdAt:asc")
        },
        ["Movimentações"] = new()
        {
            new("Data (Mais Recente)", "date:desc"),
            new("Data (Mais Antiga)", "date:asc"),
            new("Produto (A-Z)", "product:asc"),
            new("Produto (Z-A)", "product:desc"),
            new("Quantidade (Maior)", "quantity:desc"),
            new("Quantidade (Menor)", "quantity:asc")
        },
        ["Contagens"] = new()
        {
            new("Data (Mais Recente)", "date:desc"),
            new("Data (Mais Antiga)", "date:asc"),
            new("Status (A-Z)", "status:asc"),
            new("Status (Z-A)", "status:desc")
        },
        ["Categorias"] = new()
        {
            new("Nome (A-Z)", "name:asc"),
            new("Nome (Z-A)", "name:desc"),
            new("Código (A-Z)", "code:asc"),
            new("Código (Z-A)", "code:desc")
        },
        ["ContasPagar"] = new()
        {
            new("Vencimento (Próximo)", "dueDate:asc"),
            new("Vencimento (Distante)", "dueDate:desc"),
            new("Fornecedor (A-Z)", "supplierName:asc"),
            new("Fornecedor (Z-A)", "supplierName:desc"),
            new("Valor (Maior)", "amount:desc"),
            new("Valor (Menor)", "amount:asc")
        },
        ["ContasReceber"] = new()
        {
            new("Vencimento (Próximo)", "dueDate:asc"),
            new("Vencimento (Distante)", "dueDate:desc"),
            new("Cliente (A-Z)", "customerName:asc"),
            new("Cliente (Z-A)", "customerName:desc"),
            new("Valor (Maior)", "amount:desc"),
            new("Valor (Menor)", "amount:asc")
        },
        ["Usuários"] = new()
        {
            new("Nome (A-Z)", "userName:asc"),
            new("Nome (Z-A)", "userName:desc"),
            new("E-mail (A-Z)", "email:asc"),
            new("E-mail (Z-A)", "email:desc")
        }
    };

    // User profile info
    private string _userName = "Usuário";
    private string _userEmail = "";
    private List<string> _userRoles = new();

    // Change password
    private ChangePasswordRequest _changePasswordModel = new();
    private bool _isChangingPassword = false;
    private bool _showCurrentPassword = false;
    private bool _showNewPassword = false;
    private bool _showConfirmPassword = false;
    private InputType _currentPasswordInput = InputType.Password;
    private InputType _newPasswordInput = InputType.Password;
    private InputType _confirmPasswordInput = InputType.Password;
    private string _currentPasswordIcon = Icons.Material.Filled.VisibilityOff;
    private string _newPasswordIcon = Icons.Material.Filled.VisibilityOff;
    private string _confirmPasswordIcon = Icons.Material.Filled.VisibilityOff;
    private List<string> _passwordChangeErrors = new();

    // Helpers to edit dictionary preferences in a simple list form
    private List<DefaultSortRow> DefaultSortRows = new();
    private List<VisibleColumnsRow> VisibleColumnsRows = new();

    protected override async Task OnInitializedAsync()
    {
        // Garantir que as preferências estão carregadas
        await PreferenceService.InitializeAsync();

        // Load user profile info
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            if (user.Identity?.IsAuthenticated == true)
            {
                _userName = user.Identity.Name ?? "Usuário";
                _userEmail = user.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value ?? "";
                _userRoles = user.Claims
                    .Where(c => c.Type == System.Security.Claims.ClaimTypes.Role)
                    .Select(c => c.Value)
                    .ToList();
                if (!_userRoles.Any()) _userRoles.Add("Usuário");
            }
        }
        catch { }

        // Seed rows from current preferences for editing
        var ds = PreferenceService.CurrentPreferences.Tables.DefaultSortPerModule;
        if (ds != null)
            DefaultSortRows = ds.Select(kv => new DefaultSortRow { Module = kv.Key, Sort = kv.Value }).ToList();

        var vc = PreferenceService.CurrentPreferences.Tables.VisibleColumnsPerModule;
        if (vc != null)
            VisibleColumnsRows = vc.Select(kv => new VisibleColumnsRow { Module = kv.Key, ColumnsCsv = string.Join(",", kv.Value) }).ToList();

        // Load available widgets
        try
        {
            var widgets = await DashboardService.GetWidgetsAsync();
            AvailableWidgets = widgets.Select(w => w.Title).ToList();
        }
        catch
        {
            // Fallback if service fails
            AvailableWidgets = new List<string> { "Vendas do dia", "Estoque", "Tarefas", "Atalhos", "Indicadores" };
        }
    }

    private async Task OnThemeSwitchChanged(bool newValue)
    {
        await ThemeService.SetDarkModeAsync(newValue);
    }

    private async Task OnChange(Func<Task> mutator)
    {
        try
        {
            Console.WriteLine("[Settings.OnChange] Starting mutation...");
            await mutator();
            Console.WriteLine($"[Settings.OnChange] After mutation - DefaultStartPage: '{PreferenceService.CurrentPreferences.Dashboard.DefaultStartPage}'");
            await PreferenceService.SaveAsync();
            Console.WriteLine("[Settings.OnChange] SaveAsync completed");
            
            // Apply font size class directly for immediate feedback
            try
            {
                var fontSize = PreferenceService.CurrentPreferences?.Ui?.FontSize ?? "base";
                await JsRuntime.InvokeVoidAsync("erpResponsive.setFontSizeClass", fontSize);
            }
            catch { }
            
            Snackbar.Add("Preferências salvas", Severity.Success, cfg => { cfg.VisibleStateDuration = 1500; });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Settings.OnChange] Error: {ex.Message}");
            Snackbar.Add($"Erro ao salvar preferências: {ex.Message}", Severity.Error);
        }
        StateHasChanged();
    }

    // Dashboard helpers
    private async Task AddCustomWidget()
    {
        var name = (NewWidgetName ?? string.Empty).Trim();
        if (string.IsNullOrWhiteSpace(name)) return;
        if (!PreferenceService.CurrentPreferences.Dashboard.Widgets.Contains(name))
        {
            PreferenceService.CurrentPreferences.Dashboard.Widgets.Add(name);
            NewWidgetName = string.Empty;
            await PreferenceService.SaveAsync();
            Snackbar.Add("Widget adicionado", Severity.Info, c => c.VisibleStateDuration = 1200);
        }
    }

    // Color picker helper
    private async Task OnPrimaryColorChange(string color)
    {
        if (string.IsNullOrWhiteSpace(color)) return;
        _customColorHex = color;
        PreferenceService.CurrentPreferences.Ui.PrimaryColor = color;
        ThemeService.UpdatePrimaryColor(color);
        await PreferenceService.SaveAsync();
        Snackbar.Add("Cor primária atualizada", Severity.Success, c => c.VisibleStateDuration = 1200);
        StateHasChanged();
    }

    // Sound test helper
    private async Task TestNotificationSound()
    {
        try
        {
            var volume = PreferenceService.CurrentPreferences.Notifications.Volume / 100.0;
            var soundFile = PreferenceService.CurrentPreferences.Notifications.SoundFile ?? "notification.mp3";
            await JsRuntime.InvokeVoidAsync("erpNotifications.playSound", $"/sounds/{soundFile}", volume);
        }
        catch
        {
            // If sound file doesn't exist, play test beep
            try
            {
                var volume = PreferenceService.CurrentPreferences.Notifications.Volume / 100.0;
                await JsRuntime.InvokeVoidAsync("erpNotifications.testSound", volume);
            }
            catch
            {
                Snackbar.Add("Não foi possível reproduzir o som de teste", Severity.Warning);
            }
        }
    }

    private async Task HandleChangePasswordAsync()
    {
        _isChangingPassword = true;
        _passwordChangeErrors.Clear();

        try
        {
            var response = await ApiService.PostAsync<object>("/api/auth/change-password", _changePasswordModel);
            if (response != null)
            {
                _changePasswordModel = new ChangePasswordRequest();
                Snackbar.Add("Senha alterada com sucesso.", Severity.Success);
            }
            else
            {
                _passwordChangeErrors = new List<string>
                {
                    "Não foi possível alterar a senha. Verifique os dados e tente novamente."
                };
                Snackbar.Add("Não foi possível alterar a senha. Verifique os dados e tente novamente.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            _passwordChangeErrors = ParseErrorMessages(ex.Message);
            if (_passwordChangeErrors.Count == 0)
            {
                _passwordChangeErrors.Add("Não foi possível alterar a senha. Tente novamente.");
            }
            Snackbar.Add($"Erro ao alterar senha: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isChangingPassword = false;
        }
    }

    private static List<string> ParseErrorMessages(string? message)
    {
        if (string.IsNullOrWhiteSpace(message))
            return new List<string>();

        return message
            .Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries)
            .Select(m => m.Trim())
            .Where(m => !string.IsNullOrWhiteSpace(m))
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .ToList();
    }

    private void ToggleCurrentPasswordVisibility()
    {
        _showCurrentPassword = !_showCurrentPassword;
        _currentPasswordInput = _showCurrentPassword ? InputType.Text : InputType.Password;
        _currentPasswordIcon = _showCurrentPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
    }

    private void ToggleNewPasswordVisibility()
    {
        _showNewPassword = !_showNewPassword;
        _newPasswordInput = _showNewPassword ? InputType.Text : InputType.Password;
        _newPasswordIcon = _showNewPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
    }

    private void ToggleConfirmPasswordVisibility()
    {
        _showConfirmPassword = !_showConfirmPassword;
        _confirmPasswordInput = _showConfirmPassword ? InputType.Text : InputType.Password;
        _confirmPasswordIcon = _showConfirmPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
    }

    // Tables helpers (DefaultSortPerModule)
    private void AddDefaultSortRow() => DefaultSortRows.Add(new DefaultSortRow());
    private void RemoveDefaultSortRow(DefaultSortRow row)
    {
        DefaultSortRows.Remove(row);
        SyncDefaultSortDict();
    }
    private async void SyncDefaultSortDict()
    {
        var dict = DefaultSortRows
            .Where(r => !string.IsNullOrWhiteSpace(r.Module) && !string.IsNullOrWhiteSpace(r.Sort))
            .GroupBy(r => r.Module!)
            .ToDictionary(g => g.Key, g => g.Last().Sort!);
        PreferenceService.CurrentPreferences.Tables.DefaultSortPerModule = dict.Count == 0 ? null : dict;
        await PreferenceService.SaveAsync();
        Snackbar.Add("Preferências de ordenação salvas", Severity.Success, c => c.VisibleStateDuration = 1200);
    }

    // Tables helpers (VisibleColumnsPerModule)
    private void AddVisibleColumnsRow() => VisibleColumnsRows.Add(new VisibleColumnsRow());
    private void RemoveVisibleColumnsRow(VisibleColumnsRow row)
    {
        VisibleColumnsRows.Remove(row);
        SyncVisibleColumnsDict();
    }
    private async void SyncVisibleColumnsDict()
    {
        var dict = VisibleColumnsRows
            .Where(r => !string.IsNullOrWhiteSpace(r.Module))
            .GroupBy(r => r.Module!)
            .ToDictionary(g => g.Key, g => g.Last().ColumnsCsv?.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries) ?? Array.Empty<string>());
        PreferenceService.CurrentPreferences.Tables.VisibleColumnsPerModule = dict.Count == 0 ? null : dict;
        await PreferenceService.SaveAsync();
        Snackbar.Add("Preferências de colunas salvas", Severity.Success, c => c.VisibleStateDuration = 1200);
    }

    private class DefaultSortRow { public string? Module { get; set; } public string? Sort { get; set; } }
    private class VisibleColumnsRow { public string? Module { get; set; } public string? ColumnsCsv { get; set; } }

    // Preview helpers
    private string GetPreviewStyle()
    {
        var bg = ThemeService.IsDarkMode ? "#1e1e1e" : "#ffffff";
        var text = ThemeService.IsDarkMode ? "#ffffff" : "#000000";
        return $"background-color: {bg}; color: {text};";
    }

    private int GetDensitySpacing()
    {
        return PreferenceService.CurrentPreferences.Ui.Density == "compact" ? 1 : 3;
    }

    private Margin GetDensityMargin()
    {
        return PreferenceService.CurrentPreferences.Ui.Density == "compact" ? Margin.Dense : Margin.Normal;
    }

    private string GetFontSizeStyle()
    {
        var size = PreferenceService.CurrentPreferences.Ui.FontSize == "large" ? "1.1em" : "1em";
        return $"font-size: {size};";
    }

    private string FormatNumber(double number)
    {
        var format = PreferenceService.CurrentPreferences.Locale.NumberFormat;
        return format == "1.234,56" 
            ? number.ToString("N2", new System.Globalization.CultureInfo("pt-BR"))
            : number.ToString("N2", new System.Globalization.CultureInfo("en-US"));
    }
}
