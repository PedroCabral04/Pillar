@page "/service-orders"
@using erp.DTOs.ServiceOrders
@using erp.Services
@using erp.Components.Shared.Dialogs
@using erp.Components.Shared.Dialogs.ServiceOrders
@using erp.Components.Shared
@using MudBlazor
@using Size = MudBlazor.Size
@using Color = MudBlazor.Color
@attribute [Authorize]

@inject IApiService ApiService
@inject ILogger<ServiceOrders> Logger
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Navigation
@inject CurrencyFormatService Currency

<PageTitle>Ordens de Serviço - Pillar ERP</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudText Typo="Typo.h4">Ordens de Serviço</MudText>
        <MudButton Color="Color.Primary"
                Variant="Variant.Filled"
                StartIcon="@Icons.Material.Filled.Add"
                OnClick="OpenCreateDialog">
            Nova Ordem de Serviço
        </MudButton>
    </MudStack>

    @if (_loadError != null)
    {
        <MudAlert Severity="Severity.Error">@_loadError</MudAlert>
    }

    <MudTable T="ServiceOrderDto" ServerData="ServerReload"
            Dense="false" Hover="true" Elevation="2" @ref="_table" Striped="true" Loading="@_loading">
        <ToolBarContent>
            <MudText Typo="Typo.h5">Ordens Registradas</MudText>
            <MudSpacer/>
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                <MudTextField T="string" ValueChanged="OnSearch" Immediate="false" Placeholder="Procurar OS, cliente, aparelho..."
                            Variant="Variant.Outlined" Margin="Margin.Dense"
                            Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                            Clearable="true" Style="min-width: 200px;"/>
                <MudSelect T="string"
                        Value="_statusFilter"
                        ValueChanged="OnStatusFilterChanged"
                        Label="Status"
                        Variant="Variant.Outlined"
                        Margin="Margin.Dense"
                        Clearable="true"
                        Style="min-width: 150px;">
                    <MudSelectItem T="string" Value="@("Open")">Aberto</MudSelectItem>
                    <MudSelectItem T="string" Value="@("InProgress")">Em Andamento</MudSelectItem>
                    <MudSelectItem T="string" Value="@("WaitingCustomer")">Aguardando Cliente</MudSelectItem>
                    <MudSelectItem T="string" Value="@("WaitingParts")">Aguardando Peças</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Completed")">Concluído</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Delivered")">Entregue</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Cancelled")">Cancelado</MudSelectItem>
                </MudSelect>
                <DatePicker Label="Data Inicial"
                            @bind-Date="_startDate"
                            Margin="Margin.Dense"
                            Clearable="true"/>
                <DatePicker Label="Data Final"
                            @bind-Date="_endDate"
                            Margin="Margin.Dense"
                            Clearable="true"/>
                <MudIconButton Icon="@Icons.Material.Filled.FilterAlt"
                            Color="Color.Primary"
                            OnClick="ApplyFilters"/>
            </MudStack>
        </ToolBarContent>
        <HeaderContent>
            <MudTh>Número</MudTh>
            <MudTh>Data Entrada</MudTh>
            <MudTh>Cliente</MudTh>
            <MudTh>Aparelho</MudTh>
            <MudTh Style="text-align: right">Valor</MudTh>
            <MudTh>Status</MudTh>
            <MudTh Style="text-align: center">Ações</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Número">
                <MudText Typo="Typo.body2" Style="font-family: monospace">@context.OrderNumber</MudText>
            </MudTd>
            <MudTd DataLabel="Data">@context.EntryDate.ToString("dd/MM/yyyy")</MudTd>
            <MudTd DataLabel="Cliente">@(context.Customer?.Name ?? "Não informado")</MudTd>
            <MudTd DataLabel="Aparelho">
                @if (!string.IsNullOrEmpty(context.DeviceBrand) || !string.IsNullOrEmpty(context.DeviceModel))
                {
                    <MudText Typo="Typo.body2">@context.DeviceBrand @context.DeviceModel</MudText>
                }
                else
                {
                    <MudText Typo="Typo.body2" Color="Color.Default">-</MudText>
                }
            </MudTd>
            <MudTd DataLabel="Valor" Style="text-align: right">
                <MudText Typo="Typo.body2" Style="font-weight: 600">@Currency.Format(context.NetAmount)</MudText>
            </MudTd>
            <MudTd DataLabel="Status">
                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">@context.StatusDisplay</MudChip>
            </MudTd>
            <MudTd DataLabel="Ações" Style="text-align: center">
                <MudTooltip Text="Ver detalhes">
                    <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                Size="Size.Small"
                                OnClick="@(() => OpenDetailsDialog(context))"
                                aria-label="@($"Ver detalhes da OS {context.OrderNumber}")" />
                </MudTooltip>
                <MudTooltip Text="Imprimir">
                    <MudIconButton Icon="@Icons.Material.Filled.Print"
                                Size="Size.Small"
                                OnClick="@(() => OpenPrintDialog(context))"
                                aria-label="@($"Imprimir OS {context.OrderNumber}")" />
                </MudTooltip>
                @if (context.Status != "Cancelled" && context.Status != "Delivered")
                {
                    <MudTooltip Text="Alterar status">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                    Size="Size.Small"
                                    Color="Color.Primary"
                                    OnClick="@(() => OpenEditDialog(context))"
                                    aria-label="@($"Alterar OS {context.OrderNumber}")" />
                    </MudTooltip>
                }
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Class="pa-8">
                <MudIcon Icon="@Icons.Material.Filled.Build" Size="Size.Large" Color="Color.Default" Class="mb-2" />
                <MudText Typo="Typo.h6" Color="Color.Default">Nenhuma ordem de serviço encontrada</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Crie uma nova ordem clicando no botão acima</MudText>
            </MudStack>
        </NoRecordsContent>
        <LoadingContent>
            <MudText>Carregando...</MudText>
        </LoadingContent>
        <PagerContent>
            <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
        </PagerContent>
    </MudTable>
</MudContainer>

@code {
    private MudTable<ServiceOrderDto>? _table;
    private string? _loadError;
    private string? _searchString;
    private string? _statusFilter;
    private DateTime? _startDate;
    private DateTime? _endDate;
    private bool _loading = false;

    private async Task<TableData<ServiceOrderDto>> ServerReload(TableState state, CancellationToken ct)
    {
        _loading = true;
        _loadError = null;

        try
        {
            var page = state.Page + 1;
            var pageSize = state.PageSize;

            var queryParams = new List<string>
            {
                $"page={page}",
                $"pageSize={pageSize}"
            };

            if (!string.IsNullOrWhiteSpace(_searchString))
                queryParams.Add($"search={Uri.EscapeDataString(_searchString)}");

            if (!string.IsNullOrWhiteSpace(_statusFilter))
                queryParams.Add($"status={Uri.EscapeDataString(_statusFilter)}");

            if (_startDate.HasValue)
                queryParams.Add($"startDate={_startDate.Value:yyyy-MM-dd}");

            if (_endDate.HasValue)
                queryParams.Add($"endDate={_endDate.Value:yyyy-MM-dd}");

            var url = $"/api/service-orders?{string.Join("&", queryParams)}";

            var response = await ApiService.GetAsync<PaginatedServiceOrdersResponse>(url);
            if (response == null)
            {
                _loadError = "Erro ao carregar ordens de serviço";
                return new TableData<ServiceOrderDto> { TotalItems = 0, Items = new List<ServiceOrderDto>() };
            }

            return new TableData<ServiceOrderDto> { TotalItems = response.Total, Items = response.Items };
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erro ao carregar ordens de serviço");
            _loadError = $"Erro: {ex.Message}";
            return new TableData<ServiceOrderDto> { TotalItems = 0, Items = new List<ServiceOrderDto>() };
        }
        finally
        {
            _loading = false;
        }
    }

    private void OnSearch(string? search)
    {
        _searchString = search;
        _table?.ReloadServerData();
    }

    private void OnStatusFilterChanged(string? status)
    {
        _statusFilter = status;
        _table?.ReloadServerData();
    }

    private void ApplyFilters()
    {
        _table?.ReloadServerData();
    }

    private Color GetStatusColor(string status)
    {
        return status switch
        {
            "Open" => Color.Default,
            "InProgress" => Color.Primary,
            "WaitingCustomer" => Color.Warning,
            "WaitingParts" => Color.Tertiary,
            "Completed" => Color.Success,
            "Delivered" => Color.Dark,
            "Cancelled" => Color.Error,
            _ => Color.Default
        };
    }

    private void OpenCreateDialog()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        DialogService.Show<ServiceOrderCreateDialog>("Nova Ordem de Serviço", options);
    }

    private void OpenDetailsDialog(ServiceOrderDto order)
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var parameters = new DialogParameters { ["OrderId"] = order.Id };
        DialogService.Show<ServiceOrderDetailsDialog>("Detalhes da Ordem de Serviço", parameters, options);
    }

    private void OpenEditDialog(ServiceOrderDto order)
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var parameters = new DialogParameters { ["OrderId"] = order.Id };
        DialogService.Show<ServiceOrderEditDialog>("Editar Ordem de Serviço", parameters, options);
    }

    private async Task OpenPrintDialog(ServiceOrderDto order)
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.ExtraLarge, FullWidth = true };
        var parameters = new DialogParameters { ["OrderId"] = order.Id };
        await DialogService.ShowAsync<ServiceOrderPrintDialog>("Imprimir Ordem de Serviço", parameters, options);
    }
}
