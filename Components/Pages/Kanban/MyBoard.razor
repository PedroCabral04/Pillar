@page "/kanban"
@using System.Net.Http.Json
@using erp.DTOs.Kanban
@using erp.Services
@using MudBlazor
@using erp.Components.Shared.Dialogs
@inject IApiService Api
@inject NavigationManager Nav
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Kanban - Pillar ERP</PageTitle>

<div class="kanban-page">
    <div class="kanban-header">
        <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
            <MudIcon Icon="@Icons.Material.Filled.ViewKanban" Size="MudBlazor.Size.Large" />
            <MudText Typo="Typo.h5">Meu Kanban</MudText>
            @if (_columns?.Count > 3)
            {
                <MudChip T="string" Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Info" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.SwipeRight">
                    @_columns.Count colunas - role →
                </MudChip>
            }
            <MudSpacer />
            @if (_isLoading)
            {
                <MudProgressCircular Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Primary" Indeterminate="true"/>
            }
            @if (_columns?.Count > 3)
            {
                <MudIconButton Icon="@Icons.Material.Filled.ChevronLeft" 
                              Color="MudBlazor.Color.Default" 
                              OnClick="ScrollLeft"
                              Title="Rolar para esquerda" />
                <MudIconButton Icon="@Icons.Material.Filled.ChevronRight" 
                              Color="MudBlazor.Color.Default" 
                              OnClick="ScrollRight"
                              Title="Rolar para direita" />
            }
            <MudButton Color="MudBlazor.Color.Primary" 
                       Variant="Variant.Filled" 
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="NewColumn"
                       Disabled="@_isLoading">
                Nova Coluna
            </MudButton>
        </MudStack>
        <MudDivider Class="my-2"/>
    </div>

    <div class="kanban-scroll">
        @if (_columns is null)
        {
            <div class="kanban-loading">
                <MudProgressCircular Color="MudBlazor.Color.Primary" Indeterminate="true" Size="MudBlazor.Size.Large"/>
                <MudText Typo="Typo.body1" Class="mt-2">Carregando quadro...</MudText>
            </div>
        }
        else if (_columns.Count == 0)
        {
            <div class="kanban-empty">
                <MudIcon Icon="@Icons.Material.Outlined.ViewColumn" Size="MudBlazor.Size.Large" />
                <MudText Typo="Typo.h6" Class="mt-2">Nenhuma coluna criada</MudText>
                <MudText Typo="Typo.body2" Color="MudBlazor.Color.Secondary">Crie sua primeira coluna para começar!</MudText>
                <MudButton Color="MudBlazor.Color.Primary" 
                           Variant="Variant.Filled" 
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="NewColumn"
                           Class="mt-3">
                    Criar Coluna
                </MudButton>
            </div>
        }
        else
        {
            <MudDropContainer T="KanbanCardDto"
                              @ref="_dropContainer"
                              Items="@_allCards"
                                  ItemsSelector="@((KanbanCardDto item, string column) => string.Equals(item.ColumnId.ToString(), column, StringComparison.Ordinal))"
                              ItemDropped="OnCardDropped"
                                  Class="kanban-board d-flex flex-row">
                <ChildContent>
                    @foreach (var col in _columns.OrderBy(c => c.Position))
                    {
                        <MudPaper Elevation="6" Class="kanban-column pa-2">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="1" Class="column-header">
                                <MudText Typo="Typo.subtitle1"><strong>@col.Title</strong></MudText>
                                <MudChip T="string" Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Info">@col.Cards.Count</MudChip>
                                <MudSpacer/>
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                              Size="MudBlazor.Size.Small" 
                                              OnClick="() => EditColumn(col)"
                                              Title="Editar coluna"/>
                            </MudStack>
                            <MudDivider Class="my-2"/>
                            <MudDropZone T="KanbanCardDto" Identifier="@col.Id.ToString()" Class="kanban-cards mud-height-full" AllowReorder="true" />

                            <!-- Delete bar: arraste um card aqui para excluir -->
                            <MudDropZone T="KanbanCardDto" Identifier="@($"delete-{col.Id}")" Class="kanban-delete-zone" AllowReorder="false">
                                <div class="delete-zone-content">
                                    <MudIcon Icon="@Icons.Material.Filled.Delete" Size="@MudBlazor.Size.Medium" />
                                    <span class="delete-zone-text">Arraste aqui para excluir</span>
                                </div>
                            </MudDropZone>

                            <MudButton Size="MudBlazor.Size.Small" 
                                      Variant="Variant.Outlined" 
                                      StartIcon="@Icons.Material.Filled.Add" 
                                      OnClick="() => CreateCard(col)"
                                      FullWidth="true"
                                      Class="add-card-btn">
                                Adicionar Card
                            </MudButton>
                        </MudPaper>
                    }
                </ChildContent>
                <ItemRenderer>
                        <MudPaper Elevation="2" Class="pa-3 rounded-lg my-2 kanban-item" Style="cursor: grab;" @onclick="() => EditCard(context)">
                        <MudText Typo="Typo.body1" Class="kanban-card-title">@context.Title</MudText>
                        @if (!string.IsNullOrWhiteSpace(context.Description))
                        {
                            <MudText Typo="Typo.caption" Color="MudBlazor.Color.Secondary" Class="mt-1 kanban-card-desc">@context.Description</MudText>
                        }
                        <div class="kanban-card-footer">
                            <MudIcon Icon="@Icons.Material.Outlined.Edit" Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Primary" />
                        </div>
                    </MudPaper>
                </ItemRenderer>
            </MudDropContainer>
        }
    </div>
</div>

@code {
    private List<ColumnVm>? _columns;
    private bool _isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        var ensureBoard = await Api.GetAsync("api/kanban/board");
        if (!ensureBoard.IsSuccessStatusCode)
        {
            if ((int)ensureBoard.StatusCode == 401)
            {
                Nav.NavigateTo("/login", forceLoad: true);
                return;
            }
            throw new HttpRequestException($"Falha ao carregar quadro: {(int)ensureBoard.StatusCode}");
        }

        var data = await Api.GetAsync<ColumnsResponse>("api/kanban/columns");
    _columns = data?.Columns ?? new();
    _allCards = _columns.SelectMany(c => c.Cards).ToList();
    }

    private async Task NewColumn()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<KanbanColumnDialog>("Nova Coluna", options);
        var result = await dialog.Result;
        
        if (result is { Canceled: false } && result.Data is string title)
        {
            var created = await Api.PostAsJsonAsync<CreateColumnRequest, KanbanColumnDto>("api/kanban/columns", new CreateColumnRequest(title));
            if (created is not null && _columns is not null)
            {
                // Optimistic update: add column immediately
                var newColumn = new ColumnVm
                {
                    Id = created.Id,
                    Title = created.Title,
                    Position = created.Position,
                    Cards = new()
                };
                _columns.Add(newColumn);
                StateHasChanged();
                
                Snackbar.Add("Coluna criada com sucesso!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Erro ao criar coluna.", Severity.Error);
            }
        }
    }

    private async Task EditColumn(ColumnVm col)
    {
        var parameters = new DialogParameters<KanbanColumnDialog>
        {
            { x => x.InitialTitle, col.Title },
            { x => x.IsEdit, true }
        };
        var options = new DialogOptions { CloseOnEscapeKey = true, CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<KanbanColumnDialog>("Editar Coluna", parameters, options);
        var result = await dialog.Result;
        
        if (result is { Canceled: false } && result.Data is string title)
        {
            var res = await Api.PutAsJsonAsync($"api/kanban/columns/{col.Id}/title", new RenameColumnRequest(title));
            if (res.IsSuccessStatusCode)
            {
                Snackbar.Add("Coluna atualizada com sucesso!", Severity.Success);
                col.Title = title;
                StateHasChanged();
            }
            else
            {
                Snackbar.Add("Erro ao atualizar coluna.", Severity.Error);
            }
        }
    }

    private async Task CreateCard(ColumnVm col)
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, CloseButton = true, MaxWidth = MaxWidth.Medium };
        var dialog = await DialogService.ShowAsync<KanbanCardDialog>("Novo Card", options);
        var result = await dialog.Result;
        
        if (result is { Canceled: false } && result.Data is KanbanCardDialog.CardDialogResult cardResult)
        {
            var res = await Api.PostAsJsonAsync<CreateCardRequest, KanbanCardDto>("api/kanban/cards", new CreateCardRequest(col.Id, cardResult.Title, cardResult.Description));
            if (res is not null && _columns is not null)
            {
                // Optimistic update: add card immediately to UI
                var newCard = new KanbanCardDto(res.Id, res.Title, res.Description, res.Position, res.ColumnId);
                _allCards.Add(newCard);
                
                var column = _columns.FirstOrDefault(c => c.Id == col.Id);
                if (column is not null)
                {
                    column.Cards.Add(newCard);
                }
                
                _dropContainer?.Refresh();
                StateHasChanged();
                
                Snackbar.Add("Card criado com sucesso!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Erro ao criar card.", Severity.Error);
            }
        }
    }

    private async Task EditCard(KanbanCardDto card)
    {
        var parameters = new DialogParameters<KanbanCardDialog>
        {
            { x => x.InitialTitle, card.Title },
            { x => x.InitialDescription, card.Description },
            { x => x.IsEdit, true },
            { x => x.CardId, card.Id }
        };
        var options = new DialogOptions { CloseOnEscapeKey = true, CloseButton = true, MaxWidth = MaxWidth.Medium };
        var dialog = await DialogService.ShowAsync<KanbanCardDialog>("Editar Card", parameters, options);
        var result = await dialog.Result;
        
        if (result is { Canceled: false } && result.Data is KanbanCardDialog.CardDialogResult cardResult && _columns is not null)
        {
            if (cardResult.Delete)
            {
                // Optimistic delete: remove from UI immediately
                _allCards.RemoveAll(c => c.Id == card.Id);
                foreach (var col in _columns)
                {
                    col.Cards.RemoveAll(c => c.Id == card.Id);
                }
                _dropContainer?.Refresh();
                StateHasChanged();
                
                var deleteRes = await Api.DeleteAsync($"api/kanban/cards/{card.Id}");
                if (deleteRes.IsSuccessStatusCode)
                {
                    Snackbar.Add("Card excluído com sucesso!", Severity.Success);
                }
                else
                {
                    Snackbar.Add("Erro ao excluir card.", Severity.Error);
                    await RefreshData(); // Revert on error
                }
            }
            else
            {
                // Optimistic update: update UI immediately
                var idx = _allCards.FindIndex(c => c.Id == card.Id);
                if (idx >= 0)
                {
                    var updated = new KanbanCardDto(card.Id, cardResult.Title, cardResult.Description, card.Position, card.ColumnId);
                    _allCards[idx] = updated;
                    
                    foreach (var col in _columns)
                    {
                        var cardIdx = col.Cards.FindIndex(c => c.Id == card.Id);
                        if (cardIdx >= 0)
                        {
                            col.Cards[cardIdx] = updated;
                        }
                    }
                }
                _dropContainer?.Refresh();
                StateHasChanged();
                
                var updateRes = await Api.PutAsJsonAsync($"api/kanban/cards/{card.Id}", new UpdateCardRequest(cardResult.Title, cardResult.Description));
                if (updateRes.IsSuccessStatusCode)
                {
                    Snackbar.Add("Card atualizado com sucesso!", Severity.Success);
                }
                else
                {
                    Snackbar.Add("Erro ao atualizar card.", Severity.Error);
                    await RefreshData(); // Revert on error
                }
            }
        }
    }

    private async Task RefreshData()
    {
        try
        {
            var data = await Api.GetAsync<ColumnsResponse>("api/kanban/columns");
            if (data is not null)
            {
                await InvokeAsync(() =>
                {
                    _columns = data.Columns ?? new();
                    _allCards = _columns.SelectMany(c => c.Cards).ToList();
                    
                    if (_dropContainer is not null)
                    {
                        _dropContainer.Refresh();
                    }
                    
                    StateHasChanged();
                });
            }
        }
        catch (Exception ex)
        {
            await InvokeAsync(() =>
            {
                Snackbar.Add($"Erro ao atualizar dados: {ex.Message}", Severity.Error);
            });
        }
    }

    private MudDropContainer<KanbanCardDto>? _dropContainer;
    private List<KanbanCardDto> _allCards = new();

    private async Task OnCardDropped(MudItemDropInfo<KanbanCardDto> info)
    {
        if (info?.Item is null || string.IsNullOrWhiteSpace(info.DropzoneIdentifier) || _columns is null)
            return;

        // Handle deletion when dropped onto the delete bar (identifier: "delete-{columnId}")
        if (info.DropzoneIdentifier.StartsWith("delete-"))
        {
            // optimistic delete in UI
            var cardId = info.Item.Id;
            _allCards.RemoveAll(c => c.Id == cardId);
            foreach (var col in _columns)
            {
                col.Cards.RemoveAll(c => c.Id == cardId);
            }
            _dropContainer?.Refresh();
            StateHasChanged();

            // Call API to delete
            try
            {
                var deleteRes = await Api.DeleteAsync($"api/kanban/cards/{cardId}");
                if (deleteRes.IsSuccessStatusCode)
                {
                    Snackbar.Add("Card excluído com sucesso!", Severity.Success);
                }
                else
                {
                    Snackbar.Add("Erro ao excluir card. Revertendo...", Severity.Warning);
                    await RefreshData();
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro ao excluir card: {ex.Message}", Severity.Error);
                await RefreshData();
            }

            return;
        }

        // Normal move handling (drop into a column)
        if (!int.TryParse(info.DropzoneIdentifier, out var toColumnId))
            return;

        var originalColumnId = info.Item.ColumnId;
        var originalPosition = info.Item.Position;

        try
        {
            // Optimistic update: move item locally so UI reflects immediately
            var idx = _allCards.FindIndex(c => c.Id == info.Item.Id);
            if (idx >= 0)
            {
                var m = _allCards[idx];
                var updatedCard = new KanbanCardDto(m.Id, m.Title, m.Description, m.Position, toColumnId);
                _allCards[idx] = updatedCard;
                
                // Update in columns list too
                foreach (var col in _columns)
                {
                    col.Cards.RemoveAll(c => c.Id == m.Id);
                    if (col.Id == toColumnId)
                    {
                        col.Cards.Add(updatedCard);
                    }
                }
            }
            
            if (_dropContainer is not null)
            {
                _dropContainer.Refresh();
            }
            StateHasChanged();

            // Persist on server (append at end for now)
            var toPosition = _allCards.Count(c => c.ColumnId == toColumnId && c.Id != info.Item.Id);
            var moveResult = await Api.PostAsJsonAsync("api/kanban/cards/move", new MoveCardRequest(info.Item.Id, toColumnId, toPosition));

            if (!moveResult.IsSuccessStatusCode)
            {
                // Revert on error
                Snackbar.Add("Erro ao mover card. Revertendo...", Severity.Warning);
                await RefreshData();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao mover card: {ex.Message}", Severity.Error);
            await RefreshData();
        }
    }

    private async Task ScrollLeft()
    {
        await JS.InvokeVoidAsync("eval", @"
            var container = document.querySelector('.kanban-scroll');
            if (container) container.scrollBy({ left: -350, behavior: 'smooth' });
        ");
    }

    private async Task ScrollRight()
    {
        await JS.InvokeVoidAsync("eval", @"
            var container = document.querySelector('.kanban-scroll');
            if (container) container.scrollBy({ left: 350, behavior: 'smooth' });
        ");
    }

    // Simple JS prompt bridge
    [Inject] IJSRuntime JS { get; set; } = default!;
    private async Task<string?> PromptAsync(string message, string? defaultValue = null)
        => await JS.InvokeAsync<string?>("prompt", message, defaultValue);

    private record ColumnsResponse(List<ColumnVm> Columns);
    private record ColumnVm
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public int Position { get; set; }
        public List<KanbanCardDto> Cards { get; set; } = new();
    }
}

<style>
.kanban-page { 
    display: flex; 
    flex-direction: column; 
    min-height: 100vh;
    background: var(--mud-palette-background);
}

.kanban-header { 
    padding: 16px 24px;
    background: var(--mud-palette-surface);
    box-shadow: var(--mud-elevation-2);
}

.kanban-scroll { 
    flex: 1; 
    overflow-x: auto; 
    overflow-y: hidden;
    padding: 16px;
    position: relative;
    scroll-behavior: smooth; /* smooth scrolling */
}

/* Gradient hint when there are more columns to scroll */
.kanban-scroll::before,
.kanban-scroll::after {
    content: '';
    position: sticky;
    top: 0;
    width: 60px;
    height: 100%;
    pointer-events: none;
    z-index: 2;
    opacity: 0;
    transition: opacity 300ms ease;
}

.kanban-scroll::before {
    left: 0;
    background: linear-gradient(to right, var(--mud-palette-background) 0%, transparent 100%);
}

.kanban-scroll::after {
    right: 0;
    background: linear-gradient(to left, var(--mud-palette-background) 0%, transparent 100%);
}

/* Show gradients when scrollable (JS can add this class or CSS hack) */
.kanban-scroll.has-scroll::before {
    opacity: 0.8;
}

.kanban-scroll.has-scroll::after {
    opacity: 0.8;
}

.kanban-loading,
.kanban-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    min-height: 400px;
}

.kanban-board { 
    display: flex; 
    flex-direction: row; 
    align-items: flex-start; 
    gap: 20px; 
    padding: 8px;
    min-height: 500px;
    overflow-x: auto;
}

/* Responsive: Stack columns vertically on mobile */
@@media (max-width: 768px) {
    .kanban-board {
        flex-direction: column;
        align-items: stretch;
        gap: 16px;
    }
    
    .kanban-column {
        width: 100% !important;
        min-width: 100% !important;
        max-width: 100% !important;
    }
}

.kanban-column { 
    width: 300px; 
    min-width: 300px; 
    max-width: 340px;
    background: var(--mud-palette-surface);
    border-radius: 12px;
    min-height: 100px;
    display: flex;
    flex-direction: column;
    transition: box-shadow 200ms ease, transform 150ms ease;
    flex-shrink: 0; /* prevent columns from shrinking */
}

/* Subtle lift on hover for better depth perception */

.kanban-column:hover {
    box-shadow: var(--mud-elevation-8);
    transform: translateY(-2px);
}

.kanban-column .column-header {
    padding-bottom: 4px;
}

.kanban-cards { 
    display: flex; 
    flex-direction: column; 
    gap: 10px; 
    padding: 8px; 
    border-radius: 8px; 
    background: var(--mud-palette-background-grey);
    min-height: 100px;
    flex: 1;
    margin-bottom: 8px;
}

.kanban-item {
    background: var(--mud-palette-surface);
    border-radius: 8px;
    cursor: grab;
    transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
    border: 2px solid transparent;
}

.kanban-item:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: var(--mud-elevation-12);
    border-color: var(--mud-palette-primary);
}

.kanban-item:active {
    cursor: grabbing;
    transform: scale(0.98);
}

.kanban-card-title {
    font-weight: 600;
    line-height: 1.4;
    word-break: break-word;
}

.kanban-card-desc {
    line-height: 1.4;
    word-break: break-word;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.kanban-card-footer {
    display: flex;
    justify-content: flex-end;
    margin-top: 8px;
    opacity: 0;
    transition: opacity 150ms ease;
}

.kanban-item:hover .kanban-card-footer {
    opacity: 1;
}

.add-card-btn {
    margin-top: 8px;
    border-style: dashed !important;
    transition: all 150ms ease;
}

.add-card-btn:hover {
    background: var(--mud-palette-primary);
    color: white;
    border-style: solid !important;
}

.mud-paper.kanban-column .mud-divider { 
    opacity: 0.3; 
}

/* Drag feedback */
.mud-drop-zone {
    transition: background-color 200ms ease;
}

.mud-drop-zone.mud-drop-zone-drag-enter {
    background: var(--mud-palette-primary-darken);
    opacity: 0.8;
}

/* Scroll customization - more prominent */
.kanban-scroll::-webkit-scrollbar {
    height: 14px;
}

.kanban-scroll::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.05);
    border-radius: 10px;
    margin: 0 8px;
}

.kanban-scroll::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,0.2);
    border-radius: 10px;
    border: 3px solid transparent;
    background-clip: padding-box;
    transition: background 200ms ease;
}

.kanban-scroll::-webkit-scrollbar-thumb:hover {
    background: rgba(0,0,0,0.35);
    background-clip: padding-box;
}

.kanban-scroll::-webkit-scrollbar-thumb:active {
    background: var(--mud-palette-primary);
    background-clip: padding-box;
}

/* Animation for new items */
@@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.kanban-item {
    animation: slideIn 250ms ease-out;
}

.kanban-delete-zone {
    /* Start hidden with zero height for smooth slide-down/up */
    max-height: 0;
    overflow: hidden;
    border-radius: 8px;
    background: #fff7f7;
    border: 2px dashed rgba(176,0,32,0.10);
    display: block;
    align-items: center;
    justify-content: center;
    margin-bottom: 8px;
    padding: 0 12px; /* collapsed when hidden */
    opacity: 0;
    transform: translateY(6px) scale(0.995);
    transition: max-height 220ms cubic-bezier(0.2,0,0,1),
                opacity 180ms ease,
                transform 180ms cubic-bezier(0.2,0,0,1),
                border-color 150ms ease,
                background-color 150ms ease;
}

.kanban-delete-zone .delete-zone-content {
    display: flex;
    gap: 8px;
    align-items: center;
    color: #b00020;
    font-weight: 600;
}

/* Show delete zone while dragging: expand and fade in */
.kanban-dragging .kanban-delete-zone {
    max-height: 72px; /* enough for content */
    padding: 10px 12px;
    opacity: 1;
    transform: translateY(0) scale(1);
}

/* Gentle pop animation on drag-enter */
.kanban-delete-zone.mud-drop-zone-drag-enter {
    background: #ffecec;
    border-color: #b00020;
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 8px 20px rgba(176,0,32,0.12);
}

/* Subtle pulse to attract attention when active */
@@keyframes deletePulse {
    0% { box-shadow: 0 6px 16px rgba(176,0,32,0.06); }
    50% { box-shadow: 0 10px 28px rgba(176,0,32,0.10); }
    100% { box-shadow: 0 6px 16px rgba(176,0,32,0.06); }
}

.kanban-delete-zone.mud-drop-zone-drag-enter .delete-zone-content {
    animation: deletePulse 900ms ease-in-out 1;
}
</style>

<script>
(function(){
    if (window.__kanbanDragInit) return;
    window.__kanbanDragInit = true;

    function onStart(e) {
        var el = e.target;
        while (el && !el.classList?.contains('kanban-item')) el = el.parentElement;
        if (el) document.body.classList.add('kanban-dragging');
    }

    function onEnd(e) { document.body.classList.remove('kanban-dragging'); }

    document.addEventListener('dragstart', onStart);
    document.addEventListener('dragend', onEnd);
    document.addEventListener('drop', onEnd);

    // Mouse fallback: show during press on an item until mouseup
    document.addEventListener('mousedown', function(e){
        var el = e.target;
        while (el && !el.classList?.contains('kanban-item')) el = el.parentElement;
        if (el) document.body.classList.add('kanban-dragging');
    });
    document.addEventListener('mouseup', onEnd);

    // Check if kanban-scroll has horizontal overflow and add visual hint class
    function checkScrollable() {
        var scrollContainer = document.querySelector('.kanban-scroll');
        if (!scrollContainer) return;
        
        var hasHorizontalScroll = scrollContainer.scrollWidth > scrollContainer.clientWidth;
        if (hasHorizontalScroll) {
            scrollContainer.classList.add('has-scroll');
        } else {
            scrollContainer.classList.remove('has-scroll');
        }
    }

    // Check on load and when window resizes
    window.addEventListener('load', checkScrollable);
    window.addEventListener('resize', checkScrollable);
    
    // Re-check periodically (for dynamic content changes via Blazor)
    setInterval(checkScrollable, 1000);
})();
</script>
