@page "/kanban"
@using System.Net.Http.Json
@using erp.DTOs.Kanban
@using erp.Models.Kanban
@using erp.Services
@using MudBlazor
@using erp.Components.Shared.Dialogs
@inject IApiService Api
@inject NavigationManager Nav
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Kanban - Pillar ERP</PageTitle>

<div class="kanban-page">
    <div class="kanban-header">
        <div class="kanban-header-content">
            <div class="kanban-title-section">
                @* <div class="kanban-icon-wrapper">
                    <MudIcon Icon="@Icons.Material.Filled.ViewKanban" Size="MudBlazor.Size.Large" />
                </div> *@
                <div>
                    <MudText Typo="Typo.h5" Class="kanban-main-title">@(_board?.Name ?? "Meu Kanban")</MudText>
                    <MudText Typo="Typo.caption" Color="MudBlazor.Color.Secondary">
                        @if (_stats != null)
                        {
                            <span>@_stats.TotalCards cards • @_stats.CompletedCards concluídos</span>
                        }
                    </MudText>
                </div>
            </div>
            
            <div class="kanban-header-actions">
                @if (_columns?.Count > 3)
                {
                    <MudChip T="string" Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Primary" Variant="Variant.Text" Icon="@Icons.Material.Filled.SwipeRight">
                        @_columns.Count colunas
                    </MudChip>
                }
                @if (_isLoading)
                {
                    <MudProgressCircular Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Primary" Indeterminate="true"/>
                }
                @if (_columns?.Count > 3)
                {
                    <MudButtonGroup Variant="Variant.Outlined" Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Default">
                        <MudIconButton Icon="@Icons.Material.Filled.ChevronLeft" 
                                      OnClick="ScrollLeft"
                                      Title="Rolar para esquerda" />
                        <MudIconButton Icon="@Icons.Material.Filled.ChevronRight" 
                                      OnClick="ScrollRight"
                                      Title="Rolar para direita" />
                    </MudButtonGroup>
                }
                <MudTooltip Text="Gerenciar Etiquetas">
                    <MudIconButton Icon="@Icons.Material.Filled.Label" 
                                   Color="MudBlazor.Color.Default"
                                   Variant="Variant.Outlined"
                                   Size="MudBlazor.Size.Medium"
                                   OnClick="OpenLabelsDialog" />
                </MudTooltip>
                <MudTooltip Text="Meus Quadros">
                    <MudIconButton Icon="@Icons.Material.Filled.Dashboard" 
                                   Color="MudBlazor.Color.Default"
                                   Variant="Variant.Outlined"
                                   Size="MudBlazor.Size.Medium"
                                   OnClick="OpenBoardsDialog" />
                </MudTooltip>
                <MudButton Color="MudBlazor.Color.Primary" 
                           Variant="Variant.Filled" 
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="NewColumn"
                           Disabled="@_isLoading"
                           Class="new-column-btn">
                    Nova Coluna
                </MudButton>
            </div>
        </div>
    </div>

    <div class="kanban-scroll">
        @if (_columns is null)
        {
            <div class="kanban-loading">
                <MudProgressCircular Color="MudBlazor.Color.Primary" Indeterminate="true" Size="MudBlazor.Size.Large"/>
                <MudText Typo="Typo.body1" Class="mt-2">Carregando quadro...</MudText>
            </div>
        }
        else if (_columns.Count == 0)
        {
            <div class="kanban-empty">
                <MudIcon Icon="@Icons.Material.Outlined.ViewColumn" Size="MudBlazor.Size.Large" />
                <MudText Typo="Typo.h6" Class="mt-2">Nenhuma coluna criada</MudText>
                <MudText Typo="Typo.body2" Color="MudBlazor.Color.Secondary">Crie sua primeira coluna para começar!</MudText>
                <MudButton Color="MudBlazor.Color.Primary" 
                           Variant="Variant.Filled" 
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="NewColumn"
                           Class="mt-3">
                    Criar Coluna
                </MudButton>
            </div>
        }
        else
        {
            <MudDropContainer T="KanbanCardDto"
                              @ref="_dropContainer"
                              Items="@_allCards"
                              ItemsSelector="@((KanbanCardDto item, string column) => FilterCard(item) && string.Equals(item.ColumnId.ToString(), column, StringComparison.Ordinal))"
                              ItemDropped="OnCardDropped"
                              Class="kanban-board d-flex flex-row">
                <ChildContent>
                    @{ var colIndex = 0; }
                    @foreach (var col in _columns.OrderBy(c => c.Position))
                    {
                        var filteredCount = _allCards.Count(c => c.ColumnId == col.Id && FilterCard(c));
                        var columnColor = GetColumnColor(colIndex);
                        colIndex++;
                        
                        <div class="kanban-column-wrapper">
                            <MudPaper Elevation="0" Class="kanban-column">
                                <div class="column-header" style="@($"border-top: 3px solid {columnColor};")">
                                    <div class="column-header-content">
                                        <div class="column-title-group">
                                            <span class="column-title">@col.Title</span>
                                            <span class="column-count" style="@($"background: {columnColor}20; color: {columnColor};")">@filteredCount</span>
                                        </div>
                                        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="MudBlazor.Size.Small" Dense="true" AnchorOrigin="Origin.BottomRight">
                                            <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="() => EditColumn(col)">Editar</MudMenuItem>
                                            <MudMenuItem Icon="@Icons.Material.Filled.ArrowBack" OnClick="() => MoveColumnLeft(col)">Mover para Esquerda</MudMenuItem>
                                            <MudMenuItem Icon="@Icons.Material.Filled.ArrowForward" OnClick="() => MoveColumnRight(col)">Mover para Direita</MudMenuItem>
                                            <MudDivider />
                                            <MudMenuItem Icon="@Icons.Material.Filled.Delete" IconColor="MudBlazor.Color.Error" OnClick="() => DeleteColumn(col)">Excluir</MudMenuItem>
                                        </MudMenu>
                                    </div>
                                </div>
                                
                                <MudDropZone T="KanbanCardDto" Identifier="@col.Id.ToString()" Class="kanban-cards" AllowReorder="true" />

                                <MudDropZone T="KanbanCardDto" Identifier="@($"delete-{col.Id}")" Class="kanban-delete-zone" AllowReorder="false">
                                    <div class="delete-zone-content">
                                        <MudIcon Icon="@Icons.Material.Filled.DeleteOutline" Size="@MudBlazor.Size.Small" />
                                        <span>Excluir</span>
                                    </div>
                                </MudDropZone>

                                <div class="column-footer">
                                    <MudButton Size="MudBlazor.Size.Small" 
                                              Variant="Variant.Text" 
                                              StartIcon="@Icons.Material.Filled.Add" 
                                              OnClick="() => CreateCard(col)"
                                              FullWidth="true"
                                              Class="add-card-btn"
                                              Color="MudBlazor.Color.Primary">
                                        Adicionar card
                                    </MudButton>
                                </div>
                            </MudPaper>
                        </div>
                    }
                </ChildContent>
                <ItemRenderer>
                    @{
                        var cardStyle = !string.IsNullOrEmpty(context.Color) 
                            ? $"border-left: 4px solid {context.Color}; cursor: grab;" 
                            : "cursor: grab;";
                    }
                    <MudPaper Elevation="2" Class="pa-3 rounded-lg my-2 kanban-item" Style="@cardStyle" @onclick="() => EditCard(context)">
                        @* Labels *@
                        @if (context.Labels?.Any() == true)
                        {
                            <div class="d-flex flex-wrap gap-1 mb-2">
                                @foreach (var label in context.Labels.Take(3))
                                {
                                    <MudChip T="string" Size="MudBlazor.Size.Small" Style="@($"background-color: {label.Color}; color: white;")" Dense="true">
                                        @label.Name
                                    </MudChip>
                                }
                                @if (context.Labels.Count > 3)
                                {
                                    <MudChip T="string" Size="MudBlazor.Size.Small" Variant="Variant.Outlined" Dense="true">
                                        +@(context.Labels.Count - 3)
                                    </MudChip>
                                }
                            </div>
                        }

                        @* Title *@
                        <MudText Typo="Typo.body1" Class="kanban-card-title">@context.Title</MudText>

                        @* Description *@
                        @if (!string.IsNullOrWhiteSpace(context.Description))
                        {
                            <MudText Typo="Typo.caption" Color="MudBlazor.Color.Secondary" Class="mt-1 kanban-card-desc">
                                @(context.Description.Length > 80 ? context.Description[..80] + "..." : context.Description)
                            </MudText>
                        }

                        @* Footer with metadata *@
                        <div class="kanban-card-footer mt-2 d-flex align-center gap-2 flex-wrap">
                            @* Priority indicator *@
                            @if (context.Priority != KanbanPriority.None)
                            {
                                <MudTooltip Text="@GetPriorityText(context.Priority)">
                                    <MudIcon Icon="@GetPriorityIcon(context.Priority)" 
                                             Color="@GetPriorityColor(context.Priority)" 
                                             Size="MudBlazor.Size.Small" />
                                </MudTooltip>
                            }

                            @* Due date *@
                            @if (context.DueDate.HasValue)
                            {
                                var isOverdue = context.DueDate.Value.Date < DateTime.Today && context.CompletedAt == null;
                                var isToday = context.DueDate.Value.Date == DateTime.Today;
                                <MudChip T="string" Size="MudBlazor.Size.Small" 
                                         Color="@(isOverdue ? MudBlazor.Color.Error : (isToday ? MudBlazor.Color.Warning : MudBlazor.Color.Default))"
                                         Variant="Variant.Outlined" Dense="true"
                                         Icon="@Icons.Material.Filled.CalendarToday">
                                    @context.DueDate.Value.ToString("dd/MM")
                                </MudChip>
                            }

                            @* Completed indicator *@
                            @if (context.CompletedAt.HasValue)
                            {
                                <MudTooltip Text="@($"Concluído em {context.CompletedAt.Value:dd/MM/yyyy HH:mm}")">
                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="MudBlazor.Color.Success" Size="MudBlazor.Size.Small" />
                                </MudTooltip>
                            }

                            @* Comments count *@
                            @if (context.CommentCount > 0)
                            {
                                <MudTooltip Text="@($"{context.CommentCount} comentário(s)")">
                                    <div class="d-flex align-center gap-1">
                                        <MudIcon Icon="@Icons.Material.Filled.Comment" Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Default" />
                                        <MudText Typo="Typo.caption">@context.CommentCount</MudText>
                                    </div>
                                </MudTooltip>
                            }

                            <MudSpacer />

                            @* Assigned user avatar *@
                            @if (context.AssignedUserId.HasValue)
                            {
                                <MudTooltip Text="@context.AssignedUserName">
                                    @if (!string.IsNullOrEmpty(context.AssignedUserPhoto))
                                    {
                                        <MudAvatar Size="MudBlazor.Size.Small" Image="@context.AssignedUserPhoto" />
                                    }
                                    else
                                    {
                                        <MudAvatar Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Primary">
                                            @(context.AssignedUserName?.FirstOrDefault())
                                        </MudAvatar>
                                    }
                                </MudTooltip>
                            }
                        </div>
                    </MudPaper>
                </ItemRenderer>
            </MudDropContainer>
        }
    </div>
</div>

@code {
    private List<ColumnVm>? _columns;
    private bool _isLoading = false;
    private KanbanStatsDto? _stats;
    private KanbanBoardDto? _board;
    private List<AssignableUserDto> _assignableUsers = new();
    private List<KanbanLabelDto> _boardLabels = new();

    // Filters
    private KanbanPriority? _filterPriority;
    private string? _filterDueDate;
    private int? _filterAssignedUserId;
    private string? _searchText;

    private IEnumerable<KanbanCardDto> FilteredCards => _allCards.Where(FilterCard);

    private bool FilterCard(KanbanCardDto card)
    {
        if (_filterPriority.HasValue && card.Priority != _filterPriority.Value)
            return false;

        if (_filterAssignedUserId.HasValue)
        {
            if (_filterAssignedUserId == -1 && card.AssignedUserId.HasValue)
                return false;
            if (_filterAssignedUserId != -1 && card.AssignedUserId != _filterAssignedUserId)
                return false;
        }

        if (!string.IsNullOrWhiteSpace(_filterDueDate))
        {
            var today = DateTime.Today;
            switch (_filterDueDate)
            {
                case "overdue":
                    if (!card.DueDate.HasValue || card.DueDate.Value.Date >= today || card.CompletedAt.HasValue)
                        return false;
                    break;
                case "today":
                    if (!card.DueDate.HasValue || card.DueDate.Value.Date != today)
                        return false;
                    break;
                case "week":
                    var endOfWeek = today.AddDays(7);
                    if (!card.DueDate.HasValue || card.DueDate.Value.Date > endOfWeek || card.DueDate.Value.Date < today)
                        return false;
                    break;
                case "noduedate":
                    if (card.DueDate.HasValue)
                        return false;
                    break;
            }
        }

        if (!string.IsNullOrWhiteSpace(_searchText))
        {
            var search = _searchText.ToLowerInvariant();
            if (!card.Title.ToLowerInvariant().Contains(search) &&
                !(card.Description?.ToLowerInvariant().Contains(search) ?? false))
                return false;
        }

        return true;
    }

    protected override async Task OnInitializedAsync()
    {
        _board = await Api.GetAsync<KanbanBoardDto>("api/kanban/board");
        if (_board is null)
        {
            Nav.NavigateTo("/login", forceLoad: true);
            return;
        }

        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            var boardIdParam = _board?.Id > 0 ? $"?boardId={_board.Id}" : "";
            var dataTask = Api.GetAsync<ColumnsResponse>($"api/kanban/columns{boardIdParam}");
            var statsTask = Api.GetAsync<KanbanStatsDto>($"api/kanban/stats{boardIdParam}");
            var usersTask = Api.GetAsync<List<AssignableUserDto>>("api/kanban/assignable-users");
            var labelsTask = Api.GetAsync<List<KanbanLabelDto>>($"api/kanban/labels{boardIdParam}");

            await Task.WhenAll(dataTask, statsTask, usersTask, labelsTask);

            var data = await dataTask;
            _columns = data?.Columns ?? new();
            _allCards = _columns.SelectMany(c => c.Cards).ToList();

            _stats = await statsTask;
            _assignableUsers = await usersTask ?? new();
            _boardLabels = await labelsTask ?? new();
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    // Column colors - subtle, professional palette
    private static readonly string[] ColumnColors = new[]
    {
        "#6366F1", // Indigo
        "#8B5CF6", // Violet  
        "#EC4899", // Pink
        "#F59E0B", // Amber
        "#10B981", // Emerald
        "#3B82F6", // Blue
        "#EF4444", // Red
        "#14B8A6", // Teal
    };

    private string GetColumnColor(int index) => ColumnColors[index % ColumnColors.Length];

    // Helper methods for priority display
    private string GetPriorityIcon(KanbanPriority priority) => priority switch
    {
        KanbanPriority.Urgent => Icons.Material.Filled.Error,
        KanbanPriority.High => Icons.Material.Filled.KeyboardArrowUp,
        KanbanPriority.Normal => Icons.Material.Filled.Remove,
        KanbanPriority.Low => Icons.Material.Filled.KeyboardArrowDown,
        _ => Icons.Material.Filled.Remove
    };

    private MudBlazor.Color GetPriorityColor(KanbanPriority priority) => priority switch
    {
        KanbanPriority.Urgent => MudBlazor.Color.Error,
        KanbanPriority.High => MudBlazor.Color.Warning,
        KanbanPriority.Normal => MudBlazor.Color.Info,
        KanbanPriority.Low => MudBlazor.Color.Success,
        _ => MudBlazor.Color.Default
    };

    private string GetPriorityText(KanbanPriority priority) => priority switch
    {
        KanbanPriority.Urgent => "Urgente",
        KanbanPriority.High => "Alta",
        KanbanPriority.Normal => "Normal",
        KanbanPriority.Low => "Baixa",
        _ => "Nenhuma"
    };

    private record AssignableUserDto(int Id, string FullName, string? Photo);

    private async Task NewColumn()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<KanbanColumnDialog>("Nova Coluna", options);
        var result = await dialog.Result;
        
        if (result is { Canceled: false } && result.Data is string title)
        {
            var created = await Api.PostAsJsonAsync<CreateColumnRequest, KanbanColumnDto>("api/kanban/columns", new CreateColumnRequest(title));
            if (created is not null && _columns is not null)
            {
                // Optimistic update: add column immediately
                var newColumn = new ColumnVm
                {
                    Id = created.Id,
                    Title = created.Title,
                    Position = created.Position,
                    Cards = new()
                };
                _columns.Add(newColumn);
                StateHasChanged();
                
                Snackbar.Add("Coluna criada com sucesso!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Erro ao criar coluna.", Severity.Error);
            }
        }
    }

    private async Task EditColumn(ColumnVm col)
    {
        var parameters = new DialogParameters<KanbanColumnDialog>
        {
            { x => x.InitialTitle, col.Title },
            { x => x.IsEdit, true }
        };
        var options = new DialogOptions { CloseOnEscapeKey = true, CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<KanbanColumnDialog>("Editar Coluna", parameters, options);
        var result = await dialog.Result;
        
        if (result is { Canceled: false } && result.Data is string title)
        {
            var res = await Api.PutAsJsonAsync($"api/kanban/columns/{col.Id}/title", new RenameColumnRequest(title));
            if (res.IsSuccessStatusCode)
            {
                Snackbar.Add("Coluna atualizada com sucesso!", Severity.Success);
                col.Title = title;
                StateHasChanged();
            }
            else
            {
                Snackbar.Add("Erro ao atualizar coluna.", Severity.Error);
            }
        }
    }

    private async Task CreateCard(ColumnVm col)
    {
        var parameters = new DialogParameters<KanbanCardDialogV2>
        {
            { x => x.ColumnId, col.Id },
            { x => x.IsEdit, false },
            { x => x.BoardLabels, _boardLabels },
            { x => x.AssignableUsers, _assignableUsers.Select(u => new KanbanCardDialogV2.UserOption(u.Id, u.FullName, u.Photo)).ToList() }
        };
        var options = new DialogOptions { CloseOnEscapeKey = true, CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<KanbanCardDialogV2>("Novo Card", parameters, options);
        var result = await dialog.Result;
        
        if (result is { Canceled: false } && result.Data is KanbanCardDialogV2.CardDialogResult dialogResult)
        {
            var request = new CreateCardRequest(
                col.Id,
                dialogResult.Title,
                dialogResult.Description,
                dialogResult.DueDate,
                dialogResult.Priority,
                dialogResult.AssignedUserId,
                dialogResult.Color,
                dialogResult.LabelIds
            );
            
            var response = await Api.PostAsJsonAsync<CreateCardRequest, KanbanCardDto>("api/kanban/cards", request);
            if (response is not null)
            {
                await LoadDataAsync();
                _dropContainer?.Refresh();
                Snackbar.Add("Card criado com sucesso!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Erro ao criar card.", Severity.Error);
            }
        }
    }

    private async Task EditCard(KanbanCardDto card)
    {
        var parameters = new DialogParameters<KanbanCardDialogV2>
        {
            { x => x.CardId, card.Id },
            { x => x.ColumnId, card.ColumnId },
            { x => x.IsEdit, true },
            { x => x.InitialTitle, card.Title },
            { x => x.InitialDescription, card.Description },
            { x => x.InitialDueDate, card.DueDate },
            { x => x.InitialPriority, card.Priority },
            { x => x.InitialColor, card.Color },
            { x => x.InitialAssignedUserId, card.AssignedUserId },
            { x => x.InitialAssignedUserName, card.AssignedUserName },
            { x => x.InitialLabelIds, card.Labels?.Select(l => l.Id).ToList() ?? new() },
            { x => x.BoardLabels, _boardLabels },
            { x => x.AssignableUsers, _assignableUsers.Select(u => new KanbanCardDialogV2.UserOption(u.Id, u.FullName, u.Photo)).ToList() }
        };
        var options = new DialogOptions { CloseOnEscapeKey = true, CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<KanbanCardDialogV2>("Editar Card", parameters, options);
        var result = await dialog.Result;
        
        if (result is { Canceled: false } && result.Data is KanbanCardDialogV2.CardDialogResult dialogResult && _columns is not null)
        {
            if (dialogResult.Delete)
            {
                // Delete the card
                var deleteRes = await Api.DeleteAsync($"api/kanban/cards/{card.Id}");
                if (deleteRes.IsSuccessStatusCode)
                {
                    _allCards.RemoveAll(c => c.Id == card.Id);
                    foreach (var col in _columns)
                    {
                        col.Cards.RemoveAll(c => c.Id == card.Id);
                    }
                    _dropContainer?.Refresh();
                    Snackbar.Add("Card excluído com sucesso!", Severity.Success);
                }
                else
                {
                    Snackbar.Add("Erro ao excluir card.", Severity.Error);
                }
            }
            else if (dialogResult.Archive)
            {
                // Archive the card
                var archiveRes = await Api.PutAsJsonAsync($"api/kanban/cards/{card.Id}/archive", new ArchiveCardRequest(true));
                if (archiveRes.IsSuccessStatusCode)
                {
                    await LoadDataAsync();
                    _dropContainer?.Refresh();
                    Snackbar.Add("Card arquivado com sucesso!", Severity.Success);
                }
                else
                {
                    Snackbar.Add("Erro ao arquivar card.", Severity.Error);
                }
            }
            else
            {
                // Update the card
                var request = new UpdateCardRequest(
                    dialogResult.Title,
                    dialogResult.Description,
                    dialogResult.DueDate,
                    dialogResult.Priority,
                    dialogResult.AssignedUserId,
                    dialogResult.Color,
                    dialogResult.LabelIds,
                    dialogResult.CompletedAt
                );
                
                var updateRes = await Api.PutAsJsonAsync($"api/kanban/cards/{card.Id}", request);
                if (updateRes.IsSuccessStatusCode)
                {
                    await LoadDataAsync();
                    _dropContainer?.Refresh();
                    Snackbar.Add("Card atualizado com sucesso!", Severity.Success);
                }
                else
                {
                    Snackbar.Add("Erro ao atualizar card.", Severity.Error);
                }
            }
        }
    }

    private async Task RefreshData()
    {
        try
        {
            await LoadDataAsync();
            
            await InvokeAsync(() =>
            {
                if (_dropContainer is not null)
                {
                    _dropContainer.Refresh();
                }
                
                StateHasChanged();
            });
        }
        catch (Exception ex)
        {
            await InvokeAsync(() =>
            {
                Snackbar.Add($"Erro ao atualizar dados: {ex.Message}", Severity.Error);
            });
        }
    }

    private MudDropContainer<KanbanCardDto>? _dropContainer;
    private List<KanbanCardDto> _allCards = new();

    private async Task OnCardDropped(MudItemDropInfo<KanbanCardDto> info)
    {
        if (info?.Item is null || string.IsNullOrWhiteSpace(info.DropzoneIdentifier) || _columns is null)
            return;

        // Handle deletion when dropped onto the delete bar (identifier: "delete-{columnId}")
        if (info.DropzoneIdentifier.StartsWith("delete-"))
        {
            // optimistic delete in UI
            var cardId = info.Item.Id;
            _allCards.RemoveAll(c => c.Id == cardId);
            foreach (var col in _columns)
            {
                col.Cards.RemoveAll(c => c.Id == cardId);
            }
            _dropContainer?.Refresh();
            StateHasChanged();

            // Call API to delete
            try
            {
                var deleteRes = await Api.DeleteAsync($"api/kanban/cards/{cardId}");
                if (deleteRes.IsSuccessStatusCode)
                {
                    Snackbar.Add("Card excluído com sucesso!", Severity.Success);
                }
                else
                {
                    Snackbar.Add("Erro ao excluir card. Revertendo...", Severity.Warning);
                    await RefreshData();
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro ao excluir card: {ex.Message}", Severity.Error);
                await RefreshData();
            }

            return;
        }

        // Normal move handling (drop into a column)
        if (!int.TryParse(info.DropzoneIdentifier, out var toColumnId))
            return;

        var originalColumnId = info.Item.ColumnId;
        var originalPosition = info.Item.Position;

        try
        {
            // Optimistic update: move item locally so UI reflects immediately
            var idx = _allCards.FindIndex(c => c.Id == info.Item.Id);
            if (idx >= 0)
            {
                var m = _allCards[idx];
                // Create updated card preserving all properties, just changing ColumnId
                var updatedCard = m with { ColumnId = toColumnId };
                _allCards[idx] = updatedCard;
                
                // Update in columns list too
                foreach (var col in _columns)
                {
                    col.Cards.RemoveAll(c => c.Id == m.Id);
                    if (col.Id == toColumnId)
                    {
                        col.Cards.Add(updatedCard);
                    }
                }
            }
            
            if (_dropContainer is not null)
            {
                _dropContainer.Refresh();
            }
            StateHasChanged();

            // Persist on server (append at end for now)
            var toPosition = _allCards.Count(c => c.ColumnId == toColumnId && c.Id != info.Item.Id);
            var moveResult = await Api.PostAsJsonAsync("api/kanban/cards/move", new MoveCardRequest(info.Item.Id, toColumnId, toPosition));

            if (!moveResult.IsSuccessStatusCode)
            {
                // Revert on error
                Snackbar.Add("Erro ao mover card. Revertendo...", Severity.Warning);
                await RefreshData();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao mover card: {ex.Message}", Severity.Error);
            await RefreshData();
        }
    }

    private async Task ScrollLeft()
    {
        await JS.InvokeVoidAsync("eval", @"
            var container = document.querySelector('.kanban-scroll');
            if (container) container.scrollBy({ left: -350, behavior: 'smooth' });
        ");
    }

    private async Task ScrollRight()
    {
        await JS.InvokeVoidAsync("eval", @"
            var container = document.querySelector('.kanban-scroll');
            if (container) container.scrollBy({ left: 350, behavior: 'smooth' });
        ");
    }

    // Simple JS prompt bridge
    [Inject] IJSRuntime JS { get; set; } = default!;
    private async Task<string?> PromptAsync(string message, string? defaultValue = null)
        => await JS.InvokeAsync<string?>("prompt", message, defaultValue);

    private async Task OpenLabelsDialog()
    {
        var parameters = new DialogParameters<KanbanLabelsDialog>
        {
            { x => x.BoardId, _board?.Id ?? 0 }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<KanbanLabelsDialog>("Gerenciar Etiquetas", parameters, options);
        var result = await dialog.Result;
        
        // Reload labels after dialog closes
        var boardIdParam = _board?.Id > 0 ? $"?boardId={_board.Id}" : "";
        _boardLabels = await Api.GetAsync<List<KanbanLabelDto>>($"api/kanban/labels{boardIdParam}") ?? new();
        // Reload cards to update label associations
        await LoadDataAsync();
        StateHasChanged();
    }

    private async Task OpenBoardsDialog()
    {
        var parameters = new DialogParameters<KanbanBoardsDialog>
        {
            { x => x.CurrentBoardId, _board?.Id ?? 0 }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<KanbanBoardsDialog>("Meus Quadros", parameters, options);
        var result = await dialog.Result;
        
        if (result is { Canceled: false } && result.Data is int selectedBoardId)
        {
            // If a different board was selected, load that specific board
            if (selectedBoardId != _board?.Id)
            {
                // Load the selected board specifically
                _board = await Api.GetAsync<KanbanBoardDto>($"api/kanban/boards/{selectedBoardId}");
                await LoadDataAsync();
                StateHasChanged();
            }
        }
        else
        {
            // Dialog was closed, refresh board in case name changed
            if (_board?.Id > 0)
            {
                _board = await Api.GetAsync<KanbanBoardDto>($"api/kanban/boards/{_board.Id}");
            }
            else
            {
                _board = await Api.GetAsync<KanbanBoardDto>("api/kanban/board");
            }
            StateHasChanged();
        }
    }

    private async Task DeleteColumn(ColumnVm col)
    {
        // Check if column has cards
        var hasCards = _allCards.Any(c => c.ColumnId == col.Id);
        if (hasCards)
        {
            Snackbar.Add("Não é possível excluir uma coluna com cards. Mova ou exclua os cards primeiro.", Severity.Warning);
            return;
        }

        var parameters = new DialogParameters
        {
            { "ContentText", $"Tem certeza que deseja excluir a coluna \"{col.Title}\"?" },
            { "ButtonText", "Excluir" },
            { "Color", MudBlazor.Color.Error }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Confirmar Exclusão", parameters, options);
        var result = await dialog.Result;
        
        if (result is { Canceled: false })
        {
            var res = await Api.DeleteAsync($"api/kanban/columns/{col.Id}");
            if (res.IsSuccessStatusCode)
            {
                _columns?.Remove(col);
                Snackbar.Add("Coluna excluída com sucesso!", Severity.Success);
                StateHasChanged();
            }
            else
            {
                var error = await res.Content.ReadAsStringAsync();
                Snackbar.Add($"Erro ao excluir coluna: {error}", Severity.Error);
            }
        }
    }

    private async Task MoveColumnLeft(ColumnVm col)
    {
        if (col.Position <= 0 || _columns is null) return;
        
        var newPosition = col.Position - 1;
        var res = await Api.PostAsJsonAsync("api/kanban/columns/reorder", new ReorderColumnRequest(col.Id, newPosition));
        if (res.IsSuccessStatusCode)
        {
            // Update local positions
            var otherCol = _columns.FirstOrDefault(c => c.Position == newPosition);
            if (otherCol != null)
            {
                otherCol.Position = col.Position;
            }
            col.Position = newPosition;
            StateHasChanged();
        }
        else
        {
            Snackbar.Add("Erro ao mover coluna.", Severity.Error);
        }
    }

    private async Task MoveColumnRight(ColumnVm col)
    {
        if (_columns is null) return;
        var maxPosition = _columns.Max(c => c.Position);
        if (col.Position >= maxPosition) return;
        
        var newPosition = col.Position + 1;
        var res = await Api.PostAsJsonAsync("api/kanban/columns/reorder", new ReorderColumnRequest(col.Id, newPosition));
        if (res.IsSuccessStatusCode)
        {
            // Update local positions
            var otherCol = _columns.FirstOrDefault(c => c.Position == newPosition);
            if (otherCol != null)
            {
                otherCol.Position = col.Position;
            }
            col.Position = newPosition;
            StateHasChanged();
        }
        else
        {
            Snackbar.Add("Erro ao mover coluna.", Severity.Error);
        }
    }

    private record ColumnsResponse(List<ColumnVm> Columns);
    private record ColumnVm
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public int Position { get; set; }
        public List<KanbanCardDto> Cards { get; set; } = new();
    }
}

<style>
/* ============================================
   KANBAN PAGE - MODERN DESIGN
   ============================================ */

.kanban-page { 
    display: flex; 
    flex-direction: column; 
    min-height: 100vh;
    background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
}

/* Dark mode support */
:root[data-mud-theme="dark"] .kanban-page {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
}

/* ============================================
   HEADER SECTION
   ============================================ */

.kanban-header { 
    padding: 20px 24px;
    background: var(--mud-palette-surface);
    border-bottom: 1px solid rgba(0,0,0,0.08);
    position: sticky;
    top: 0;
    z-index: 10;
}

.kanban-header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 16px;
}

.kanban-title-section {
    display: flex;
    align-items: center;
    gap: 16px;
}

.kanban-icon-wrapper {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--mud-palette-primary) 0%, var(--mud-palette-primary-darken) 100%);
    border-radius: 12px;
    color: white;
    box-shadow: 0 4px 12px rgba(var(--mud-palette-primary-rgb), 0.3);
}

.kanban-main-title {
    font-weight: 700;
    letter-spacing: -0.5px;
}

.kanban-header-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}

.new-column-btn {
    border-radius: 10px !important;
    padding: 8px 20px !important;
    font-weight: 600 !important;
    box-shadow: 0 4px 14px rgba(var(--mud-palette-primary-rgb), 0.25) !important;
    transition: all 200ms ease !important;
}

.new-column-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(var(--mud-palette-primary-rgb), 0.35) !important;
}

/* ============================================
   SCROLL AREA
   ============================================ */

.kanban-scroll { 
    flex: 1; 
    overflow-x: auto; 
    overflow-y: hidden;
    padding: 24px;
    scroll-behavior: smooth;
}

.kanban-loading,
.kanban-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    min-height: 400px;
    background: var(--mud-palette-surface);
    border-radius: 16px;
    margin: 20px;
}

/* ============================================
   KANBAN BOARD
   ============================================ */

.kanban-board { 
    display: flex; 
    flex-direction: row; 
    align-items: flex-start; 
    gap: 20px; 
    padding: 4px;
    min-height: calc(100vh - 280px);
}

/* ============================================
   COLUMN STYLES - MODERN
   ============================================ */

.kanban-column-wrapper {
    flex-shrink: 0;
}

.kanban-column { 
    width: 320px;
    background: var(--mud-palette-surface);
    border-radius: 16px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border: 1px solid rgba(0,0,0,0.06);
    transition: all 250ms cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
}

.kanban-column:hover {
    box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    transform: translateY(-2px);
}

/* Column Header */
.column-header {
    padding: 16px;
    background: var(--mud-palette-surface);
}

.column-header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.column-title-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

.column-title {
    font-size: 15px;
    font-weight: 700;
    color: var(--mud-palette-text-primary);
    letter-spacing: -0.3px;
}

.column-count {
    font-size: 12px;
    font-weight: 700;
    padding: 4px 10px;
    border-radius: 20px;
    min-width: 28px;
    text-align: center;
}

/* Column Footer */
.column-footer {
    padding: 12px 16px 16px;
    background: var(--mud-palette-surface);
}

.add-card-btn {
    border-radius: 10px !important;
    font-weight: 600 !important;
    transition: all 200ms ease !important;
    opacity: 0.7;
}

.add-card-btn:hover {
    opacity: 1;
    background: rgba(var(--mud-palette-primary-rgb), 0.08) !important;
}

/* ============================================
   CARDS DROP ZONE
   ============================================ */

.kanban-cards { 
    display: flex; 
    flex-direction: column; 
    gap: 10px; 
    padding: 8px 16px;
    min-height: 120px;
    flex: 1;
    background: transparent;
}

/* Drop zone feedback */
.mud-drop-zone {
    transition: all 200ms ease;
    border-radius: 12px;
}

.kanban-cards.mud-drop-zone-drag-enter {
    background: rgba(var(--mud-palette-primary-rgb), 0.06);
    border: 2px dashed var(--mud-palette-primary);
}

/* ============================================
   CARD ITEMS
   ============================================ */

.kanban-item {
    background: var(--mud-palette-surface);
    border-radius: 12px;
    cursor: grab;
    transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid rgba(0,0,0,0.06);
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}

.kanban-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    border-color: var(--mud-palette-primary);
}

.kanban-item:active {
    cursor: grabbing;
    transform: scale(0.98);
    box-shadow: 0 2px 10px rgba(0,0,0,0.15);
}

.kanban-card-title {
    font-weight: 600;
    font-size: 14px;
    line-height: 1.5;
    word-break: break-word;
    color: var(--mud-palette-text-primary);
}

.kanban-card-desc {
    font-size: 13px;
    line-height: 1.5;
    color: var(--mud-palette-text-secondary);
    word-break: break-word;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.kanban-card-footer {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 12px;
    padding-top: 10px;
    border-top: 1px solid rgba(0,0,0,0.06);
}

/* ============================================
   DELETE ZONE
   ============================================ */

.kanban-delete-zone {
    max-height: 0;
    overflow: hidden;
    border-radius: 10px;
    background: rgba(239, 68, 68, 0.05);
    border: 2px dashed transparent;
    margin: 0 16px;
    opacity: 0;
    transform: translateY(4px);
    transition: all 220ms cubic-bezier(0.4, 0, 0.2, 1);
}

.kanban-delete-zone .delete-zone-content {
    display: flex;
    gap: 8px;
    align-items: center;
    justify-content: center;
    padding: 12px;
    color: #EF4444;
    font-weight: 600;
    font-size: 13px;
}

.kanban-dragging .kanban-delete-zone {
    max-height: 60px;
    opacity: 1;
    transform: translateY(0);
    border-color: rgba(239, 68, 68, 0.3);
    margin-bottom: 8px;
}

.kanban-delete-zone.mud-drop-zone-drag-enter {
    background: rgba(239, 68, 68, 0.1);
    border-color: #EF4444;
    transform: scale(1.02);
}

/* ============================================
   ANIMATIONS
   ============================================ */

@@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-8px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.kanban-item {
    animation: slideIn 200ms ease-out;
}

/* ============================================
   SCROLLBAR
   ============================================ */

.kanban-scroll::-webkit-scrollbar {
    height: 10px;
}

.kanban-scroll::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.03);
    border-radius: 10px;
}

.kanban-scroll::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,0.15);
    border-radius: 10px;
    border: 2px solid transparent;
    background-clip: padding-box;
}

.kanban-scroll::-webkit-scrollbar-thumb:hover {
    background: rgba(0,0,0,0.25);
    background-clip: padding-box;
}

/* ============================================
   RESPONSIVE
   ============================================ */

@@media (max-width: 768px) {
    .kanban-header-content {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .kanban-header-actions {
        width: 100%;
        justify-content: flex-end;
    }
    
    .kanban-board {
        flex-direction: column;
        align-items: stretch;
        padding: 0;
    }
    
    .kanban-column-wrapper {
        width: 100%;
    }
    
    .kanban-column {
        width: 100%;
    }
    
    .kanban-scroll {
        padding: 16px;
    }
}
</style>

<script>
(function(){
    if (window.__kanbanDragInit) return;
    window.__kanbanDragInit = true;

    function onStart(e) {
        var el = e.target;
        while (el && !el.classList?.contains('kanban-item')) el = el.parentElement;
        if (el) document.body.classList.add('kanban-dragging');
    }

    function onEnd(e) { document.body.classList.remove('kanban-dragging'); }

    document.addEventListener('dragstart', onStart);
    document.addEventListener('dragend', onEnd);
    document.addEventListener('drop', onEnd);

    // Mouse fallback: show during press on an item until mouseup
    document.addEventListener('mousedown', function(e){
        var el = e.target;
        while (el && !el.classList?.contains('kanban-item')) el = el.parentElement;
        if (el) document.body.classList.add('kanban-dragging');
    });
    document.addEventListener('mouseup', onEnd);

    // Check if kanban-scroll has horizontal overflow and add visual hint class
    function checkScrollable() {
        var scrollContainer = document.querySelector('.kanban-scroll');
        if (!scrollContainer) return;
        
        var hasHorizontalScroll = scrollContainer.scrollWidth > scrollContainer.clientWidth;
        if (hasHorizontalScroll) {
            scrollContainer.classList.add('has-scroll');
        } else {
            scrollContainer.classList.remove('has-scroll');
        }
    }

    // Check on load and when window resizes
    window.addEventListener('load', checkScrollable);
    window.addEventListener('resize', checkScrollable);
    
    // Re-check periodically (for dynamic content changes via Blazor)
    setInterval(checkScrollable, 1000);
})();
</script>
