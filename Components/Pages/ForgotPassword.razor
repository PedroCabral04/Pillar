@page "/forgot-password"
@using erp.DTOs.Auth
@using erp.Services
@using MudBlazor
@inject IApiService ApiService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Recuperar Senha - Pillar ERP</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
    <MudPaper Elevation="3" Class="pa-8">
        <MudStack Spacing="4">
            <div style="text-align: center;">
                <MudIcon Icon="@Icons.Material.Filled.Lock" Size="MudBlazor.Size.Large" Color="MudBlazor.Color.Primary" />
                <MudText Typo="Typo.h4" Class="mt-4">Recuperar Senha</MudText>
                <MudText Typo="Typo.body2" Color="MudBlazor.Color.Secondary">
                    Digite seu email para receber instruções de recuperação de senha
                </MudText>
            </div>

            @if (!_emailSent)
            {
                <EditForm Model="@_model" OnValidSubmit="HandleSubmit">
                    <DataAnnotationsValidator />
                    
                    <MudStack Spacing="3">
                        <MudTextField @bind-Value="_model.Email"
                                      Label="Email"
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Email"
                                      For="@(() => _model.Email)"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Email" />

                        <MudButton Variant="Variant.Filled"
                                   Color="MudBlazor.Color.Primary"
                                   FullWidth="true"
                                   ButtonType="ButtonType.Submit"
                                   Disabled="@_isLoading"
                                   StartIcon="@Icons.Material.Filled.Send">
                            @if (_isLoading)
                            {
                                <MudProgressCircular Size="MudBlazor.Size.Small" Indeterminate="true" />
                                <span class="ml-2">Enviando...</span>
                            }
                            else
                            {
                                <span>Enviar Instruções</span>
                            }
                        </MudButton>

                        <MudDivider />

                        <MudButton Variant="Variant.Text"
                                   Color="MudBlazor.Color.Default"
                                   FullWidth="true"
                                   Href="/login"
                                   StartIcon="@Icons.Material.Filled.ArrowBack">
                            Voltar para Login
                        </MudButton>
                    </MudStack>
                </EditForm>
            }
            else
            {
                <MudAlert Severity="Severity.Success" Icon="@Icons.Material.Filled.CheckCircle">
                    <MudText Typo="Typo.body1" Class="mb-2">
                        <strong>Email enviado com sucesso!</strong>
                    </MudText>
                    <MudText Typo="Typo.body2">
                        Se o email informado estiver cadastrado no sistema, você receberá instruções para redefinir sua senha.
                        Verifique sua caixa de entrada e spam.
                    </MudText>
                </MudAlert>

                <MudButton Variant="Variant.Filled"
                           Color="MudBlazor.Color.Primary"
                           FullWidth="true"
                           Href="/login"
                           StartIcon="@Icons.Material.Filled.Login">
                    Ir para Login
                </MudButton>
            }
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    private PasswordResetRequest _model = new();
    private bool _isLoading = false;
    private bool _emailSent = false;

    private async Task HandleSubmit()
    {
        _isLoading = true;
        try
        {
            var response = await ApiService.PostAsync<object>(
                "/api/auth/password-reset/request",
                _model);

            if (response != null)
            {
                _emailSent = true;
                Snackbar.Add("Instruções enviadas para o email informado", Severity.Success);
            }
            else
            {
                Snackbar.Add("Erro ao processar solicitação. Tente novamente.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }
}
