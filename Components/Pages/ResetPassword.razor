@page "/reset-password"
@attribute [AllowAnonymous]
@using erp.DTOs.Auth
@using erp.Services
@using erp.Services.Tenancy
@using erp.Components.Branding
@using MudBlazor
@using Microsoft.AspNetCore.WebUtilities
@inject IApiService ApiService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject ITenantBrandingProvider BrandingProvider

<PageTitle>Redefinir Senha • @_branding.TenantName</PageTitle>

<MudGrid Spacing="0" Style="height: 100vh; overflow: hidden;">
    <!-- Left Side: Branding / Image -->
    <MudItem xs="12" md="6" lg="7" Class="d-none d-md-flex flex-column justify-center align-center relative" 
             Style="@($"background-color: {_branding.PrimaryColor}; color: white; position: relative;")">
        
        @if (!string.IsNullOrEmpty(_branding.LoginBackgroundUrl))
        {
             <div style="@($"position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('{_branding.LoginBackgroundUrl}'); background-size: cover; background-position: center; opacity: 0.4; mix-blend-mode: overlay;")"></div>
        }
        else
        {
             <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);"></div>
        }
        
        <div class="d-flex flex-column align-center gap-4 pa-8 text-center" style="z-index: 2; max-width: 600px;">
             @if (!string.IsNullOrEmpty(_branding.LogoUrl))
             {
                 <MudImage Src="@_branding.LogoUrl" Alt="@_branding.TenantName" Width="150" Class="mb-6" ObjectFit="ObjectFit.Contain" />
             }
             else
             {
                 <MudAvatar Size="MudBlazor.Size.Large" Color="MudBlazor.Color.Surface" Variant="Variant.Filled" Class="mb-6" Style="width: 80px; height: 80px;">
                     <MudText Typo="Typo.h3" Color="MudBlazor.Color.Primary" Style="font-weight: 700;">@_branding.Initials</MudText>
                 </MudAvatar>
             }
             
             <MudText Typo="Typo.h2" Style="font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">@_branding.TenantName</MudText>
             <MudText Typo="Typo.h5" Style="opacity: 0.9; font-weight: 300;">Defina sua nova senha de acesso.</MudText>
        </div>
    </MudItem>

    <!-- Right Side: Reset Password Form -->
    <MudItem xs="12" md="6" lg="5" Class="d-flex justify-center align-center pa-4" Style="background-color: var(--mud-palette-background);">
        <MudPaper Elevation="0" Class="pa-8 w-100" Style="max-width: 480px; background: transparent;">
            
            <!-- Mobile Branding Header -->
            <div class="d-md-none d-flex flex-column align-center mb-8">
                 <MudAvatar Size="MudBlazor.Size.Large" Color="MudBlazor.Color.Primary" Class="mb-2">@_branding.Initials</MudAvatar>
                 <MudText Typo="Typo.h5" Color="MudBlazor.Color.Primary" Style="font-weight: 600;">@_branding.TenantName</MudText>
            </div>

            <div class="mb-10">
                <MudText Typo="Typo.h4" Style="font-weight: 700;" Class="mb-2">Redefinir Senha</MudText>
                <MudText Typo="Typo.body1" Color="MudBlazor.Color.Secondary">
                    Digite sua nova senha abaixo.
                </MudText>
            </div>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mb-6" Variant="Variant.Filled">@_errorMessage</MudAlert>
            }

            @if (!_passwordReset)
            {
                <EditForm Model="@_model" OnValidSubmit="HandleSubmit">
                    <DataAnnotationsValidator />
                    
                    <MudTextField @bind-Value="_model.Email"
                                  Label="Email"
                                  Variant="Variant.Outlined"
                                  InputType="InputType.Email"
                                  For="@(() => _model.Email)"
                                  ReadOnly="@(!string.IsNullOrEmpty(Email))"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Email"
                                  Class="mb-4" />

                    <MudTextField @bind-Value="_model.Token"
                                  Label="Código de Recuperação"
                                  Variant="Variant.Outlined"
                                  For="@(() => _model.Token)"
                                  ReadOnly="@(!string.IsNullOrEmpty(Token))"
                                  HelperText="Código recebido por email"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Code"
                                  Class="mb-4" />

                    <MudTextField @bind-Value="_model.NewPassword"
                                  Label="Nova Senha"
                                  Variant="Variant.Outlined"
                                  InputType="@_passwordInput"
                                  For="@(() => _model.NewPassword)"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@_passwordIcon"
                                  OnAdornmentClick="TogglePasswordVisibility"
                                  Class="mb-4" />

                    <MudTextField @bind-Value="_model.ConfirmPassword"
                                  Label="Confirmar Nova Senha"
                                  Variant="Variant.Outlined"
                                  InputType="@_confirmPasswordInput"
                                  For="@(() => _model.ConfirmPassword)"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@_confirmPasswordIcon"
                                  OnAdornmentClick="ToggleConfirmPasswordVisibility"
                                  Class="mb-2" />

                    <MudText Typo="Typo.caption" Color="MudBlazor.Color.Secondary" Class="mb-6 d-block">
                        A senha deve ter no mínimo 8 caracteres, incluindo letra maiúscula, minúscula, número e caractere especial.
                    </MudText>

                    <MudButton Variant="Variant.Filled"
                               Color="MudBlazor.Color.Primary"
                               FullWidth="true"
                               Size="MudBlazor.Size.Large"
                               ButtonType="ButtonType.Submit"
                               Disabled="@_isLoading"
                               Class="mb-4 py-3"
                               Style="font-weight: 600; border-radius: 8px;">
                        @if (_isLoading)
                        {
                            <MudProgressCircular Size="MudBlazor.Size.Small" Indeterminate="true" Class="mr-2" />
                            <text>Redefinindo...</text>
                        }
                        else
                        {
                            <text>Redefinir Senha</text>
                        }
                    </MudButton>

                    <div class="text-center mt-4">
                        <MudLink Href="/login" Color="MudBlazor.Color.Secondary" Underline="Underline.Hover" StartIcon="@Icons.Material.Filled.ArrowBack">
                            Voltar para Login
                        </MudLink>
                    </div>
                </EditForm>
            }
            else
            {
                <MudAlert Severity="Severity.Success" Icon="@Icons.Material.Filled.CheckCircle" Variant="Variant.Filled" Class="mb-6">
                    <MudText Typo="Typo.subtitle1" Class="mb-2" Style="font-weight: 600;">Senha redefinida com sucesso!</MudText>
                    <MudText Typo="Typo.body2">
                        Você já pode fazer login com sua nova senha.
                    </MudText>
                </MudAlert>

                <MudButton Variant="Variant.Outlined"
                           Color="MudBlazor.Color.Primary"
                           FullWidth="true"
                           Size="MudBlazor.Size.Large"
                           Href="/login"
                           Class="py-3"
                           Style="font-weight: 600; border-radius: 8px;">
                    Ir para Login
                </MudButton>
            }
            
            <div class="mt-12 text-center">
                <MudText Typo="Typo.caption" Color="MudBlazor.Color.Secondary">
                    &copy; @DateTime.Now.Year @_branding.TenantName. Todos os direitos reservados.
                </MudText>
            </div>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    [SupplyParameterFromQuery]
    public string? Token { get; set; }

    [SupplyParameterFromQuery]
    public string? Email { get; set; }

    private PasswordResetConfirmRequest _model = new();
    private bool _isLoading = false;
    private bool _passwordReset = false;
    private string? _errorMessage;
    private TenantBrandingTheme _branding = TenantBrandingTheme.Default;

    // Password visibility toggles
    private bool _showPassword = false;
    private bool _showConfirmPassword = false;
    private InputType _passwordInput = InputType.Password;
    private InputType _confirmPasswordInput = InputType.Password;
    private string _passwordIcon = Icons.Material.Filled.VisibilityOff;
    private string _confirmPasswordIcon = Icons.Material.Filled.VisibilityOff;

    protected override void OnInitialized()
    {
        _branding = BrandingProvider.GetCurrentBranding();
        
        if (!string.IsNullOrEmpty(Email))
        {
            _model.Email = Email;
        }

        if (!string.IsNullOrEmpty(Token))
        {
            _model.Token = Token;
        }
    }

    private async Task HandleSubmit()
    {
        _isLoading = true;
        _errorMessage = null;
        
        try
        {
            var response = await ApiService.PostAsync<object>(
                "/api/autenticacao/password-reset/confirm",
                _model);

            if (response != null)
            {
                _passwordReset = true;
                Snackbar.Add("Senha redefinida com sucesso!", Severity.Success);
            }
            else
            {
                _errorMessage = "Erro ao redefinir senha. Verifique se o código está correto.";
                Snackbar.Add(_errorMessage, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Erro: {ex.Message}";
            Snackbar.Add(_errorMessage, Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void TogglePasswordVisibility()
    {
        _showPassword = !_showPassword;
        _passwordInput = _showPassword ? InputType.Text : InputType.Password;
        _passwordIcon = _showPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
    }

    private void ToggleConfirmPasswordVisibility()
    {
        _showConfirmPassword = !_showConfirmPassword;
        _confirmPasswordInput = _showConfirmPassword ? InputType.Text : InputType.Password;
        _confirmPasswordIcon = _showConfirmPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
    }
}
