@page "/reset-password"
@using erp.DTOs.Auth
@using erp.Services
@using MudBlazor
@using Microsoft.AspNetCore.WebUtilities
@inject IApiService ApiService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Redefinir Senha - Pillar ERP</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
    <MudPaper Elevation="3" Class="pa-8">
        <MudStack Spacing="4">
            <div style="text-align: center;">
                <MudIcon Icon="@Icons.Material.Filled.VpnKey" Size="MudBlazor.Size.Large" Color="MudBlazor.Color.Primary" />
                <MudText Typo="Typo.h4" Class="mt-4">Redefinir Senha</MudText>
                <MudText Typo="Typo.body2" Color="MudBlazor.Color.Secondary">
                    Digite sua nova senha
                </MudText>
            </div>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
            }

            @if (!_passwordReset)
            {
                <EditForm Model="@_model" OnValidSubmit="HandleSubmit">
                    <DataAnnotationsValidator />
                    
                    <MudStack Spacing="3">
                        <MudTextField @bind-Value="_model.Email"
                                      Label="Email"
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Email"
                                      For="@(() => _model.Email)"
                                      ReadOnly="@(!string.IsNullOrEmpty(_emailFromQuery))"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Email" />

                        <MudTextField @bind-Value="_model.Token"
                                      Label="Código de Recuperação"
                                      Variant="Variant.Outlined"
                                      For="@(() => _model.Token)"
                                      ReadOnly="@(!string.IsNullOrEmpty(_tokenFromQuery))"
                                      HelperText="Código recebido por email"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Code" />

                        <MudTextField @bind-Value="_model.NewPassword"
                                      Label="Nova Senha"
                                      Variant="Variant.Outlined"
                                      InputType="@_passwordInput"
                                      For="@(() => _model.NewPassword)"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@_passwordIcon"
                                      OnAdornmentClick="TogglePasswordVisibility" />

                        <MudTextField @bind-Value="_model.ConfirmPassword"
                                      Label="Confirmar Nova Senha"
                                      Variant="Variant.Outlined"
                                      InputType="@_confirmPasswordInput"
                                      For="@(() => _model.ConfirmPassword)"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@_confirmPasswordIcon"
                                      OnAdornmentClick="ToggleConfirmPasswordVisibility" />

                        <MudText Typo="Typo.caption" Color="MudBlazor.Color.Secondary">
                            A senha deve ter no mínimo 8 caracteres, incluindo letra maiúscula, minúscula, número e caractere especial.
                        </MudText>

                        <MudButton Variant="Variant.Filled"
                                   Color="MudBlazor.Color.Primary"
                                   FullWidth="true"
                                   ButtonType="ButtonType.Submit"
                                   Disabled="@_isLoading"
                                   StartIcon="@Icons.Material.Filled.Check">
                            @if (_isLoading)
                            {
                                <MudProgressCircular Size="MudBlazor.Size.Small" Indeterminate="true" />
                                <span class="ml-2">Redefinindo...</span>
                            }
                            else
                            {
                                <span>Redefinir Senha</span>
                            }
                        </MudButton>

                        <MudDivider />

                        <MudButton Variant="Variant.Text"
                                   Color="MudBlazor.Color.Default"
                                   FullWidth="true"
                                   Href="/login"
                                   StartIcon="@Icons.Material.Filled.ArrowBack">
                            Voltar para Login
                        </MudButton>
                    </MudStack>
                </EditForm>
            }
            else
            {
                <MudAlert Severity="Severity.Success" Icon="@Icons.Material.Filled.CheckCircle">
                    <MudText Typo="Typo.body1" Class="mb-2">
                        <strong>Senha redefinida com sucesso!</strong>
                    </MudText>
                    <MudText Typo="Typo.body2">
                        Você já pode fazer login com sua nova senha.
                    </MudText>
                </MudAlert>

                <MudButton Variant="Variant.Filled"
                           Color="MudBlazor.Color.Primary"
                           FullWidth="true"
                           Href="/login"
                           StartIcon="@Icons.Material.Filled.Login">
                    Ir para Login
                </MudButton>
            }
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    private PasswordResetConfirmRequest _model = new();
    private bool _isLoading = false;
    private bool _passwordReset = false;
    private string? _errorMessage;
    private string? _emailFromQuery;
    private string? _tokenFromQuery;

    // Password visibility toggles
    private bool _showPassword = false;
    private bool _showConfirmPassword = false;
    private InputType _passwordInput = InputType.Password;
    private InputType _confirmPasswordInput = InputType.Password;
    private string _passwordIcon = Icons.Material.Filled.VisibilityOff;
    private string _confirmPasswordIcon = Icons.Material.Filled.VisibilityOff;

    protected override void OnInitialized()
    {
        var uri = new Uri(Navigation.Uri);
        var queryParams = QueryHelpers.ParseQuery(uri.Query);

        if (queryParams.TryGetValue("email", out var email))
        {
            _emailFromQuery = email.ToString();
            _model.Email = _emailFromQuery;
        }

        if (queryParams.TryGetValue("token", out var token))
        {
            _tokenFromQuery = token.ToString();
            _model.Token = _tokenFromQuery;
        }
    }

    private async Task HandleSubmit()
    {
        _isLoading = true;
        _errorMessage = null;
        
        try
        {
            var response = await ApiService.PostAsync<object>(
                "/api/auth/password-reset/confirm",
                _model);

            if (response != null)
            {
                _passwordReset = true;
                Snackbar.Add("Senha redefinida com sucesso!", Severity.Success);
            }
            else
            {
                _errorMessage = "Erro ao redefinir senha. Verifique se o código está correto.";
                Snackbar.Add(_errorMessage, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Erro: {ex.Message}";
            Snackbar.Add(_errorMessage, Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void TogglePasswordVisibility()
    {
        _showPassword = !_showPassword;
        _passwordInput = _showPassword ? InputType.Text : InputType.Password;
        _passwordIcon = _showPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
    }

    private void ToggleConfirmPasswordVisibility()
    {
        _showConfirmPassword = !_showConfirmPassword;
        _confirmPasswordInput = _showConfirmPassword ? InputType.Text : InputType.Password;
        _confirmPasswordIcon = _showConfirmPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
    }
}
