@page "/sales/{Id:int}"
@using erp.DTOs.Sales
@using erp.Services
@using erp.Components.Shared.Dialogs
@using MudBlazor
@using Size = MudBlazor.Size
@using Color = MudBlazor.Color
@using System.Text
@attribute [Authorize]

@inject IApiService ApiService
@inject ILogger<SaleDetails> Logger
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject CurrencyFormatService Currency

<PageTitle>Detalhes da Venda</PageTitle>

@if (_loading)
{
    <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Style="min-height: 400px;">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large"/>
        <MudText Typo="Typo.body1" Color="Color.Secondary">Carregando venda...</MudText>
    </MudStack>
}
else if (_error != null)
{
    <MudAlert Severity="Severity.Error" Class="mb-4">@_error</MudAlert>
    <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.ArrowBack" Href="/sales">
        Voltar para Vendas
    </MudButton>
}
else if (_sale != null)
{
    <!-- Header with actions -->
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Href="/sales" Title="Voltar"/>
            <MudText Typo="Typo.h4">Venda @_sale.SaleNumber</MudText>
            <MudChip T="string" Size="Size.Medium" Color="@GetStatusColor(_sale.Status)">@_sale.Status</MudChip>
        </MudStack>
        <MudStack Row="true" Spacing="2">
            <MudButton Variant="Variant.Outlined" 
                       StartIcon="@Icons.Material.Filled.Print"
                       OnClick="PrintSale"
                       Title="Imprimir">
                Imprimir
            </MudButton>
            <MudButton Variant="Variant.Outlined" 
                       Color="Color.Error"
                       StartIcon="@Icons.Material.Filled.PictureAsPdf"
                       OnClick="ExportPdf"
                       Title="Exportar PDF">
                Exportar PDF
            </MudButton>
            @if (_sale.Status == "Pendente")
            {
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Success"
                           StartIcon="@Icons.Material.Filled.CheckCircle"
                           OnClick="FinalizeSale">
                    Finalizar
                </MudButton>
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Error"
                           StartIcon="@Icons.Material.Filled.Cancel"
                           OnClick="CancelSale">
                    Cancelar
                </MudButton>
            }
        </MudStack>
    </MudStack>

    <!-- Sale Information Cards -->
    <MudGrid Spacing="3" Class="mb-4">
        <!-- General Info -->
        <MudItem xs="12" md="6">
            <MudCard Elevation="2">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2"/>
                            Informações Gerais
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack Spacing="2">
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Número da Venda</MudText>
                            <MudText Typo="Typo.body1" Style="font-family: monospace; font-weight: 600;">@_sale.SaleNumber</MudText>
                        </MudStack>
                        <MudDivider/>
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Data da Venda</MudText>
                            <MudText Typo="Typo.body1">@_sale.SaleDate.ToString("dd/MM/yyyy HH:mm")</MudText>
                        </MudStack>
                        <MudDivider/>
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Data de Criação</MudText>
                            <MudText Typo="Typo.body1">@_sale.CreatedAt.ToString("dd/MM/yyyy HH:mm")</MudText>
                        </MudStack>
                        <MudDivider/>
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Método de Pagamento</MudText>
                            <MudText Typo="Typo.body1">@(_sale.PaymentMethod ?? "Não informado")</MudText>
                        </MudStack>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Customer & Seller Info -->
        <MudItem xs="12" md="6">
            <MudCard Elevation="2">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.People" Class="mr-2"/>
                            Cliente e Vendedor
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack Spacing="2">
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Cliente</MudText>
                            <MudText Typo="Typo.body1">@(_sale.CustomerName ?? "Cliente não informado")</MudText>
                        </MudStack>
                        <MudDivider/>
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Vendedor</MudText>
                            <MudText Typo="Typo.body1">@_sale.UserName</MudText>
                        </MudStack>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <!-- Items Table -->
    <MudCard Elevation="2" Class="mb-4">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">
                    <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Class="mr-2"/>
                    Itens da Venda (@_sale.Items.Count itens)
                </MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent Class="pa-0">
            <MudTable Items="@_sale.Items" Dense="true" Hover="true" Striped="true" Elevation="0">
                <HeaderContent>
                    <MudTh>SKU</MudTh>
                    <MudTh>Produto</MudTh>
                    <MudTh Style="text-align: right">Quantidade</MudTh>
                    <MudTh Style="text-align: right">Preço Unit.</MudTh>
                    <MudTh Style="text-align: right">Desconto</MudTh>
                    <MudTh Style="text-align: right">Subtotal</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="SKU">
                        <MudText Typo="Typo.body2" Style="font-family: monospace">@context.ProductSku</MudText>
                    </MudTd>
                    <MudTd DataLabel="Produto">@context.ProductName</MudTd>
                    <MudTd DataLabel="Quantidade" Style="text-align: right">@context.Quantity.ToString("N2")</MudTd>
                    <MudTd DataLabel="Preço Unit." Style="text-align: right">@Currency.Format(context.UnitPrice)</MudTd>
                    <MudTd DataLabel="Desconto" Style="text-align: right">@Currency.Format(context.Discount)</MudTd>
                    <MudTd DataLabel="Subtotal" Style="text-align: right">
                        <MudText Typo="Typo.body2" Style="font-weight: 600">@Currency.Format(context.Total)</MudText>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudCardContent>
    </MudCard>

    <!-- Totals -->
    <MudGrid Spacing="3" Class="mb-4">
        <MudItem xs="12" md="6">
            @if (!string.IsNullOrWhiteSpace(_sale.Notes))
            {
                <MudCard Elevation="2">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">
                                <MudIcon Icon="@Icons.Material.Filled.Notes" Class="mr-2"/>
                                Observações
                            </MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudText Typo="Typo.body1" Style="white-space: pre-wrap;">@_sale.Notes</MudText>
                    </MudCardContent>
                </MudCard>
            }
        </MudItem>
        <MudItem xs="12" md="6">
            <MudCard Elevation="3" Style="background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);">
                <MudCardContent>
                    <MudStack Spacing="2" Style="color: white;">
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.body1">Subtotal dos Itens</MudText>
                            <MudText Typo="Typo.body1">@Currency.Format(_sale.TotalAmount)</MudText>
                        </MudStack>
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.body1">Desconto Geral</MudText>
                            <MudText Typo="Typo.body1">- @Currency.Format(_sale.DiscountAmount)</MudText>
                        </MudStack>
                        <MudDivider Light="true"/>
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.h5" Style="font-weight: bold;">TOTAL</MudText>
                            <MudText Typo="Typo.h5" Style="font-weight: bold;">@Currency.Format(_sale.NetAmount)</MudText>
                        </MudStack>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private SaleDto? _sale;
    private bool _loading = true;
    private string? _error;

    protected override async Task OnInitializedAsync()
    {
        await LoadSale();
    }

    private async Task LoadSale()
    {
        _loading = true;
        _error = null;
        try
        {
            _sale = await ApiService.GetAsync<SaleDto>($"/api/sales/{Id}");
            if (_sale == null)
            {
                _error = "Venda não encontrada";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erro ao carregar venda {SaleId}", Id);
            _error = $"Erro ao carregar venda: {ex.Message}";
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task PrintSale()
    {
        if (_sale == null) return;

        var printHtml = BuildPrintHtml(_sale);
        await JSRuntime.InvokeVoidAsync("printHtml", printHtml);
    }

    private static string BuildPrintHtml(SaleDto sale)
    {
        var sb = new StringBuilder();
        
        var statusColor = sale.Status switch
        {
            "Pendente" => "#ff9800",
            "Finalizada" => "#4caf50",
            "Cancelada" => "#f44336",
            _ => "#9e9e9e"
        };

        sb.AppendLine("<!DOCTYPE html>");
        sb.AppendLine("<html>");
        sb.AppendLine("<head>");
        sb.AppendLine("    <meta charset='UTF-8'>");
        sb.AppendLine($"    <title>Venda {sale.SaleNumber}</title>");
        sb.AppendLine("    <style>");
        sb.AppendLine("        * { margin: 0; padding: 0; box-sizing: border-box; }");
        sb.AppendLine("        body { font-family: 'Segoe UI', Arial, sans-serif; padding: 20px; color: #333; max-width: 800px; margin: 0 auto; }");
        sb.AppendLine("        .header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #1976d2; padding-bottom: 20px; margin-bottom: 20px; }");
        sb.AppendLine("        .logo { display: flex; align-items: center; gap: 10px; }");
        sb.AppendLine("        .logo img { height: 50px; }");
        sb.AppendLine("        .logo h1 { color: #1976d2; font-size: 28px; font-weight: bold; }");
        sb.AppendLine("        .sale-info { text-align: right; }");
        sb.AppendLine("        .sale-number { font-size: 24px; font-weight: bold; font-family: monospace; color: #1976d2; }");
        sb.AppendLine($"        .status {{ display: inline-block; padding: 4px 12px; border-radius: 16px; color: white; font-weight: 600; font-size: 12px; background-color: {statusColor}; margin-top: 5px; }}");
        sb.AppendLine("        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }");
        sb.AppendLine("        .info-section { background: #f5f5f5; padding: 15px; border-radius: 8px; }");
        sb.AppendLine("        .info-section h3 { color: #1976d2; font-size: 14px; margin-bottom: 10px; text-transform: uppercase; }");
        sb.AppendLine("        .info-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #e0e0e0; }");
        sb.AppendLine("        .info-row:last-child { border-bottom: none; }");
        sb.AppendLine("        .info-label { color: #666; font-size: 13px; }");
        sb.AppendLine("        .info-value { font-weight: 500; }");
        sb.AppendLine("        .items-section { margin-bottom: 25px; }");
        sb.AppendLine("        .items-section h3 { color: #1976d2; font-size: 16px; margin-bottom: 10px; }");
        sb.AppendLine("        table { width: 100%; border-collapse: collapse; }");
        sb.AppendLine("        th { background: #1976d2; color: white; padding: 10px 8px; text-align: left; font-size: 12px; text-transform: uppercase; }");
        sb.AppendLine("        th:nth-child(3), th:nth-child(4), th:nth-child(5), th:nth-child(6) { text-align: right; }");
        sb.AppendLine("        td { padding: 8px; border-bottom: 1px solid #ddd; }");
        sb.AppendLine("        td:nth-child(3), td:nth-child(4), td:nth-child(5), td:nth-child(6) { text-align: right; }");
        sb.AppendLine("        .totals { display: flex; justify-content: flex-end; }");
        sb.AppendLine("        .totals-box { background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color: white; padding: 20px; border-radius: 8px; min-width: 280px; }");
        sb.AppendLine("        .total-row { display: flex; justify-content: space-between; padding: 5px 0; }");
        sb.AppendLine("        .total-row.final { border-top: 2px solid rgba(255,255,255,0.3); margin-top: 10px; padding-top: 10px; font-size: 18px; font-weight: bold; }");
        sb.AppendLine("        .notes { background: #fff3e0; padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800; margin-bottom: 25px; }");
        sb.AppendLine("        .notes h3 { color: #f57c00; font-size: 14px; margin-bottom: 8px; }");
        sb.AppendLine("        .footer { margin-top: 30px; text-align: center; color: #999; font-size: 11px; border-top: 1px solid #ddd; padding-top: 15px; }");
        sb.AppendLine("        @media print { body { padding: 0; } .no-print { display: none; } }");
        sb.AppendLine("    </style>");
        sb.AppendLine("</head>");
        sb.AppendLine("<body>");
        
        // Header
        sb.AppendLine("    <div class='header'>");
        sb.AppendLine("        <div class='logo'>");
        sb.AppendLine("            <img src='/images/logo.png' alt='Pillar ERP' onerror=\"this.style.display='none'\"/>");
        sb.AppendLine("            <h1>Pillar ERP</h1>");
        sb.AppendLine("        </div>");
        sb.AppendLine("        <div class='sale-info'>");
        sb.AppendLine($"            <div class='sale-number'>{sale.SaleNumber}</div>");
        sb.AppendLine($"            <div class='status'>{sale.Status}</div>");
        sb.AppendLine("        </div>");
        sb.AppendLine("    </div>");
        
        // Info Grid
        sb.AppendLine("    <div class='info-grid'>");
        sb.AppendLine("        <div class='info-section'>");
        sb.AppendLine("            <h3>Informações da Venda</h3>");
        sb.AppendLine("            <div class='info-row'>");
        sb.AppendLine("                <span class='info-label'>Data da Venda</span>");
        sb.AppendLine($"                <span class='info-value'>{sale.SaleDate:dd/MM/yyyy HH:mm}</span>");
        sb.AppendLine("            </div>");
        sb.AppendLine("            <div class='info-row'>");
        sb.AppendLine("                <span class='info-label'>Método de Pagamento</span>");
        sb.AppendLine($"                <span class='info-value'>{sale.PaymentMethod ?? "Não informado"}</span>");
        sb.AppendLine("            </div>");
        sb.AppendLine("        </div>");
        sb.AppendLine("        <div class='info-section'>");
        sb.AppendLine("            <h3>Cliente e Vendedor</h3>");
        sb.AppendLine("            <div class='info-row'>");
        sb.AppendLine("                <span class='info-label'>Cliente</span>");
        sb.AppendLine($"                <span class='info-value'>{sale.CustomerName ?? "Não informado"}</span>");
        sb.AppendLine("            </div>");
        sb.AppendLine("            <div class='info-row'>");
        sb.AppendLine("                <span class='info-label'>Vendedor</span>");
        sb.AppendLine($"                <span class='info-value'>{sale.UserName}</span>");
        sb.AppendLine("            </div>");
        sb.AppendLine("        </div>");
        sb.AppendLine("    </div>");
        
        // Items Table
        sb.AppendLine("    <div class='items-section'>");
        sb.AppendLine($"        <h3>Itens da Venda ({sale.Items.Count} itens)</h3>");
        sb.AppendLine("        <table>");
        sb.AppendLine("            <thead>");
        sb.AppendLine("                <tr>");
        sb.AppendLine("                    <th>SKU</th>");
        sb.AppendLine("                    <th>Produto</th>");
        sb.AppendLine("                    <th>Qtd</th>");
        sb.AppendLine("                    <th>Preço Unit.</th>");
        sb.AppendLine("                    <th>Desconto</th>");
        sb.AppendLine("                    <th>Subtotal</th>");
        sb.AppendLine("                </tr>");
        sb.AppendLine("            </thead>");
        sb.AppendLine("            <tbody>");
        
        foreach (var item in sale.Items)
        {
            sb.AppendLine("                <tr>");
            sb.AppendLine($"                    <td style='font-family: monospace;'>{item.ProductSku}</td>");
            sb.AppendLine($"                    <td>{item.ProductName}</td>");
            sb.AppendLine($"                    <td>{item.Quantity:N2}</td>");
            sb.AppendLine($"                    <td>{CurrencyFormatService.FormatStatic(item.UnitPrice)}</td>");
            sb.AppendLine($"                    <td>{CurrencyFormatService.FormatStatic(item.Discount)}</td>");
            sb.AppendLine($"                    <td style='font-weight: 600;'>{CurrencyFormatService.FormatStatic(item.Total)}</td>");
            sb.AppendLine("                </tr>");
        }
        
        sb.AppendLine("            </tbody>");
        sb.AppendLine("        </table>");
        sb.AppendLine("    </div>");
        
        // Notes
        if (!string.IsNullOrWhiteSpace(sale.Notes))
        {
            sb.AppendLine("    <div class='notes'>");
            sb.AppendLine("        <h3>Observações</h3>");
            sb.AppendLine($"        <p>{sale.Notes}</p>");
            sb.AppendLine("    </div>");
        }
        
        // Totals
        sb.AppendLine("    <div class='totals'>");
        sb.AppendLine("        <div class='totals-box'>");
        sb.AppendLine("            <div class='total-row'>");
        sb.AppendLine("                <span>Subtotal dos Itens</span>");
        sb.AppendLine($"                <span>{CurrencyFormatService.FormatStatic(sale.TotalAmount)}</span>");
        sb.AppendLine("            </div>");
        sb.AppendLine("            <div class='total-row'>");
        sb.AppendLine("                <span>Desconto Geral</span>");
        sb.AppendLine($"                <span>- {CurrencyFormatService.FormatStatic(sale.DiscountAmount)}</span>");
        sb.AppendLine("            </div>");
        sb.AppendLine("            <div class='total-row final'>");
        sb.AppendLine("                <span>TOTAL</span>");
        sb.AppendLine($"                <span>{CurrencyFormatService.FormatStatic(sale.NetAmount)}</span>");
        sb.AppendLine("            </div>");
        sb.AppendLine("        </div>");
        sb.AppendLine("    </div>");
        
        // Footer
        sb.AppendLine("    <div class='footer'>");
        sb.AppendLine($"        <p>Documento gerado em {DateTime.Now:dd/MM/yyyy HH:mm} | Pillar ERP</p>");
        sb.AppendLine("    </div>");
        
        sb.AppendLine("</body>");
        sb.AppendLine("</html>");
        
        return sb.ToString();
    }

    private async Task ExportPdf()
    {
        if (_sale == null) return;

        try
        {
            var url = $"/api/sales/{Id}/export/pdf";
            await JSRuntime.InvokeVoidAsync("open", url, "_blank");
            Snackbar.Add("Exportando PDF...", Severity.Info);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erro ao exportar PDF da venda {SaleId}", Id);
            Snackbar.Add("Erro ao exportar PDF", Severity.Error);
        }
    }

    private async Task FinalizeSale()
    {
        if (_sale == null) return;

        var parameters = new DialogParameters
        {
            { "ContentText", $"Deseja finalizar a venda {_sale.SaleNumber}? Após finalizada, a venda não poderá mais ser alterada." },
            { "ButtonText", "Finalizar" },
            { "Color", Color.Success }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Finalizar Venda", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            try
            {
                await ApiService.PostAsync<object>($"/api/sales/{Id}/finalize", null);
                Snackbar.Add("Venda finalizada com sucesso", Severity.Success);
                await LoadSale();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Erro ao finalizar venda {SaleId}", Id);
                Snackbar.Add($"Erro ao finalizar venda: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task CancelSale()
    {
        if (_sale == null) return;

        var parameters = new DialogParameters
        {
            { "ContentText", $"Tem certeza que deseja cancelar a venda {_sale.SaleNumber}? Esta ação não pode ser desfeita." },
            { "ButtonText", "Cancelar Venda" },
            { "Color", Color.Error }
        };

        var options2 = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Cancelar Venda", parameters, options2);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            try
            {
                await ApiService.PostAsync<object>($"/api/sales/{Id}/cancel", null);
                Snackbar.Add("Venda cancelada com sucesso", Severity.Success);
                await LoadSale();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Erro ao cancelar venda {SaleId}", Id);
                Snackbar.Add($"Erro ao cancelar venda: {ex.Message}", Severity.Error);
            }
        }
    }

    private MudBlazor.Color GetStatusColor(string status)
    {
        return status switch
        {
            "Pendente" => MudBlazor.Color.Warning,
            "Finalizada" => MudBlazor.Color.Success,
            "Cancelada" => MudBlazor.Color.Error,
            _ => MudBlazor.Color.Default
        };
    }
}
