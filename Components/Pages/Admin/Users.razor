@page "/admin/users"
@using System.ComponentModel.DataAnnotations
@using System.Security.Claims
@using erp.Components.Shared.Dialogs
@using erp.DTOs.User
@using erp.DTOs.Role
@using erp.Security
@using erp.Services
@using erp.Services.Authorization
@attribute [Authorize(Policy = ModulePolicies.HR)]

@inject IApiService ApiService
@inject ILogger<Users> Logger
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ITablePreferenceService TablePreferences
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthenticationStateProvider
@implements IDisposable;

<PageTitle>Gerenciar Usuários - Pillar ERP</PageTitle>

<MudSnackbarProvider/>

<MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
    <MudText Typo="Typo.h4">Gerenciar Usuários</MudText>
    <MudButton Color="MudBlazor.Color.Primary" 
               Variant="Variant.Filled" 
               StartIcon="@Icons.Material.Filled.PersonAdd"
               OnClick="@ShowUserCreateDialog">
        Adicionar Usuário
    </MudButton>
</MudStack>

@if (_loadError != null)
{
    <MudAlert Severity="Severity.Error">@_loadError</MudAlert>
}

<MudTable T="UserDto" ServerData="new Func<TableState, CancellationToken, Task<TableData<UserDto>>>(ServerReload)" 
          Dense="false" Hover="true" Elevation="2" @ref="_table" Striped='true' RowsPerPage="@_defaultPageSize">
    <ToolBarContent>
        <MudText Typo="Typo.h5">Usuários Cadastrados</MudText>
        <MudSpacer/>
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudTextField T="string" ValueChanged="OnSearch" Immediate="true" Placeholder="Procurar" Variant="Variant.Outlined" Margin="Margin.Dense"
                          Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Clearable="true" Style="min-width: 200px;"/>
            <MudSelect T="string" 
                       Value="_statusFilter" 
                       ValueChanged="OnStatusFilterChanged"
                       Label="Status" 
                       Variant="Variant.Outlined" 
                       Margin="Margin.Dense"
                       Clearable="true"
                       Style="min-width: 120px;">
                <MudSelectItem T="string" Value="@("active")">Ativos</MudSelectItem>
                <MudSelectItem T="string" Value="@("inactive")">Inativos</MudSelectItem>
            </MudSelect>
            <MudSelect T="string" 
                       Value="_roleFilter" 
                       ValueChanged="OnRoleFilterChanged"
                       Label="Função" 
                       Variant="Variant.Outlined" 
                       Margin="Margin.Dense"
                       Clearable="true"
                       Style="min-width: 150px;">
                @if (_availableRoles != null)
                {
                    @foreach (var role in _availableRoles)
                    {
                        <MudSelectItem T="string" Value="@role.Name">@role.Name</MudSelectItem>
                    }
                }
            </MudSelect>
            @if (HasActiveFilters())
            {
                <MudButton Variant="Variant.Text" 
                           Color="MudBlazor.Color.Secondary" 
                           StartIcon="@Icons.Material.Filled.FilterAltOff"
                           OnClick="ClearFilters"
                           Size="MudBlazor.Size.Small">
                    Limpar Filtros
                </MudButton>
            }
        </MudStack>
    </ToolBarContent>
    <HeaderContent>
        <MudTh><MudTableSortLabel SortLabel="username" T="UserDto">Nome</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="email" T="UserDto">Email</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="phone" T="UserDto">Telefone</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="department" T="UserDto">Departamento</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="position" T="UserDto">Cargo</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="roles" T="UserDto">Função/Permissão</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="active" T="UserDto">Ativo</MudTableSortLabel></MudTh>
        <MudTh>Ações</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Nome">@context.Username</MudTd>
        <MudTd DataLabel="Email">@context.Email</MudTd>
        <MudTd DataLabel="Telefone">@context.Phone</MudTd>
        <MudTd DataLabel="Departamento">
            @if (!string.IsNullOrWhiteSpace(context.DepartmentName))
            {
                <MudChip T="string" Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Primary" Variant="Variant.Outlined">
                    @context.DepartmentName
                </MudChip>
            }
            else
            {
                <MudText Typo="Typo.caption" Color="MudBlazor.Color.Default">-</MudText>
            }
        </MudTd>
        <MudTd DataLabel="Cargo">
            @if (!string.IsNullOrWhiteSpace(context.PositionTitle))
            {
                <MudChip T="string" Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Info" Variant="Variant.Outlined">
                    @context.PositionTitle
                </MudChip>
            }
            else
            {
                <MudText Typo="Typo.caption" Color="MudBlazor.Color.Default">-</MudText>
            }
        </MudTd>
        <MudTd DataLabel="Permissões">@string.Join(", ", context.RoleAbbreviations)</MudTd>
        <MudTd DataLabel="Ativo">
            <MudChip T="string" Size="MudBlazor.Size.Small" Color="@(context.IsActive ? MudBlazor.Color.Success : MudBlazor.Color.Default)">
                @(context.IsActive ? "Ativo" : "Inativo")
            </MudChip>
        </MudTd>
        <MudTd>
            <MudButtonGroup Variant="Variant.Outlined" Size="MudBlazor.Size.Small">
                <MudTooltip Text="Editar usuário">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="MudBlazor.Color.Info" 
                                   OnClick="@(() => ShowUserUpdateDialog(context.Id))" 
                                   aria-label="@($"Editar usuário {context.Username}")" />
                </MudTooltip>
                <MudTooltip Text="@(context.IsActive ? "Desativar usuário" : "Ativar usuário")">
                    <MudIconButton Icon="@(context.IsActive ? Icons.Material.Filled.PersonOff : Icons.Material.Filled.PersonAdd)" 
                                   Color="@(context.IsActive ? MudBlazor.Color.Warning : MudBlazor.Color.Success)" 
                                   OnClick="@(() => ToggleUserStatus(context))" 
                                   aria-label="@(context.IsActive ? $"Desativar usuário {context.Username}" : $"Ativar usuário {context.Username}")" />
                </MudTooltip>
                @if (_isSuperAdmin && _currentUserId != context.Id)
                {
                    <MudTooltip Text="Entrar como este usuário">
                        <MudIconButton Icon="@Icons.Material.Filled.SwitchAccount"
                                       Color="MudBlazor.Color.Secondary"
                                       OnClick="@(() => ImpersonateUserAsync(context))"
                                       aria-label="@($"Impersonar usuário {context.Username}")" />
                    </MudTooltip>
                }
            </MudButtonGroup>
        </MudTd>    
    </RowTemplate>
    <NoRecordsContent>
        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Class="pa-8">
            <MudIcon Icon="@Icons.Material.Filled.PersonSearch" Size="MudBlazor.Size.Large" Color="MudBlazor.Color.Default" Class="mb-2" />
            <MudText Typo="Typo.h6" Color="MudBlazor.Color.Default">Nenhum usuário encontrado</MudText>
            <MudText Typo="Typo.body2" Color="MudBlazor.Color.Secondary">Adicione um novo usuário clicando no botão acima</MudText>
        </MudStack>
    </NoRecordsContent>
    <LoadingContent>
        <MudText>Carregando...</MudText>
    </LoadingContent>
    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>

@code {

    private MudTable<UserDto>? _table;
    private IEnumerable<UserDto>? _users;
    private int _totalItems;
    private string _searchString = "";
    private string _statusFilter = "";
    private string _roleFilter = "";
    private List<RoleDto>? _availableRoles;

    private System.Timers.Timer? _debounceTimer;
    private const int DebounceDelayMs = 600;
    
    private string? _loadError;
    
    // Table preferences
    private string? _currentSortLabel;
    private bool _sortDescending;
    private int _defaultPageSize = 25;
    private bool _isSuperAdmin;
    private int? _currentUserId;

    protected override async Task OnInitializedAsync()
    {
        _debounceTimer = new System.Timers.Timer(DebounceDelayMs);
        _debounceTimer.Elapsed += OnDebounceTimerElapsed;
        _debounceTimer.AutoReset = false;

        await LoadCurrentPrincipalAsync();
        
        // Load table preferences
        _defaultPageSize = TablePreferences.GetPageSize();
        var defaultSort = TablePreferences.GetDefaultSort("Usuários");
        if (defaultSort.HasValue)
        {
            _currentSortLabel = defaultSort.Value.field;
            _sortDescending = defaultSort.Value.descending;
        }
        
        // Load available roles for filter
        try
        {
            var rolesResponse = await ApiService.GetAsync("api/roles");
            if (rolesResponse.IsSuccessStatusCode)
            {
                _availableRoles = await rolesResponse.Content.ReadFromJsonAsync<List<RoleDto>>() ?? new List<RoleDto>();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"Erro ao carregar funções: {ex.Message}");
        }
    }

    private async Task LoadCurrentPrincipalAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var principal = authState.User;

        _isSuperAdmin = principal.IsInRole(RoleNames.SuperAdmin);

        var currentUserClaim = principal.FindFirstValue(ClaimTypes.NameIdentifier);
        _currentUserId = int.TryParse(currentUserClaim, out var parsedUserId) ? parsedUserId : null;
    }

    private async Task<TableData<UserDto>> ServerReload(TableState state, CancellationToken token)
    {
        try
        {
            var response = await ApiService.GetAsync("api/users", token);
            
            if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                _loadError = "Você precisa estar autenticado para acessar esta página.";
                Snackbar.Add(_loadError, Severity.Error);
                return new TableData<UserDto>() { TotalItems = 0, Items = Enumerable.Empty<UserDto>() };
            }
            
            if (response.StatusCode == System.Net.HttpStatusCode.Forbidden)
            {
                _loadError = "Você não tem permissão para acessar esta página.";
                Snackbar.Add(_loadError, Severity.Error);
                return new TableData<UserDto>() { TotalItems = 0, Items = Enumerable.Empty<UserDto>() };
            }
            
            response.EnsureSuccessStatusCode();
            
            IEnumerable<UserDto> data = await response.Content.ReadFromJsonAsync<IEnumerable<UserDto>>(cancellationToken: token) 
                                            ?? Enumerable.Empty<UserDto>();
            _loadError = null;

            data = data.Where(user =>
            {
                // Search filter
                if (!string.IsNullOrWhiteSpace(_searchString))
                {
                    if (!user.Username.Contains(_searchString, StringComparison.OrdinalIgnoreCase) &&
                        !user.Email.Contains(_searchString, StringComparison.OrdinalIgnoreCase) &&
                        !user.Phone.Contains(_searchString, StringComparison.OrdinalIgnoreCase) &&
                        !user.RoleNames.Any(r => r.Contains(_searchString, StringComparison.OrdinalIgnoreCase)))
                    {
                        return false;
                    }
                }
                
                // Status filter
                if (_statusFilter == "active" && !user.IsActive)
                    return false;
                if (_statusFilter == "inactive" && user.IsActive)
                    return false;
                
                // Role filter
                if (!string.IsNullOrWhiteSpace(_roleFilter) && !user.RoleNames.Contains(_roleFilter, StringComparer.OrdinalIgnoreCase))
                    return false;
                
                return true;
            });

            _totalItems = data.Count();

            // Handle sorting - use preference as fallback when no sort is selected
            var sortLabel = state.SortLabel;
            var sortDirection = state.SortDirection;
            
            if (string.IsNullOrEmpty(sortLabel) && !string.IsNullOrEmpty(_currentSortLabel))
            {
                sortLabel = _currentSortLabel;
                sortDirection = _sortDescending ? SortDirection.Descending : SortDirection.Ascending;
            }

            data = sortLabel switch
            {
                "username" => data.OrderByDirection(sortDirection, u => u.Username),
                "email" => data.OrderByDirection(sortDirection, u => u.Email),
                "phone" => data.OrderByDirection(sortDirection, u => u.Phone),
                "department" => data.OrderByDirection(sortDirection, u => u.DepartmentName ?? ""),
                "position" => data.OrderByDirection(sortDirection, u => u.PositionTitle ?? ""),
                "roles" => data.OrderByDirection(sortDirection, u => string.Join(",", u.RoleNames)),
                "active" => data.OrderByDirection(sortDirection, u => u.IsActive),
                _ => data
            };

            _users = data.Skip(state.Page * state.PageSize).Take(state.PageSize).ToArray();
            return new TableData<UserDto>() { TotalItems = _totalItems, Items = _users };
        }
        catch (HttpRequestException ex)
        {
            Console.WriteLine($"Erro ao buscar usuários: {ex.Message}");
            _loadError = "Não foi possível conectar ao servidor. Verifique sua conexão e tente novamente.";
            Snackbar.Add(_loadError, Severity.Error);
            return new TableData<UserDto>() { TotalItems = 0, Items = Enumerable.Empty<UserDto>() };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao buscar usuários: {ex.Message}");
            _loadError = "Erro inesperado ao carregar os usuários. Tente novamente.";
            Snackbar.Add(_loadError, Severity.Error);
            return new TableData<UserDto>() { TotalItems = 0, Items = Enumerable.Empty<UserDto>() };
        }
    }

    private void OnSearch(string text)
    {
        _searchString = text;
        _debounceTimer?.Stop();
        _debounceTimer?.Start();
    }
    
    private void OnDebounceTimerElapsed(object? sender, System.Timers.ElapsedEventArgs e)
    {
        InvokeAsync(async () => { if (_table != null) await _table.ReloadServerData(); });
    }

    private async void OnStatusFilterChanged(string value)
    {
        _statusFilter = value ?? "";
        if (_table != null) await _table.ReloadServerData();
    }

    private async void OnRoleFilterChanged(string value)
    {
        _roleFilter = value ?? "";
        if (_table != null) await _table.ReloadServerData();
    }

    private bool HasActiveFilters()
    {
        return !string.IsNullOrWhiteSpace(_searchString) || 
               !string.IsNullOrWhiteSpace(_statusFilter) || 
               !string.IsNullOrWhiteSpace(_roleFilter);
    }

    private async void ClearFilters()
    {
        _searchString = "";
        _statusFilter = "";
        _roleFilter = "";
        if (_table != null) await _table.ReloadServerData();
    }

    private async Task ShowUserCreateDialog()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, CloseButton = true, MaxWidth = MaxWidth.Medium };
        var dialog = await DialogService.ShowAsync<UserCreateDialog>("Adicionar Novo Usuário", options);
        var result = await dialog.Result;
        
        if (result is { Canceled: false } && _table != null)
        {
            await Task.Delay(200);
            _users = null;
            _totalItems = 0;
            await _table.ReloadServerData();
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task ShowUserUpdateDialog(int userId)
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, CloseButton = true, MaxWidth = MaxWidth.Medium };
        var parameters = new DialogParameters { { "UserId", userId } };

        var userName = _users?.FirstOrDefault(u => u.Id == userId)?.Username ?? "usuário";
        var dialog = await DialogService.ShowAsync<UserUpdateDialog>($"Alterar {userName}", parameters, options);
        var result = await dialog.Result;
        
        if (result is { Canceled: false } && _table != null)
        {
            // Aguarda um momento para garantir que as alterações foram salvas
            await Task.Delay(200);
            
            // Limpa o estado da tabela e força reload
            _users = null;
            _totalItems = 0;
            await _table.ReloadServerData();
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task ToggleUserStatus(UserDto user)
    {
        var action = user.IsActive ? "desativar" : "ativar";
        var parameters = new DialogParameters
        {
            { "ContentText", $"Tem certeza que deseja {action} o usuário '{user.Username}'?" },
            { "ButtonText", action.First().ToString().ToUpper() + action.Substring(1) },
            { "Color", user.IsActive ? MudBlazor.Color.Warning : MudBlazor.Color.Success }
        };

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>($"Confirmar {action}", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            try
            {
                // Buscar dados completos do usuário para ter os RoleIds
                var userResponse = await ApiService.GetAsync($"api/users/{user.Id}");
                if (!userResponse.IsSuccessStatusCode)
                {
                    Snackbar.Add("Erro ao carregar dados do usuário.", Severity.Error);
                    return;
                }
                
                var fullUser = await userResponse.Content.ReadFromJsonAsync<UpdateUserDto>();
                if (fullUser == null)
                {
                    Snackbar.Add("Erro ao carregar dados do usuário.", Severity.Error);
                    return;
                }

                fullUser.IsActive = !user.IsActive;

                var response = await ApiService.PutAsJsonAsync($"api/users/{user.Id}", fullUser);
                if (response.IsSuccessStatusCode)
                {
                    Snackbar.Add($"✓ Usuário {(user.IsActive ? "desativado" : "ativado")} com sucesso!", Severity.Success);
                    if (_table != null)
                    {
                        await _table.ReloadServerData();
                    }
                }
                else
                {
                    var errorMessage = ErrorMessageHelper.GetUserOperationErrorMessage(response.StatusCode, "update");
                    Snackbar.Add(errorMessage, Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Logger.LogError($"Erro ao {action} usuário: {ex.Message}");
                Snackbar.Add($"Erro ao {action} usuário. Tente novamente.", Severity.Error);
            }
        }
    }

    private async Task ImpersonateUserAsync(UserDto user)
    {
        var parameters = new DialogParameters
        {
            { "ContentText", $"Deseja entrar como o usuário '{user.Username}'? Você será redirecionado para o tenant desse usuário." },
            { "ButtonText", "Entrar como usuário" },
            { "Color", MudBlazor.Color.Warning }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Confirmar impersonação", parameters, options);
        var result = await dialog.Result;
        if (result is null || result.Canceled)
        {
            return;
        }

        try
        {
            var response = await JS.InvokeAsync<AuthActionResult>("erpAuth.impersonate", user.Id);
            if (response.ok)
            {
                Snackbar.Add($"Agora você está autenticado como {user.Username}.", Severity.Success);
                NavigationManager.NavigateTo("/", forceLoad: true);
                return;
            }

            var errorMessage = string.IsNullOrWhiteSpace(response.text)
                ? "Não foi possível iniciar a impersonação."
                : response.text;
            Snackbar.Add(errorMessage, Severity.Error);
        }
        catch (Exception ex)
        {
            Logger.LogError($"Erro ao iniciar impersonação: {ex.Message}");
            Snackbar.Add("Erro ao iniciar impersonação.", Severity.Error);
        }
    }

    private class AuthActionResult
    {
        public bool ok { get; set; }
        public int status { get; set; }
        public string? text { get; set; }
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}
