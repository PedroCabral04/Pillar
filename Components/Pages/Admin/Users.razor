@page "/admin/users"
@using System.ComponentModel.DataAnnotations
@using erp.Components.Shared.Dialogs
@using erp.DTOs.User
@using erp.DTOs.Role
@using erp.Services
@attribute [Authorize]

@inject IApiService ApiService
@inject ILogger<Users> Logger
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@implements IDisposable;

<PageTitle>Gerenciar Usuários</PageTitle>

<MudSnackbarProvider/>

<MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
    <MudText Typo="Typo.h4">Gerenciar Usuários</MudText>
    <MudButton Color="MudBlazor.Color.Primary" 
               Variant="Variant.Filled" 
               StartIcon="@Icons.Material.Filled.PersonAdd"
               OnClick="@ShowUserCreateDialog">
        Adicionar Usuário
    </MudButton>
</MudStack>

@if (_loadError != null)
{
    <MudAlert Severity="Severity.Error">@_loadError</MudAlert>
}

<MudTable T="UserDto" ServerData="new Func<TableState, CancellationToken, Task<TableData<UserDto>>>(ServerReload)" 
          Dense="false" Hover="true" Elevation="4" @ref="_table" Striped='true'>
    <ToolBarContent>
        <MudText Typo="Typo.h5">Usuários Cadastrados</MudText>
        <MudSpacer/>
        <MudTextField T="string" ValueChanged="OnSearch" Immediate="true" Placeholder="Procurar" Variant="Variant.Outlined" Margin="Margin.Dense"
                      Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Clearable="true"/>
    </ToolBarContent>
    <HeaderContent>
        <MudTh><MudTableSortLabel SortLabel="username" T="UserDto">Nome</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="email" T="UserDto">Email</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="phone" T="UserDto">Telefone</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="roles" T="UserDto">Função/Permissão</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="active" T="UserDto">Ativo</MudTableSortLabel></MudTh>
        <MudTh>Ações</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Nome">@context.Username</MudTd>
        <MudTd DataLabel="Email">@context.Email</MudTd>
        <MudTd DataLabel="Telefone">@context.Phone</MudTd>
        <MudTd DataLabel="Permissões">@string.Join(", ", context.RoleAbbreviations)</MudTd>
        <MudTd DataLabel="Ativo">
            <MudChip T="string" Size="MudBlazor.Size.Small" Color="@(context.IsActive ? MudBlazor.Color.Success : MudBlazor.Color.Default)">
                @(context.IsActive ? "Ativo" : "Inativo")
            </MudChip>
        </MudTd>
        <MudTd>
            <MudButtonGroup Variant="Variant.Outlined" Size="MudBlazor.Size.Small">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="MudBlazor.Color.Info" 
                               OnClick="@(() => ShowUserUpdateDialog(context.Id))" 
                               Title="Editar usuário" />
                <MudIconButton Icon="@(context.IsActive ? Icons.Material.Filled.PersonOff : Icons.Material.Filled.PersonAdd)" 
                               Color="@(context.IsActive ? MudBlazor.Color.Warning : MudBlazor.Color.Success)" 
                               OnClick="@(() => ToggleUserStatus(context))" 
                               Title="@(context.IsActive ? "Desativar usuário" : "Ativar usuário")" />
            </MudButtonGroup>
        </MudTd>    
    </RowTemplate>
    <NoRecordsContent>
        <MudText>Nenhum usuário encontrado.</MudText>
    </NoRecordsContent>
    <LoadingContent>
        <MudText>Carregando...</MudText>
    </LoadingContent>
    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>

@code {

    private MudTable<UserDto>? _table;
    private IEnumerable<UserDto>? _users;
    private int _totalItems;
    private string _searchString = "";

    private System.Timers.Timer? _debounceTimer;
    private const int DebounceDelayMs = 600;
    
    private string? _loadError;

    protected override async Task OnInitializedAsync()
    {
        _debounceTimer = new System.Timers.Timer(DebounceDelayMs);
        _debounceTimer.Elapsed += OnDebounceTimerElapsed;
        _debounceTimer.AutoReset = false;
    }

    private async Task<TableData<UserDto>> ServerReload(TableState state, CancellationToken token)
    {
        try
        {
            var response = await ApiService.GetAsync("api/users", token);
            
            if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                _loadError = "Você precisa estar autenticado para acessar esta página.";
                Snackbar.Add(_loadError, Severity.Error);
                return new TableData<UserDto>() { TotalItems = 0, Items = Enumerable.Empty<UserDto>() };
            }
            
            if (response.StatusCode == System.Net.HttpStatusCode.Forbidden)
            {
                _loadError = "Você não tem permissão para acessar esta página.";
                Snackbar.Add(_loadError, Severity.Error);
                return new TableData<UserDto>() { TotalItems = 0, Items = Enumerable.Empty<UserDto>() };
            }
            
            response.EnsureSuccessStatusCode();
            
            IEnumerable<UserDto> data = await response.Content.ReadFromJsonAsync<IEnumerable<UserDto>>(cancellationToken: token) 
                                            ?? Enumerable.Empty<UserDto>();
            _loadError = null;

            data = data.Where(user =>
            {
                if (string.IsNullOrWhiteSpace(_searchString))
                    return true;
                if (user.Username.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
                    return true;
                if (user.Email.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
                    return true;
                if (user.Phone.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
                    return true;
                return user.RoleNames.Any(r => r.Contains(_searchString, StringComparison.OrdinalIgnoreCase));
            });

            _totalItems = data.Count();

            data = state.SortLabel switch
            {
                "username" => data.OrderByDirection(state.SortDirection, u => u.Username),
                "email" => data.OrderByDirection(state.SortDirection, u => u.Email),
                "phone" => data.OrderByDirection(state.SortDirection, u => u.Phone),
                "roles" => data.OrderByDirection(state.SortDirection, u => string.Join(",", u.RoleNames)),
                "active" => data.OrderByDirection(state.SortDirection, u => u.IsActive),
                _ => data
            };

            _users = data.Skip(state.Page * state.PageSize).Take(state.PageSize).ToArray();
            return new TableData<UserDto>() { TotalItems = _totalItems, Items = _users };
        }
        catch (HttpRequestException ex)
        {
            Console.WriteLine($"Erro ao buscar usuários: {ex.Message}");
            _loadError = "Não foi possível conectar ao servidor. Verifique sua conexão e tente novamente.";
            Snackbar.Add(_loadError, Severity.Error);
            return new TableData<UserDto>() { TotalItems = 0, Items = Enumerable.Empty<UserDto>() };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao buscar usuários: {ex.Message}");
            _loadError = "Erro inesperado ao carregar os usuários. Tente novamente.";
            Snackbar.Add(_loadError, Severity.Error);
            return new TableData<UserDto>() { TotalItems = 0, Items = Enumerable.Empty<UserDto>() };
        }
    }

    private void OnSearch(string text)
    {
        _searchString = text;
        _debounceTimer?.Stop();
        _debounceTimer?.Start();
    }
    
    private void OnDebounceTimerElapsed(object? sender, System.Timers.ElapsedEventArgs e)
    {
        InvokeAsync(async () => { if (_table != null) await _table.ReloadServerData(); });
    }

    private async Task ShowUserCreateDialog()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, CloseButton = true, MaxWidth = MaxWidth.Medium };
        var dialog = await DialogService.ShowAsync<UserCreateDialog>("Adicionar Novo Usuário", options);
        var result = await dialog.Result;
        
        if (result is { Canceled: false } && _table != null)
        {
            await Task.Delay(200);
            _users = null;
            _totalItems = 0;
            await _table.ReloadServerData();
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task ShowUserUpdateDialog(int userId)
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, CloseButton = true, MaxWidth = MaxWidth.Medium };
        var parameters = new DialogParameters<UserUpdateDialog> { { x => x.UserId, userId } };

        var userName = _users?.FirstOrDefault(u => u.Id == userId)?.Username ?? "usuário";
        var dialog = await DialogService.ShowAsync<UserUpdateDialog>($"Alterar {userName}", parameters, options);
        var result = await dialog.Result;
        
        if (result is { Canceled: false } && _table != null)
        {
            // Aguarda um momento para garantir que as alterações foram salvas
            await Task.Delay(200);
            
            // Limpa o estado da tabela e força reload
            _users = null;
            _totalItems = 0;
            await _table.ReloadServerData();
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task ToggleUserStatus(UserDto user)
    {
        var action = user.IsActive ? "desativar" : "ativar";
        var parameters = new DialogParameters
        {
            { "ContentText", $"Tem certeza que deseja {action} o usuário '{user.Username}'?" },
            { "ButtonText", action.First().ToString().ToUpper() + action.Substring(1) },
            { "Color", user.IsActive ? MudBlazor.Color.Warning : MudBlazor.Color.Success }
        };

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>($"Confirmar {action}", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            try
            {
                // Buscar dados completos do usuário para ter os RoleIds
                var userResponse = await ApiService.GetAsync($"api/users/{user.Id}");
                if (!userResponse.IsSuccessStatusCode)
                {
                    Snackbar.Add("Erro ao carregar dados do usuário.", Severity.Error);
                    return;
                }
                
                var fullUser = await userResponse.Content.ReadFromJsonAsync<UpdateUserDto>();
                if (fullUser == null)
                {
                    Snackbar.Add("Erro ao carregar dados do usuário.", Severity.Error);
                    return;
                }

                fullUser.IsActive = !user.IsActive;

                var response = await ApiService.PutAsJsonAsync($"api/users/{user.Id}", fullUser);
                if (response.IsSuccessStatusCode)
                {
                    Snackbar.Add($"✓ Usuário {(user.IsActive ? "desativado" : "ativado")} com sucesso!", Severity.Success);
                    if (_table != null)
                    {
                        await _table.ReloadServerData();
                    }
                }
                else
                {
                    var errorMessage = ErrorMessageHelper.GetUserOperationErrorMessage(response.StatusCode, "update");
                    Snackbar.Add(errorMessage, Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Logger.LogError($"Erro ao {action} usuário: {ex.Message}");
                Snackbar.Add($"Erro ao {action} usuário. Tente novamente.", Severity.Error);
            }
        }
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}
