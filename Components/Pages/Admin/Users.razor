@page "/admin/users"
@using System.ComponentModel.DataAnnotations
@using System.Net.Http.Json
@using System.Reflection.Metadata
@using erp.Models
@using erp.DTOs.User
@using erp.DTOs.Role
@using erp.Services

@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject ILogger<Users> Logger
@inject ISnackbar Snackbar

<PageTitle>Gerenciar Usuários</PageTitle>

<MudSnackbarProvider/>
<MudCard Elevation="8" Class="w-100">
    <MudCardHeader Style="margin-bottom: -20px">
        <CardHeaderContent>
            <MudText Typo="Typo.h5" Color="Color.Default">Adicionar usuários</MudText>
        </CardHeaderContent>
        <CardHeaderActions>
            <MudIconButton Icon="@Icons.Material.Filled.Settings" Color="Color.Default"></MudIconButton>
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent>
        <MudTextField T="string" Label="Nome" Variant="Variant.Outlined" Margin="Margin.Dense"
                      InputType="InputType.Text" Required="true" RequiredError="Nome é obrigatório"
                      @bind-Value="_newUser.Username"/>
        <MudTextField T="string" Label="Email" Variant="Variant.Outlined" Margin="Margin.Dense"
                      InputType="InputType.Email" Required="true" RequiredError="Email é obrigatório"
                      Validation="@(new EmailAddressAttribute() {ErrorMessage = "Email inválido!"})"
                      @bind-Value="_newUser.Email"/>
        <MudTextField T="string" Label="Telefone" Variant="Variant.Outlined" Margin="Margin.Dense"
                      InputType="InputType.Telephone" Required="true" RequiredError="Telefone é obrigatório"
                      Validation="@(new PhoneAttribute() {ErrorMessage = "Telefone inválido!"})" 
                      Placeholder="(00) 00000-0000" Mask="@(new PatternMask("(00) 00000-0000"))"
                      @bind-Value="_newUser.Phone"/>
        <MudSelect T="@RoleDto" @bind-SelectedValues="_selectedRoles" Label="Função/Permissão" MultiSelection="true"
                   Variant="Variant.Outlined" Margin="Margin.Dense" Required="true"
                   RequiredError="Escolha pelo menos uma permissão" SelectAll="true" SelectAllText="Selecionar todos">
            @foreach (var roleOption in _rolesList)
            {
                <MudSelectItem T="@RoleDto" Value="@roleOption">@roleOption.Name</MudSelectItem>
            }
        </MudSelect>
        <MudButton Color="Color.Primary" Variant="Variant.Outlined" EndIcon="@Icons.Material.Filled.Add"
                   ButtonType="ButtonType.Submit"
                   OnClick="@HandleAddUser"
                   Class="w-100" Style="margin-top: 20px">
            Adicionar
        </MudButton>
    </MudCardContent>
</MudCard>

<MudDivider Class="my-4"/>

@if (_users == null && _loadError == null)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true"/>
    <MudText>Carregando...</MudText>
} 
else if (_loadError != null)
{
    <MudAlert Severity="Severity.Error">@_loadError</MudAlert>
} 
else if (_users != null && _users.Any())
{
    <MudTable Items="@_users" Dense="false" Hover="true"
              Elevation="4" RowClass="cursor-pointer" Striped='true'>
        <ToolBarContent>
            <MudText Typo="Typo.h5">Usuários Cadastrados</MudText>
            <MudSpacer/>
            <MudSpacer/>
            <MudSpacer/>
            <MudTextField T="string" @bind-Value="_search" Placeholder="Procurar" Variant="Variant.Outlined" Margin="Margin.Dense"
            Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Clearable="true"/>
        </ToolBarContent>
        <HeaderContent>
            <MudTh><MudTableSortLabel SortBy="new Func<User, object>(e => e.Username)">Nome</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<User, object>(e => e.Email)">Email</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<User, object>(e => e.Phone)">Telefone</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<Role, object>(e => e.Name)">Função/Permissão</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<User, object>(e => e.IsActive)">Ativo</MudTableSortLabel></MudTh>
            <MudTh>Ações</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Nome">@context.Username</MudTd>
            <MudTd DataLabel="Email">@context.Email</MudTd>
            <MudTd DataLabel="Telefone">@context.Phone</MudTd>
            <MudTd DataLabel="Permissões">@string.Join(", ", context.RoleNames)</MudTd>
            <MudTd DataLabel="Ativo">@context.IsActive</MudTd>
            <MudTd DataLabel="Ações"/>    
        </RowTemplate>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>
}
else
{
    <MudText>Nenhum usuário encontrado</MudText>
}


@code {

    private string _search = String.Empty;

    private CreateUserDto _newUser = new()
    {
        RoleIds = new List<int>()
    };

    private IEnumerable<RoleDto> _selectedRoles = new List<RoleDto>();
    private List<RoleDto> _rolesList = new List<RoleDto>();
    
    // Api retorna IEnumerable<UserDto>
    private IEnumerable<UserDto>? _users;
    private string? _loadError;

    protected override async Task OnInitializedAsync()
    {
        var executionContext = OperatingSystem.IsBrowser() ? "Client" : "Server";
        if (_users == null)
        {
            try
            {
                // A API está em "api/users" e o método GetAllUsers é um GET nesse endpoint.
                // HttpClient.GetFromJsonAsync desserializa a resposta JSON.
                _users = await Http.GetFromJsonAsync<IEnumerable<UserDto>>("api/users");
                await LoadRolesAsync();
                _loadError = null; // Limpa erros anteriores
            }
            catch (Exception ex)
            {
                // Logar o erro real no console do servidor/browser para debugging
                Console.WriteLine($"Erro ao buscar usuários: {ex.Message}");
                _loadError = "Não foi possível carregar os usuários. Tente novamente mais tarde.";
                _users = Enumerable.Empty<UserDto>(); // Define como vazio para evitar null ref na UI
            }
        }
    }
    
    private async Task HandleAddUser()
    {
        try
        {
            _newUser.RoleIds = _selectedRoles.Select(r => r.Id).ToList();
            var response = await Http.PostAsJsonAsync("api/users", _newUser);
            if (response.IsSuccessStatusCode)
            {
                Logger.LogInformation("Usuário adicionado com sucesso.");
                _newUser = new CreateUserDto { RoleIds = new List<int>() };
                _selectedRoles = new List<RoleDto>();

                _users = await Http.GetFromJsonAsync<IEnumerable<UserDto>>("api/users"); // Recarrega a lista de usuários
                Snackbar.Add("Usuário adicionado com sucesso!", Severity.Success);
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Logger.LogError($"Erro ao adicionar usuário: {response.StatusCode} - {errorContent}");
                Snackbar.Add($"Erro ao adicionar usuário: {errorContent}", Severity.Error);

            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"Erro ao adicionar usuário: {ex.Message}");
        }
    }

    private async Task LoadRolesAsync()
    {
        try
        {
            var roles = await Http.GetFromJsonAsync<List<RoleDto>>("api/roles");
            _rolesList = roles ?? new List<RoleDto>();
        }
        catch (Exception ex)
        {
            Logger.LogError($"Erro ao buscar funções: {ex.Message}");
            _rolesList = new List<RoleDto>(); // Ensure it's not null on error
            Snackbar.Add("Erro ao buscar funções: " + ex.Message, Severity.Error);
        }
        StateHasChanged();

    }
        
}
