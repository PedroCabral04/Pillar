@page "/admin/tenants"
@attribute [Authorize(Roles = "SuperAdmin")]
@using erp.DTOs.Tenancy
@using erp.Models.Tenancy
@using erp.Services
@inject IApiService ApiService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ILogger<Tenants> Logger

<PageTitle>Tenants - Pillar ERP</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
    <MudStack Spacing="3">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudStack Spacing="1">
                <MudText Typo="Typo.h4">Tenants</MudText>
                <MudText Typo="Typo.subtitle2" Color="MudBlazor.Color.Secondary">Gerenciamento de empresas e status.</MudText>
            </MudStack>
            <MudButton Variant="Variant.Filled" Color="MudBlazor.Color.Primary" StartIcon="@Icons.Material.Filled.AddBusiness" OnClick="CreateTenant">
                Novo tenant
            </MudButton>
        </MudStack>

        <MudGrid>
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="0" Outlined="true" Class="pa-3">
                    <MudText Typo="Typo.caption" Color="MudBlazor.Color.Secondary">Total</MudText>
                    <MudText Typo="Typo.h5">@_tenants.Count</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="0" Outlined="true" Class="pa-3">
                    <MudText Typo="Typo.caption" Color="MudBlazor.Color.Secondary">Ativos</MudText>
                    <MudText Typo="Typo.h5">@_tenants.Count(t => t.Status == TenantStatus.Active)</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="0" Outlined="true" Class="pa-3">
                    <MudText Typo="Typo.caption" Color="MudBlazor.Color.Secondary">Suspensos</MudText>
                    <MudText Typo="Typo.h5">@_tenants.Count(t => t.Status == TenantStatus.Suspended)</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="0" Outlined="true" Class="pa-3">
                    <MudText Typo="Typo.caption" Color="MudBlazor.Color.Secondary">Arquivados</MudText>
                    <MudText Typo="Typo.h5">@_tenants.Count(t => t.Status == TenantStatus.Archived)</MudText>
                </MudPaper>
            </MudItem>
        </MudGrid>

        @if (!string.IsNullOrWhiteSpace(_loadError))
        {
            <MudAlert Severity="Severity.Error">@_loadError</MudAlert>
        }

        <MudPaper Elevation="1" Class="pa-4">
            <MudStack Spacing="2">
                <MudGrid>
                    <MudItem xs="12" md="8">
                        <MudTextField @bind-Value="_search" Placeholder="Filtrar por nome, slug, região ou contato" Variant="Variant.Outlined" Immediate="true" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudSelect T="TenantStatus?" @bind-Value="_statusFilter" Variant="Variant.Outlined" Label="Status">
                            <MudSelectItem T="TenantStatus?" Value="@(null)">Todos</MudSelectItem>
                            @foreach (var status in Enum.GetValues<TenantStatus>())
                            {
                                <MudSelectItem T="TenantStatus?" Value="@status">@GetStatusLabel(status)</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                </MudGrid>
                <MudTable Items="@FilteredTenants" Hover="true" Dense="true" SortLabel="Ordenar" RowsPerPage="10">
                    <HeaderContent>
                        <MudTh><MudTableSortLabel T="TenantDto" SortBy="@(x => x.Name)">Empresa</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel T="TenantDto" SortBy="@(x => x.Status)">Status</MudTableSortLabel></MudTh>
                        <MudTh>Contato</MudTh>
                        <MudTh><MudTableSortLabel T="TenantDto" SortBy="@(x => x.Region)">Região</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel T="TenantDto" SortBy="@(x => x.CreatedAt)">Criado em</MudTableSortLabel></MudTh>
                        <MudTh Align="Align.Right">Ações</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Empresa">
                            <MudStack>
                                <MudText Typo="Typo.body1">@context.Name</MudText>
                                <MudText Typo="Typo.caption" Color="MudBlazor.Color.Secondary">Slug: @context.Slug</MudText>
                                @if (context.IsDemo)
                                {
                                    <MudChip T="string" Color="MudBlazor.Color.Info" Variant="Variant.Outlined" Size="MudBlazor.Size.Small">Demo</MudChip>
                                }
                            </MudStack>
                        </MudTd>
                        <MudTd DataLabel="Status">
                            <MudChip T="string" Color="@GetStatusColor(context.Status)" Variant="Variant.Filled" Size="MudBlazor.Size.Small">@GetStatusLabel(context.Status)</MudChip>
                        </MudTd>
                        <MudTd DataLabel="Contato">
                            <MudText Typo="Typo.subtitle2">@context.PrimaryContactName</MudText>
                            <MudText Typo="Typo.caption">@context.PrimaryContactEmail</MudText>
                            <MudText Typo="Typo.caption">@context.PrimaryContactPhone</MudText>
                        </MudTd>
                        <MudTd DataLabel="Região">@context.Region</MudTd>
                        <MudTd DataLabel="Criado em">
                            <MudText Typo="Typo.body2">@context.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy")</MudText>
                            <MudText Typo="Typo.caption" Color="MudBlazor.Color.Secondary">@GetRelativeTime(context.CreatedAt)</MudText>
                        </MudTd>
                        <MudTd Align="Align.Right">
                            <MudButtonGroup Variant="Variant.Text" Dense="true">
                                <MudIconButton Icon="@Icons.Material.Filled.People" Color="MudBlazor.Color.Primary" Title="Gerenciar usuários" OnClick="@(() => ManageUsers(context))" />
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="MudBlazor.Color.Info" Title="Editar" OnClick="@(() => EditTenant(context))" />
                                @if (context.Status == TenantStatus.Archived)
                                {
                                    <MudIconButton Icon="@Icons.Material.Filled.Unarchive" Color="MudBlazor.Color.Success" Title="Reativar" OnClick="@(() => ReactivateTenant(context))" />
                                }
                                else
                                {
                                    <MudIconButton Icon="@Icons.Material.Filled.Archive" Color="MudBlazor.Color.Warning" Title="Arquivar" OnClick="@(() => ArchiveTenant(context))" />
                                }
                            </MudButtonGroup>
                        </MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText>Nenhum tenant encontrado.</MudText>
                    </NoRecordsContent>
                    <PagerContent>
                        <MudTablePager />
                    </PagerContent>
                </MudTable>
            </MudStack>
        </MudPaper>
    </MudStack>
</MudContainer>

@code {
    private List<TenantDto> _tenants = new();
    private string? _loadError;
    private string _search = string.Empty;
    private TenantStatus? _statusFilter;

    protected override async Task OnInitializedAsync()
    {
        await LoadTenantsAsync();
    }

    private IEnumerable<TenantDto> FilteredTenants => _tenants.Where(t =>
        string.IsNullOrWhiteSpace(_search)
        || t.Name.Contains(_search, StringComparison.OrdinalIgnoreCase)
        || t.Slug.Contains(_search, StringComparison.OrdinalIgnoreCase)
        || (t.Region?.Contains(_search, StringComparison.OrdinalIgnoreCase) ?? false)
        || (t.PrimaryContactName?.Contains(_search, StringComparison.OrdinalIgnoreCase) ?? false))
        .Where(t => !_statusFilter.HasValue || t.Status == _statusFilter.Value);

    private async Task LoadTenantsAsync()
    {
        try
        {
            var response = await ApiService.GetAsync("api/tenants");
            response.EnsureSuccessStatusCode();
            var tenants = await response.Content.ReadFromJsonAsync<List<TenantDto>>() ?? new List<TenantDto>();
            _tenants = tenants.OrderBy(t => t.Name).ToList();
            _loadError = null;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erro ao carregar tenants");
            _loadError = "Não foi possível carregar os tenants.";
            Snackbar.Add(_loadError, Severity.Error);
        }
    }

    private async Task CreateTenant()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = false };
        var dialog = await DialogService.ShowAsync<TenantFormDialog>("Novo tenant", options);
        var result = await dialog.Result;
        if (result is { Canceled: false })
        {
            await LoadTenantsAsync();
        }
    }

    private async Task EditTenant(TenantDto tenant)
    {
        var parameters = new DialogParameters<TenantFormDialog> { { x => x.Tenant, tenant }, { x => x.IsEdit, true } };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = false };
        var dialog = await DialogService.ShowAsync<TenantFormDialog>($"Editar {tenant.Name}", parameters, options);
        var result = await dialog.Result;
        if (result is { Canceled: false })
        {
            await LoadTenantsAsync();
        }
    }

    private async Task ArchiveTenant(TenantDto tenant)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Arquivar tenant",
            $"Deseja arquivar o tenant '{tenant.Name}'? Ele deixara de aparecer como ativo.",
            yesText: "Arquivar",
            cancelText: "Cancelar");

        if (confirmed != true)
        {
            return;
        }

        var response = await ApiService.DeleteAsync($"api/tenants/{tenant.Id}");
        if (response.IsSuccessStatusCode)
        {
            Snackbar.Add("Tenant arquivado com sucesso.", Severity.Success);
            await LoadTenantsAsync();
            return;
        }

        Snackbar.Add("Nao foi possivel arquivar o tenant.", Severity.Error);
    }

    private async Task ReactivateTenant(TenantDto tenant)
    {
        var dto = new UpdateTenantDto
        {
            Name = tenant.Name,
            DocumentNumber = tenant.DocumentNumber,
            PrimaryContactName = tenant.PrimaryContactName,
            PrimaryContactEmail = tenant.PrimaryContactEmail,
            PrimaryContactPhone = tenant.PrimaryContactPhone,
            Region = tenant.Region,
            IsDemo = tenant.IsDemo,
            Status = TenantStatus.Active,
            Notes = tenant.Notes,
            Branding = tenant.Branding
        };

        await ApiService.PutAsync<TenantDto>($"api/tenants/{tenant.Id}", dto);
        Snackbar.Add("Tenant reativado com sucesso.", Severity.Success);
        await LoadTenantsAsync();
    }

    private async Task ManageUsers(TenantDto tenant)
    {
        var parameters = new DialogParameters<TenantUsersDialog>
        {
            { x => x.Tenant, tenant }
        };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.ExtraLarge, FullWidth = true };
        var dialog = await DialogService.ShowAsync<TenantUsersDialog>($"Usuários - {tenant.Name}", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await LoadTenantsAsync(); // Recarrega para atualizar contadores
        }
    }

    private static string GetRelativeTime(DateTime value)
    {
        var delta = DateTime.UtcNow - value;
        if (delta.TotalDays >= 1)
        {
            return $"ha {(int)delta.TotalDays} dia(s)";
        }

        if (delta.TotalHours >= 1)
        {
            return $"ha {(int)delta.TotalHours} hora(s)";
        }

        return "agora";
    }

    private MudBlazor.Color GetStatusColor(TenantStatus status) => status switch
    {
        TenantStatus.Active => MudBlazor.Color.Success,
        TenantStatus.Provisioning => MudBlazor.Color.Info,
        TenantStatus.Suspended => MudBlazor.Color.Warning,
        TenantStatus.Disabled => MudBlazor.Color.Dark,
        TenantStatus.Archived => MudBlazor.Color.Secondary,
        _ => MudBlazor.Color.Default
    };

    private static string GetStatusLabel(TenantStatus status) => status switch
    {
        TenantStatus.Active => "Ativo",
        TenantStatus.Provisioning => "Provisionando",
        TenantStatus.Suspended => "Suspenso",
        TenantStatus.Disabled => "Desativado",
        TenantStatus.Archived => "Arquivado",
        _ => status.ToString()
    };
}
