@page "/financial/dashboard"
@using erp.DTOs.Financial
@attribute [Authorize]

<PageTitle>Dashboard Financeiro - Pillar ERP</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.Dashboard" Class="mr-2" />
        Dashboard Financeiro
    </MudText>

    @if (isLoading)
    {
        <MudProgressLinear Indeterminate="true" Color="MudBlazor.Color.Primary" />
    }
    else if (dashboardData != null)
    {
        <MudGrid>
            <!-- Summary Cards -->
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-4" Elevation="3">
                    <MudStack Spacing="2">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                            <MudIcon Icon="@Icons.Material.Filled.CallReceived" Color="MudBlazor.Color.Success" Size="Size.Large" />
                            <MudChip T="string" Size="Size.Small" Color="MudBlazor.Color.Success">Receitas</MudChip>
                        </MudStack>
                        <MudText Typo="Typo.h6" Color="Color.Secondary">Contas a Receber</MudText>
                        <MudText Typo="Typo.h4">@dashboardData.TotalReceivablePending.ToString("C2")</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Error">
                            Vencidas: @dashboardData.TotalReceivableOverdue.ToString("C2") (@dashboardData.ReceivablesOverdueCount)
                        </MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-4" Elevation="3">
                    <MudStack Spacing="2">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                            <MudIcon Icon="@Icons.Material.Filled.CallMade" Color="MudBlazor.Color.Error" Size="Size.Large" />
                            <MudChip T="string" Size="Size.Small" Color="MudBlazor.Color.Error">Despesas</MudChip>
                        </MudStack>
                        <MudText Typo="Typo.h6" Color="Color.Secondary">Contas a Pagar</MudText>
                        <MudText Typo="Typo.h4">@dashboardData.TotalPayablePending.ToString("C2")</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Error">
                            Vencidas: @dashboardData.TotalPayableOverdue.ToString("C2") (@dashboardData.PayablesOverdueCount)
                        </MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-4" Elevation="3">
                    <MudStack Spacing="2">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                            <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Color="MudBlazor.Color.Info" Size="Size.Large" />
                            <MudChip T="string" Size="Size.Small" Color="MudBlazor.Color.Info">Saldo</MudChip>
                        </MudStack>
                        <MudText Typo="Typo.h6" Color="Color.Secondary">Saldo Previsto</MudText>
                        <MudText Typo="Typo.h4" Color="@(dashboardData.ForecastedBalance >= 0 ? MudBlazor.Color.Success : MudBlazor.Color.Error)">
                            @dashboardData.ForecastedBalance.ToString("C2")
                        </MudText>
                        <MudText Typo="Typo.caption">
                            (Recebíveis - Pagáveis)
                        </MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-4" Elevation="3">
                    <MudStack Spacing="2">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                            <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Color="MudBlazor.Color.Warning" Size="Size.Large" />
                            <MudChip T="string" Size="Size.Small" Color="MudBlazor.Color.Warning">Caixa</MudChip>
                        </MudStack>
                        <MudText Typo="Typo.h6" Color="Color.Secondary">Saldo Realizado</MudText>
                        <MudText Typo="Typo.h4" Color="@(dashboardData.CashBalance >= 0 ? MudBlazor.Color.Success : MudBlazor.Color.Error)">
                            @dashboardData.CashBalance.ToString("C2")
                        </MudText>
                         <MudText Typo="Typo.caption">
                            (Recebido - Pago)
                        </MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <!-- Charts Row -->
            <MudItem xs="12" md="8">
                <MudPaper Class="pa-4" Elevation="3">
                    @if (dashboardData.CashFlowProjection.Any())
                    {
                        <ApexChart TItem="CashFlowItemDto"
                                   Title="Fluxo de Caixa (Próximos 30 dias)"
                                   Options="options">

                            <ApexPointSeries TItem="CashFlowItemDto"
                                             Items="dashboardData.CashFlowProjection"
                                             Name="Receitas"
                                             SeriesType="SeriesType.Bar"
                                             XValue="@(e => e.Date.ToString("dd/MM"))"
                                             YValue="@(e => e.Revenue)"
                                             Color="#00C853" />

                            <ApexPointSeries TItem="CashFlowItemDto"
                                             Items="dashboardData.CashFlowProjection"
                                             Name="Despesas"
                                             SeriesType="SeriesType.Bar"
                                             XValue="@(e => e.Date.ToString("dd/MM"))"
                                             YValue="@(e => e.Expense)"
                                             Color="#F44336" />
                        </ApexChart>
                    }
                    else
                    {
                        <MudText Typo="Typo.h6" Class="mb-4">Fluxo de Caixa (Próximos 30 dias)</MudText>
                        <MudText>Sem dados para projeção.</MudText>
                    }
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudPaper Class="pa-4" Elevation="3">
                    <MudText Typo="Typo.h6" Class="mb-4">Aging List (A Pagar)</MudText>
                    @if (dashboardData.PayablesAgingList.Any(x => x.Amount > 0))
                    {
                        <MudChart ChartType="MudBlazor.ChartType.Donut" 
                                  InputData="@dashboardData.PayablesAgingList.Select(x => (double)x.Amount).ToArray()" 
                                  InputLabels="@dashboardData.PayablesAgingList.Select(x => $"{x.Period} ({x.Amount:C0})").ToArray()" 
                                  Width="100%" 
                                  Height="300px" />
                    }
                    else
                    {
                        <MudText>Sem contas em atraso.</MudText>
                    }
                </MudPaper>
            </MudItem>

            <!-- Tables Row -->
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4" Elevation="3">
                    <MudText Typo="Typo.h6" Class="mb-4">Top 5 Clientes</MudText>
                    <MudTable Items="@dashboardData.TopCustomers" Dense="true" Hover="true" Elevation="0">
                        <HeaderContent>
                            <MudTh>Cliente</MudTh>
                            <MudTh>Transações</MudTh>
                            <MudTh>Total</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.Name</MudTd>
                            <MudTd>@context.TransactionCount</MudTd>
                            <MudTd>@context.TotalAmount.ToString("C2")</MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4" Elevation="3">
                    <MudText Typo="Typo.h6" Class="mb-4">Top 5 Fornecedores</MudText>
                    <MudTable Items="@dashboardData.TopSuppliers" Dense="true" Hover="true" Elevation="0">
                        <HeaderContent>
                            <MudTh>Fornecedor</MudTh>
                            <MudTh>Transações</MudTh>
                            <MudTh>Total</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.Name</MudTd>
                            <MudTd>@context.TransactionCount</MudTd>
                            <MudTd>@context.TotalAmount.ToString("C2")</MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    [Inject] private IApiService ApiService { get; set; } = null!;
    [Inject] private ISnackbar Snackbar { get; set; } = null!;

    private FinancialDashboardDto? dashboardData;
    private bool isLoading = false;

    private ApexChartOptions<CashFlowItemDto> options = new();

    protected override async Task OnInitializedAsync()
    {
        options.Chart = new Chart
        {
            Toolbar = new Toolbar
            {
                Show = false
            }
        };
        options.PlotOptions = new PlotOptions
        {
            Bar = new PlotOptionsBar
            {
                Horizontal = false,
                ColumnWidth = "50%"
            }
        };
        options.Xaxis = new XAxis
        {
            Labels = new XAxisLabels
            {
                Rotate = -45
            }
        };
        options.Yaxis = new List<YAxis>
        {
            new YAxis
            {
                Labels = new YAxisLabels
                {
                    Formatter = @"function (value) {
                        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
                    }"
                }
            }
        };
        options.Tooltip = new Tooltip
        {
            Y = new TooltipY
            {
                Formatter = @"function (value) {
                    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
                }"
            }
        };

        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        isLoading = true;
        try
        {
            dashboardData = await ApiService.GetAsync<FinancialDashboardDto>("api/financial-dashboard");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar dashboard: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }
}
