@page "/financial/dashboard"
@using erp.DTOs.Financial
@using erp.Services
@using erp.Services.Authorization
@attribute [Authorize(Policy = ModulePolicies.Financial)]

<PageTitle>Dashboard Financeiro - Pillar ERP</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudText Typo="Typo.h4">
            <MudIcon Icon="@Icons.Material.Filled.Dashboard" Class="mr-2" />
            Dashboard Financeiro
        </MudText>
    </MudStack>

    <!-- Quick Access Buttons -->
    <MudStack Row="true" Spacing="2" Class="mb-4">
        <MudButton Variant="Variant.Outlined" Color="MudBlazor.Color.Success" 
                   StartIcon="@Icons.Material.Filled.CallReceived"
                   OnClick="@(() => NavigateTo("/financial/accounts-receivable"))">
            Contas a Receber
        </MudButton>
        <MudButton Variant="Variant.Outlined" Color="MudBlazor.Color.Error" 
                   StartIcon="@Icons.Material.Filled.CallMade"
                   OnClick="@(() => NavigateTo("/financial/accounts-payable"))">
            Contas a Pagar
        </MudButton>
        <MudButton Variant="Variant.Outlined" Color="MudBlazor.Color.Primary" 
                   StartIcon="@Icons.Material.Filled.LocalShipping"
                   OnClick="@(() => NavigateTo("/financial/suppliers"))">
            Fornecedores
        </MudButton>
        <MudButton Variant="Variant.Outlined" Color="MudBlazor.Color.Info"
                   StartIcon="@Icons.Material.Filled.Assessment"
                   OnClick="@(() => NavigateTo("/reports/financial?tab=daily"))">
            Relatorio Diario
        </MudButton>
    </MudStack>

    @if (isLoading)
    {
        <MudProgressLinear Indeterminate="true" Color="MudBlazor.Color.Primary" />
    }
    else if (_hasError)
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mb-4">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudText>Ocorreu um erro ao carregar o dashboard financeiro. Por favor, tente novamente.</MudText>
                <MudButton Variant="Variant.Text" Color="MudBlazor.Color.Inherit" OnClick="LoadDashboardData">
                    <MudIcon Icon="@Icons.Material.Filled.Refresh" Class="mr-1" />
                    Tentar Novamente
                </MudButton>
            </MudStack>
        </MudAlert>
    }
    else if (dashboardData != null)
    {
        <MudGrid>
            <!-- Main Row: Chart + Summary Cards Side by Side -->
            <!-- Chart Column -->
            <MudItem xs="12" lg="9">
                <MudPaper Class="pa-4" Elevation="3" Style="height: 100%;">
                    @if (dashboardData.CashFlowProjection.Any())
                    {
                        <ApexChart TItem="CashFlowItemDto"
                                   Title="Fluxo de Caixa (Próximos 60 dias)"
                                   Options="options"
                                   Height="450">

                            <ApexPointSeries TItem="CashFlowItemDto"
                                             Items="dashboardData.CashFlowProjection"
                                             Name="Receitas"
                                             SeriesType="SeriesType.Bar"
                                             XValue="@(e => e.Date.ToString("dd/MM"))"
                                             YValue="@(e => e.Revenue)"
                                             Color="#00C853" />

                            <ApexPointSeries TItem="CashFlowItemDto"
                                             Items="dashboardData.CashFlowProjection"
                                             Name="Despesas"
                                             SeriesType="SeriesType.Bar"
                                             XValue="@(e => e.Date.ToString("dd/MM"))"
                                             YValue="@(e => Math.Abs(e.Expense))"
                                             Color="#F44336" />

                            <ApexPointSeries TItem="CashFlowItemDto"
                                             Items="dashboardData.CashFlowProjection"
                                             Name="Saldo Acumulado"
                                             SeriesType="SeriesType.Line"
                                             XValue="@(e => e.Date.ToString("dd/MM"))"
                                             YValue="@(e => e.CumulativeBalance)"
                                             Color="#2196F3" />
                        </ApexChart>
                    }
                    else
                    {
                        <MudText Typo="Typo.h6" Class="mb-4">Fluxo de Caixa (Próximos 60 dias)</MudText>
                        <MudText>Sem movimentações pendentes no período.</MudText>
                    }
                </MudPaper>
            </MudItem>

            <!-- Summary Cards Column -->
            <MudItem xs="12" lg="3">
                <MudStack Spacing="2">
                    <!-- A Receber -->
                    <MudPaper Class="pa-3 cursor-pointer hover-card" Elevation="3" @onclick="@(() => NavigateTo("/financial/accounts-receivable"))">
                        <MudStack Spacing="0">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudIcon Icon="@Icons.Material.Filled.CallReceived" Color="MudBlazor.Color.Success" Size="Size.Small" />
                                <MudChip T="string" Size="Size.Small" Color="MudBlazor.Color.Success">Receitas</MudChip>
                            </MudStack>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">A Receber (Pendente)</MudText>
                            <MudText Typo="Typo.h6">@Currency.Format(dashboardData.TotalReceivablePending + dashboardData.TotalReceivableOverdue)</MudText>
                            <MudText Typo="Typo.caption" Color="MudBlazor.Color.Success">
                                Recebido: @Currency.Format(dashboardData.TotalReceivablePaid)
                            </MudText>
                            @if (dashboardData.ReceivablesOverdueCount > 0)
                            {
                                <MudText Typo="Typo.caption" Color="MudBlazor.Color.Error">
                                    <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Small" Class="mr-1" />
                                    Vencidas: @Currency.Format(dashboardData.TotalReceivableOverdue) (@dashboardData.ReceivablesOverdueCount)
                                </MudText>
                            }
                        </MudStack>
                    </MudPaper>

                    <!-- A Pagar -->
                    <MudPaper Class="pa-3 cursor-pointer hover-card" Elevation="3" @onclick="@(() => NavigateTo("/financial/accounts-payable"))">
                        <MudStack Spacing="0">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudIcon Icon="@Icons.Material.Filled.CallMade" Color="MudBlazor.Color.Error" Size="Size.Small" />
                                <MudChip T="string" Size="Size.Small" Color="MudBlazor.Color.Error">Despesas</MudChip>
                            </MudStack>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">A Pagar (Pendente)</MudText>
                            <MudText Typo="Typo.h6">@Currency.Format(dashboardData.TotalPayablePending + dashboardData.TotalPayableOverdue)</MudText>
                            <MudText Typo="Typo.caption" Color="MudBlazor.Color.Error">
                                Pago: @Currency.Format(dashboardData.TotalPayablePaid)
                            </MudText>
                            @if (dashboardData.PayablesOverdueCount > 0)
                            {
                                <MudText Typo="Typo.caption" Color="MudBlazor.Color.Error">
                                    <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Small" Class="mr-1" />
                                    Vencidas: @Currency.Format(dashboardData.TotalPayableOverdue) (@dashboardData.PayablesOverdueCount)
                                </MudText>
                            }
                        </MudStack>
                    </MudPaper>

                    <!-- Saldo Previsto -->
                    <MudPaper Class="pa-3" Elevation="3">
                        <MudStack Spacing="0">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Color="MudBlazor.Color.Info" Size="Size.Small" />
                                <MudChip T="string" Size="Size.Small" Color="MudBlazor.Color.Info">Saldo</MudChip>
                            </MudStack>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Saldo Previsto</MudText>
                            <MudText Typo="Typo.h6" Color="@(dashboardData.ForecastedBalance >= 0 ? MudBlazor.Color.Success : MudBlazor.Color.Error)">
                                @Currency.Format(dashboardData.ForecastedBalance)
                            </MudText>
                            <MudText Typo="Typo.caption">(Realizado + Pendentes)</MudText>
                        </MudStack>
                    </MudPaper>

                    <!-- Saldo Realizado -->
                    <MudPaper Class="pa-3" Elevation="3">
                        <MudStack Spacing="0">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Color="MudBlazor.Color.Warning" Size="Size.Small" />
                                <MudChip T="string" Size="Size.Small" Color="MudBlazor.Color.Warning">Caixa</MudChip>
                            </MudStack>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Saldo Realizado</MudText>
                            <MudText Typo="Typo.h6" Color="@(dashboardData.CashBalance >= 0 ? MudBlazor.Color.Success : MudBlazor.Color.Error)">
                                @Currency.Format(dashboardData.CashBalance)
                            </MudText>
                            <MudText Typo="Typo.caption">(Recebido - Pago)</MudText>
                        </MudStack>
                    </MudPaper>
                </MudStack>
            </MudItem>

            <!-- Cash Flow Alerts Banner -->
            @if (dashboardData.CashFlowAlerts.Any())
            {
                <MudItem xs="12">
                    <MudAlert Severity="@(dashboardData.CashFlowAlerts.Any(a => a.Severity == "Critical") ? Severity.Error : Severity.Warning)" 
                              Variant="Variant.Filled" Dense="true" Class="mb-0">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudStack>
                                <MudText Typo="Typo.subtitle1">
                                    <MudIcon Icon="@Icons.Material.Filled.Warning" Class="mr-1" Size="Size.Small" />
                                    Alerta de Fluxo de Caixa: @dashboardData.CashFlowAlerts.Count dia(s) com saldo negativo projetado
                                </MudText>
                                <MudText Typo="Typo.body2">
                                    Primeiro dia crítico: @dashboardData.CashFlowAlerts.First().Date.ToString("dd/MM/yyyy") 
                                    (Saldo projetado: @Currency.Format(dashboardData.CashFlowAlerts.First().ProjectedBalance))
                                </MudText>
                            </MudStack>
                            <MudButton Variant="Variant.Text" Color="MudBlazor.Color.Inherit" Size="Size.Small"
                                       OnClick="() => _showAlertDetails = !_showAlertDetails">
                                @(_showAlertDetails ? "Ocultar" : "Ver Detalhes")
                            </MudButton>
                        </MudStack>
                    </MudAlert>
                </MudItem>
                
                @if (_showAlertDetails)
                {
                    <MudItem xs="12">
                        <MudPaper Class="pa-4" Elevation="2">
                            <MudText Typo="Typo.subtitle1" Class="mb-2">Dias com Saldo Negativo Projetado</MudText>
                            <MudSimpleTable Dense="true" Hover="true" Style="overflow-x: auto;">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Saldo Projetado</th>
                                        <th>Déficit</th>
                                        <th>Severidade</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var alert in dashboardData.CashFlowAlerts.Take(10))
                                    {
                                        <tr>
                                            <td>@alert.Date.ToString("dd/MM/yyyy (ddd)")</td>
                                            <td style="color: #F44336; font-weight: bold;">@Currency.Format(alert.ProjectedBalance)</td>
                                            <td>@Currency.Format(alert.Shortfall)</td>
                                            <td>
                                                <MudChip T="string" Size="Size.Small" 
                                                         Color="@(alert.Severity == "Critical" ? MudBlazor.Color.Error : MudBlazor.Color.Warning)">
                                                    @(alert.Severity == "Critical" ? "Crítico" : "Atenção")
                                                </MudChip>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </MudSimpleTable>
                        </MudPaper>
                    </MudItem>
                }
            }
        </MudGrid>
    }
</MudContainer>

@code {
    [Inject] private IApiService ApiService { get; set; } = null!;
    [Inject] private ISnackbar Snackbar { get; set; } = null!;
    [Inject] private CurrencyFormatService Currency { get; set; } = null!;
    [Inject] private NavigationManager NavigationManager { get; set; } = null!;

    private FinancialDashboardDto? dashboardData;
    private bool isLoading = false;
    private bool _hasError = false;
    private decimal _initialBalance = 0;
    private bool _showAlertDetails = false;

    private ApexChartOptions<CashFlowItemDto> options = new();
    private ApexChartOptions<AgingListItemDto> donutOptions = new();
    private ApexChartOptions<AgingListItemDto> donutOptionsReceivables = new();

    private void NavigateTo(string url)
    {
        NavigationManager.NavigateTo(url);
    }

    protected override async Task OnInitializedAsync()
    {
        // Bar Chart Options
        options.Chart = new Chart
        {
            Toolbar = new Toolbar
            {
                Show = false
            }
        };
        options.PlotOptions = new PlotOptions
        {
            Bar = new PlotOptionsBar
            {
                Horizontal = false,
                ColumnWidth = "50%"
            }
        };
        options.Xaxis = new XAxis
        {
            Labels = new XAxisLabels
            {
                Rotate = -45
            }
        };
        options.Yaxis = new List<YAxis>
        {
            new YAxis
            {
                SeriesName = "Receitas",
                Title = new AxisTitle { Text = "Receitas / Despesas (R$)" },
                Min = 0,
                Labels = new YAxisLabels
                {
                    Formatter = @"function (value) {
                        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
                    }"
                }
            },
            new YAxis
            {
                SeriesName = "Despesas",
                Show = false,
                Min = 0
            },
            new YAxis
            {
                SeriesName = "Saldo Acumulado",
                Opposite = true,
                Title = new AxisTitle { Text = "Saldo Acumulado (R$)" },
                Labels = new YAxisLabels
                {
                    Formatter = @"function (value) {
                        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
                    }"
                }
            }
        };
        options.Stroke = new Stroke
        {
            Width = new List<double> { 0, 0, 3 },
            Curve = Curve.Smooth
        };
        options.Annotations = new Annotations
        {
            Yaxis = new List<AnnotationsYAxis>
            {
                new AnnotationsYAxis
                {
                    Y = 0,
                    BorderColor = "#FF5722",
                    StrokeDashArray = 4,
                    Label = new Label 
                    { 
                        Text = "Saldo Zero",
                        Style = new Style { Background = "#FF5722", Color = "#fff" }
                    }
                }
            }
        };
        options.Tooltip = new Tooltip
        {
            Y = new TooltipY
            {
                Formatter = @"function (value) {
                    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
                }"
            }
        };

        // Donut Chart Options - Payables
        donutOptions.Chart = new Chart
        {
            Toolbar = new Toolbar { Show = false }
        };
        donutOptions.PlotOptions = new PlotOptions
        {
            Pie = new PlotOptionsPie
            {
                Donut = new PlotOptionsDonut()
            }
        };
        donutOptions.Tooltip = new Tooltip
        {
            Y = new TooltipY
            {
                Formatter = @"function (value) {
                    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
                }"
            }
        };
        donutOptions.Legend = new Legend
        {
            Position = LegendPosition.Bottom
        };
        donutOptions.Colors = new List<string> { "#F44336", "#FF5722", "#FF9800", "#FFC107" };

        // Donut Chart Options - Receivables
        donutOptionsReceivables.Chart = new Chart
        {
            Toolbar = new Toolbar { Show = false }
        };
        donutOptionsReceivables.PlotOptions = new PlotOptions
        {
            Pie = new PlotOptionsPie
            {
                Donut = new PlotOptionsDonut()
            }
        };
        donutOptionsReceivables.Tooltip = new Tooltip
        {
            Y = new TooltipY
            {
                Formatter = @"function (value) {
                    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
                }"
            }
        };
        donutOptionsReceivables.Legend = new Legend
        {
            Position = LegendPosition.Bottom
        };
        donutOptionsReceivables.Colors = new List<string> { "#4CAF50", "#8BC34A", "#CDDC39", "#FFEB3B" };

        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        isLoading = true;
        _hasError = false;
        try
        {
            dashboardData = await ApiService.GetAsync<FinancialDashboardDto>($"api/financial-dashboard?initialBalance={_initialBalance}");
            if (dashboardData == null)
            {
                _hasError = true;
            }
        }
        catch (Exception ex)
        {
            _hasError = true;
            Snackbar.Add($"Erro ao carregar dashboard: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }
}

<style>
    .hover-card {
        transition: all 0.3s ease;
    }

    .hover-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.15) !important;
    }

    .cursor-pointer {
        cursor: pointer;
    }
</style>
