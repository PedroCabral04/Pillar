@page "/financial/dashboard"
@using erp.DTOs.Financial
@attribute [Authorize]

<PageTitle>Dashboard Financeiro - Pillar ERP</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudText Typo="Typo.h4">
            <MudIcon Icon="@Icons.Material.Filled.Dashboard" Class="mr-2" />
            Dashboard Financeiro
        </MudText>
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudNumericField T="decimal" @bind-Value="_initialBalance" Label="Saldo Inicial (R$)" 
                             Variant="Variant.Outlined" Format="N2" Style="width: 180px;"
                             Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.AttachMoney"
                             HelperText="Saldo atual em caixa" />
            <MudButton Variant="Variant.Filled" Color="MudBlazor.Color.Primary" OnClick="LoadDashboardData" 
                       StartIcon="@Icons.Material.Filled.Refresh">
                Atualizar
            </MudButton>
        </MudStack>
    </MudStack>

    @if (isLoading)
    {
        <MudProgressLinear Indeterminate="true" Color="MudBlazor.Color.Primary" />
    }
    else if (dashboardData != null)
    {
        <MudGrid>
            <!-- Summary Cards -->
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-4" Elevation="3">
                    <MudStack Spacing="2">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                            <MudIcon Icon="@Icons.Material.Filled.CallReceived" Color="MudBlazor.Color.Success" Size="Size.Large" />
                            <MudChip T="string" Size="Size.Small" Color="MudBlazor.Color.Success">Receitas</MudChip>
                        </MudStack>
                        <MudText Typo="Typo.h6" Color="Color.Secondary">Contas a Receber</MudText>
                        <MudText Typo="Typo.h4">@dashboardData.TotalReceivablePending.ToString("C2")</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Error">
                            Vencidas: @dashboardData.TotalReceivableOverdue.ToString("C2") (@dashboardData.ReceivablesOverdueCount)
                        </MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-4" Elevation="3">
                    <MudStack Spacing="2">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                            <MudIcon Icon="@Icons.Material.Filled.CallMade" Color="MudBlazor.Color.Error" Size="Size.Large" />
                            <MudChip T="string" Size="Size.Small" Color="MudBlazor.Color.Error">Despesas</MudChip>
                        </MudStack>
                        <MudText Typo="Typo.h6" Color="Color.Secondary">Contas a Pagar</MudText>
                        <MudText Typo="Typo.h4">@dashboardData.TotalPayablePending.ToString("C2")</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Error">
                            Vencidas: @dashboardData.TotalPayableOverdue.ToString("C2") (@dashboardData.PayablesOverdueCount)
                        </MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-4" Elevation="3">
                    <MudStack Spacing="2">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                            <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Color="MudBlazor.Color.Info" Size="Size.Large" />
                            <MudChip T="string" Size="Size.Small" Color="MudBlazor.Color.Info">Saldo</MudChip>
                        </MudStack>
                        <MudText Typo="Typo.h6" Color="Color.Secondary">Saldo Previsto</MudText>
                        <MudText Typo="Typo.h4" Color="@(dashboardData.ForecastedBalance >= 0 ? MudBlazor.Color.Success : MudBlazor.Color.Error)">
                            @dashboardData.ForecastedBalance.ToString("C2")
                        </MudText>
                        <MudText Typo="Typo.caption">
                            (Recebíveis - Pagáveis)
                        </MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-4" Elevation="3">
                    <MudStack Spacing="2">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                            <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Color="MudBlazor.Color.Warning" Size="Size.Large" />
                            <MudChip T="string" Size="Size.Small" Color="MudBlazor.Color.Warning">Caixa</MudChip>
                        </MudStack>
                        <MudText Typo="Typo.h6" Color="Color.Secondary">Saldo Realizado</MudText>
                        <MudText Typo="Typo.h4" Color="@(dashboardData.CashBalance >= 0 ? MudBlazor.Color.Success : MudBlazor.Color.Error)">
                            @dashboardData.CashBalance.ToString("C2")
                        </MudText>
                         <MudText Typo="Typo.caption">
                            (Recebido - Pago)
                        </MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <!-- Cash Flow Alerts Banner -->
            @if (dashboardData.CashFlowAlerts.Any())
            {
                <MudItem xs="12">
                    <MudAlert Severity="@(dashboardData.CashFlowAlerts.Any(a => a.Severity == "Critical") ? Severity.Error : Severity.Warning)" 
                              Variant="Variant.Filled" Dense="true" Class="mb-0">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudStack>
                                <MudText Typo="Typo.subtitle1">
                                    <MudIcon Icon="@Icons.Material.Filled.Warning" Class="mr-1" Size="Size.Small" />
                                    Alerta de Fluxo de Caixa: @dashboardData.CashFlowAlerts.Count dia(s) com saldo negativo projetado
                                </MudText>
                                <MudText Typo="Typo.body2">
                                    Primeiro dia crítico: @dashboardData.CashFlowAlerts.First().Date.ToString("dd/MM/yyyy") 
                                    (Saldo projetado: @dashboardData.CashFlowAlerts.First().ProjectedBalance.ToString("C2"))
                                </MudText>
                            </MudStack>
                            <MudButton Variant="Variant.Text" Color="MudBlazor.Color.Inherit" Size="Size.Small"
                                       OnClick="() => _showAlertDetails = !_showAlertDetails">
                                @(_showAlertDetails ? "Ocultar" : "Ver Detalhes")
                            </MudButton>
                        </MudStack>
                    </MudAlert>
                </MudItem>
                
                @if (_showAlertDetails)
                {
                    <MudItem xs="12">
                        <MudPaper Class="pa-4" Elevation="2">
                            <MudText Typo="Typo.subtitle1" Class="mb-2">Dias com Saldo Negativo Projetado</MudText>
                            <MudSimpleTable Dense="true" Hover="true" Style="overflow-x: auto;">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Saldo Projetado</th>
                                        <th>Déficit</th>
                                        <th>Severidade</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var alert in dashboardData.CashFlowAlerts.Take(10))
                                    {
                                        <tr>
                                            <td>@alert.Date.ToString("dd/MM/yyyy (ddd)")</td>
                                            <td style="color: #F44336; font-weight: bold;">@alert.ProjectedBalance.ToString("C2")</td>
                                            <td>@alert.Shortfall.ToString("C2")</td>
                                            <td>
                                                <MudChip T="string" Size="Size.Small" 
                                                         Color="@(alert.Severity == "Critical" ? MudBlazor.Color.Error : MudBlazor.Color.Warning)">
                                                    @(alert.Severity == "Critical" ? "Crítico" : "Atenção")
                                                </MudChip>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </MudSimpleTable>
                        </MudPaper>
                    </MudItem>
                }
            }

            <!-- Charts Row -->
            <MudItem xs="12" md="8">
                <MudPaper Class="pa-4" Elevation="3">
                    @if (dashboardData.CashFlowProjection.Any())
                    {
                        <ApexChart TItem="CashFlowItemDto"
                                   Title="Fluxo de Caixa (Próximos 30 dias)"
                                   Options="options">

                            <ApexPointSeries TItem="CashFlowItemDto"
                                             Items="dashboardData.CashFlowProjection"
                                             Name="Receitas"
                                             SeriesType="SeriesType.Bar"
                                             XValue="@(e => e.Date.ToString("dd/MM"))"
                                             YValue="@(e => e.Revenue)"
                                             Color="#00C853" />

                            <ApexPointSeries TItem="CashFlowItemDto"
                                             Items="dashboardData.CashFlowProjection"
                                             Name="Despesas"
                                             SeriesType="SeriesType.Bar"
                                             XValue="@(e => e.Date.ToString("dd/MM"))"
                                             YValue="@(e => e.Expense)"
                                             Color="#F44336" />

                            <ApexPointSeries TItem="CashFlowItemDto"
                                             Items="dashboardData.CashFlowProjection"
                                             Name="Saldo Acumulado"
                                             SeriesType="SeriesType.Line"
                                             XValue="@(e => e.Date.ToString("dd/MM"))"
                                             YValue="@(e => e.CumulativeBalance)"
                                             Color="#2196F3" />
                        </ApexChart>
                    }
                    else
                    {
                        <MudText Typo="Typo.h6" Class="mb-4">Fluxo de Caixa (Próximos 30 dias)</MudText>
                        <MudText>Sem dados para projeção.</MudText>
                    }
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudPaper Class="pa-4" Elevation="3">
                    <MudText Typo="Typo.h6" Class="mb-4">Aging List (A Pagar)</MudText>
                    @if (dashboardData.PayablesAgingList.Any(x => x.Amount > 0))
                    {
                        <ApexChart TItem="AgingListItemDto"
                                   Title=""
                                   Options="donutOptions">
                            <ApexPointSeries TItem="AgingListItemDto"
                                             Items="dashboardData.PayablesAgingList"
                                             Name="Valor"
                                             SeriesType="SeriesType.Donut"
                                             XValue="@(e => e.Period)"
                                             YValue="@(e => e.Amount)" />
                        </ApexChart>
                    }
                    else
                    {
                        <MudText>Sem contas em atraso.</MudText>
                    }
                </MudPaper>
            </MudItem>

            <!-- Tables Row -->
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4" Elevation="3">
                    <MudText Typo="Typo.h6" Class="mb-4">Top 5 Clientes</MudText>
                    <MudTable Items="@dashboardData.TopCustomers" Dense="true" Hover="true" Elevation="0">
                        <HeaderContent>
                            <MudTh>Cliente</MudTh>
                            <MudTh>Transações</MudTh>
                            <MudTh>Total</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.Name</MudTd>
                            <MudTd>@context.TransactionCount</MudTd>
                            <MudTd>@context.TotalAmount.ToString("C2")</MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4" Elevation="3">
                    <MudText Typo="Typo.h6" Class="mb-4">Top 5 Fornecedores</MudText>
                    <MudTable Items="@dashboardData.TopSuppliers" Dense="true" Hover="true" Elevation="0">
                        <HeaderContent>
                            <MudTh>Fornecedor</MudTh>
                            <MudTh>Transações</MudTh>
                            <MudTh>Total</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.Name</MudTd>
                            <MudTd>@context.TransactionCount</MudTd>
                            <MudTd>@context.TotalAmount.ToString("C2")</MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    [Inject] private IApiService ApiService { get; set; } = null!;
    [Inject] private ISnackbar Snackbar { get; set; } = null!;

    private FinancialDashboardDto? dashboardData;
    private bool isLoading = false;
    private decimal _initialBalance = 0;
    private bool _showAlertDetails = false;

    private ApexChartOptions<CashFlowItemDto> options = new();
    private ApexChartOptions<AgingListItemDto> donutOptions = new();

    protected override async Task OnInitializedAsync()
    {
        // Bar Chart Options
        options.Chart = new Chart
        {
            Toolbar = new Toolbar
            {
                Show = false
            }
        };
        options.PlotOptions = new PlotOptions
        {
            Bar = new PlotOptionsBar
            {
                Horizontal = false,
                ColumnWidth = "50%"
            }
        };
        options.Xaxis = new XAxis
        {
            Labels = new XAxisLabels
            {
                Rotate = -45
            }
        };
        options.Yaxis = new List<YAxis>
        {
            new YAxis
            {
                Title = new AxisTitle { Text = "Receitas / Despesas (R$)" },
                Labels = new YAxisLabels
                {
                    Formatter = @"function (value) {
                        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
                    }"
                }
            },
            new YAxis
            {
                Opposite = true,
                Title = new AxisTitle { Text = "Saldo Acumulado (R$)" },
                Labels = new YAxisLabels
                {
                    Formatter = @"function (value) {
                        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
                    }"
                }
            }
        };
        options.Stroke = new Stroke
        {
            Width = new List<double> { 0, 0, 3 },
            Curve = Curve.Smooth
        };
        options.Annotations = new Annotations
        {
            Yaxis = new List<AnnotationsYAxis>
            {
                new AnnotationsYAxis
                {
                    Y = 0,
                    BorderColor = "#FF5722",
                    StrokeDashArray = 4,
                    Label = new Label 
                    { 
                        Text = "Saldo Zero",
                        Style = new Style { Background = "#FF5722", Color = "#fff" }
                    }
                }
            }
        };
        options.Tooltip = new Tooltip
        {
            Y = new TooltipY
            {
                Formatter = @"function (value) {
                    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
                }"
            }
        };

        // Donut Chart Options
        donutOptions.Chart = new Chart
        {
            Toolbar = new Toolbar { Show = false }
        };
        donutOptions.PlotOptions = new PlotOptions
        {
            Pie = new PlotOptionsPie
            {
                                Donut = new PlotOptionsDonut()
            }
        };
        donutOptions.Tooltip = new Tooltip
        {
            Y = new TooltipY
            {
                Formatter = @"function (value) {
                    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
                }"
            }
        };
        donutOptions.Legend = new Legend
        {
            Position = LegendPosition.Bottom
        };

        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        isLoading = true;
        try
        {
            dashboardData = await ApiService.GetAsync<FinancialDashboardDto>($"api/financial-dashboard?initialBalance={_initialBalance}");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar dashboard: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }
}
