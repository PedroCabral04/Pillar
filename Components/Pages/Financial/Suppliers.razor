@page "/financial/suppliers"
@using erp.DTOs.Financial
@attribute [Authorize]

<PageTitle>Fornecedores - Pillar ERP</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.LocalShipping" Class="mr-2" />
        Fornecedores
    </MudText>

    <MudPaper Class="pa-4 mb-4">
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudTextField @bind-Value="searchTerm" 
                         Placeholder="Buscar fornecedores..." 
                         Adornment="Adornment.Start" 
                         AdornmentIcon="@Icons.Material.Filled.Search"
                         Class="flex-grow-1" />
            
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      StartIcon="@Icons.Material.Filled.Add"
                      OnClick="@(() => Snackbar.Add("Criar fornecedor - em desenvolvimento", Severity.Info))">
                Novo Fornecedor
            </MudButton>
        </MudStack>
    </MudPaper>

    <MudPaper Class="pa-4">
        <MudDataGrid T="SupplierDto" 
                    Items="@suppliers" 
                    Loading="@isLoading"
                    Dense="true"
                    Hover="true">
            <Columns>
                <PropertyColumn Property="x => x.Name" Title="Nome" />
                <PropertyColumn Property="x => x.TaxId" Title="CNPJ" />
                <PropertyColumn Property="x => x.Email" Title="Email" />
                <PropertyColumn Property="x => x.Phone" Title="Telefone" />
                <TemplateColumn Title="Status">
                    <CellTemplate>
                        <MudChip T="string" Size="Size.Small" 
                                Color="@(context.Item.IsActive ? Color.Success : Color.Default)">
                            @(context.Item.IsActive ? "Ativo" : "Inativo")
                        </MudChip>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
    </MudPaper>
</MudContainer>

@code {
    [Inject] private IApiService ApiService { get; set; } = null!;
    [Inject] private ISnackbar Snackbar { get; set; } = null!;

    private List<SupplierDto> suppliers = new();
    private bool isLoading = false;
    private string searchTerm = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadSuppliers();
    }

    private async Task LoadSuppliers()
    {
        isLoading = true;
        try
        {
            suppliers = await ApiService.GetAsync<List<SupplierDto>>("api/suppliers") ?? new();
            Snackbar.Add($"{suppliers.Count} fornecedores carregados", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar fornecedores: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }
}
