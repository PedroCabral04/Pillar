@page "/financial/costcenters"
@using erp.DTOs.Financial
@using erp.DTOs.User
@using erp.Components.Shared.Dialogs.Financial
@attribute [Authorize]

<PageTitle>Centros de Custo - Pillar ERP</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" Class="mr-2" />
        Centros de Custo
    </MudText>

    <MudPaper Class="pa-4 mb-4">
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudTextField @bind-Value="searchTerm" 
                         Placeholder="Buscar centros de custo..." 
                         Adornment="Adornment.Start" 
                         AdornmentIcon="@Icons.Material.Filled.Search"
                         Class="flex-grow-1" 
                         DebounceInterval="500"
                         OnDebounceIntervalElapsed="OnSearch" />
            
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      StartIcon="@Icons.Material.Filled.Add"
                      OnClick="OpenCreateDialog">
                Novo Centro de Custo
            </MudButton>
        </MudStack>
    </MudPaper>

    <MudGrid>
        @foreach (var costCenter in costCenters)
        {
            <MudItem xs="12" sm="6" md="4">
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" Color="Color.Primary" />
                                <MudText Typo="Typo.h6">@costCenter.Name</MudText>
                            </MudStack>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Código: @costCenter.Code</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudMenu Icon="@Icons.Material.Filled.MoreVert">
                                <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="@(() => OpenEditDialog(costCenter))">Editar</MudMenuItem>
                                <MudMenuItem Icon="@Icons.Material.Filled.Delete" IconColor="Color.Error" OnClick="@(() => DeleteCostCenter(costCenter))">Excluir</MudMenuItem>
                            </MudMenu>
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (!string.IsNullOrWhiteSpace(costCenter.Description))
                        {
                            <MudText Typo="Typo.body2" Class="mb-3">@costCenter.Description</MudText>
                        }
                        
                        @if (costCenter.ManagerUserId.HasValue && costCenter.ManagerName != null)
                        {
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-2">
                                <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Color="Color.Info" />
                                <MudText Typo="Typo.body2">Gerente: @costCenter.ManagerName</MudText>
                            </MudStack>
                        }
                        
                        @if (costCenter.MonthlyBudget.HasValue)
                        {
                            <MudStack Spacing="1" Class="mt-3">
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText Typo="Typo.body2">Orçamento Mensal:</MudText>
                                    <MudText Typo="Typo.body2" Style="font-weight: 600;">
                                        @costCenter.MonthlyBudget.Value.ToString("C")
                                    </MudText>
                                </MudStack>
                            </MudStack>
                        }

                        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mt-2">
                            <MudText Typo="Typo.caption">Status:</MudText>
                             <MudChip T="string" Size="Size.Small" 
                                     Color="@(costCenter.IsActive ? Color.Success : Color.Default)"
                                     OnClick="@(() => ToggleActive(costCenter))"
                                     Class="cursor-pointer">
                                @(costCenter.IsActive ? "Ativo" : "Inativo")
                            </MudChip>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        }
    </MudGrid>

    @if (!costCenters.Any() && !isLoading)
    {
        <MudPaper Class="pa-8 mt-4" Elevation="0">
            <MudStack AlignItems="AlignItems.Center" Spacing="3">
                <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Secondary" />
                <MudText Typo="Typo.h6" Color="Color.Secondary">Nenhum centro de custo encontrado</MudText>
            </MudStack>
        </MudPaper>
    }
</MudContainer>

@code {
    [Inject] private IApiService ApiService { get; set; } = null!;
    [Inject] private ISnackbar Snackbar { get; set; } = null!;
    [Inject] private IDialogService DialogService { get; set; } = null!;

    private List<CostCenterDto> costCenters = new();
    private List<UserDto> users = new();
    private bool isLoading = false;
    private string searchTerm = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            var tasks = new List<Task>
            {
                LoadCostCenters(),
                LoadUsers()
            };
            await Task.WhenAll(tasks);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadCostCenters()
    {
        try
        {
            var allCostCenters = await ApiService.GetAsync<List<CostCenterDto>>("api/cost-centers") ?? new();
            
            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                costCenters = allCostCenters.Where(c => 
                    c.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) || 
                    c.Code.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
                ).ToList();
            }
            else
            {
                costCenters = allCostCenters;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar centros de custo: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadUsers()
    {
        try
        {
            // Assuming we have an endpoint to get users for dropdowns
            users = await ApiService.GetAsync<List<UserDto>>("api/users") ?? new();
        }
        catch (Exception ex)
        {
            // Silent fail for users, just won't show in dropdown
            Console.WriteLine($"Error loading users: {ex.Message}");
        }
    }

    private async Task OnSearch()
    {
        await LoadCostCenters();
    }

    private async Task OpenCreateDialog()
    {
        var parameters = new DialogParameters();
        parameters.Add("Users", users);

        var options = new DialogOptions { CloseOnEscapeKey = true };
        var dialog = DialogService.Show<CostCenterDialog>("Novo Centro de Custo", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is CreateCostCenterDto dto)
        {
            try
            {
                await ApiService.PostAsync<CostCenterDto>("api/cost-centers", dto);
                Snackbar.Add("Centro de custo criado com sucesso", Severity.Success);
                await LoadCostCenters();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro ao criar centro de custo: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task OpenEditDialog(CostCenterDto costCenter)
    {
        var parameters = new DialogParameters();
        parameters.Add("Users", users);
        
        var model = new CreateCostCenterDto
        {
            Name = costCenter.Name,
            Code = costCenter.Code,
            Description = costCenter.Description,
            ManagerUserId = costCenter.ManagerUserId,
            MonthlyBudget = costCenter.MonthlyBudget,
            IsActive = costCenter.IsActive
        };
        
        parameters.Add("Model", model);

        var options = new DialogOptions { CloseOnEscapeKey = true };
        var dialog = DialogService.Show<CostCenterDialog>("Editar Centro de Custo", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is CreateCostCenterDto dto)
        {
            try
            {
                var updateDto = new UpdateCostCenterDto
                {
                    Name = dto.Name,
                    Code = dto.Code,
                    Description = dto.Description,
                    ManagerUserId = dto.ManagerUserId,
                    MonthlyBudget = dto.MonthlyBudget,
                    IsActive = dto.IsActive
                };

                await ApiService.PutAsync($"api/cost-centers/{costCenter.Id}", updateDto);
                Snackbar.Add("Centro de custo atualizado com sucesso", Severity.Success);
                await LoadCostCenters();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro ao atualizar centro de custo: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeleteCostCenter(CostCenterDto costCenter)
    {
        var parameters = new DialogParameters();
        parameters.Add("ContentText", $"Tem certeza que deseja excluir o centro de custo {costCenter.Name}?");
        parameters.Add("ButtonText", "Excluir");
        parameters.Add("Color", MudBlazor.Color.Error);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };
        var dialog = DialogService.Show<erp.Components.Shared.Dialogs.ConfirmDialog>("Excluir Centro de Custo", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            try
            {
                await ApiService.DeleteAsync($"api/cost-centers/{costCenter.Id}");
                Snackbar.Add("Centro de custo excluído com sucesso", Severity.Success);
                await LoadCostCenters();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro ao excluir centro de custo: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task ToggleActive(CostCenterDto costCenter)
    {
        try
        {
            await ApiService.PatchAsync<object>($"api/cost-centers/{costCenter.Id}/toggle-active", null);
            costCenter.IsActive = !costCenter.IsActive;
            // No need to reload everything, just toggle UI state
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao alterar status: {ex.Message}", Severity.Error);
            // Revert UI change if failed (though we haven't changed it yet in UI object reference except above line which runs after success usually, but here we are optimistic or need to reload)
            await LoadCostCenters(); 
        }
    }
}
