@page "/financial/categories"
@using erp.DTOs.Financial
@using erp.Models.Financial
@using erp.Components.Shared.Dialogs.Financial
@attribute [Authorize]

<PageTitle>Categorias Financeiras - Pillar ERP</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.Category" Class="mr-2" />
        Categorias Financeiras
    </MudText>

    <MudPaper Class="pa-4 mb-4">
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudButton Variant="Variant.Filled" 
                      Color="@(filterType == null ? Color.Primary : Color.Default)"
                      OnClick="@(() => LoadCategories(null))">
                Todas
            </MudButton>
            <MudButton Variant="Variant.Filled" 
                      Color="@(filterType == CategoryType.Revenue ? Color.Success : Color.Default)"
                      OnClick="@(() => LoadCategories(CategoryType.Revenue))">
                Receitas
            </MudButton>
            <MudButton Variant="Variant.Filled" 
                      Color="@(filterType == CategoryType.Expense ? Color.Error : Color.Default)"
                      OnClick="@(() => LoadCategories(CategoryType.Expense))">
                Despesas
            </MudButton>
            
            <MudSpacer />
            
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      StartIcon="@Icons.Material.Filled.Add"
                      OnClick="OpenCreateDialog">
                Nova Categoria
            </MudButton>
        </MudStack>
    </MudPaper>

    <MudPaper Class="pa-4">
        @if (isLoading)
        {
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
        }
        else
        {
            <MudTable T="FinancialCategoryDto" Items="@categories" Dense="true" Hover="true" Striped="true">
                <HeaderContent>
                    <MudTh><MudTableSortLabel SortBy="new Func<FinancialCategoryDto, object>(x => x.Code)">Código</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortBy="new Func<FinancialCategoryDto, object>(x => x.Name)">Nome</MudTableSortLabel></MudTh>
                    <MudTh>Tipo</MudTh>
                    <MudTh>Categoria Pai</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Ações</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.Code</MudTd>
                    <MudTd>@context.Name</MudTd>
                    <MudTd>
                        <MudChip T="string" Size="Size.Small" 
                                Color="@(context.Type == CategoryType.Revenue ? Color.Success : Color.Error)">
                            @context.TypeDescription
                        </MudChip>
                    </MudTd>
                    <MudTd>@context.ParentCategoryName</MudTd>
                    <MudTd>
                        <MudChip T="string" Size="Size.Small" 
                                Color="@(context.IsActive ? Color.Success : Color.Default)"
                                OnClick="@(() => ToggleActive(context))"
                                Class="cursor-pointer">
                            @(context.IsActive ? "Ativa" : "Inativa")
                        </MudChip>
                    </MudTd>
                    <MudTd>
                        <MudTooltip Text="Editar">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="@(() => OpenEditDialog(context))" />
                        </MudTooltip>
                        <MudTooltip Text="Excluir">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => DeleteCategory(context))" />
                        </MudTooltip>
                    </MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager />
                </PagerContent>
            </MudTable>
        }
    </MudPaper>
</MudContainer>

@code {
    [Inject] private IApiService ApiService { get; set; } = null!;
    [Inject] private ISnackbar Snackbar { get; set; } = null!;
    [Inject] private IDialogService DialogService { get; set; } = null!;

    private List<FinancialCategoryDto> categories = new();
    private bool isLoading = false;
    private CategoryType? filterType = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories(null);
    }

    private async Task LoadCategories(CategoryType? type)
    {
        filterType = type;
        isLoading = true;
        try
        {
            if (type.HasValue)
            {
                categories = await ApiService.GetAsync<List<FinancialCategoryDto>>($"api/financial-categories/by-type/{(int)type.Value}") ?? new();
            }
            else
            {
                categories = await ApiService.GetAsync<List<FinancialCategoryDto>>("api/financial-categories") ?? new();
            }
            
            // Sort by code by default to show hierarchy better
            categories = categories.OrderBy(c => c.Code).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar categorias: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OpenCreateDialog()
    {
        var parameters = new DialogParameters();
        parameters.Add("Categories", categories); // Pass existing categories for parent selection

        var options = new DialogOptions { CloseOnEscapeKey = true };
        var dialog = DialogService.Show<FinancialCategoryDialog>("Nova Categoria", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is CreateFinancialCategoryDto dto)
        {
            try
            {
                await ApiService.PostAsync<FinancialCategoryDto>("api/financial-categories", dto);
                Snackbar.Add("Categoria criada com sucesso", Severity.Success);
                await LoadCategories(filterType);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro ao criar categoria: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task OpenEditDialog(FinancialCategoryDto category)
    {
        var parameters = new DialogParameters();
        parameters.Add("Categories", categories);
        
        var model = new CreateFinancialCategoryDto
        {
            Name = category.Name,
            Code = category.Code,
            Description = category.Description,
            Type = category.Type,
            ParentCategoryId = category.ParentCategoryId,
            IsActive = category.IsActive
        };
        
        parameters.Add("Model", model);

        var options = new DialogOptions { CloseOnEscapeKey = true };
        var dialog = DialogService.Show<FinancialCategoryDialog>("Editar Categoria", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is CreateFinancialCategoryDto dto)
        {
            try
            {
                // We need UpdateFinancialCategoryDto
                var updateDto = new UpdateFinancialCategoryDto
                {
                    Name = dto.Name,
                    Code = dto.Code,
                    Description = dto.Description,
                    Type = dto.Type,
                    ParentCategoryId = dto.ParentCategoryId,
                    IsActive = dto.IsActive
                };

                await ApiService.PutAsync($"api/financial-categories/{category.Id}", updateDto);
                Snackbar.Add("Categoria atualizada com sucesso", Severity.Success);
                await LoadCategories(filterType);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro ao atualizar categoria: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeleteCategory(FinancialCategoryDto category)
    {
        var parameters = new DialogParameters();
        parameters.Add("ContentText", $"Tem certeza que deseja excluir a categoria {category.Name}?");
        parameters.Add("ButtonText", "Excluir");
        parameters.Add("Color", MudBlazor.Color.Error);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };
        var dialog = DialogService.Show<erp.Components.Shared.Dialogs.ConfirmDialog>("Excluir Categoria", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            try
            {
                await ApiService.DeleteAsync($"api/financial-categories/{category.Id}");
                Snackbar.Add("Categoria excluída com sucesso", Severity.Success);
                await LoadCategories(filterType);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro ao excluir categoria: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task ToggleActive(FinancialCategoryDto category)
    {
        try
        {
            await ApiService.PatchAsync<object>($"api/financial-categories/{category.Id}/toggle-active", null);
            category.IsActive = !category.IsActive;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao alterar status: {ex.Message}", Severity.Error);
            await LoadCategories(filterType);
        }
    }
}
