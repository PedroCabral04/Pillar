@page "/dashboard"
@using erp.Services.Dashboard
@using MudBlazor
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Color = MudBlazor.Color
@using Size = MudBlazor.Size
@using erp.Services.Onboarding
@using erp.Services

@inject IDashboardService Dashboard
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IOnboardingService OnboardingService
@inject ISnackbar Snackbar
@inject PreferenceService PreferenceService

<MudStack Spacing="3" id="main-content">
    <!-- Greeting Section -->
    <MudPaper Class="pa-4 dashboard-section" Elevation="2">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudStack Spacing="1">
                <MudText Typo="Typo.h4">@_greeting, @_userName!</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">@DateTime.Now.ToString("dddd, dd 'de' MMMM 'de' yyyy")</MudText>
            </MudStack>
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                @if (!_tourCompleted)
                {
                    <MudTooltip Text="Iniciar tour guiado">
                        <MudIconButton Icon="@Icons.Material.Filled.Help" 
                                      Color="Color.Info" 
                                      OnClick="StartDashboardTour"
                                      Size="Size.Medium"/>
                    </MudTooltip>
                }
                <MudIcon Icon="@_greetingIcon" Size="Size.Large" Color="Color.Primary" />
            </MudStack>
        </MudStack>
    </MudPaper>

    <!-- Date Range Filters -->
    <MudPaper Class="pa-3">
        <MudGrid>
            <MudItem xs="12" sm="6" md="4">
                <MudDateRangePicker @bind-DateRange="_range" 
                                    Label="PerÃ­odo Personalizado" 
                                    Dense="true"
                                    Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" sm="6" md="8">
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Style="height: 100%;">
                    <MudText Typo="Typo.body2" Style="white-space: nowrap;">Presets:</MudText>
                    <MudChipSet T="string" @bind-SelectedChip="_selectedPreset" Filter="true" Mandatory="false">
                        <MudChip T="string" Text="Hoje" Color="Color.Primary" Value="@("today")" OnClick="() => ApplyPreset(DatePreset.Today)" />
                        <MudChip T="string" Text="Ontem" Color="Color.Primary" Value="@("yesterday")" OnClick="() => ApplyPreset(DatePreset.Yesterday)" />
                        <MudChip T="string" Text="Ãšltimos 7 dias" Color="Color.Primary" Value="@("week")" OnClick="() => ApplyPreset(DatePreset.Last7Days)" />
                        <MudChip T="string" Text="Ãšltimos 30 dias" Color="Color.Primary" Value="@("month")" OnClick="() => ApplyPreset(DatePreset.Last30Days)" />
                        <MudChip T="string" Text="Este mÃªs" Color="Color.Primary" Value="@("thisMonth")" OnClick="() => ApplyPreset(DatePreset.ThisMonth)" />
                        <MudChip T="string" Text="Ãšltimo mÃªs" Color="Color.Primary" Value="@("lastMonth")" OnClick="() => ApplyPreset(DatePreset.LastMonth)" />
                    </MudChipSet>
                </MudStack>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudGrid Class="mt-2" GutterSize="GutterSize.Small">
        @if (_widgets is null)
        {
            @for (var i = 0; i < 4; i++)
            {
                <MudItem xs="12" md="6" lg="4">
                    <MudSkeleton Height="320px" Width="100%" />
                </MudItem>
            }
        }
        else
        {
            @foreach (var w in _widgets)
            {
                <MudItem xs="12" md="6" lg="4">
                    <erp.Components.Shared.Charts.WidgetHost Definition="w" />
                </MudItem>
            }
        }
    </MudGrid>
</MudStack>

<!-- Onboarding Tour Component -->
<erp.Components.Shared.OnboardingTour @ref="_tourComponent" 
                                       OnTourCompleted="HandleTourCompleted"
                                       OnTourSkipped="HandleTourSkipped" />

@code {
    private List<DashboardWidgetDefinition>? _widgets;
    private DateRange _range = new(DateTime.Today.AddMonths(-1), DateTime.Today);
    private MudChip<string>? _selectedPreset;
    
    private string _greeting = "";
    private string _greetingIcon = Icons.Material.Filled.WbSunny;
    private string _userName = "UsuÃ¡rio";
    private string? _userId;
    private bool _tourCompleted = false;
    
    private erp.Components.Shared.OnboardingTour? _tourComponent;

    protected override async Task OnInitializedAsync()
    {
        // Set greeting based on time of day
        var hour = DateTime.Now.Hour;
        if (hour >= 5 && hour < 12)
        {
            _greeting = "Bom dia";
            _greetingIcon = Icons.Material.Filled.WbSunny;
        }
        else if (hour >= 12 && hour < 18)
        {
            _greeting = "Boa tarde";
            _greetingIcon = Icons.Material.Filled.WbTwilight;
        }
        else
        {
            _greeting = "Boa noite";
            _greetingIcon = Icons.Material.Filled.DarkMode;
        }

        // Get user name and ID
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            _userName = user.FindFirst(ClaimTypes.Name)?.Value 
                        ?? user.FindFirst("sub")?.Value 
                        ?? user.Identity.Name 
                        ?? "UsuÃ¡rio";
            _userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        }

        var list = await Dashboard.GetWidgetsAsync();
        _widgets = list.ToList();

        // Check if tour should be shown
        await CheckTourStatus();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_tourCompleted && _userId != null)
        {
            // Small delay to ensure page is fully rendered
            await Task.Delay(1000);
            
            var progress = await OnboardingService.GetUserProgressAsync(_userId, "welcome-tour");
            if (progress == null || !progress.IsCompleted)
            {
                await StartDashboardTour();
            }
        }
    }

    private async Task CheckTourStatus()
    {
        if (_userId == null) return;
        
        var progress = await OnboardingService.GetUserProgressAsync(_userId, "welcome-tour");
        _tourCompleted = progress?.IsCompleted ?? false;
    }

    private async Task StartDashboardTour()
    {
        if (_tourComponent != null)
        {
            await _tourComponent.StartTour("welcome-tour");
        }
    }

    private async Task HandleTourCompleted(string tourId)
    {
        _tourCompleted = true;
        Snackbar.Add("ðŸŽ‰ Tour concluÃ­do! Bem-vindo ao Pillar ERP!", Severity.Success);
        StateHasChanged();
    }

    private async Task HandleTourSkipped(string tourId)
    {
        _tourCompleted = true;
        StateHasChanged();
    }

    private enum DatePreset
    {
        Today,
        Yesterday,
        Last7Days,
        Last30Days,
        ThisMonth,
        LastMonth
    }

    private void ApplyPreset(DatePreset preset)
    {
        var today = DateTime.Today;
        _range = preset switch
        {
            DatePreset.Today => new DateRange(today, today),
            DatePreset.Yesterday => new DateRange(today.AddDays(-1), today.AddDays(-1)),
            DatePreset.Last7Days => new DateRange(today.AddDays(-7), today),
            DatePreset.Last30Days => new DateRange(today.AddDays(-30), today),
            DatePreset.ThisMonth => new DateRange(new DateTime(today.Year, today.Month, 1), today),
            DatePreset.LastMonth => new DateRange(
                new DateTime(today.Year, today.Month, 1).AddMonths(-1),
                new DateTime(today.Year, today.Month, 1).AddDays(-1)
            ),
            _ => _range
        };
        StateHasChanged();
    }
}
