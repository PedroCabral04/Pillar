@page "/dashboard"
@using erp.Services.Dashboard
@using MudBlazor
@using erp.Services
@using erp.DTOs.Dashboard
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Color = MudBlazor.Color
@using Size = MudBlazor.Size
@using erp.Services.Onboarding
@using erp.DTOs.Onboarding
@using ApexCharts

@inject IDashboardService Dashboard
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IOnboardingService OnboardingService
@inject IApiService Api
@inject ISnackbar Snackbar
@inject PreferenceService PreferenceService

<PageTitle>Dashboard - Pillar ERP</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
    <!-- Greeting Section -->
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudGrid>
            <MudItem xs="12" sm="8">
                <MudText Typo="Typo.h4" Class="mb-1">@_greeting, @_userName!</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">@DateTime.Now.ToString("dddd, dd 'de' MMMM 'de' yyyy")</MudText>
            </MudItem>
            <MudItem xs="12" sm="4" Class="d-flex align-center justify-end">
                <MudIcon Icon="@_greetingIcon" Size="Size.Large" Color="Color.Primary" />
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Date Range Filters -->
    <MudPaper Class="pa-4 mb-4" Elevation="1">
        <MudGrid AlignItems="MudBlazor.AlignItems.Center">
            <MudItem xs="12" md="4">
                <MudDateRangePicker @bind-DateRange="_range" 
                                    Label="Período" 
                                    Variant="Variant.Outlined"
                                    DateFormat="dd/MM/yyyy" />
            </MudItem>
            <MudItem xs="12" md="8">
                <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center" Class="flex-wrap">
                    <MudChip T="string" Text="Hoje" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined" OnClick="() => ApplyPreset(DatePreset.Today)" />
                    <MudChip T="string" Text="Ontem" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined" OnClick="() => ApplyPreset(DatePreset.Yesterday)" />
                    <MudChip T="string" Text="7 dias" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined" OnClick="() => ApplyPreset(DatePreset.Last7Days)" />
                    <MudChip T="string" Text="30 dias" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined" OnClick="() => ApplyPreset(DatePreset.Last30Days)" />
                    <MudChip T="string" Text="Este mês" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined" OnClick="() => ApplyPreset(DatePreset.ThisMonth)" />
                    <MudChip T="string" Text="Mês anterior" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined" OnClick="() => ApplyPreset(DatePreset.LastMonth)" />
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" StartIcon="@Icons.Material.Filled.Refresh" OnClick="RefreshWidgets" Class="ml-2">
                        Atualizar
                    </MudButton>
                </MudStack>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Widgets Grid -->
    @if (_widgetVms is null)
    {
        <MudGrid Spacing="3">
            @for (var i = 0; i < 6; i++)
            {
                <MudItem xs="12" md="6" lg="4">
                    <MudPaper Class="pa-4" Elevation="1">
                        <MudSkeleton Width="60%" Height="24px" Class="mb-2" />
                        <MudSkeleton Width="100%" Height="280px" />
                    </MudPaper>
                </MudItem>
            }
        </MudGrid>
    }
    else if (!_widgetVms.Any())
    {
        <MudPaper Class="pa-6 text-center" Elevation="1">
            <MudIcon Icon="@Icons.Material.Filled.Dashboard" Size="Size.Large" Color="Color.Secondary" Class="mb-3" />
            <MudText Typo="Typo.h5" Class="mb-2">Nenhum widget disponível</MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary">
                Adicione widgets ao seu painel ou peça ao administrador para liberar widgets para seu papel.
            </MudText>
        </MudPaper>
    }
    else
    {
        <MudGrid Spacing="3">
            @foreach (var widget in _widgetVms)
            {
                <MudItem xs="12" md="6" lg="4">
                    <erp.Components.Shared.Charts.WidgetHost Definition="widget.Definition" Query="widget.Query" RefreshToken="_refreshToken" />
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>

<!-- Onboarding Tour -->
<erp.Components.Shared.OnboardingTour @ref="_tourComponent"
                                     OnTourCompleted="@HandleTourComplete" 
                                     OnTourSkipped="@HandleTourSkip" />

@code {
    private List<DashboardWidgetDefinition>? _widgets;
    private List<WidgetVm>? _widgetVms;
    private DateRange _range = new(DateTime.Today.AddMonths(-1), DateTime.Today);
    private long _refreshToken = 0;
    private bool _isRefreshing = false;
    
    private string _greeting = "";
    private string _greetingIcon = Icons.Material.Filled.WbSunny;
    private string _userName = "Usuário";
    private string _userId = string.Empty;
    private string[] _userRoles = Array.Empty<string>();
    
    private erp.Components.Shared.OnboardingTour? _tourComponent;

    protected override async Task OnInitializedAsync()
    {
        SetGreeting();
        await LoadUserInfo();
        await LoadWidgets();
        await InitializeTourAsync();
    }
    
    private void SetGreeting()
    {
        var hour = DateTime.Now.Hour;
        if (hour >= 5 && hour < 12)
        {
            _greeting = "Bom dia";
            _greetingIcon = Icons.Material.Filled.WbSunny;
        }
        else if (hour >= 12 && hour < 18)
        {
            _greeting = "Boa tarde";
            _greetingIcon = Icons.Material.Filled.WbTwilight;
        }
        else
        {
            _greeting = "Boa noite";
            _greetingIcon = Icons.Material.Filled.DarkMode;
        }
    }
    
    private async Task LoadUserInfo()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            _userName = user.FindFirst(ClaimTypes.Name)?.Value 
                        ?? user.FindFirst("sub")?.Value 
                        ?? user.Identity.Name 
                        ?? "Usuário";
            
            _userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? string.Empty;
            _userRoles = user.FindAll(ClaimTypes.Role).Select(c => c.Value).ToArray();
        }
    }
    
    private async Task LoadWidgets()
    {
        try
        {
            // Load dashboard widgets (already filtered by server by role)
            var list = await Dashboard.GetWidgetsAsync();
            _widgets = list.ToList();

            // Load user's saved layout and build VM list
            var layout = await Api.GetAsync<DashboardLayout>("api/dashboard/layout");
            
            if (layout?.Widgets?.Any() == true)
            {
                _widgetVms = layout.Widgets
                    .OrderBy(w => w.Order)
                    .Select(wcfg =>
                    {
                        var def = _widgets.FirstOrDefault(d => d.ProviderKey == wcfg.ProviderKey && d.WidgetKey == wcfg.WidgetKey);
                        if (def == null) return null;

                        // Respect role restrictions on client as well
                        if (def.RequiredRoles?.Length > 0 && !_userRoles.Intersect(def.RequiredRoles).Any())
                            return null;

                        return new WidgetVm
                        {
                            Definition = def,
                            Config = wcfg,
                            Query = new DashboardQuery { From = _range.Start, To = _range.End }
                        };
                    })
                    .Where(x => x != null)
                    .Cast<WidgetVm>()
                    .ToList();
            }
            else
            {
                // Fallback: build from available definitions
                _widgetVms = _widgets.Select(d => new WidgetVm 
                { 
                    Definition = d, 
                    Config = new WidgetConfiguration 
                    { 
                        WidgetId = $"{d.ProviderKey}_{d.WidgetKey}_default", 
                        ProviderKey = d.ProviderKey, 
                        WidgetKey = d.WidgetKey, 
                        Order = 0 
                    }, 
                    Query = new DashboardQuery { From = _range.Start, To = _range.End } 
                }).ToList();
            }

            // Filter by user preferences if any are selected
            var preferredWidgets = PreferenceService.CurrentPreferences.Dashboard.Widgets;
            if (preferredWidgets?.Any() == true)
            {
                _widgetVms = _widgetVms?
                    .Where(vm => preferredWidgets.Contains(vm.Definition.Title))
                    .ToList();
            }
        }
        catch (Exception ex)
        {
            // If layout endpoint fails, still show definitions
            if (_widgets != null)
            {
                _widgetVms = _widgets.Select(d => new WidgetVm 
                { 
                    Definition = d, 
                    Config = new WidgetConfiguration 
                    { 
                        WidgetId = $"{d.ProviderKey}_{d.WidgetKey}_default", 
                        ProviderKey = d.ProviderKey, 
                        WidgetKey = d.WidgetKey, 
                        Order = 0 
                    }, 
                    Query = new DashboardQuery { From = _range.Start, To = _range.End } 
                }).ToList();
            }
            Console.WriteLine($"Warning loading dashboard: {ex.Message}");
        }
    }
    
    private async Task RefreshWidgets()
    {
        _widgetVms = null;
        StateHasChanged();
        
        // Update query dates for all widgets
        await LoadWidgets();
        StateHasChanged();
        
        Snackbar.Add("Dashboard atualizado!", Severity.Success);
    }
    
    private async Task InitializeTourAsync()
    {
        if (string.IsNullOrEmpty(_userId) || _tourComponent == null)
            return;
            
        var dashboardTour = OnboardingService.GetTourById("dashboard-tour");
        if (dashboardTour == null)
            return;
            
        var progress = await OnboardingService.GetUserProgressAsync(_userId, "dashboard-tour");
        
        if (progress == null || !progress.IsCompleted)
        {
            await Task.Delay(500);
            await _tourComponent.StartTour("dashboard-tour");
        }
    }
    
    private Task HandleTourComplete(string tourId) => Task.CompletedTask;
    private Task HandleTourSkip(string tourId) => Task.CompletedTask;

    private enum DatePreset
    {
        Today,
        Yesterday,
        Last7Days,
        Last30Days,
        ThisMonth,
        LastMonth
    }

    private async Task ApplyPreset(DatePreset preset)
    {
        if (_isRefreshing) return;
        
        var today = DateTime.Today;
        var newRange = preset switch
        {
            DatePreset.Today => new DateRange(today, today),
            DatePreset.Yesterday => new DateRange(today.AddDays(-1), today.AddDays(-1)),
            DatePreset.Last7Days => new DateRange(today.AddDays(-7), today),
            DatePreset.Last30Days => new DateRange(today.AddDays(-30), today),
            DatePreset.ThisMonth => new DateRange(new DateTime(today.Year, today.Month, 1), today),
            DatePreset.LastMonth => new DateRange(
                new DateTime(today.Year, today.Month, 1).AddMonths(-1),
                new DateTime(today.Year, today.Month, 1).AddDays(-1)
            ),
            _ => _range
        };
        
        // Se o range não mudou, não faz nada
        if (newRange.Start == _range.Start && newRange.End == _range.End)
            return;
            
        _range = newRange;
        await UpdateWidgetQueries();
    }
    
    private async Task UpdateWidgetQueries()
    {
        if (_widgetVms == null) return;
        
        _isRefreshing = true;
        
        // Criar novos objetos Query para forçar a detecção de mudança
        foreach (var vm in _widgetVms)
        {
            vm.Query = new DashboardQuery { From = _range.Start, To = _range.End };
        }
        
        // Incrementar token para forçar refresh nos WidgetHost
        _refreshToken++;
        StateHasChanged();
        
        // Pequeno delay para evitar múltiplos cliques rápidos
        await Task.Delay(100);
        _isRefreshing = false;
    }

    private class WidgetVm
    {
        public required DashboardWidgetDefinition Definition { get; set; }
        public required WidgetConfiguration Config { get; set; }
        public DashboardQuery? Query { get; set; }
    }
}
